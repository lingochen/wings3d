!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){o(1),e.exports=o(2)},function(e,t,o){"use strict";o.r(t);let n=null;const r=function(e,t,o,r){var i;this.handle=e,this.format=1===(i=o)?n.LUMINANCE:2===i?n.LUMINACE_ALPHA:3===i?n.RGB:4===i?n.RGBA:void console.log(`unsupport format size: ${i}`),this.formatChannel=o,this.type=r,this.height=0,this.unit=t};r.getSize=function(e,t=1){const o=Math.ceil(e/n.textureSize);return n.textureSize*o*t},r.prototype.getSize=function(){return n.textureSize*this.height*this.formatChannel},r.prototype.deleteBuffer=function(){n.deleteTexture(this.handle)},r.prototype.bufferData=function(e){this.height=Math.ceil(e.length/this.formatChannel/n.textureSize),n.bindTexture(n.TEXTURE_2D,this.handle),n.texImage2D(n.TEXTURE_2D,0,this.format,n.textureSize,this.height,0,this.format,this.type,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)},r.prototype.bufferSubData=function(e,t,o,r){if(o){if(r){let e=o+r;o=Math.floor(o/this.formatChannel)*this.formatChannel,r=(e=Math.ceil(e/this.formatChannel)*this.formatChannel)-o}else r=t.length-o;t=t.subarray(o,o+r)}else o=0,r||(r=t.length);const i=Math.ceil(r/this.formatChannel),s=Math.floor(e/n.textureSize),a=Math.floor((e+i)/n.textureSize)-s+1;let l=0,c=n.textureSize;1===a&&(l=e%n.textureSize,c=i),n.bindTexture(n.TEXTURE_2D,this.handle),n.texSubImage2D(n.TEXTURE_2D,0,l,s,c,a,this.format,this.type,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)};const i=function(){this.attribute={},this.uniform={},this.index={},this.sampler={}};i.attribLayout=function(e=3,t=n.FLOAT,o=!1,r=0,i=0){return{size:e,type:t,normalized:o,stride:r,offset:i}},i.prototype.setupAttribute=function(e,t,o,n){this.createAttribute(e,t,n),this.resizeAttribute(e,o.byteLength),this.uploadAttribute(e,0,o)},i.prototype.createAttribute=function(e,t,o){if(this.attribute[e])console.log("Shader Data: "+e+" already initialized");else{var r=n.createBuffer();this.attribute[e]={handle:r,byteLength:0,usage:o,size:t.size,type:t.type,normalized:t.normalized,stride:t.stride,offset:t.offset}}},i.prototype.resizeAttribute=function(e,t){var o=this.attribute[e];o&&o.byteLength!=t&&(n.bindBuffer(n.ARRAY_BUFFER,o.handle),n.bufferData(n.ARRAY_BUFFER,t,o.usage),o.byteLength=t)},i.prototype.deleteAttribute=function(e){var t=this.attribute[e];t&&(n.deleteBuffer(t.handle),this.attribute[e]=null)},i.prototype.freeAllAttributes=function(){var e=[];for(var t in this.attribute)e.push(t);for(var o=0;o<e.length;++o)this.deleteAttribute(e[o])},i.prototype.uploadAttribute=function(e,t,o){var r=this.attribute[e];r?(n.bindBuffer(n.ARRAY_BUFFER,r.handle),n.bufferSubData(n.ARRAY_BUFFER,t,o)):console.log("Shader Data: "+e+" not initialized")},i.prototype.updateAttribute=function(e,t){t.gpuSize!==t.usedSize?(t.gpuSize=t.usedSize,this.resizeAttribute(e,4*t.usedSize),this.uploadAttribute(e,0,t.buffer.subarray(0,t.usedSize)),t._resetCounter()):t.isAltered()&&(this.uploadAttribute(e,4*t.alteredMin,t.buffer.subarray(t.alteredMin,t.alteredMax+1)),t._resetCounter())},i.prototype.updateAttributeEx=function(e,t,o){const r=this.attribute[e];if(r){if(t.isLengthAltered()||o.isLengthAltered())n.bindBuffer(n.ARRAY_BUFFER,r.handle),n.bufferData(n.ARRAY_BUFFER,t.byteLength()+o.byteLength(),r.usage),n.bufferSubData(n.ARRAY_BUFFER,0,t.getBuffer()),n.bufferSubData(n.ARRAY_BUFFER,t.byteLength(),o.getBuffer()),t._resetLength(),o._resetLength();else{if(t.isAltered()){n.bindBuffer(n.ARRAY_BUFFER,r.handle);const e=t.getChanged();n.bufferSubData(n.ARRAY_BUFFER,e.byteOffset,e.array)}if(o.isAltered()){t.isAltered()||n.bindBuffer(n.ARRAY_BUFFER,r.handle);const e=o.getChanged();n.bufferSubData(n.ARRAY_BUFFER,t.byteLength()+e.byteOffset,e.array)}}t._resetCounter(),o._resetCounter()}else console.log("Shader Attribute: "+e+" not initialized")},i.prototype.createIndex=function(e){this.index[e]?console.log("Shader Index: "+e+" already initialized"):this.index[e]=n.createBuffer()},i.prototype.updateIndex=function(e,t,o,r=n.STATIC_DRAW){let i=this.index[e];if(i){if(t.isLengthAltered()){n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i);const e=t.buffer.subarray(0,t.usedSize),s=new Uint32Array(e);for(let t=2;t<s.length;t+=3)e[t]<0&&(s[t]=-e[t]-1+o);n.bufferData(n.ELEMENT_ARRAY_BUFFER,s,r),t._resetCounter(),t._resetLength()}else if(t.isAltered()){n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,i);const e=t.getChanged(),r=new Uint32Array(e.array);for(let t=2;t<r.length;t+=3)e.array[t]<0&&(r[t]=-e.array[t]-1+o);n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,e.byteOffset,r),t._resetCounter()}}else console.log("unknown index: "+e)},i.prototype.createSampler=function(e,t,o,i){let s=null;if(this.sampler[e])console.log("Shader Data: "+e+" already initialized");else{const a=n.createTexture();s=new r(a,t,o,i),this.sampler[e]=s,this.setUniformSampler(e,s)}return s},i.prototype.getSampler=function(e){return this.sampler[e]},i.prototype.updateSampler=function(e,t){const o=this.getSampler(e);if(o){const n=e+"Height";if(o.getSize()!==t.buffer.length)o.bufferData(t.buffer),t._resetCounter(),this.setUniform1f(n,o.height);else if(t.isAltered()){let e=t.getInterval(o.formatChannel);o.bufferSubData(e.start/o.formatChannel,t.buffer,e.start,e.end-e.start),t._resetCounter()}}else console.log("unknown sampler: "+e)},i.prototype.setUniform1f=function(e,t){this.uniform[e]={value:new Float32Array(1),binder:i.uniform1fFn},this.uniform[e].value=t},i.uniform1fFn=function(e,t,o){e.uniform1f(t,o)},i.prototype.setUniform1fv=function(e,t){const o={value:new Float32Array(t),binder:i.uniform1fvFn};this.uniform[e]=o},i.uniform1fvFn=function(e,t,o){try{e.uniform1fv(t,o)}catch(e){console.log(e)}},i.prototype.setUniform3fv=function(e,t){const o={value:new Float32Array(t),binder:i.uniform3fvFn};this.uniform[e]=o},i.uniform3fvFn=function(e,t,o){e.uniform3fv(t,o)},i.prototype.setUniform4fv=function(e,t){const o={value:new Float32Array(t),binder:i.uniform4fvFn};this.uniform[e]=o},i.uniform4fvFn=function(e,t,o){e.uniform4fv(t,o)},i.prototype.setUniformSampler=function(e,t){this.uniform[e]={value:{unit:t.unit,handle:t.handle},binder:i.uniformSampler},this.uniform[e+"Height"]={value:t.height,binder:i.uniform1f}},i.uniformSampler=function(e,t,o){e.activeTexture(e.TEXTURE0+o.unit),e.bindTexture(e.TEXTURE_2D,o.handle),e.uniform1i(t,o.unit)};var s=function(e,t,o,n){this.progHandle=e,this.transform=t,this.attribute=o,this.uniform=n};s.prototype.disableVertexAttributeArray=function(e){for(var t in this.attribute)this.attribute.hasOwnProperty(t)&&e.disableVertexAttribArray(this.attribute[t].loc)},s.prototype.bindAttribute=function(e,t,o){try{for(let n of o)if(t.hasOwnProperty(n)&&this.attribute.hasOwnProperty(n)){const o=t[n];e.bindAttributeToProgram(this.attribute[n].loc,o)}}catch(e){console.log(e)}},s.prototype.bindUniform=function(e,t,o){try{for(let r of o)if(t.hasOwnProperty(r)&&this.uniform.hasOwnProperty(r)){var n=t[r];n.binder(e,this.uniform[r].loc,n.value)}}catch(e){console.log(e)}},s.prototype.bindTransform=function(e,t){try{for(var o in this.transform){if(t.hasOwnProperty(o))(0,t[o])(e,this.transform[o])}}catch(e){console.log(e)}},s.prototype.getTypeByName=function(e){};const a=function(e){this.buffer=null,this.component=e,this.usedSize=0,this.gpuSize=0,this.alteredMin=0,this.alteredMax=-1};a.prototype.byteLength=function(){return this.usedSize*this.byteSize()},a.prototype.getBuffer=function(){return this.buffer.subarray(0,this.usedSize)},a.prototype.getChanged=function(){let e=Math.floor(this.alteredMin/this.component)*this.component,t=(Math.floor(this.alteredMax/this.component)+1)*this.component;return{byteOffset:e*this.byteSize(),array:this.buffer.subarray(e,t)}},a.prototype.getInterval=function(e){const t={start:0,end:0};return this.isAltered()&&(t.start=Math.floor(this.alteredMin/e)*e,t.end=(Math.floor(this.alteredMax/e)+1)*e),t},a.prototype.alloc=function(){const e=this.usedSize;return this.usedSize+=this.component,this.usedSize>this.buffer.length&&this.expand(),e},a.prototype.computeAllocateSize=function(e){return Math.ceil(e/n.textureSize)*n.textureSize*this.component},a.prototype.expand=function(){const e=this.buffer.length;let t=Math.ceil(e/this.component*1.5);const o=this.buffer;this.buffer=this._allocateBuffer(t),this.buffer.set(o)},a.prototype.get=function(e){return this.buffer[e]},a.prototype.set=function(e,t){return this.buffer[e]!==t&&(this.buffer[e]=t,e<this.alteredMin&&(this.alteredMin=e),e>this.alteredMax&&(this.alteredMax=e),!0)},a.prototype._resetCounter=function(){this.alteredMin=this.buffer?this.buffer.length:0,this.alteredMax=-1},a.prototype._resetLength=function(){this.gpuSize=this.usedSize},a.prototype.isAltered=function(){return this.alteredMin<=this.alteredMax},a.prototype.isLengthAltered=function(){return this.gpuSize!==this.usedSize};const l=function(e,t){a.call(this,e),t||(t=n.textureSize),this.buffer=this._allocateBuffer(t)};l.prototype=Object.create(a.prototype),Object.defineProperty(l.prototype,"constructor",{value:l,enumerable:!1,writable:!0}),l.prototype._allocateBuffer=function(e){return new Float32Array(this.computeAllocateSize(e))},l.prototype.byteSize=function(){return 4};const c=function(e,t){a.call(this,e),t||(t=n.textureSize),this.buffer=this._allocateBuffer(t)};c.prototype=Object.create(a.prototype),Object.defineProperty(c.prototype,"constructor",{value:c,enumerable:!1,writable:!0}),c.prototype._allocateBuffer=function(e){return new Uint8Array(this.computeAllocateSize(e))},c.prototype.byteSize=function(){return 1};const d=function(e,t){a.call(this,e),t||(t=n.textureSize),this.buffer=this._allocateBuffer(t)};d.prototype=Object.create(a.prototype),Object.defineProperty(d.prototype,"constructor",{value:d,enumerable:!1,writable:!0}),d.prototype._allocateBuffer=function(e){return new Int32Array(this.computeAllocateSize(e))},d.prototype.byteSize=function(){return 4};const u=function(e,t){a.call(this,e),t||(t=n.textureSize),this.buffer=this._allocateBuffer(t)};u.prototype=Object.create(a.prototype),Object.defineProperty(u.prototype,"constructor",{value:u,enumerable:!1,writable:!0}),u.prototype._allocateBuffer=function(e){return new Uint32Array(this.computeAllocateSize(e))},u.prototype.byteSize=function(){return 4};let f=!1,h=[];function p(e){return f?e():h.push(e),this}let g="";function m(e){document.removeEventListener("DOMContentLoaded",m),w(g)}void 0===NodeList.prototype[Symbol.iterator]&&(NodeList.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator]);let v=[];function y(e,t){for(let o of v)o(e,t)}function x(e,t){if(t)v.push(e);else{let t=v.indexOf(e);t>-1&&v.splice(t,1)}}function S(){let e=0,t=0,o=arguments.length>32?32:arguments.length;for(;t<o;e|=arguments[t]<<t++);return e}const b=1,E=8*b;function w(e){!function(e,t){var o={currentShader:null},r=document.getElementById(e);if(!r)return null;if(t=void 0!==t?t:{depth:!0,stencil:!0,antialias:!0},!(n=r.getContext("webgl",t)))return alert("Unable to initialize WebGL"),null;{let e=n.getExtension("OES_standard_derivatives");if(null===e)return console.log("No OES_standard_derivatives"),null;if(null===(e=n.getExtension("OES_element_index_uint")))return console.log("No OES_element_index_uint"),null;if(null===(e=n.getExtension("OES_texture_float")))return console.log("No floating texture"),null;if(n.getParameter(n.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<8)return console.log("Not enough vertex texture units"),null;n.textureSize=n.getParameter(n.MAX_TEXTURE_SIZE),console.log("WebGL 1 init with extension")}n.resizeToDisplaySize=function(){var e=n.canvas,t=e.clientWidth,o=e.clientHeight;return(e.width!=t||e.height!=o)&&(e.width=t,e.height=o,n.viewport(0,0,t,o),!0)},n.projection=mat4.create(),n.modelView=mat4.create(),o.transform={projection:function(e,t){e.uniformMatrix4fv(t,!1,e.projection)},worldView:function(e,t){e.uniformMatrix4fv(t,!1,e.modelView)}},n.getViewport=function(){return n.getParameter(n.VIEWPORT)},n.project=function(e,t,o,r,i){var s=vec4.fromValues(e,t,o,1);if(out=vec4.create(),vec4.transformMat4(out,s,r),vec4.transformMat4(s,out,i),0==s[3])return s;s[0]/=s[3],s[1]/=s[3],s[2]/=s[3];var a=n.getViewport();return out[0]=(.5*s[0]+.5)*a[2]+a[0],out[1]=(.5*s[1]+.5)*a[3]+a[1],out[2]=.5*s[2]+.5,out[3]=1,out},n.unProject=function(e,t,o,r,i,s){var a=mat4.create(),l=vec4.create(),c=vec4.create();return mat4.multiply(a,i,r),null==mat4.invert(a,a)?(c[3]=0,c):(s=n.getViewport(),l[0]=(e-s[0])/s[2]*2-1,l[1]=(t-s[1])/s[3]*2-1,l[2]=2*o-1,l[3]=1,vec4.transformMat4(c,l,a),0==c[3]?c:(c[0]/=c[3],c[1]/=c[3],c[2]/=c[3],c[3]=1,c))},n.transformVertex=function(e){var t=vec4.create();return vec4.transformMat4(t,vec4.transformMat4(t,e,n.modelView),n.projection)},n.compileGLSL=function(e,t){var o=n.loadShader(n.VERTEX_SHADER,e);if(!o)return console.log("failed to compile vertex shader"),null;var r=n.loadShader(n.FRAGMENT_SHADER,t);if(!r)return console.log("failed to compile fragment shader"),null;var i=n.createProgram();if(n.attachShader(i,o),n.attachShader(i,r),n.linkProgram(i),!n.getProgramParameter(i,n.LINK_STATUS)){var s=n.getProgramInfoLog(i);return console.log("failed to link program: "+s),n.deleteProgram(i),n.deleteShader(r),n.deleteShader(o),null}return i},n.loadShader=function(e,t){var o=n.createShader(e);if(n.shaderSource(o,t),n.compileShader(o),!n.getShaderParameter(o,n.COMPILE_STATUS)){var r=n.getShaderInfoLog(o);return console.log("failed to compile shader: "+r),n.deleteShader(o),null}return o},n.createShaderProgram=function(e,t){var o=n.compileGLSL(e,t);if(o){for(var r,i={},a=n.getProgramParameter(o,n.ACTIVE_ATTRIBUTES),l=0;l<a;++l){if(!(r=n.getActiveAttrib(o,l)))return console.log("Something wrong, getActiveAttrib failed"),null;i[r.name]={loc:n.getAttribLocation(o,r.name),type:r.type}}var c={},d={world:null,worldView:null,worldViewProjection:null,view:null,projection:null};for(a=n.getProgramParameter(o,n.ACTIVE_UNIFORMS),l=0;l<a;++l){if(!(r=n.getActiveUniform(o,l)))return console.log("Something wrong, getActiveUniform failed"),null;if(d.hasOwnProperty(r.name))d[r.name]=n.getUniformLocation(o,r.name);else{let e=r.name;"[0]"===e.substr(-3)&&(e=e.substr(0,e.length-3)),c[e]={loc:n.getUniformLocation(o,r.name),size:r.size,type:r.type}}}return new s(o,d,i,c)}},n.createBufferHandle=function(e,t=n.ARRAY_BUFFER,o=n.STATIC_DRAW){if(ArrayBuffer.isView(e)){var r=n.createBuffer();return n.bindBuffer(t,r),n.bufferData(t,e,o),n.bindBuffer(t,null),r}return console.log("not typedArray"),null},n.setBufferAndAttrib=function(e,t,o=3){n.bindBuffer(n.ARRAY_BUFFER,e),n.vertexAttribPointer(t,o,n.FLOAT,!1,0,0),n.enableVertexAttribArray(t)},n.bindAttributeToProgram=function(e,t){n.bindBuffer(n.ARRAY_BUFFER,t.handle),n.vertexAttribPointer(e,t.size,t.type,t.normalized,t.stride,t.offset),n.enableVertexAttribArray(e)},n.bindIndex=function(e,t){const o=e.index[t];o&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,o)},n.bindAttribute=function(e,t){o.currentShader.bindAttribute(n,e.attribute,t)},n.bindUniform=function(e,t){o.currentShader.bindUniform(n,e.uniform,t)},n.bindTransform=function(){o.currentShader.bindTransform(n,o.transform)},n.pushTransform=function(e){},n.popTransform=function(){},n.useShader=function(e){o.currentShader=e,n.useProgram(e.progHandle)},n.disableShader=function(){o.currentShader&&o.currentShader.disableVertexAttributeArray(n)},n.drawVertex=function(e){n.bindTransform(),n.bindShaderData(e.shaderData,!1),e.drawVertex(n)},n.drawSelect=function(e){n.bindTransform(),e.bindSelectorShaderData(n),e.drawSelect(n)},n.createShaderData=function(){return new i}}(e),f=!0;for(let e of h)e();window.addEventListener("beforeunload",C)}function C(e){return e.returnValue="Are you sure you want to quit?","Are you sure you want to quit?"}let F;const A=[null,null,null];function _(e){return e.preventDefault(),!1}function M(e){e.button<=2?A[e.button]=e.currentTarget:console.log("Amazing: mouse button is "+e.button)}const V="data-menuid";function L(e){if(e.button<=2){let t=A[e.button];t&&t===e.currentTarget&&B(e.button,e.currentTarget.getAttribute(V),e)}A[0]=A[1]=A[2]=null}function P(e,t,o,n){if(I.hasOwnProperty(o)){if(!Array.isArray(I[o])){I[o]=[null,null,null];for(const t of e)t.addEventListener("mousedown",M),t.addEventListener("mouseup",L),t.addEventListener("contextmenu",_)}I[o][t]=n}}function B(e,t,o){if(I.hasOwnProperty(t)){const n=I[t][e];n&&(F?F(t,o)&&n(o):n(o))}else console.log("unrecognized action: "+t)}function T(e){console.log(e.name+" action is not implemented")}const I={cameraModeEnter:()=>{T(void 0)},cameraModeExit:()=>{T(void 0)},cameraZoom:()=>{T(void 0)},contextMenu:()=>{T(void 0)},createCubeDialog:()=>{T(void 0)},fileMenu:()=>{T(void 0)},importMenu:()=>{T(void 0)},exportMenu:()=>{T(void 0)},save:()=>{T(void 0)},open:()=>{T(void 0)},openSidebar:()=>{T(void 0)},toggleVertexMode:()=>{T(void 0)},toggleEdgeMode:()=>{T(void 0)},toggleFaceMode:()=>{T(void 0)},toggleBodyMode:()=>{T(void 0)},toggleMultiMode:()=>{T(void 0)},redoEdit:()=>{T(void 0)},undoEdit:()=>{T(void 0)},preferenceButton:()=>{T(void 0)},toggleOrtho:()=>{T(void 0)},toggleGround:()=>{T(void 0)},toggleAxes:()=>{T(void 0)},createCube:()=>{T(void 0)},createCubePref:()=>{T(void 0)},createMaterial:()=>{T(void 0)},toggleObjectSelect:()=>{T(void 0)},toggleObjectVisibility:()=>{T(void 0)},toggleObjectLock:()=>{T(void 0)},toggleWireMode:()=>{T(void 0)},objectRename:()=>{T(void 0)},objectDelete:()=>{T(void 0)},objectDuplicate:()=>{T(void 0)},createGroup:()=>{T(void 0)},createGroupWorld:()=>{T(void 0)},importImageFileGUI:()=>{T(void 0)},showImage:()=>{T(void 0)},deleteImage:()=>{T(void 0)},createMaterial:()=>{T(void 0)},editMaterial:()=>{T(void 0)},deleteMaterial:()=>{T(void 0)},renameMaterial:()=>{T(void 0)},duplicateMaterial:()=>{T(void 0)},assignMaterial:()=>{T(void 0)},selectMaterial:()=>{T(void 0)},selectMenu:()=>{T(void 0)},deselect:()=>{T(void 0)},more:()=>{T(void 0)},less:()=>{T(void 0)},similar:()=>{T(void 0)},all:()=>{T(void 0)},invert:()=>{T(void 0)},adjacent:()=>{T(void 0)},edgeLoopMenu:()=>{T(void 0)},edgeLoop1:()=>{T(void 0)},nthEdgeLoopMenu:()=>{T(void 0)},edgeLoop2:()=>{T(void 0)},edgeLoop3:()=>{T(void 0)},edgeLoopN:()=>{T(void 0)},edgeRing1:()=>{T(void 0)},nthEdgeRingMenu:()=>{T(void 0)},edgeRing2:()=>{T(void 0)},edgeRing3:()=>{T(void 0)},edgeRingN:()=>{T(void 0)},bodyDelete:()=>{T(void 0)},bodyRename:()=>{T(void 0)},bodyDuplicateMoveMenu:()=>{T(void 0)},bodyDuplicateMoveX:()=>{T(void 0)},bodyDuplicateMoveY:()=>{T(void 0)},bodyDuplicateMoveZ:()=>{T(void 0)},bodyDuplicateMoveFree:()=>{T(void 0)},bodyMoveMenu:()=>{T(void 0)},bodyMoveX:()=>{T(void 0)},bodyMoveY:()=>{T(void 0)},bodyMoveZ:()=>{T(void 0)},bodyMoveFree:()=>{T(void 0)},bodyRotateMenu:()=>{T(void 0)},bodyRotateX:()=>{T(void 0)},bodyRotateY:()=>{T(void 0)},bodyRotateZ:()=>{T(void 0)},bodyRotateFree:()=>{T(void 0)},bodyInvert:()=>{T(void 0)},bodyCombine:()=>{T(void 0)},bodySeparate:()=>{T(void 0)},bodyFlipMenu:()=>{T(void 0)},bodyFlipX:()=>{T(void 0)},bodyFlipY:()=>{T(void 0)},bodyFlipZ:()=>{T(void 0)},bodyScaleUniform:()=>{T(void 0)},bodyScaleAxis:()=>{T(void 0)},bodyScaleAxisX:()=>{T(void 0)},bodyScaleAxisY:()=>{T(void 0)},bodyScaleAxisZ:()=>{T(void 0)},bodyScaleRadial:()=>{T(void 0)},bodyScaleRadialX:()=>{T(void 0)},bodyScaleRadialY:()=>{T(void 0)},bodyScaleRadialZ:()=>{T(void 0)},bodyPlaneCut:()=>{T(void 0)},bodyPlaneCutX:()=>{T(void 0)},bodyPlaneCutY:()=>{T(void 0)},bodyPlaneCutZ:()=>{T(void 0)},bodySlice:()=>{T(void 0)},bodySliceX:()=>{T(void 0)},bodySliceY:()=>{T(void 0)},bodySliceZ:()=>{T(void 0)},bodyWeld:()=>{T(void 0)},bodyColor:()=>{T(void 0)},cutMenu:()=>{T(void 0)},cutLine2:()=>{T(void 0)},cutLine3:()=>{T(void 0)},cutLine4:()=>{T(void 0)},cutLine5:()=>{T(void 0)},cutLine10:()=>{T(void 0)},cutAsk:()=>{T(void 0)},cutAndConnect:()=>{T(void 0)},edgeBevel:()=>{T(void 0)},edgeDissolve:()=>{T(void 0)},edgeCollapse:()=>{T(void 0)},edgeMoveMenu:()=>{T(void 0)},edgeMoveX:()=>{T(void 0)},edgeMoveY:()=>{T(void 0)},edgeMoveZ:()=>{T(void 0)},edgeMoveFree:()=>{T(void 0)},edgeMoveNormal:()=>{T(void 0)},edgeRotateMenu:()=>{T(void 0)},edgeRotateX:()=>{T(void 0)},edgeRotateY:()=>{T(void 0)},edgeRotateZ:()=>{T(void 0)},edgeRotateFree:()=>{T(void 0)},edgeExtrudeMenu:()=>{T(void 0)},edgeExtrudeNormal:()=>{T(void 0)},edgeExtrudeFree:()=>{T(void 0)},edgeExtrudeX:()=>{T(void 0)},edgeExtrudeY:()=>{T(void 0)},edgeExtrudeZ:()=>{T(void 0)},edgeCrease:()=>{T(void 0)},edgeLoopCut:()=>{T(void 0)},edgeCorner:()=>{T(void 0)},edgeSlide:()=>{T(void 0)},edgeFlatten:()=>{T(void 0)},edgeFlattenX:()=>{T(void 0)},edgeFlattenY:()=>{T(void 0)},edgeFlattenZ:()=>{T(void 0)},edgeScaleUniform:()=>{T(void 0)},edgeScaleAxis:()=>{T(void 0)},edgeScaleAxisX:()=>{T(void 0)},edgeScaleAxisY:()=>{T(void 0)},edgeScaleAxisZ:()=>{T(void 0)},edgeScaleRadial:()=>{T(void 0)},edgeScaleRadialX:()=>{T(void 0)},edgeScaleRadialY:()=>{T(void 0)},edgeScaleRadialZ:()=>{T(void 0)},edgeHardness:()=>{T(void 0)},edgeSoft:()=>{T(void 0)},edgeHard:()=>{T(void 0)},edgeInvert:()=>{T(void 0)},faceExtrudeMenu:()=>{T(void 0)},faceExtrudeX:()=>{T(void 0)},faceExtrudeY:()=>{T(void 0)},faceExtrudeZ:()=>{T(void 0)},faceExtrudeFree:()=>{T(void 0)},faceExtrudeNormal:()=>{T(void 0)},faceDissolve:()=>{T(void 0)},faceCollapse:()=>{T(void 0)},faceMoveMenu:()=>{T(void 0)},faceMoveX:()=>{T(void 0)},faceMoveY:()=>{T(void 0)},faceMoveZ:()=>{T(void 0)},faceMoveFree:()=>{T(void 0)},faceMoveNormal:()=>{T(void 0)},faceRotateMenu:()=>{T(void 0)},faceRotateX:()=>{T(void 0)},faceRotateY:()=>{T(void 0)},faceRotateZ:()=>{T(void 0)},faceRotateFree:()=>{T(void 0)},faceScaleUniform:()=>{T(void 0)},faceBridge:()=>{T(void 0)},faceInset:()=>{T(void 0)},faceBevel:()=>{T(void 0)},faceBump:()=>{T(void 0)},faceIntrude:()=>{T(void 0)},facePutOn:()=>{T(void 0)},faceLift:()=>{T(void 0)},faceMirror:()=>{T(void 0)},faceFlatten:()=>{T(void 0)},faceFlattenNormal:()=>{T(void 0)},faceFlattenX:()=>{T(void 0)},faceFlattenY:()=>{T(void 0)},faceFlattenZ:()=>{T(void 0)},faceScaleAxis:()=>{T(void 0)},faceScaleAxisX:()=>{T(void 0)},faceScaleAxisY:()=>{T(void 0)},faceScaleAxisZ:()=>{T(void 0)},faceScaleRadial:()=>{T(void 0)},faceScaleRadialX:()=>{T(void 0)},faceScaleRadialY:()=>{T(void 0)},faceScaleRadialZ:()=>{T(void 0)},facePlaneCut:()=>{T(void 0)},facePlaneCutX:()=>{T(void 0)},facePlaneCutY:()=>{T(void 0)},facePlaneCutZ:()=>{T(void 0)},faceMaterialMenu:()=>{T(void 0)},faceColor:()=>{T(void 0)},vertexConnect:()=>{T(void 0)},vertexDissolve:()=>{T(void 0)},vertexCollapse:()=>{T(void 0)},vertexMoveMenu:()=>{T(void 0)},vertexMoveX:()=>{T(void 0)},vertexMoveY:()=>{T(void 0)},vertexMoveZ:()=>{T(void 0)},vertexMoveFree:()=>{T(void 0)},vertexMoveNormal:()=>{T(void 0)},vertexRotateMenu:()=>{T(void 0)},vertexRotateX:()=>{T(void 0)},vertexRotateY:()=>{T(void 0)},vertexRotateZ:()=>{T(void 0)},vertexRotateFree:()=>{T(void 0)},vertexBevel:()=>{T(void 0)},vertexExtrudeMenu:()=>{T(void 0)},vertexExtrudeNormal:()=>{T(void 0)},vertexExtrudeFree:()=>{T(void 0)},vertexExtrudeX:()=>{T(void 0)},vertexExtrudeY:()=>{T(void 0)},vertexExtrudeZ:()=>{T(void 0)},vertexWeld:()=>{T(void 0)},vertexFlatten:()=>{T(void 0)},vertexFlattenX:()=>{T(void 0)},vertexFlattenY:()=>{T(void 0)},vertexFlattenZ:()=>{T(void 0)},vertexScaleUniform:()=>{T(void 0)},vertexScaleAxis:()=>{T(void 0)},vertexScaleAxisX:()=>{T(void 0)},vertexScaleAxisY:()=>{T(void 0)},vertexScaleAxisZ:()=>{T(void 0)},vertexScaleRadial:()=>{T(void 0)},vertexScaleRadialX:()=>{T(void 0)},vertexScaleRadialY:()=>{T(void 0)},vertexScaleRadialZ:()=>{T(void 0)},vertexColor:()=>{T(void 0)},helpMenu:()=>{T(void 0)},about:()=>{T(void 0)},introduction:()=>{T(void 0)},basicCommands:()=>{T(void 0)},tableTutor:()=>{T(void 0)}};const O=function(){return function(t){return fetch(t).then(e)};function e(e){let t=e.headers.get("content-type");if(t.includes("application/json")||t.includes("application/jason"))return function(e){return e.json().then(t=>e.ok?t:Promise.reject(Object.assign({},t,{status:e.status,statusText:e.statusText})))}(e);if(t.includes("text/html"))return function(e){return e.text().then(t=>e.ok?t:Promise.reject({status:e.status,statusText:e.statusText,err:t}))}(e);throw new Error(`Sorry, content-type ${t} not supported`)}}(),z=new Map;const D="data-menuId";function N(e,t,o,n,r,i,s){if(P(t,o,n,r),void 0!==i){!function(e,t,o,n=""){o=o.toLowerCase();const r=S((n=n.toLowerCase()).indexOf("alt")>-1,n.indexOf("ctrl")>-1,n.indexOf("shift")>-1);z.has(o)||z.set(o,[]),z.get(o).unshift({mode:e,meta:r,id:t})}(e,n,i,s);const o=s?`${s}+${i}`:i;for(let e of t)e.classList.add("hotkey"),e.setAttribute("data-hotkey",o.toUpperCase())}}function R(e,t,o,n){const r=document.querySelectorAll(`[${D}="${e}"]`);r?N(null,r,0,e,t,o,n):console.log("Click: could not find menuItem "+e)}function k(e,t,o,n,r){const i=document.querySelectorAll(`[${D}="${e}"]`);i?N(o,i,0,e,t,n,r):console.log("Click: could not find menuItem "+e)}function j(e,t,o,n,r,i){const s=document.querySelector(`[${D}="${e}"]`),a=document.createElement("li"),l=document.createElement("a");l.setAttribute(D,t),l.textContent=o,a.appendChild(l),s.appendChild(a),function(e){I[e]=()=>{T(this)}}(t),N(null,[l],0,t,n,r,i)}function H(e){const t={x:0,y:0};return e.pageX||e.pageY?(t.x=e.pageX,t.y=e.pageY):(e.clientX||e.clientY)&&(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t}function U(e,t){var o=e.offsetWidth+4,n=e.offsetHeight+4,r=window.innerWidth,i=window.innerHeight;r-t.x<o?e.style.left=r-o+"px":e.style.left=t.x+"px",i-t.y<n?e.style.top=i-n+"px":e.style.top=t.y+"px"}function G(e,t){const o=e.querySelector("div");let n=e.querySelectorAll("label");for(let e of n)o.removeChild(e);for(let e of t){const t=document.createElement("label");t.textContent=e.name;const n=document.createElement("input");n.type="text",n.name=e.uuid,n.placeholder=e.name,t.appendChild(n),o.appendChild(t)}}function X(e){const t={};for(let o of e.elements)o.name&&o.value&&(t[o.name]=o.value);return t}function Y(e,t,o,n){q(e,o,n,t)}function q(e,t,o,n){const r=document.querySelector(e);if(r){const e={submitSuccess:!1},i=document.createElement("div");i.classList.add("overlay"),i.addEventListener("keydown",function(e){e.stopPropagation()}),i.appendChild(r),r.style.display="block",n?i.classList.add("realCenterModal"):i.classList.add("centerModal"),r.reset(),o&&o(r);const s=r.querySelectorAll("[type=submit]");for(let t of s)0=="ok".localeCompare(t.value,"en",{sensitivity:"base"})?t.addEventListener("click",function o(n){e.submitSuccess=!0,t.removeEventListener("click",o)}):0=="cancel".localeCompare(t.value,"en",{sensitivity:"base"})||console.log("submit "+t.value+" type not supported");document.body.appendChild(i),r.addEventListener("submit",function o(n){n.preventDefault(),r.style.display="none",r.removeEventListener("submit",o),document.body.appendChild(r),document.body.removeChild(i),e.submitSuccess&&t(r)})}}const W={input:void 0,ul:void 0};!function(){let e=document.createElement("style");document.head.appendChild(e),e.appendChild(document.createTextNode("")),e.sheet}();const $=[];function Z(){if(0===$.length)return!1;const e=$.pop();e.style.visibility="hidden";const t=e.parentElement;t.classList.remove("hideAfter","showBefore");const o=t.parentElement;let n=o.firstElementChild;do{n.style.visibility="inherit"}while(n=n.nextElementSibling);if($.length>0){const e=o.previousElementSibling;e&&"A"==e.tagName&&(e.style.visibility="inherit",e.parentElement.style.visibility="inherit")}return!0}function K(e){if($.length>0&&$[$.length-1]===e)Z();else{const t=e.parentElement;t.classList.add("showBefore","hideAfter");const o=t.parentElement;if($.length>0){const e=o.previousElementSibling;e&&"A"==e.tagName&&(e.style.visibility="hidden",e.parentElement.style.visibility="hidden")}let n=o.firstElementChild;do{n!==t&&(n.style.visibility="hidden")}while(n=n.nextElementSibling);$.push(e),e.style.visibility="visible"}}let J=!1,Q=!1;function ee(){if(J)for(J.style.visibility="hidden",J=!1;Z(););Q&&(J=Q,Q=!1,J.style.visibility="visible")}let te=0;function oe(){document.addEventListener("mouseup",function e(t){te?te--:(ee(),J||document.removeEventListener("mouseup",e))},!1)}function ne(e){J?ee():(te++,oe()),(J=e).style.visibility="visible"}const re=function(){let e=!1,t=[0,0],o=null;const n={mouseDown:function(n,r){e=!0,t=[(o=r).offsetLeft-n.clientX,o.offsetTop-n.clientY]},mouseUp:function(t){e=!1,o=null},mouseMove:function(n){if(n.preventDefault(),e){const e={x:n.clientX,y:n.clientY};o.style.left=e.x+t[0]+"px",o.style.top=e.y+t[1]+"px"}}};return n}();function ie(e,t){let o=document.createElement("div");o.classList.add("popup");let n=document.createRange().createContextualFragment('<span class="close">&times;</span>');n.firstElementChild.addEventListener("click",function(e){document.body.removeChild(o)}),o.appendChild(n);let r=document.createElement("h3");r.addEventListener("mousedown",e=>{re.mouseDown(e,o)}),document.addEventListener("mouseup",re.mouseUp),document.addEventListener("mousemove",re.mouseMove),r.textContent=t,o.appendChild(r);let i=document.createElement("div");return i.classList.add("wrap"),i.appendChild(e),o.appendChild(i),document.body.appendChild(o),function(e){let t=window.innerWidth,o=window.innerHeight,n=e.getBoundingClientRect();e.style.left=Math.round((t-n.width)/2)+"px",e.style.top=Math.round((o-n.height)/2)+"px"}(o),document.body.removeChild(o),o}class se{_calibrateMovement(e){let t;return t=0==e?0:e<0?-(t=Math.log(-e)/5):Math.log(e)/5}_xPercentMovement(e){let t=window.innertWidth||document.documentElement.clientWidth||document.body.clientWidth;return e.movementX/t}free(){}isDoable(){return!0}}class ae extends se{}class le extends se{isMoveable(){return!!this.moveHandler}handleMouseMove(e,t){this.moveHandler&&this.moveHandler.handleMouseMove(e,t)}doIt(){this.moveHandler&&this.moveHandler.doIt()}undo(){this.moveHandler&&this.moveHandler.undo()}}class ce extends le{constructor(e,t,o,n){super(),this.selectable={isVertex:e,isEdge:t,isFace:o},this.planeNormal=n}isVertexSelectable(){return this.selectable.isVertex}isEdgeSelectable(){return this.selectable.isEdge}isFaceSelectable(){return this.selectable.isFace}getPlaneNormal(){return this.planeNormal}}class de extends se{constructor(e){super(),this.commandName=e}doIt(e){return this.result=e[this.commandName](),!1!==this.result}undo(e){this.result.undo.call(e,this.result.snapshots)}}class ue extends se{constructor(e){super(),this.editCommands=e}doIt(){for(let e of this.editCommands)e.doIt()}undo(){for(let e=this.editCommands.length-1;e>=0;--e)this.editCommands[e].undo()}}class fe extends ae{constructor(){super(),this.saveView={origin:[0,0,0]},ge(this.saveView,pe)}handleMouseMove(e){4==e.buttons?function(e,t){const o=.05*pe.distance/(101-he.panSpeed);pe.panX+=e*o,pe.panY+=t*o}(e.movementX,0):function(e,t){pe.azimuth+=e*he.camRotationSpeed,pe.elevation+=t*he.camRotationSpeed}(e.movementX,e.movementY)}doIt(){}undo(){ge(pe,this.saveView)}}let he={cameraMode:"WingsCam",numButtons:3,camRotationSpeed:.5,panSpeed:25,panSpeedArrowKeys:50,wheelAdds:!1,whScrollInfo:!0,whPanSpeed:50,whRotationSpeed:.15,highLightZoomAim:!1,wheelZooms:!0,wheelZoomFactorAlt:5e-4,wheelZoomFactor:.005},pe=function(){let e={origin:[0,0,0],azimuth:-45,elevation:25,distance:E,panX:0,panY:0,fov:45,zNear:.1,zFar:1e3};return{alongAxis:!1,isModified:!1,inverseCameraVectors:function(){var t=mat4.create();mat4.fromTranslation(t,vec3.fromValues(-e.panX,-e.panY,e.distance)),mat4.rotateX(t,t,-e.elevation*Math.PI/180),mat4.rotateY(t,t,-e.azimuth*Math.PI/180),mat4.translate(t,t,-e.origin);var o={x:[t[0],t[1],t[2]],y:[t[4],t[5],t[6]],z:[t[8],t[9],t[10]]};return vec3.normalize(o.x,o.x),vec3.normalize(o.y,o.y),vec3.normalize(o.z,o.z),o},get origin(){return e.origin},set origin(t){e.origin[0]==t[0]&&e.origin[1]==t[1]&&e.origin[2]==t[2]||(e.origin[0]=t[0],e.origin[1]=t[1],e.origin[2]=t[2],this.isModified=!0)},get azimuth(){return e.azimuth},set azimuth(t){t!=e.azimuth&&(e.azimuth=t,this.isModified=!0)},get elevation(){return e.elevation},set elevation(t){e.elevation!=t&&(e.elevation=t,this.isModified=!0)},get distance(){return e.distance},set distance(t){e.distance!=t&&(y(I.cameraZoom,t-e.distance),e.distance=t,this.isModified=!0)},get panX(){return e.panX},set panX(t){e.panX!=t&&(e.panX=t,this.isModified=!0)},get panY(){return e.panY},set panY(t){e.panY!=t&&(e.panY=t,this.isModified=!0)},get fov(){return e.fov},set fov(t){e.fov!=t&&(e.fov=t,this.isModified=!0)},get zNear(){return e.zNear},set zNear(t){e.zNear!=t&&(camear.zNear=t,this.isModified=!0)},get zFar(){return e.zFar},set zFar(t){e.zFar!=t&&(e.zFar=t,this.isModified=!0)}}}();function ge(e,t){e.origin[0]=t.origin[0],e.origin[1]=t.origin[1],e.origin[2]=t.origin[2],e.azimuth=t.azimuth,e.elevation=t.elevation,e.distance=t.distance,e.panX=t.panX,e.panY=t.panY,e.fov=t.fov,e.zNear=t.zNear,e.zFar=t.zFar}function me(e,t){var o=Math.max(Math.abs(pe.distance),.2)*(t*e);pe.distance+=o}p(function(){});let ve={vertexShader:["attribute vec3 position;","uniform mat4 worldView;","uniform mat4 projection;","void main(void) {","   gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),fragShader:["uniform lowp vec4 uColor;","void main(void) {","   gl_FragColor = uColor;","}"].join("\n")},ye={vertexShader:["attribute vec3 aVertexPosition;","attribute vec3 aVertexColor;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","varying lowp vec4 vColor;","void main(void) {","   gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","   vColor = vec4(aVertexColor, 1.0);","}"].join("\n"),fragShader:["varying lowp vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"].join("\n")},xe={vertex:(e,t)=>`  uniform mat4 projection;\n   uniform mat4 worldView;\n   uniform vec4 faceColor[4];\n\n   // (vertex, halfEdge, face, group) index/ HalfEdge\n   attribute highp vec4 polygonIndex;\n\n   // positionTexture, centroidTexture, stateTexture, materialTexture, vertexColorTexture, \n   uniform highp sampler2D positionBuffer;\n   uniform highp sampler2D centerBuffer;\n   uniform sampler2D groupState;\n   uniform sampler2D faceState;\n   uniform sampler2D materialColor;\n   uniform sampler2D edgeVertexColor;\n   uniform sampler2D centerVertexColor;\n   uniform float positionBufferHeight;\n   uniform float centerBufferHeight;\n   uniform float faceStateHeight;\n   uniform float groupStateHeight;\n   uniform float materialColorHeight;\n   uniform float edgeVertexColorHeight;\n   uniform float centerVertexColorHeight;\n\n\n   varying vec4 color;                    // color of material * vertex \n   varying vec4 stateColor;               // selected, or hiliteColor, or just original color\n\n   ${e}\n\n   ${t}\n\n   void main() {\n      gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n      if ((polygonIndex.w < 0.0) || (polygonIndex.z < 0.0) || (polygonIndex.x < 0.0)) {  // non \n         return;\n      }\n      float gState = texture2D(groupState, index2TexCoord(polygonIndex.w, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n      if (gState < 8.0) {\n         float transparency = 1.0;\n         if (gState >= 4.0) {\n            transparency = 0.0;\n            gState -= 4.0;       // == gState & ~4;\n         }\n         vec3 polyState = texture2D(faceState, index2TexCoord(polygonIndex.z, faceStateHeight)).xyz;\n         int state = int(max(gState, polyState.x * 255.0)); // luminance === {l, l, l, 1}; l is [0-1]         \n         if (state < 4) {\n            float matIndex = materialIndex(polyState) * 3.;\n            transparency = transparency * texture2D(materialColor, index2TexCoord(matIndex+1., materialColorHeight)).z;\n            color = vec4(texture2D(materialColor, index2TexCoord(matIndex, materialColorHeight)).xyz, transparency);   // material color\n            if (state == 0) {\n               if (transparency == 0.0) { // whole triangle is transparent.\n                  return;\n               }\n               stateColor = color;       // current Material color\n            } else {\n               for (int i = 1; i < 4; i++) {\n                  if (i == state) {\n                     stateColor = faceColor[i];\n                     break;\n                  }\n               }\n               color = mix(stateColor, color, 0.5);\n            }\n            vec3 pos, vertexColor;\n            if (polygonIndex.y >= 0.0) {\n               pos = texture2D(positionBuffer, index2TexCoord(polygonIndex.x, positionBufferHeight)).xyz;\n               vertexColor = texture2D(edgeVertexColor, index2TexCoord(polygonIndex.y, edgeVertexColorHeight)).rgb;\n            } else {\n               pos = texture2D(centerBuffer, index2TexCoord(polygonIndex.x, centerBufferHeight)).xyz;\n               vertexColor = texture2D(centerVertexColor, index2TexCoord(polygonIndex.x, centerVertexColorHeight)).rgb;\n            }\n            gl_Position = projection * worldView * vec4(pos, 1.0);\n            // modulate vertexColor;\n            color = color * vec4(vertexColor, 1.0);\n         }\n      }\n   }\n`,fragment:"precision mediump float;     // stipple/screendoor shader\n   varying vec4 color;\n   varying vec4 stateColor;\n\n   void main(void) {\n      vec2 oddEven = floor( fract(gl_FragCoord.xy * 0.5) + 0.5 ); // floor( value + 0.5 ) == round( value );\n      float result = oddEven.x + oddEven.y;\n\n      if (result == 1.0) {\n         gl_FragColor = color;\n      } else {\n         gl_FragColor = stateColor;\n      }\n   }\n"},Se={vertex:e=>`//#extension OES_texture_float : enable\n      uniform mat4 projection; \n      uniform mat4 worldView;\n      // color of various state\n      uniform vec4 edgeColor[8];\n      uniform float edgeWidth[8];\n\n      // (vertex, wEdge, face, group)\n      attribute highp vec4 indexBuffer;\n\n      // position texture (x,y,z), state texture(uint8)\n      uniform highp sampler2D positionBuffer;\n      uniform sampler2D edgeState;\n      uniform sampler2D groupState;\n      uniform float positionBufferHeight;\n      uniform float edgeStateHeight;\n      uniform float groupStateHeight;\n\n      varying vec3 vBC;\n      varying float lineWidth;\n      varying vec4 color;\n\n      ${e}\n\n      void main() {\n         gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n         if ((indexBuffer.w < 0.0) || (indexBuffer.z < 0.0)) {  // no group, or no face\n            return;\n         }\n         float gState = texture2D(groupState, index2TexCoord(indexBuffer.w, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n         if (gState < 8.0) {\n            vBC = vec3(1.0, 0.0, 1.0);\n            float indexBufferY = indexBuffer.y;\n            if (indexBufferY < 0.0) {\n               vBC.y = 1.0;\n               indexBufferY = (-indexBufferY) - 1.0;     // convert to positive\n            }\n            int state = int(texture2D(edgeState, index2TexCoord(indexBufferY, edgeStateHeight)).x * 255.0); // luminance === {l, l, l, 1}; l is [0-1]\n            for (int i = 0; i < 8; i++) {\n               if (i == state) {\n                  color = edgeColor[i];\n                  lineWidth = edgeWidth[i];\n                  break;\n               }\n            }\n            vec3 pos = texture2D(positionBuffer, index2TexCoord(indexBuffer.x, positionBufferHeight)).xyz;\n         \n            gl_Position = projection * worldView * vec4(pos, 1.0);\n         }\n      }\n   `,fragment:"#extension GL_OES_standard_derivatives : enable\n      precision mediump float;\n      varying vec3 vBC;\n      varying float lineWidth;\n      varying vec4 color;\n\n      float edgeFactor() {\n         vec3 d = fwidth(vBC);\n         vec3 a3 = smoothstep(vec3(0.0), d*lineWidth, vBC);\n         return min(min(a3.x, a3.y), a3.z);\n      }\n\n      void main() {\n         // coloring by edge\n         float edge = edgeFactor();\n         if (edge < 1.0) {\n            gl_FragColor = vec4(color.rgb, (1.0-edge)*0.95);\n         } else {\n            discard;\n         }\n      }\n   "},be={vertex:e=>`uniform mat4 worldView;\n      uniform mat4 projection;\n\n      uniform vec4 vertexColor[8];\n      uniform float sizeOfVertex[8];\n\n      // draw point array;\n      attribute highp vec3 vertexIndex;                 // (vIndex, state, group)\n\n      // attribute texture\n      uniform highp sampler2D positionBuffer;\n      uniform sampler2D groupState;\n      uniform float positionBufferHeight;\n      uniform float groupStateHeight;\n\n      // output\n      varying vec4 color;\n\n      ${e}\n\n      void main(void) {\n         gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n         if (vertexIndex.z < 0.0) {\n            return;\n         }\n         float gState = texture2D(groupState, index2TexCoord(vertexIndex.z, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n         if ((gState < 8.0) && (vertexIndex.y < 128.0)) {\n            vec3 pos = texture2D(positionBuffer, index2TexCoord(vertexIndex.x, positionBufferHeight)).xyz;\n            gl_Position = projection * worldView * vec4(pos, 1.0);\n\n            int vState = int(vertexIndex.y);\n            for (int i = 0; i < 8; ++i) {\n               if (i == vState) {\n                  color = vertexColor[i];\n                  gl_PointSize = sizeOfVertex[i];\n                  break;\n               }\n            }\n         }\n      }\n   `,fragment:"precision lowp float;\n      varying vec4 color;\n\n      void main(void) {\n         gl_FragColor = color;\n      }\n   "},Ee=(["attribute vec4 aVertexPosition;","attribute vec2 aTexCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","varying vec2 v_texcoord;","void main() {","gl_Position =  uPMatrix * uMVMatrix * aVertexPosition;","v_texcoord = aTexCoord;","}"].join("\n"),["precision mediump float;","varying vec2 v_texcoord;","uniform sampler2D u_texture;","void main() {","gl_FragColor = texture2D(u_texture, v_texcoord);","}"].join("\n"),{vertex:["attribute vec3 position;","uniform vec3 faceColor;","uniform mat4 worldView;","uniform mat4 projection;","varying vec3 vPosition;","varying vec3 vLight;","varying vec3 vColor;","void main(void) {","   gl_Position = projection * worldView * vec4(position, 1.0);","   vPosition =  (worldView * vec4(position, 1.0)).xyz;","   vColor = faceColor;","   vLight = vec3(0.0, 0.0, -1.0);","}"].join("\n"),fragment:["#extension GL_OES_standard_derivatives : enable","precision mediump float;\n","varying vec3 vPosition;","varying vec3 vLight;","varying vec3 vColor;","void main() {","  vec3 n = normalize(cross(dFdy(vPosition), dFdx(vPosition)));","  float diffuseFactor = dot(normalize(n), vLight);","  if (diffuseFactor > 0.0) {","    gl_FragColor = vec4(vColor * diffuseFactor, 1.0);","  } else {","    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","  }","}"].join("\n")}),we={vertex:["attribute vec3 position;","uniform mat4 worldView;","uniform mat4 projection;","void main(void) {","  gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),fragment:["precision mediump float;","uniform vec4 faceColor;","void main(void) {","  gl_FragColor = faceColor;","}"].join("\n")},Ce={vertex:["attribute vec3 position;","uniform mat4 worldView;","uniform mat4 projection;","void main() {","  gl_Position = projection * worldView * vec4(position, 1.0);","  gl_PointSize = 8.8;","}"].join("\n"),fragment:["precision lowp float;","uniform vec4 uColor;","void main() {","float distance = distance( gl_PointCoord, vec2(0.5,0.5) );","if ( distance >= 0.5 ) {","discard;","}","gl_FragColor = uColor;","}"].join("\n")},Fe={vertex:e=>`//#extension OES_texture_float : enable\n      uniform mat4 projection; \n      uniform mat4 worldView;\n      // color of various state\n      uniform vec4 edgeColor[8];\n\n      // (vertex, wEdge, face, group)\n      attribute highp vec4 indexBuffer;\n\n      // position texture (x,y,z), state texture(uint8)\n      uniform highp sampler2D positionBuffer;\n      uniform sampler2D groupState;\n      uniform float positionBufferHeight;\n      uniform float groupStateHeight;\n\n      varying vec3 vBC;\n      varying vec4 color;\n\n      ${e}\n\n      void main() {\n         gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n         if ((indexBuffer.w < 0.0) || (indexBuffer.z < 0.0)) {  // no group, or no face\n            return;\n         }\n\n         float gState = texture2D(groupState, index2TexCoord(indexBuffer.w, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n         if (gState < 8.0) {\n            vBC = vec3(1.0, 0.0, 1.0);\n            if (indexBuffer.y < 0.0) {\n               vBC.y = 1.0;\n            }\n            color = edgeColor[0];                        // unselected color\n \n            vec3 pos = texture2D(positionBuffer, index2TexCoord(indexBuffer.x, positionBufferHeight)).xyz;\n            gl_Position = projection * worldView * vec4(pos, 1.0);\n         }\n      }\n   `,fragment:"#extension GL_OES_standard_derivatives : enable\n      precision mediump float;\n      varying vec3 vBC;\n      varying vec4 color;\n\n      float edgeFactor() {\n         vec3 d = fwidth(vBC);\n         vec3 a3 = smoothstep(vec3(0.0), d, vBC);\n         return min(min(a3.x, a3.y), a3.z);\n      }\n\n      void main() {\n         // coloring by edge\n         float edge = edgeFactor();\n         if (edge < 1.0) {\n            gl_FragColor = vec4(color.rgb, (1.0-edge)*0.95);\n         } else {\n            discard;\n         }\n      }\n   "};p(function(){const e=`vec2 index2TexCoord(float index, float height) {\n         return vec2( mod(index, float(${n.textureSize})) / float(${n.textureSize}), (index/float(${n.textureSize})) / height);\n      }\n   `;Ee=n.createShaderProgram(Ee.vertex,Ee.fragment),we=n.createShaderProgram(we.vertex,we.fragment),Ce=n.createShaderProgram(Ce.vertex,Ce.fragment),Fe=n.createShaderProgram(Fe.vertex(e),Fe.fragment),Se=n.createShaderProgram(Se.vertex(e),Se.fragment),be=n.createShaderProgram(be.vertex(e),be.fragment),xe=n.createShaderProgram(xe.vertex(e,"float materialIndex(vec3 v) {\n         return dot(v, vec3(0., 255., 255.*255.));\n      }\n     "),xe.fragment)});const Ae=1e-6;function _e(e,t){var o=vec3.create(),n=vec3.create();vec3.sub(o,t[1],t[0]),vec3.sub(n,t[2],t[0]);var r=vec3.create();vec3.cross(r,e.direction,n);var i=vec3.dot(o,r);if(i<Ae)return 0;var s=1/i,a=vec3.create();vec3.sub(a,e.origin,t[0]);var l=vec3.dot(a,r)*s;if(l<0||l>1)return 0;var c=vec3.create();vec3.cross(c,a,o);var d=vec3.dot(e.direction,c)*s;return d<0||l+d>1?0:vec3.dot(n,c)*s}const Me=function(){const e=vec3.create();return function(t,o){vec3.sub(e,o.center,t.origin);const n=vec3.dot(e,e),r=vec3.dot(e,t.direction);return!(r<0&&n>o.radius2)&&!(n-r*r>o.radius2)}}(),Ve=function(){const e=vec3.create();return function(t,o){return Te(e,o.center,t),vec3.squaredDistance(e,o.center)<o.radius2}}();function Le(e,t,o){const n=o.origin,r=o.destination();let i,s=vec3.dot(t.normal,n)-t.distance,a=vec3.dot(t.normal,r)-t.distance;if(Math.abs(s)<Ae&&(s=0),Math.abs(a)<Ae&&(a=0),s*a>0)return-2;if(0==s){if(0==a)return-1;i=0}else 0==a&&(i=1);if(e){if(void 0===i){vec3.sub(e,t.pt,n);const o=vec3.dot(t.normal,e);vec3.sub(e,r,n),i=o/vec3.dot(t.normal,e)}vec3.scaleAndAdd(e,n,e,i)}return void 0!==i?i:.5}function Pe(e,t,o){let n=function(e,t,o,n){let r=vec3.create(),i=vec3.create();vec3.sub(r,t,o),vec3.sub(i,n,o),vec3.cross(e,r,i);let s=Math.atan2(vec3.length(e),vec3.dot(r,i));return vec3.normalize(e,e),s}(e,t.destination(),t.origin,o.destination());((n=Math.abs(n))<Ae||n>Math.PI-Ae)&&(vec3.set(e,0,0,0),t.face&&vec3.add(e,e,t.face.normal),o.pair.face&&vec3.add(e,e,o.pair.face)),vec3.normalize(e,e)}function Be(e,t,o){const n=vec3.create();for(let r of e){vec3.sub(n,r,o);let e=vec3.dot(n,t);vec3.scale(n,t,e),vec3.sub(r,r,n)}}function Te(e,t,o){const n=vec3.dot(o.normal,t)-o.distance;vec3.scaleAndAdd(e,t,o.normal,-n)}function Ie(e){return[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255]}function Oe(e){return[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255,1]}function ze(e){return e=Math.min(Math.max(e,0),1),Math.round(255*e).toString(16).padStart(2,"0")}function De(e,t,o){return`#${e=ze(e)}${t=ze(t)}${o=ze(o)}`}function Ne(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}const Re=function(e,t=0){this.buffer=e,this.offset=t};Re.prototype.init=function(e,t=0){return this.buffer=e,this.offset=t,this},Re.prototype.reset=function(){return this.offset=0,this},Re.uint8resize=function(e){const t=new Uint8Array(1.5*e.length);return t.set(e),t},Re.prototype.alloc=function(e){return this.offset>=this.buffer.length&&(this.buffer=e(this.buffer)),this.buffer},Re.prototype.inc=function(){return this.offset+=3,this},Re.prototype.dec=function(){return this.offset-=3,this},Re.prototype.set=function(e){return this.buffer[this.offset]=e[0],this.buffer[this.offset+1]=e[1],this.buffer[this.offset+2]=e[2],this},Object.defineProperties(Re.prototype,{0:{get:function(){return this.buffer[this.offset]},set:function(e){return this.buffer[this.offset]=e,e}},1:{get:function(){return this.buffer[this.offset+1]},set:function(e){return this.buffer[this.offset+1]=e,e}},2:{get:function(){return this.buffer[this.offset+2]},set:function(e){return this.buffer[this.offset+2]=e,e}},length:{get:function(){return 3},set:function(e){}}});const ke=function(e,t=0){this.buffer=e,this.offset=t};let je,He,Ue;function Ge(e,t,o,n,r,i){(function(e,t){for(var o,n=0,r=1,i=[e[3]+e[0],e[3]-e[0],e[3]+e[1],e[3]-e[1],e[3]+e[2],e[3]-e[2]],s=[t[3]+t[0],t[3]-t[0],t[3]+t[1],t[3]-t[1],t[3]+t[2],t[3]-t[2]],a={pt0:0,pt1:0},l=0;l<6;++l){var c=(i[l]<0)<<l;a.pt0|=c,a.pt1|=(s[l]<0)<<l}if(0!=(a.pt0&a.pt1))return!1;if(0==(a.pt0|a.pt1))return!0;for(l=0;l<6;l++)if(s[l]<0?(o=i[l]/(i[l]-s[l]),r=Math.min(r,o)):i[l]<0&&(o=i[l]/(i[l]-s[l]),n=Math.max(n,o)),n>r)return!1;if(c=vec4.create(),0!=a.pt0)for(l=0;l<4;++l)c[l]=e[l]+n*(t[l]-e[l]);if(0!=a.pt1)for(l=0;l<4;++l)t[l]=e[l]+r*(t[l]-e[l]);return e=c,!0})(t,o)&&function(e,t,o,n){Ue.font="18px Arial",Ue.fillStyle=o,Ue.fillText(n,e,t)}(Math.trunc((.5*o[0]/o[3]+.5)*(i[2]-20)+10),i[3]-Math.trunc((.5*o[1]/o[3]+.5)*(i[3]-16)+7),r,n)}function Xe(e,t,o){var r,i,s=function(e,t){var o=n.canvas.clientWidth,r=n.canvas.clientHeight,i=Math.max(o,r),s=n.unProject(i,0,0,t,e,[0,0,o,r]),a=b*Math.max(Math.round(Math.max(Math.max(Math.abs(s[0]),Math.abs(s[1])),Math.abs(s[2]))),10);return a*=o/r*.7,Math.round(a)}(t,o),a=function(e,t){for(var o=[],n=e;n>0;n-=t)o=o.concat([n,0,e],[n,0,-e],[-n,0,e],[-n,0,-e],[e,0,n],[-e,0,n],[e,0,-n],[-e,0,-n]);return o.concat([0,0,e],[0,0,-e],[e,0,0],[-e,0,0])}(s,b);return je.groundGridVBO={position:e.createBufferHandle(new Float32Array(a)),length:a.length/3},He.axisVBO={position:e.createBufferHandle((r=pe.zFar,i=[[r,0,0],[0,0,0],[0,0,0],[-r,0,0],[0,r,0],[0,0,0],[0,0,0],[0,-r,0],[0,0,r],[0,0,0],[0,0,0],[0,0,-r]],new Float32Array([].concat.apply([],i)))),color:e.createBufferHandle(Ye()),length:12},s}function Ye(){const e=[Ie(_n.colorX),Ie(_n.colorY),Ie(_n.colorZ)],t=[Ie(_n.negColorX),Ie(_n.negColorY),Ie(_n.negColorZ)];for(var o=[],n=0;n<3;n++)o=o.concat(e[n],e[n],t[n],t[n]);return new Float32Array(o)}ke.prototype.inc=function(){return this.offset+=4,this},ke.prototype.dec=function(){return this.offset-=4,this},ke.prototype.set=function(e){return this.buffer[this.offset]=e[0],this.buffer[this.offset+1]=e[1],this.buffer[this.offset+2]=e[2],this.buffer[this.offset+3]=e[3],this},Object.defineProperties(ke.prototype,{0:{get:function(){return this.buffer[this.offset]},set:function(e){return this.buffer[this.offset]=e,e}},1:{get:function(){return this.buffer[this.offset+1]},set:function(e){return this.buffer[this.offset+1]=e,e}},2:{get:function(){return this.buffer[this.offset+2]},set:function(e){return this.buffer[this.offset+2]=e,e}},3:{get:function(){return this.buffer[this.offset+3]},set:function(e){return this.buffer[this.offset+3]=e,e}},length:{get:function(){return 4},set:function(e){}}}),p(function(){qe=!0,n.enable(n.DEPTH_TEST),n.enable(n.CULL_FACE),je=n.createShaderProgram(ve.vertexShader,ve.fragShader),(He={handle:n.compileGLSL(ye.vertexShader,ye.fragShader)}).vertexPosition=n.getAttribLocation(He.handle,"aVertexPosition"),He.vertexColor=n.getAttribLocation(He.handle,"aVertexColor"),He.uPMatrix=n.getUniformLocation(He.handle,"uPMatrix"),He.uMVMatrix=n.getUniformLocation(He.handle,"uMVMatrix");var e=Ar(!0);Xe(n,e.projection,e.modelView);!function(e,t){for(var o=[].concat([0,0,0],[.1,0,0],[0,0,0],[0,.1,0],[0,0,0],[0,0,.1],[.08,0,-.01],[.1,0,0],[.08,0,.01],[.1,0,0],[-.01,.08,0],[0,.1,0],[.01,.08,0],[0,.1,0],[-.01,0,.08],[0,0,.1],[.01,0,.08],[0,0,.1]),n=[Ie(_n.colorX),Ie(_n.colorY),Ie(_n.colorZ)],r=[],i=[],s=0;s<3;++s)r=r.concat(n[s],n[s]),i=i.concat(n[s],n[s],n[s],n[s]);r=r.concat(i),He.miniAxisVBO={position:e.createBufferHandle(new Float32Array(o)),color:e.createBufferHandle(new Float32Array(r)),length:18};var a=e.canvas.clientWidth/e.canvas.clientHeight,l=mat4.clone(t);l[12]=.11-a,l[13]=-.89,l[14]=0,He.miniAxisVBO.modelView=l,He.miniAxisVBO.projection=mat4.create(),mat4.ortho(He.miniAxisVBO.projection,-a,a,-1,1,1e-5,1e7)}(n,e.modelView);const t=document.getElementById("text");Ue=t.getContext("2d")});let qe=!1;function We(){qe=!0}function $e(e,t){if(n.resizeToDisplaySize()&&(Ue.canvas.width=Ue.canvas.clientWidth,Ue.canvas.height=Ue.canvas.clientHeight,1)||pe.isModified||qe){Ue.clearRect(0,0,Ue.canvas.width,Ue.canvas.height),qe=!1;const n=Oe(_n.geometryBackground);e.clearColor(n[0],n[1],n[2],n[3]),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.polygonOffset(0,0),e.enable(e.POLYGON_OFFSET_FILL);var o=Ar(!0);pe.isModified&&(pe.isModified=!1,Xe(e,o.projection,o.modelView));var r=function(e,t,o){const n=An.showAxes;if(An.showGroundplane){pe.alongAxis;const i=Oe(_n.gridColor);var r=je.groundGridVBO.length;n&&(r-=4),e.useProgram(je.progHandle),e.setBufferAndAttrib(je.groundGridVBO.position,je.attribute.position.loc),e.uniform4fv(je.uniform.uColor.loc,i),e.uniformMatrix4fv(je.transform.projection,!1,t),e.uniformMatrix4fv(je.transform.worldView,!1,o),e.drawArrays(e.LINES,0,r)}var i;return i=pe.zFar,n&&(e.useProgram(He.handle),e.uniformMatrix4fv(He.uPMatrix,!1,t),e.uniformMatrix4fv(He.uMVMatrix,!1,o),e.setBufferAndAttrib(He.axisVBO.position,He.vertexPosition),e.setBufferAndAttrib(He.axisVBO.color,He.vertexColor),e.drawArrays(e.LINES,0,He.axisVBO.length)),i}(e,o.projection,o.modelView);!function(e,t){if(An.showMiniAxis){var o=e.canvas.clientWidth/e.canvas.clientHeight,n=He.miniAxisVBO.modelView;mat4.copy(n,t),n[12]=.11-o,n[13]=-.89,n[14]=0,mat4.ortho(He.miniAxisVBO.projection,-o,o,-1,1,1e-5,1e7);var r=He.miniAxisVBO.length;e.useProgram(He.handle),e.uniformMatrix4fv(He.uPMatrix,!1,He.miniAxisVBO.projection),e.uniformMatrix4fv(He.uMVMatrix,!1,He.miniAxisVBO.modelView),e.setBufferAndAttrib(He.miniAxisVBO.position,He.vertexPosition),e.setBufferAndAttrib(He.miniAxisVBO.color,He.vertexColor),e.drawArrays(e.LINES,0,r)}}(e,o.modelView),t(e),function(e,t){if(An.showAxes){var o=e.getViewport(),n=vec4.fromValues(0,0,0,1),r=e.transformVertex(n);t+=b,Ie(_n.colorX),Ie(_n.colorY),Ie(_n.colorZ);var i=e.transformVertex(vec4.fromValues(t,0,0,1)),s=e.transformVertex(vec4.fromValues(0,t,0,1)),a=e.transformVertex(vec4.fromValues(0,0,t,1));Ge(0,r,i,"x",_n.colorX,o),Ge(0,r,s,"y",_n.colorY,o),Ge(0,r,a,"z",_n.colorZ,o)}}(e,r)}}const Ze=function(){this.cntrOffset=Ze.center.alloc(),this.radius=0,this.radius2=0,this.octree=null};Ze.center=null,Object.defineProperties(Ze.prototype,{0:{get:function(){return Ze.center.buffer[this.cntrOffset]},set:function(e){Ze.center.set(this.cntrOffset,e)}},1:{get:function(){return Ze.center.buffer[this.cntrOffset+1]},set:function(e){Ze.center.set(this.cntrOffset+1,e)}},2:{get:function(){return Ze.center.buffer[this.cntrOffset+2]},set:function(e){Ze.center.set(this.cntrOffset+2,e)}},3:{get:function(){return this.radius},set:function(e){return this.radius=e,this.radius=e*e,e}},center:{get:function(){return this},set:function(e){Ze.center.set(this.cntrOffset,e[0]),Ze.center.set(this.cntrOffset+1,e[1]),Ze.center.set(this.cntrOffset+2,e[2])}}}),Ze.prototype.isIntersect=function(e){return Me(e,this)},Ze.prototype.setSphere=function(e){Ze.center.set(this.cntrOffset,e.center[0]),Ze.center.set(this.cntrOffset+1,e.center[1]),Ze.center.set(this.cntrOffset+2,e.center[2]),this.radius=e.radius,this.radius2=e.radius*e.radius,this.octree&&this.octree._move(this)},Ze.prototype.getBVHRoot=function(){return this.octree.bvh.bvh.root},Ze.computeSphere=function(e,t){t[0]=t[1]=t[2]=0;var o={center:t,radius:0};return e.eachVertex(function(e){vec3.add(o.center,o.center,e)}),vec3.scale(o.center,o.center,1/e.numberOfVertex),e.eachVertex(function(e){var t=vec3.distance(o.center,e);t>o.radius&&(o.radius=t)}),o},Ze.prototype.getCentroid=function(e){const t=this.cntrOffset;return e[0]=Ze.center.buffer[t],e[1]=Ze.center.buffer[t+1],e[2]=Ze.center.buffer[t+2],e};class Ke{constructor(e,t,o){this.bvh=e,this.level=o,this.node=[],t&&(this.bound={center:vec3.clone(t.center),halfSize:vec3.clone(t.halfSize)})}*[Symbol.iterator](){if(yield this,this.leaf)for(let e=0;e<8;++e){const t=this.leaf[e];t&&(yield*t)}}getHalfSize(){return this.bound.halfSize}getBound(e){vec3.copy(e.center,this.bound.center),vec3.copy(e.halfSize,this.bound.halfSize)}getLooseBound(e){vec3.copy(e.center,this.bound.center),vec3.scale(e.halfSize,this.bound.halfSize,Ke.kLOOSENESS)}getExtent(e,t=1){for(let o=0;o<3;++o){const n=this.bound.halfSize[o]*t;e.min[o]=this.bound.center[o]-n,e.max[o]=this.bound.center[o]+n}}getLooseExtent(e){this.getExtent(e,Ke.kLOOSENESS)}static getOctant(e,t){let o=0;const n=[1,2,4];for(let r=0;r<3;++r){if(t.halfSize[r]/=2,e.radius>t.halfSize[r])return-1;e.center[r]<t.center[r]?(o+=n[r],t.center[r]-=t.halfSize[r]):t.center[r]+=t.halfSize[r]}return o}check(e){if(this.node)for(let t of this.node)e.has(t)?console.log("octree problems"):e.add(t);else{for(let t=0;t<8;++t){const o=this.leaf[t];o&&o.check(e)}for(let t=8;t<this.leaf.length;++t){const o=this.leaf[t];e.has(o)?console.log("octree problems"):e.add(o)}}}free(){if(this.node)for(let e of this.node)e.octree=null;else{for(let e=0;e<8;++e){const t=this.leaf[e];t&&t.free()}for(let e=8;e<this.leaf.length;++e){this.leaf[e].octree=null}}}insert(e,t){if(this.node){if(this.node.push(e),e.octree=this,this.node.length>=Ke.kTHRESHOLD){this.leaf=[null,null,null,null,null,null,null,null];let e,o={center:vec3.create(),halfSize:vec3.create()};const n=this.node;delete this.node;for(let r of n)vec3.copy(o.center,t.center),vec3.copy(o.halfSize,t.halfSize),e=this.insert(r,o);return e}}else{let o=Ke.getOctant(e,t);if(o>=0){let n=this.leaf[o];return null===n&&(n=new Ke(this.bvh,t,this.level+1),this.leaf[o]=n),n.insert(e,t)}this.leaf.push(e),e.octree=this}return this}_move(e){this.isInside(e)||(this._remove(e),this.bvh.moveSphere(e))}_remove(e){e.octree===this?(this.node?this.node.splice(this.node.indexOf(e),1):this.leaf.splice(this.leaf.indexOf(e),1),e.octree=null):console.log("LooseOctree _remove error")}isInside(e){for(let t=0;t<3;++t){let o=this.bound.halfSize[t];if(o<e.radius||this.bound.center[t]+o<e.center[t]||this.bound.center[t]-o>e.center[t])return!1}return!0}*intersectExtent(e){const t={min:vec3.create(),max:vec3.create()};this.getLooseExtent(t),e.intersectAAExtent(t)&&(yield*this._extentIntersect(e,t))}*_extentIntersect(e,t){if(this.node)for(let t of this.node)e.intersectSphere(t)&&(yield t);else{for(let t=8;t<this.leaf.length;++t){const o=this.leaf[t];e.intersectSphere(o)&&(yield o)}for(let o=0;o<8;++o){const n=this.leaf[o];n&&(n.getLooseExtent(t),e.intersectAAExtent(t)&&(yield*n._extentIntersect(e,t)))}}}*intersectBound(e){const t={center:vec3.create(),halfSize:vec3.create()};this.getLooseBound(t),e.intersectAABB(t)&&(yield*this._boundIntersect(e,t))}*_boundIntersect(e,t){if(this.node)for(let t of this.node)e.intersectSphere(t)&&(yield t);else{for(let t=8;t<this.leaf.length;++t){const o=this.leaf[t];e.intersectSphere(o)&&(yield o)}for(let o=0;o<8;++o){const n=this.leaf[o];n&&(n.getLooseBound(t),e.intersectAABB(t)&&(yield*n._boundIntersect(e,t)))}}}}Ke.kTHRESHOLD=88,Ke.kLOOSENESS=1.5;class Je{constructor(e,t){this.normal=vec3.clone(e),vec3.normalize(this.normal,this.normal),this.pt=vec3.clone(t),this.distance=vec3.dot(this.normal,this.pt)}closestPoint(e,t){Te(e,t,this)}intersectAABB(e){return function(e,t){const o=t.halfSize[0]*Math.abs(e.normal[0])+t.halfSize[1]*Math.abs(e.normal[1])+t.halfSize[2]*Math.abs(e.normal[2]),n=vec3.dot(e.normal,t.center)-e.distance;return Math.abs(n)<=o}(this,e)}intersectSphere(e){return Ve(this,e)}}class Qe{constructor(e,t){this.origin=e,this.direction=t,this.invDir=vec3.fromValues(1/t[0],1/t[1],1/t[2])}intersectSphere(e){return Me(this,e)}intersectAAExtent(e){return function(e,t){let o=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY;for(let r=0;r<3;++r){let i=(t.min[r]-e.origin[r])*e.invDir[r],s=(t.max[r]-e.origin[r])*e.invDir[r];if(e.invDir[r]<0){let e=i;i=s,s=e}if((n=s<n?s:n)<=(o=i>o?i:o))return!1}return n>0}(this,e)}}const et={baseColor:Ie("#C9CFB1"),roughness:.8,metallic:.1,emission:Ie("#000000"),opacity:1},tt=function(e){this.name=e,this.uuid=Ne(),this.isAltered=!1,this.usageCount=0,this.guiStatus={},this.pbr=Object.assign({},et),this.index=tt.color.alloc()/9,this.setGPU()};tt.color=null;const ot=[],nt=[];tt.create=function(e,t){let o;return nt.lenth>0?((o=nt.pop()).name=e,o.setValues(et)):(o=new tt(e),ot.push(o)),t&&o.setValues(t),o},tt.release=function(e){return 0===e.usageCunt&&(nt.push(e),!0)},tt.prototype.setGPU=function(){const e=9*this.index;tt.color.set(e,this.pbr.baseColor[0]),tt.color.set(e+1,this.pbr.baseColor[1]),tt.color.set(e+2,this.pbr.baseColor[2]),tt.color.set(e+3,this.pbr.roughness),tt.color.set(e+4,this.pbr.metallic),tt.color.set(e+5,this.pbr.opacity),tt.color.set(e+6,this.pbr.emission[0]),tt.color.set(e+7,this.pbr.emission[1]),tt.color.set(e+8,this.pbr.emission[2])},tt.prototype.setValues=function(e){for(const t of Object.keys(e))this.pbr.hasOwnProperty(t)?isNaN(e[t])&&!Array.isArray(e[t])?this.pbr[t]=Ie(e[t]):this.pbr[t]=e[t]:console.log("unknown input material: "+t);this.setGPU()},tt.prototype.assigned=function(){++this.usageCount,this.updateGUI(),this.isAltered=!0},tt.prototype.unassigned=function(){--this.usageCount,this.updateGUI(),this.isAltered=!0},tt.prototype.updateGUI=function(){this.guiStatus.count&&(this.guiStatus.count.textContent=this.usageCount),this.menu&&this.menu.color&&(this.menu.color.style.backgroundColor=De(...this.pbr.baseColor)),this.pict&&(this.pict.style.backgroundColor=De(...this.pbr.baseColor))},tt.luminance=function(e){return.2125*e[0]+.7154*e[1]+.0721*rbg[2]},tt.convertTraditionalToMetallicRoughness=function(e){const t=luminance(e.specularMaterial);let o=1-e.shininessMaterial;return t<.1&&(o*=1-t),{baseColor:e.diffuseMaterial,metal:0,roughness:o,emission:e.emissionMaterial,opacity:e.opacityMaterial}};const rt=function(e,t,o){rt.state.alloc(),rt.index.alloc(),this.index=o,this.left=new it(this),this.right=new it(this),this.left.pair=this.right,this.left.next=this.right,this.right.pair=this.left,this.right.next=this.left,this.left.origin=e,this.right.origin=t,this.left.setVertexColor(it.WHITE),this.right.setVertexColor(it.WHITE);const n=2*this.index*4,r=2*this.index;it.index.set(n+1,r),it.index.set(n+5,r+1),it.triangleList.set(3*r,r),it.triangleList.set(3*(r+1),r+1)};rt.index=null,rt.state=null,rt.prototype[Symbol.iterator]=function*(){yield this.left,yield this.right},rt.prototype.isHard=function(){return 1&rt.state.buffer[this.index]},rt.prototype.setHardness=function(e){return e<2?this.setEdgeMask(e,1):this.isHard()?this.setHardness(!1,1):this.setHardness(!0,1)},rt.prototype.selectEdge=function(e){this.setEdgeMask(e,2)},rt.prototype.setEdgeMask=function(e,t){const o=this.index,n=rt.state.buffer[o];return e?rt.state.set(o,n|t):rt.state.set(o,n&~t)},rt.prototype.setGroup=function(e){let t=24*this.index+3;for(let o=0;o<6;o++,t+=4)rt.index.set(t,e);t=2*this.index*4,it.index.set(t+3,e),it.index.set(t+7,e)},rt.prototype.getIndex=function(e){return 2*this.index+(e===this.left?0:1)},rt.prototype.updateIndex=function(e){const t=rt.index.buffer;let o=24*this.index;this.right===e&&(o+=12),o<rt.index.alteredMin&&(rt.index.alteredMin=o);const n=e.face?e.face.index:-1;t[o++]=e.origin?e.origin.index:-1,t[o++]=this.index,t[o++]=n,o++,t[o++]=e.destination()?e.destination().index:-1,t[o++]=this.index,t[o++]=n,o++,t[o++]=e.next?e.next.destination().index:-1,t[o++]=-this.index-1,t[o]=n,o>rt.index.alteredMax&&(rt.index.alteredMax=o)},rt.prototype.isLive=function(){return null!==this.left.origin&&null!==this.right.origin},rt.prototype.adjacent=function*(){let e=this.left.next.wingedEdge;yield e;let t=this.left.prev().wingedEdge;t!==e&&(yield t),e=this.right.next.wingedEdge,yield e,(t=this.right.prev().wingedEdge)!==e&&(yield t)},rt.prototype.oneRing=function*(){for(let e of this){let t=e.next;e=e.pair;do{yield t.wingedEdge,t=t.pair.next}while(t!==e)}},rt.prototype.eachVertex=function*(){yield this.left.origin,yield this.right.origin},rt.prototype.wing=function*(){yield this.left.prev(),yield this.left,yield this.left.next,yield this.right.prev(),yield this.right,yield this.right.next},rt.prototype.getNormal=function(e){this.left.face&&vec3.add(e,e,this.left.face.normal),this.right.face&&vec3.add(e,e,this.right.face.normal),vec3.normalize(e,e)};const it=function(e){it.index.alloc(),it.triangleList.alloc(),it.color.alloc(),this.wingedEdge=e,this._next=null,this._origin=null,this._face=null,this.pair=null};it.index=null,it.normal=null,it.color=null,it.WHITE=[255,255,255],it.triangleList=null,Object.defineProperties(it.prototype,{origin:{get:function(){return this._origin},set:function(e){if(this._origin!==e){this._origin=e;let t=4*this.wingedEdge.getIndex(this);const o=e?e.index:-1;it.index.set(t,o)}}},face:{get:function(){return this._face},set:function(e){if(this._face!==e){this._face=e;const t=4*this.wingedEdge.getIndex(this),o=this.getIndex();e?(it.index.set(t+2,e.index),it.triangleList.set(3*o+2,-e.index-1)):(it.index.set(t+2,-1),it.triangleList.set(3*o+2,o))}}},next:{get:function(){return this._next},set:function(e){if(this._next!==e){this._next=e;const t=this.getIndex();let o=t;e&&(o=e.getIndex()),it.triangleList.set(3*t+1,o)}}}}),it.prototype.updateIndex=function(){this.wingedEdge.updateIndex(this)},it.prototype.getIndex=function(){return this.wingedEdge.getIndex(this)},it.prototype.setHilite=function(e){this.wingedEdge.setEdgeMask(e,4)},it.prototype.getVertexColor=function(e){let t=3*this.getIndex();e[0]=it.color.get(t++),e[1]=it.color.get(t++),e[2]=it.color.get(t)},it.prototype.setVertexColor=function(e){let t=3*this.getIndex();it.color.set(t++,e[0]),it.color.set(t++,e[1]),it.color.set(t,e[2])},it.prototype.isBoundary=function(){return null===this.face},it.prototype.isNotBoundary=function(){return null!==this.face},it.prototype.destination=function(){return this.pair.origin},it.prototype.prevAux=function(){if(null!==this.face){let e=this;for(;e.next!==this;)e=e.next;return e}return null},it.prototype.prev=function(){if(this.pair.next===this)return this.pair;var e=this,t=this.origin.findInEdge(function(t,o){return t.next===e});return null===t&&console.log("HalfEdge.prev: link list is broken, cannot find prev"),t},it.prototype.eachEdge=function(e){var t=this;if(t)do{e(t),t=t.pair.next}while(t&&t!==this)};const st=function(e){st.index.alloc();let t=st.position.alloc();this.outEdge=null,this.posOffset=t,this._index=e;const o=t;st.index.set(o,o/3)};st.index=null,st.position=null,Object.defineProperty(st.prototype,"index",{get:function(){return this.posOffset/3}}),Object.defineProperties(st.prototype,{0:{get:function(){return st.position.buffer[this.posOffset]},set:function(e){st.position.set(this.posOffset,e)}},1:{get:function(){return st.position.buffer[this.posOffset+1]},set:function(e){st.position.set(this.posOffset+1,e)}},2:{get:function(){return st.position.buffer[this.posOffset+2]},set:function(e){st.position.set(this.posOffset+2,e)}},length:{get:function(){return 3},set:function(e){}}}),st.prototype.set=function(e){st.position.set(this.posOffset,e[0]),st.position.set(this.posOffset+1,e[1]),st.position.set(this.posOffset+2,e[2])},Object.defineProperty(st.prototype,"valence",{get:function(){let e=0,t=this.outEdge,o=t;if(o)do{++e,o=o.pair.next}while(o&&o!==t);return e}}),st.prototype.hide=function(){this.setMask(!1,128)},st.prototype.show=function(){this.setMask(!0,128)},st.prototype.resetState=function(){const e=this.posOffset+1,t=parseInt(st.index.buffer[e]);st.index.set(e,128&t)},st.prototype.setHilite=function(e){this.setState(e,4)},st.prototype.setSelect=function(e){this.setState(e,1)},st.prototype.setMagnet=function(e){this.setState(e,2)},st.prototype.setState=function(e,t){const o=this.posOffset+1,n=parseInt(st.index.buffer[o]);return e?st.index.set(o,n|t):st.index.set(o,n&~t)},st.prototype.setGroup=function(e){const t=this.posOffset+2;st.index.set(t,e)},st.prototype.reorient=function(){let e=this.outEdge,t=this.outEdge;do{t.index<e.index&&(e=t),t=t.pair.next}while(t!==this.outEdge);this.outEdge=e},st.prototype.isLive=function(){return null!==this.outEdge},st.prototype.oneRing=function*(e){e||(e=this.outEdge);let t=e;do{const e=t.pair;yield e.origin,t=e.next}while(t!==e)},st.prototype.edgeRing=function*(e){e||(e=this.outEdge);let t=e;do{yield t,t=t.pair.next}while(t!==e)},st.prototype.eachInEdge=function(e){var t=this.outEdge,o=t;if(o)do{const t=o.pair;o=o.pair.next,e(t,this)}while(o&&o!==t)},st.prototype.findInEdge=function(e){var t=this.outEdge,o=t;if(o)do{if(e(o.pair,this))return o.pair;o=o.pair.next}while(o&&o!==t);return null},st.prototype.eachOutEdge=function(e){var t=this.outEdge,o=t;if(o)do{e(o,this),o=o.pair.next}while(o&&o!==t)},st.prototype.findOutEdge=function(e){var t=this.outEdge,o=t;if(o)do{if(e(o,this))return o;o=o.pair.next}while(o&&o!==t);return null},st.prototype.findFreeInEdge=function(){return this.findInEdge(function(e,t){return null===e.face})},st.prototype.linkEdge=function(e,t){if(null===this.outEdge)this.outEdge=e;else{var o=this.findFreeInEdge();if(null===o)return console.log("Error: Vertex.linkEdge: complex vertex "+this.index),!1;var n=o.next;o.next=e,t.next=n}return!0},st.prototype.unlinkEdge=function(e,t){const o=e.prev();if(this.outEdge===e){if(o===t)return void(this.outEdge=null);this.outEdge=o.pair}o.next=t.next},st.prototype.isIsolated=function(){return null===this.outEdge},st.prototype.numberOfEdge=function(){let e=0;const t=this.outEdge;let o=t;do{e++,o=o.pair.next}while(o!==t||e>1001);return e},st.prototype.getNormal=function(e){const t=this.outEdge;let o=t;const n=vec3.create(),r=vec3.create(),i=vec3.create();vec3.sub(n,o.destination(),o.origin);do{o=o.pair.next,vec3.sub(r,o.destination(),o.origin),vec3.cross(i,r,n),vec3.add(e,e,i),vec3.copy(n,r)}while(o!==t);vec3.normalize(e,e)};const at=function(e,t,o=tt.default){Ze.call(this),this.index=at.state.alloc()/3,at.normal.alloc(),at.color.alloc(),this.halfEdge=e,this.numberOfVertex=t,this.assignMaterial(o),this.update(),this._setColor(it.WHITE),at.centerIndex.alloc();const n=4*this.index;at.centerIndex.set(n,this.index),at.centerIndex.set(n+1,-this.index-1),at.centerIndex.set(n+2,this.index),at.centerIndex.set(n+3,-1)};at.prototype=Object.create(Ze.prototype),Object.defineProperty(at.prototype,"constructor",{value:at,enumerable:!1,writable:!0}),at.state=null,at.centerIndex=null,at.normal=null,at.color=null,at.prototype.hide=function(){this.setState(!0,4)},at.prototype.show=function(){this.setState(!1,4)},at.prototype.setHilite=function(e){this.setState(e,2)},at.prototype.setSelect=function(e){this.setState(e,1)},at.prototype.setState=function(e,t){const o=3*this.index,n=at.state.buffer[o];return e?at.state.set(o,n|t):at.state.set(o,n&~t)},at.prototype.setGroup=function(e){at.centerIndex.set(4*this.index+3,e)},at.prototype.assignMaterial=function(e){if(e!==this.material){this.material&&this.material.unassigned(),this.material=e,e.assigned();const t=3*this.index;at.state.set(t+1,255&e.index),at.state.set(t+2,(65280&e.index)>>8)}},Object.defineProperty(at.prototype,"normal",{get:function(){return new Re(at.normal.buffer,this.cntrOffset)}}),at.prototype.getNormal=function(e){let t=this.cntrOffset;return e[0]=at.normal.get(t),e[1]=at.normal.get(t+1),e[2]=at.normal.get(t+2),e},at.prototype.isLive=function(){return null!==this.halfEdge},at.prototype.isVisible=function(){return!(4&at.state.buffer[this.index])&&null!==this.halfEdge},at.prototype.buildIndex=function(e,t,o){for(let n of this.hEdges())e[t++]=n.origin.index,e[t++]=n.destination().index,e[t++]=o;return t},at.prototype.eachVertex=function(e){var t=this.halfEdge,o=t;do{e(o.origin),o=o.next}while(o!==t)},at.prototype.eachEdge=function(e){var t=this.halfEdge,o=t;do{let t=o.next;e(o),o=t}while(o!==t)},at.prototype.hEdges=function*(e=!1){if(e){const e=[];let t=this.halfEdge;do{e.push(t),t=t.next}while(t!==this.halfEdge);for(let t of e)yield t}else{const e=this.halfEdge;let t=e;do{let e=t.next;yield t,t=e}while(t!==e)}},at.prototype.adjacent=function*(){const e=new Set,t=this.halfEdge;let o=t;do{let t=o.pair.face;null===t||e.has(t)||(e.add(t),yield t),o=o.next}while(o!==t)},at.prototype.oneRing=function*(){const e=new Set;e.add(this);const t=this.halfEdge;let o=t;do{const t=o.origin;for(let o of t.edgeRing()){const t=o.face;null===t||e.has(t)||(e.add(t),yield t)}o=o.next}while(o!==t)},at.prototype.computeNormal=function(){const e=vec3.create(),t=vec3.create();return function(){const o=this.halfEdge.origin,n=this.halfEdge.next.origin,r=this.halfEdge.next.destination();vec3.sub(e,o,n),vec3.sub(t,r,n),vec3.cross(t,t,e),vec3.normalize(t,t);const i=3*this.index;at.normal.set(i,t[0]),at.normal.set(i+1,t[1]),at.normal.set(i+2,t[2])}}(),at.prototype.updateCentroidColor=function(){const e=[0,0,0],t=[0,0,0];let o=this.halfEdge;do{o.getVertexColor(e),vec3.add(t,t,e),o=o.next}while(o!==this.halfEdge);vec3.scale(t,t,1/this.numberOfVertex),this._setColor(t)},at.prototype._setColor=function(e){const t=3*this.index;at.color.set(t,e[0]),at.color.set(t+1,e[1]),at.color.set(t+2,e[2])},at.prototype.update=function(){const e=this.halfEdge;let t,o=e,n=e;this.numberOfVertex=0,this[0]=this[1]=this[2]=0;do{vec3.add(this,this,n.origin),n.face=this;n.getIndex();if(++this.numberOfVertex,n.getIndex()<o.getIndex()&&(o=n),this.numberOfVertex>1001)return void console.log("something is wrong with polygon link list");n.updateIndex(),n=n.next}while(n!==e);vec3.scale(this,this,1/this.numberOfVertex),this.radius=0;do{(t=vec3.distance(this,n.origin))>this.radius&&(this.radius=t),n=n.next}while(n!==e);this.radius2=this.radius*this.radius,this.halfEdge=o,this.numberOfVertex>2&&this.computeNormal()};const lt=function(e){tt.color=new l(9),tt.default=tt.create("default"),tt.dead=tt.create("dead"),rt.index=new l(24),rt.state=new c(1),it.index=new l(4),it.triangleList=new d(3),it.color=new c(3),st.index=new l(3),st.position=this.position=new l(3,e),Ze.center=new l(3,e),at.centerIndex=new l(4),at.state=new c(3),at.normal=new l(3,e),at.color=new c(3),ct.state=new c(1),this.vertices=[],this.edges=[],this.faces=[],this.free={vertices:[],edges:[],faces:[]},this.affected={vertices:new Set,edges:new Set,faces:new Set}};lt.prototype.allocVertex=function(e,t){if(this.free.vertices.length>0){let o;if(void 0===t)o=this.vertices[this.free.vertices.pop()];else{const e=t.index;this.free.vertices=this.free.vertices.filter(function(t){return t!==e}),o=t}return o.set(e),this.affected.vertices.add(o),o}{let t=new st(this.vertices.length);return t.set(e),this.vertices.push(t),t}},lt.prototype.allocEdge=function(e,t,o){let n,r;if(this.free.edges.length>0){if(void 0!==o){const e=o.wingedEdge.index;this.free.edges=this.free.edges.filter(function(t){return t!==e}),n=o.wingedEdge,r=o}else r=(n=this.edges[this.free.edges.pop()]).left;r.origin=e,r.pair.origin=t,this.affected.edges.add(n)}else n=new rt(e,t,this.edges.length),this.edges.push(n),r=n.left;return r},lt.prototype.allocPolygon=function(e,t,o,n){let r;if(this.free.faces.length>0){if(void 0!==n){const e=n.index;this.free.faces=this.free.faces.filter(function(t){return t!==e}),r=n}else r=this.faces[this.free.faces.pop()];r.assignMaterial(o),r.halfEdge=e,r.numberOfVertex=t,r.update(),r.show(),this.affected.faces.add(r)}else(r=new at(e,t,o)).index=this.faces.length,this.faces.push(r);return r},lt.prototype._insertFreeList=function(e,t){for(var o=0,n=t.length-1;o<=n;){let r=o+(n-o>>>1),i=e-t[r];if(i>0)n=r-1;else{if(!(i<0))break;o=r+1}}t.splice(o,0,e)},lt.prototype.freeVertex=function(e){e.outEdge=null,this._insertFreeList(e.index,this.free.vertices),this.affected.vertices.add(e)},lt.prototype.freeHEdge=function(e){const t=e.pair;e.face=null,t.face=null,e.origin=null,t.origin=null,e.next=t,t.next=e,this._insertFreeList(e.wingedEdge.index,this.free.edges),this.affected.edges.add(e.wingedEdge)},lt.prototype.freePolygon=function(e){e.halfEdge=null,e.numberOfVertex=0,e.assignMaterial(tt.dead),e.hide(),this._insertFreeList(e.index,this.free.faces),this.affected.faces.add(e)},lt.prototype.freeAll=function(e,t,o){function n(e,t){return t-e}for(let t of e)this.free.faces.push(t.index),t.halfEdge=null,t.numberOfVertex=0;this.free.faces.sort(n);for(let e of t)this.free.edges.push(e.index),e.left.face=null,e.left.origin=null,e.right.face=null,e.right.face=null,e.left.next=e.right,e.right.next=e.left;this.free.edges.sort(n);for(let e of o)this.free.vertices.push(e.index),e.outEdge=null;this.free.vertices.sort(n)},lt.prototype.getVertices=function(e){return this.vertices[e]},lt.prototype.clearAffected=function(){this.affected.vertices.clear(),this.affected.edges.clear(),this.affected.faces.clear()},lt.prototype.addAffectedWEdge=function(e){this.affected.edges.add(e)},lt.prototype.addAffectedFace=function(e){this.affected.faces.add(e)},lt.prototype.addAffectedVertex=function(e){this.affected.vertices.add(e)},lt.prototype.addAffectedEdgeAndFace=function(e){this.affected.vertices.add(e);const t=this;e.eachOutEdge(function(e){t.affected.edges.add(e.wingedEdge),null!==e.face&&t.affected.faces.add(e.face)})},lt.prototype.updateAffected=function(){for(let e of this.affected.vertices)if(e.isLive())for(let t of e.edgeRing())t.face&&this.affected.faces.add(t.face);for(let e of this.affected.edges)for(let t of e)t.face&&this.affected.faces.add(t.face);for(let e of this.affected.faces)e.isLive()&&e.update();this.clearAffected()};const ct=function(e){this.guid=ct.state.alloc(),this.alloc=e,this.vertices=new Set,this.faces=new Set,this.edges=new Set};ct.state=null,ct.prototype.hide=function(){this.setState(!0,8)},ct.prototype.show=function(){this.setState(!1,8)},ct.prototype.setTransparency=function(e){this.setState(e,4)},ct.prototype.setHilite=function(e){this.setState(e,2)},ct.prototype.setSelect=function(e){this.setState(e,1)},ct.prototype.setState=function(e,t){const o=this.guid,n=ct.state.buffer[o];return e?ct.state.set(o,n|t):ct.state.set(o,n&~t)},ct.prototype.free=function(){this.alloc.freeAll(this.faces,this.edges,this.vertices),this.faces=new Set,this.edges=new Set,this.vertices=new Set},ct.prototype.merge=function(e){const t=this;this.vertices=new Set(function*(){yield*t.vertices;for(let t of e())yield*t.vertices}()),this.edges=new Set(function*(){yield*t.edges;for(let t of e())yield*t.edges}()),this.faces=new Set(function*(){yield*t.faces;for(let t of e())yield*t.faces}())},ct.prototype.separateOut=function(){const e=new Set,t=[];let o;function n(t){for(let r of t.hEdges()){const t=r.pair.face;null===t||e.has(t)||(e.add(t),o.add(t),n(t))}}for(let r of this.faces)if(!e.has(r)){e.add(r);let i=new ct(this.alloc);(o=i.faces).add(r),n(r),t.push(i)}if(t.length>1){for(let e of t)for(let t of e.faces)for(let o of t.hEdges())e.vertices.add(o.origin),e.edges.add(o.wingedEdge);return t}return null},ct.prototype.detachFace=function(e){const t=new Set,o=new Set;for(let n of e){this.faces.delete(n);for(let e of n.hEdges())t.add(e.origin),this.vertices.delete(e.origin),o.add(e.wingedEdge),this.edges.delete(e.wingedEdge)}return{vertices:t,edges:o}},ct.prototype.sanityCheck=function(){let e=!0;for(let[n,r]of this.vertices.entries())if(r.isLive())if(r.outEdge.origin!==r)console.log("vertex "+n+" outEdge is wrong"),e=!1;else{var t=r.outEdge,o=t;let i=null,s=0;if(o)do{if(o.pair.next===t){i=o.pair;break}o=o.pair.next,s++}while(o&&o!==t&&s<101);null===i&&(console.log("vertex "+n+" is broken"),e=!1)}return e},ct.prototype.addAffectedWEdge=function(e){this.alloc.addAffectedWEdge(e)},ct.prototype.addAffectedFace=function(e){this.alloc.addAffectedFace(e)},ct.prototype.addAffectedVertex=function(e){this.alloc.addAffectedVertex(e)},ct.prototype.clearAffected=function(){this.alloc.clearAffected()},ct.prototype.addAffectedEdgeAndFace=function(e){this.alloc.addAffectedEdgeAndFace(e)},ct.prototype._createPolygon=function(e,t,o,n){let r;return(r=n?this.alloc.allocPolygon(e,t,n.material,n.polygon):this.alloc.allocPolygon(e,t,o)).setGroup(this.guid),this.faces.add(r),r},ct.prototype.addVertex=function(e,t){const o=this.alloc.allocVertex(e,t);return this.vertices.add(o),o.setGroup(this.guid),o},ct.prototype._createEdge=function(e,t,o){const n=this.alloc.allocEdge(e,t,o);return n.wingedEdge.setGroup(this.guid),this.edges.add(n.wingedEdge),n},ct.prototype._freeVertex=function(e){this.vertices.delete(e)&&(e.setGroup(-1),this.alloc.freeVertex(e))},ct.prototype._freeEdge=function(e){this.edges.delete(e.wingedEdge)&&(e.wingedEdge.setGroup(-1),this.alloc.freeHEdge(e))},ct.prototype._freePolygon=function(e){if(this.faces.delete(e)){const t={material:e.material,polygon:e};return this.alloc.freePolygon(e),t}},ct.prototype.getExtent=function(e,t){for(let o of this.vertices)for(let n=0;n<3;++n){const r=o[n];r>t[n]?t[n]=r:r<e[n]&&(e[n]=r)}},ct.prototype.addEdge=function(e,t,o){var n=this._createEdge(e,t,o).wingedEdge;return e.linkEdge(n.left,n.right)?t.linkEdge(n.right,n.left)?n.left:(e.unlinkEdge(n.left,n.right),this._freeEdge(n.right),null):(this._freeEdge(n.left),null)},ct.prototype.findFreeInEdge=function(e,t){var o=e.pair;do{do{o=o.next.pair}while(!o.isBoundary());if(o!==t)return o}while(o!==e.pair);return console.log("WingedTopology.addFace.findFreeInEdge: patch re-linking failed"),null},ct.prototype.spliceAdjacent=function(e,t){if(e.next===t)return!0;const o=e.next,n=t.prev(),r=this.findFreeInEdge(t,e);if(null===r)return console.log("WingedTopology.spliceAjacent: no free inedge, bad ajacency"),!1;if(r===n)e.next=t,n.next=o;else{const i=r.next;e.next=t,r.next=o,n.next=i}return!0},ct.prototype._unwindNewEdges=function(e){for(let t of e){let e=t.pair;t.origin.unlinkEdge(t,e),e.origin.unlinkEdge(e,t),this._freeEdge(t)}},ct.prototype.addPolygon=function(e,t){return this._addPolygon(0,e.length,e,t)},ct.prototype._addPolygon=function(e,t,o,n){const r=t-e;if(r<3)return console.log("Bad polygon: less than 3 edges"),-1;var i=e,s=[],a=[];const l=new Set;for(let n=e;n<t;++n){(i=n+1)===t&&(i=e);var c=this.alloc.getVertices(o[n]),d=this.alloc.getVertices(o[i]),u=this.findHalfEdge(c,d);if(null===u){if(null===(u=this.addEdge(c,d)))return this._unwindNewEdges(a),null;a.push(u),l.add(u.wingedEdge)}else{if(!u.isBoundary())return this._unwindNewEdges(a),console.log("non-manifold condition, no boundary"),null;if(l.has(u.wingedEdge))return this._unwindNewEdges(a),console.log("complex polygon detected"),null;l.add(u.wingedEdge)}s.push(u)}for(let e=0;e<r;++e)if((i=e+1)===r&&(i=0),!this.spliceAdjacent(s[e],s[i]))return this._unwindNewEdges(a),console.log("non-manifold condition, cannot splice"),null;var f=this._createPolygon(s[0],r,n);for(let e=0;e<r;++e)s[e].face=f;return f},ct.prototype.findHalfEdge=function(e,t){return e.findOutEdge(function(e,o){return e.destination()===t})},ct.prototype.insertEdge=function(e,t,o,n){const r=e.destination(),i=t.origin,s=e.face,a=this._createEdge(r,i,o),l=a.pair,c=e.next,d=t.prev();e.next=a,a.next=t,d.next=l,l.next=c;const u=this._createPolygon(a,4,tt.default,n);a.face=u;let f=0;return u.eachEdge(function(e){++f,e.face=u}),u.numberOfVertex=f,l.face=s,s&&(s.halfEdge.face===u&&(s.halfEdge=l),f=0,s.eachEdge(function(e){++f}),s.numberOfVertex=f,this.addAffectedFace(s)),a},ct.prototype.splitEdge=function(e,t,o){const n=e.pair,r=e.prev(),i=n.next,s=e.origin,a=s.outEdge,l=this.addVertex(t),c=this._createEdge(s,l,o),d=c.pair;return c.next=e,n.next=d,r.next=c,d.next=i,c.face=e.face,c.face.numberOfVertex++,d.face=n.face,d.face.numberOfVertex++,e.origin=l,l.outEdge=d,a===e&&(s.outEdge=c),this.addAffectedWEdge(e.wingedEdge),c},ct.prototype.doubleEdge=function(e){const t=e.prev(),o=this._createEdge(e.destination(),e.origin),n=o.pair;return o.next=e,n.next=e.next,e.next=o,t.next=n,n.face=e.face,e.face.halfEdge===e&&(n.face.halfEdge=n),this.addAffectedFace(n.face),this._createPolygon(o,2,tt.default),o},ct.prototype.simpleSplit=function(e){const t=this._createEdge(e.destination(),e.next.origin);return t.next=e.next,e.next=t,t.face=e.face,t.face.numberOfVertex++,t},ct.prototype.prepVertex=function(e,t,o,n,r,i){i||(i=t.origin);const s=n.get(i);let a,l=e,c=!0;do{(a=l.next).origin=i,l=a.pair,c&&(s.push(l),o.has(a.wingedEdge)||(c=!1,s.length=0,s.push(l)))}while(a!==t);if(r)for(let e of s)r.add(e)},ct.prototype.prepVertexAdd=function(e,t,o,n,r){const i=this.addVertex(e.destination());return n.set(i,[]),this.prepVertex(e,t,o,n,r,i),i},ct.prototype.isSplitEdgeSelected=function(e,t,o){for(let n of[e,t]){let e=0,t=0;for(let r of n.edgeRing())e++,o.has(r.wingedEdge)&&t++;if(3!==e)return!1;if(2!==t)return!1}return!0},ct.prototype.bevelEdge=function(e){const t={vertices:[],halfEdges:[],collapsibleWings:new Set,selectedFaces:new Set},o=new Set,n=new Map,r=new Map,i=new Set,s=new Set;for(let n of e){const e=this.doubleEdge(n.left);t.selectedFaces.add(e.face),o.add(e.origin),o.add(e.destination()),r.set(n,e.wingedEdge),r.set(e.wingedEdge,n),t.collapsibleWings.add(e.wingedEdge)}for(let e of o){t.vertices.push(e),n.set(e,[]);let o=[];const a=e.outEdge;let l,c,d,u=a;do{let e=u.pair.next;r.has(u.wingedEdge)?r.get(u.wingedEdge)===e.wingedEdge&&o.push(u.pair):r.has(e.wingedEdge)||o.push(u.pair),u=e}while(u!==a);for(let e of o){if(l){const o=this.prepVertexAdd(l,e.pair,r,n,i);let s=this.simpleSplit(l);o.outEdge=s.pair,t.vertices.push(o),t.halfEdges.push(s.pair),c?s.pair.next=c.pair:d=s,c=s}l=e}if(1===o.length){const o=l.next.pair.next,i=this.doubleEdge(o.pair);r.set(o.wingedEdge,i.wingedEdge),r.set(i.wingedEdge,o.wingedEdge),t.selectedFaces.add(i.face);const s=this.prepVertexAdd(l,o,r,n),a=this.simpleSplit(l);s.outEdge=a.pair,t.vertices.push(s),t.halfEdges.push(a.pair);const c=a.pair;c.next=i,o.pair.next=c,c.face=i.face,c.face.numberOfVertex++;let d=n.get(e);d.push(i.pair),d.push(l.pair.next.pair),(d=n.get(s))[0]=d[0].prev()}else if(2===o.length){let e=o[0].next.pair;e.next=l.next,l.next=e,e.face=l.face,e.face.numberOfVertex++,this.addAffectedFace(e.face);const t=n.get(e.next.origin);if(this.isSplitEdgeSelected(e.next.origin,e.origin,r)){const o=e.next.pair;let r=o.prev();t.push(r),i.add(r);let a=o.next.next.pair;t.push(a),i.add(a);const l=n.get(e.origin);r=l[0].prev(),l[0]=r,i.add(r),a=l[1].pair.next.pair,l[1]=a,i.add(a),s.add(e.origin).add(e.destination())}else{const o=[];do{e=e.next.pair,o.push(e)}while(r.has(e.wingedEdge));if(e!==l.next)t.push(e),i.add(e);else{o.pop();for(let e of o)t.push(e),i.add(e)}}}else{this.prepVertex(l,o[0].pair,r,n,i);const e=this.simpleSplit(l);t.halfEdges.push(e.pair),e.pair.next=c.pair,d.pair.next=e.pair;const s=this._createPolygon(e.pair,o.length,tt.default);t.selectedFaces.add(s)}}t.vertexLimit=Number.MAX_SAFE_INTEGER,t.position=new Float32Array(3*t.vertices.length),t.direction=new Float32Array(3*t.vertices.length);let a=0;const l=vec3.create();for(let e of t.vertices){const o=t.position.subarray(a,a+3),r=t.direction.subarray(a,a+3),c=n.get(e);let d=1;s.has(e)&&(d=.4);for(let n of c){vec3.copy(l,n.origin),vec3.copy(o,e),vec3.sub(l,l,o);let s=d;i.has(n.pair)&&(s=.5),t.vertexLimit=Math.min(vec3.length(l)*s,t.vertexLimit),vec3.normalize(l,l),vec3.add(r,r,l)}.4==d&&vec3.normalize(r,r),a+=3}return t},ct.prototype.bevelVertex=function(e){const t={vertices:[],halfEdges:[],selectedFaces:[]},o=new Set;for(let n of e){let e,r=n.outEdge,i=r.pair.next,s=0;for(t.vertices.push(n),o.add(i);i!==n.outEdge;){const n=this.addVertex(i.origin);t.vertices.push(n),i.origin=n,n.outEdge=i,o.add(i);const a=i.pair.next;let l=this.simpleSplit(r.pair);t.halfEdges.push(l.pair),++s,e&&(l.pair.next=e.pair),e=l,r=i,i=a}if(s>1){let o=this.simpleSplit(r.pair);t.halfEdges.push(o),o.pair.next=e.pair;const i=n.outEdge.pair.next;i.pair.next=o.pair;const a=this._createPolygon(i.pair,s+1,tt.default);t.selectedFaces.push(a)}else console.log("weird 2 edge vertex, to be done later")}t.vertexLimit=Number.MAX_SAFE_INTEGER,t.position=new Float32Array(3*t.vertices.length),t.direction=new Float32Array(3*t.vertices.length);let n=0;for(let e of t.vertices){const r=t.position.subarray(n,n+3),i=t.direction.subarray(n,n+3);vec3.copy(r,e),vec3.sub(i,e.outEdge.destination(),r),o.has(e.outEdge.pair)?t.vertexLimit=Math.min(.5*vec3.length(i),t.vertexLimit):t.vertexLimit=Math.min(vec3.length(i),t.vertexLimit),vec3.normalize(i,i),n+=3}return t},ct.prototype.extrudeContours=function(e){let t=[];for(let o of e)for(let e of o){let o=[];o.push(e.inner.origin.index),o.push(e.outer.origin.index),o.push(e.outer.destination().index),o.push(e.inner.destination().index),this.addPolygon(o,e.inner.face.material),t.push(this.findHalfEdge(e.inner.origin,e.outer.origin))}return t},ct.prototype.findEdgeGroup=function(e){const t=new Set(e);let o=null;function n(e){t.delete(e),o.add(e);for(let o of e.oneRing())t.has(o)&&n(o)}let r=[];for(let e of t)o=new Set,n(e),r.push(o);return r},ct.findFaceGroup=function(e){const t=new Set(e);let o=null;function n(e){t.delete(e),o.add(e),e.eachVertex(e=>{e.eachOutEdge(e=>{const o=e.pair.face;t.has(o)&&n(o)})})}let r=[];for(let e of t)o=new Set,n(e),r.push(o);return r},ct.findContours=function(e){const t=new Set,o=[];for(let n of e)n.eachEdge(function(n){if(!t.has(n)&&!e.has(n.pair.face)){const r=[];let i=n;do{let o=i.next.pair;for(;o!==i&&e.has(o.face);)o=o.next.pair;const n={outer:i,inner:null};r.push(n),t.add(i),i=o.pair}while(i!==n);o.push(r)}});return o},ct.prototype.weldContour=function(e){let t=e[e.length-1];for(let o=0;o<e.length;++o){const n=e[o];if(t.inner.next!==n.inner){const e=n.inner;let o,r=t.inner.next;t.outer.next=r;do{r.origin=n.outer.origin,r=(o=r.pair).next}while(r!==e);o.next=n.outer}n.outer.face=n.inner.face,n.inner.face.halfEdge===n.inner&&(n.outer.face.halfEdge=n.outer),t=n,this.addAffectedFace(n.outer.face)}for(let t of e)t.restore={origin:t.inner.origin,pt:vec3.clone(t.inner.origin),hEdge:t.inner},this._freeVertex(t.inner.origin),this._freeEdge(t.inner)},ct.prototype._liftLoop=function(e){let t=e[e.length-1];for(let o=0;o<e.length;++o){let n=e[o],r=t.outer.next;if(r!==n.outer){let e=n.outer.prev();t.outer.next=n.outer,t.inner.next=r,e.next=n.inner;let o=r;do{o.origin.outEdge===o&&(o.origin.outEdge=n.outer),o.origin=n.inner.origin,o=o.pair.next}while(o!==n.inner)}t=n,n.inner.face=n.outer.face,n.outer.face=null,n.inner.face.halfEdge===n.outer&&(n.inner.face.halfEdge=n.inner),this.addAffectedFace(n.inner.face)}return e},ct.prototype.liftContour=function(e){if(0===e.length)return e;let t=this.addVertex(e[0].outer.origin),o=t;for(let n=0;n<e.length;++n){let r,i=e[n].outer;r=n==e.length-1?t:this.addVertex(i.destination()),e[n].inner=this.addEdge(o,r),o=r}return this._liftLoop(e)},ct.prototype.restoreContour=function(e){if(0===e.length)return e;for(let t of e)this.addVertex(t.restore.pt,t.restore.origin);let t;for(let o=0;o<e.length;++o){const n=e[o],r=e[(o+1)%e.length],i=this._createEdge(n.restore.origin,r.restore.origin,n.restore.hEdge);n.restore.origin.outEdge=i,t&&(t.next=i,i.pair.next=t.pair),t=i}return t.next=e[0].inner,e[0].inner.pair.next=t.pair,this._liftLoop(e)},ct.prototype.liftContours=function(e){for(let t of e)this.liftContour(t);return e},ct.prototype._liftEdge=function(e,t,o,n){const r=e.prev(),i=t.next,s=this._createEdge(o,e.origin,n),a=s.pair;t.next=s,s.next=i,a.next=e,r.next=a,o.outEdge=s;let l=e;do{l.origin.outEdge===l&&(l.origin.outEdge=i),l.origin=o,this.addAffectedWEdge(l.wingedEdge),l=l.pair.next}while(l!==s);s.face=t.face,s.face&&(s.face.numberOfVertex++,this.addAffectedFace(s.face)),a.face=e.face,a.face&&(a.face.numberOfVertex++,this.addAffectedFace(a.face))},ct.prototype._collapseEdge=function(e){const t=e.next,o=e.prev(),n=e.pair,r=n.next,i=n.prev(),s=e.origin,a=n.origin;let l=r;for(;l!==e;)l.origin=a,this.addAffectedWEdge(l.wingedEdge),l=l.pair.next;o.next=t,i.next=r;let c=e.face;return c&&(c.halfEdge===e&&(c.halfEdge=t),c.numberOfVertex--,this.addAffectedFace(c)),(c=n.face)&&(c.halfEdge===n&&(c.halfEdge=r),c.numberOfVertex--,this.addAffectedFace(c)),a.outEdge===n&&(a.outEdge=t),this._freeEdge(e),this._freeVertex(s),{hEdge:e,pairNext:r,prev:o,vertex:s}},ct.prototype._restoreLoop=function(e,t,o){const n=e.prev(),r=this._createEdge(e.destination(),e.origin,t),i=r.pair;n.next=i,i.next=e.next,e.next=r,r.next=e,i.face=e.face;const s=this._createPolygon(r,2,tt.default,o);e.face=s,r.face=s,i.face.halfEdge===e&&(i.face.halfEdge=i)},ct.prototype._collapseLoop=function(e,t){t&&!t.has(e.wingedEdge)&&(e=e.next);const o=e.next,n=e.pair,r=o.pair;o.next=n.next,n.prev().next=o;let i=n.face;o.face=i,e.origin.outEdge===e&&(e.origin.outEdge=r),n.origin.outEdge===n&&(n.origin.outEdge=o),i.halfEdge===n&&(i.halfEdge=o);const s=e.face;return this._freePolygon(e.face),this._freeEdge(e),{next:o,hEdge:e,polygon:s}},ct.prototype.collapseEdge=function(e,t){const o=e.next,n=e.pair.next,r=this._collapseEdge(e);return o.next.next===o&&(r.leftLoop=this._collapseLoop(o.next,t)),n.wingedEdge.isLive()&&n.next.next===n&&(r.rightLoop=this._collapseLoop(n,t)),r},ct.prototype.restoreCollapseEdge=function(e){e.rightLoop&&this._restoreLoop(e.rightLoop.next,e.rightLoop.hEdge,e.rightLoop.polygon),e.leftLoop&&this._restoreLoop(e.leftLoop.next,e.leftLoop.hEdge,e.leftLoop.polygon),this._liftEdge(e.pairNext,e.prev,this.addVertex(e.vertex,e.vertex),e.hEdge)},ct.prototype._removeEdge=function(e,t){const o=e.prev(),n=e.next,r=t.prev(),i=t.next;return o.next=i,r.next=e.next,e.origin.outEdge===e&&(e.origin.outEdge=o.pair),t.origin.outEdge===t&&(t.origin.outEdge=r.pair),{outPrev:o,outNext:n,outEdge:e}},ct.prototype.removeEdge=function(e){let t=e.pair;null===t.face&&null!==e.face&&(e=t=e);const o=this._removeEdge(e,t),n=e.face,r=t.face;if(null!==r){r.halfEdge===t&&(r.halfEdge=o.outPrev),r.numberOfVertex=0;for(let e of r.hEdges())++r.numberOfVertex,e.face=r;this.addAffectedFace(r)}return null!==n&&(this._freePolygon(n),o.delFace=n),this._freeEdge(e),o},ct.prototype.restoreRemoveEdge=function(e){this.insertEdge(e.outPrev,e.outNext,e.outEdge,e.delFace)},ct.prototype.dissolveEdge=function(e,t){const o=e.pair;return e.next.pair.next===o?this.collapseEdge(o,t):o.next.pair.next===e?this.collapseEdge(e,t):this.removeEdge(e)},ct.prototype.restoreDissolveEdge=function(e){e.outPrev?this.restoreRemoveEdge(e):this.restoreCollapseEdge(e)},ct.prototype.connectVertex=function(e){const t=new Map;for(let o of e)o.eachOutEdge(function(e){let o=1;t.has(e.face)&&(o=t.get(e.face)+1),t.set(e.face,o)});const o=[];let n=[];for(let[r,i]of t)if(i>1){let t=-1,i=-1,s=r.halfEdge;for(;2==s.origin.valence;)s=s.next;const a=s;do{let o=s.origin.valence;if(t=i,2!=o&&i++,e.has(s.origin)){const e={prevEdgeNumber:t,edgeNumber:i,outEdge:s};n.push(e)}s=s.next}while(s!==a);const l=n[0];-1==l.prevEdgeNumber&&(l.prevEdgeNumber=i),o.push(n),n=[]}const r=[];for(let e of o){let t=!0,o=-1;for(let[n,r]of e.entries()){if(r.prevEdgeNumber!==r.edgeNumber||o==r.edgeNumber){t=!1;break}o=r.edgeNumber}if(t)if(2===e.length)r.push(this.insertEdge(e[0].outEdge.prev(),e[1].outEdge));else{const t=e[0].outEdge.prev();for(let o=0;o<e.length;++o){let n,i,s=e[o];o+1<e.length?(n=e[o+1],i=this.insertEdge(s.outEdge.prev(),n.outEdge)):i=this.insertEdge(s.outEdge.prev(),t.next),r.push(i)}}else{let t=e.length-1,o=0;do{let n=e[t],i=e[o];if(n.edgeNumber!=i.prevEdgeNumber){const e=this.insertEdge(n.outEdge.prev(),i.outEdge);r.push(e),t--}o++}while(o<t)}}return r},ct.prototype.removePolygon=function(e){for(let t of e.hEdges())t.face=null;this._freePolygon(e)},ct.prototype.dissolveVertex=function(e){const t=new Float32Array(3);if(vec3.copy(t,e),e.isIsolated())return this._freeVertex(e),{pt:t,vertex:e};{this.addAffectedEdgeAndFace(e);let o=0;const n=e.outEdge.pair;let r,i;e.eachInEdge(function(e){const t=e.next;i=e.pair,t.face.halfEdge===t&&(t.face.halfEdge=e),--t.face.numberOfVertex,e.next=t.next,t.next=i,i.origin=t.pair.origin,o++,r=e});const s=this._createPolygon(i,o,tt.default),a=[];let l=e.outEdge;i=e.outEdge;do{let e=i.pair;i=i.next,e.next.next===e&&(e.pair===l&&(l=e.next),a.unshift(this._collapseLoop(e)))}while(i!==l);return this._freeVertex(e),{polygon:s,pt:t,vertex:e,undoCollapseLoop:a,lastIn:r,firstIn:n}}},ct.prototype.restoreDissolveVertex=function(e){if(e.polygon){const t=this.addVertex(e.pt,e.vertex);for(let t of e.undoCollapseLoop)this._restoreLoop(t.next,t.hEdge,t.polygon);let o=e.lastIn,n=e.lastIn.next.pair,r=e.firstIn;do{let e=o.pair;e.origin=t;let n=r.pair;n.next=o.next,o.next=n,n.face=o.face,++n.face.numberOfVertex,r=o,o=e.next.pair}while(o!==n);t.outEdge=e.firstIn.pair,this._freePolygon(e.polygon),this.addAffectedEdgeAndFace(t)}else this.addVertex(e.pt,e.vertex);return e.vertex},ct.prototype.bridgeFace=function(e,t,o){const n={target:{face:e,hEdge:e.halfEdge},source:{face:t,hEdge:t.halfEdge}},r=[],i=[];for(let t of e.hEdges())r.push(t),t.face=null;for(let e of t.hEdges()){const t=vec3.clone(e.origin);vec3.add(t,t,o),i.unshift({hEdge:e,delta:t}),e.face=null}let s=-1,a=Number.MAX_SAFE_INTEGER;const l=vec3.create();for(let e=0;e<t.numberOfVertex;++e){let t=0;for(let e=0;e<r.length;++e)vec3.sub(l,r[e].origin,i[e].delta),a+=vec3.length(l);t<a&&(a=t,s=e),i.push(i.shift())}i.unshift.apply(i,i.splice(s-1,i.length)),n.target.face=this._freePolygon(e),n.source.face=this._freePolygon(t);let c=null;const d=[];for(let e=0;e<r.length;++e){const t=this.addEdge(i[e].hEdge.origin,r[e].origin);c&&this._createPolygon(c,4,tt.default),d.push(t),c=t}return this._createPolygon(c,4,tt.default),n.hEdges=d,n},ct.prototype.undoBridgeFace=function(e){for(let t of e.hEdges)this.removePolygon(t.face);for(let t of e.hEdges)this._removeEdge(t,t.pair),this._freeEdge(t);this._createPolygon(e.target.hEdge,e.hEdges.length,tt.default,e.target.face),this._createPolygon(e.source.hEdge,e.hEdges.length,tt.default,e.source.face)},ct.prototype.findInsetContours=function(e){const t=[];for(let o of e){const e=[];for(let t of o.hEdges()){const o={outer:t,inner:null};e.push(o)}t.push(e)}return t},ct.prototype._liftDanglingEdge=function(e,t){const o=e.next,n=this._createEdge(o.origin,t);return t.outEdge=n.pair,e.next=n,n.pair.next=o,n.face=n.pair.face=e.face,n},ct.prototype.liftCornerEdge=function(e,t=.2){const o=vec3.create(),n=vec3.create();let r=e.next;vec3.lerp(o,r.origin,r.destination(),t),vec3.sub(n,e.origin,e.destination()),vec3.scale(n,n,t),vec3.add(o,o,n);let i=this.addVertex(o);return this._liftDanglingEdge(e,i)},ct.prototype.extrudeEdge=function(e,t){const o=[],n=[];let r=e,i=e.next,s=i.next;vec3.create();for(;s!==t;){let e=this.liftCornerEdge(i);o.push(e.pair);let t=this.insertEdge(e,r);n.push(t),r=e.pair,i=s,s=s.next}let a=this.insertEdge(s,r);return n.push(a),{extrude:n,lift:o}},ct.prototype.slideToPrev=function(e,t){t||(t=e.prev().prev());const o=t.next,n=e.pair;if(e.face.numberOfVertex<=3){const t={inEdge:e,delFace:e.face,inNext:e.next,inPrev:e.prev()};return this.this.removeEdge(e),t}return o.next=n.next,n.next=o,t.next=e,e.origin.outEdge===e&&(e.origin.outEdge=o.next),e.origin=o.origin,o.face.halfEdge===o&&(o.face.halfEdge=n),o.face=n.face,++n.face.numberOfVertex,--e.face.numberOfVertex,{inEdge:n}},ct.prototype.slideToNext=function(e){if(e.face.numberOfVertex<=3){const t={inEdge:e,delFace:e.face,inNext:e.next,inPrev:e.prev()};return this.removeEdge(e),t}const t=e.pair,o=e.next,n=t.prev();return n.next=o,e.next=o.next,o.next=t,t.origin.outEdge===t&&(t.origin.outEdge=o),t.origin=e.next.origin,this.addAffectedWEdge(t.wingedEdge),o.face.halfEdge===o&&(o.face.halfEdge=e),e.face=o.face,o.face=t.face,++t.face.numberOfVertex,--e.face.numberOfVertex,this.addAffectedFace(t.face),this.addAffectedFace(e.face),{prevPrev:n,outEdge:t}},ct.prototype.undoSlideToNext=function(e){e.delFace?this.insertEdge(e.inPrev,e.inNext,e.inEdge,e.delFace):this.slideToPrev(e.outEdge,e.prevPrev)},ct.prototype.insertFan=function(e,t){const o=vec3.create();e.getCentroid(o);let n=this.addVertex(o);const r=[];let i;for(let o of e.hEdges())t.has(o)&&(void 0!==i?(i=this.insertEdge(o,i.pair),r.unshift(i.pair)):(i=this._liftDanglingEdge(o,n),r.unshift(i)));return r},ct.prototype.invert=function(){const e=[];for(let t of this.faces)for(let o of t.hEdges())e.push({hEdge:o.next.pair,next:o.pair});for(let{hEdge:t,next:o}of e)t.next=o;for(let e of this.edges){let t=e.left.face;t.halfEdge===e.left&&(t.halfEdge=e.right),e.left.face=e.right.face,e.left.face.halfEdge===e.right&&(e.left.face.halfEdge=e.left),e.right.face=t}},ct.prototype.flip=function(e,t){const o=2*e[t];for(let e of this.vertices)e[t]=o-e[t],this.addAffectedEdgeAndFace(e)},ct.prototype.makeHole=function(e){let t={hEdge:e.halfEdge,face:e,dissolveEdges:[]};for(let o of e.hEdges(!0)){o.face=null,null===o.pair.face&&t.dissolveEdges.unshift(this.dissolveEdge(o))}return this._freePolygon(e),t},ct.prototype.undoHole=function(e){for(let t of e.dissolveEdges)e.face.isLive()||(t.delFace=e.face),this.restoreDissolveEdge(t);return e.face.isLive()?e.face:this._createPolygon(e.hEdge,4,tt.default,e.face)};const dt="data-i18n",ut="data-tooltip",ft="data-menuid",ht="\n";let pt,gt,mt="LMB: ",vt="MMB: ",yt="RMB: ",xt="US",St="en";function bt(e){let t=gt.msgstr.get(e);return!t&&pt?pt.msgstr.get(e):t}function Et(e){const t=this.getAttribute("title").replace(ht,"    ");help(t)}function wt(e,t){let o=!0,n=function(e){let t=gt.tooltip.get(e);return!t&&pt?pt.tooltip.get(e):t}(t);if(n){o=!1;let t="";Array.isArray(n)?(n[0]&&(t+=mt+n[0]),n[1]&&(t+=ht+vt+n[1]),n[2]&&(t+=ht+yt+n[2])):t=n,e.setAttribute("title",t),e.removeEventListener("mouseover",Et),e.addEventListener("mouseover",Et)}}function*Ct(e){for(let t in e)yield[t,e[t]]}function Ft(e,t){O(`./resources/${e}.json`).then(e=>{!function(e){gt={msgstr:new Map,tooltip:new Map};for(let[t,o]of Ct(e))gt[t]=new Map(Ct(o));pt||(pt=gt);let t=document.querySelectorAll(`[${dt}]`);for(let e of t){let t=!0,o=e.getAttribute(dt),n=bt(o);n&&(e.textContent=n,t=!1),t&&console.log(`Warning: ${o} has no translation`)}t=document.querySelectorAll(`[${ft}]`);for(let e of t){let t=e.getAttribute(ft);wt(e,t)}t=document.querySelectorAll(`[${ut}]`);for(let e of t){let t=e.getAttribute(ut);wt(e,t)}}(e),t&&t()}).catch(e=>{console.log("Fetch Error :-S",e)})}function At(e,t,o){xt=t||"unknown",Ft(St=e||"unknown",o)}const _t=function(e,t){return new Function(`return \`${e}\`;`).call(t)};p(()=>{let e=document.querySelectorAll(`[${dt}]`);for(let t of e){let e=t.getAttribute(dt);e||(e=(e=t.textContent.replace(/ /g,"")).replace(/^.{1}/g,e[0].toLowerCase()),t.setAttribute(dt,e)),t.hasAttribute(ut)&&t.setAttribute(ut,e)}e=document.querySelectorAll(`[${ut}=""]`);for(let t of e){let e=t.getAttribute(ut);e||(e=(e=t.textContent.replace(/ /g,"")).replace(/^.{1}/g,e[0].toLowerCase()),t.setAttribute(ut,e))}At("en");let t=document.querySelector("#selectLanguage");t&&t.addEventListener("change",function(e){At(t.value)})});const Mt=function(){this.group=[],this.parent=null,this.uuid=Ne(),this.guiStatus={},this.status={locked:!1,visible:!0,wireMode:!1},this._name=""};function Vt(e,t){return e+t.numberOfCage()}Mt.nameSetters=[],Object.defineProperty(Mt.prototype,"name",{get:function(){return this._name},set:function(e){if(""!==e){this._name=e;for(let t of Mt.nameSetters)t.call(this,e)}}}),Mt.prototype.insert=function(e){e.parent&&e.parent.remove(e),this.group.push(e),e.parent=this},Mt.prototype.remove=function(e){if(e.parent===this){const t=this.group.indexOf(e);if(t>=0)return this.group.splice(t,1),e.parent=null,e}return console.log("remove() integrity error"),null},Mt.prototype.numberOfCage=function(){return this.group.reduce(Vt,0)},Mt.prototype.getCage=function*(){for(let e of this.group)for(let t of e.getCage())yield t};class Lt{constructor(e){this.preview=e}allocVertex(...e){return this.preview.bench.allocVertex(...e)}allocEdge(...e){return this.preview.bench.allocEdge(...e)}allocPolygon(...e){const t=this.preview.bench.allocPolygon(...e);return this.preview.insertFace(t),t}freeAll(e,t,o){this.preview.bench.freeAll(e,t,o)}freeVertex(e){this.preview.bench.freeVertex(e)}freeHEdge(e){this.preview.bench.freeHEdge(e)}freePolygon(e){this.preview.removeFace(e),this.preview.bench.freePolygon(e)}getVertices(e){return this.preview.bench.getVertices(e)}clearAffected(){this.preview.bench.clearAffected()}addAffectedEdgeAndFace(...e){this.preview.bench.addAffectedEdgeAndFace(...e)}addAffectedWEdge(e){this.preview.bench.addAffectedWEdge(e)}addAffectedFace(e){this.preview.bench.addAffectedFace(e)}addAffectedVertex(e){this.preview.bench.addAffectedVertex(e)}}const Pt=function(e){this.parent=null,this.uuid=Ne(),this.geometry=new ct(new Lt(this)),this.bench=e,this.guiStatus={},this.status={locked:!1,visible:!0,wireMode:!1},this.edge={size:0,index:null},this.selectedSet=new Set,this._name="",this.bvh={root:null,queue:new Set}};Pt.nameSetters=[],Object.defineProperty(Pt.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e;for(let t of Pt.nameSetters)t.call(this,e)}}),Pt.prototype.numberOfCage=function(){return 1},Pt.prototype.getCage=function*(){yield this},Pt.prototype.removeFromParent=function(){return!!this.parent&&this.parent.remove(this)},Pt.prototype.freeBuffer=function(){this.bvh.root&&(this.bvh.root.free(),this.bvh.root=null),this.geometry.free()},Pt.prototype.initBVH=function(){const e=this.geometry.faces;let t,o;const n=vec3.create(),r=[];for(let i of e)if(r.push(i),vec3.add(n,n,i.center),t)for(let e=0;e<3;++e)t[e]<i.center[e]+i.radius?t[e]=i.center[e]+i.radius:o[e]>i.center[e]-i.radius&&(o[e]=i.center[e]-i.radius);else t=vec3.fromValues(i.center[0]+i.radius,i.center[1]+i.radius,i.center[2]+i.radius),o=vec3.fromValues(i.center[0]-i.radius,i.center[1]-i.radius,i.center[2]-i.radius);vec3.scale(n,n,1/r.length);const i={center:n,halfSize:vec3.fromValues(Math.max(t[0]-n[0],n[0]-o[0]),Math.max(t[1]-n[1],n[1]-o[1]),Math.max(t[2]-n[2],n[2]-o[2]))};this.bvh.root&&this.bvh.root.free(),this.bvh.queue.clear(),this.bvh.root=new Ke(this,i,0);for(let e of r)this.bvh.root.getBound(i),this.bvh.root.insert(e,i)},Pt.prototype.insertFace=function(e){e.octree?console.log("octree insert duplicated"):this.bvh.queue.add(e)},Pt.prototype.moveSphere=function(e){this.bvh.queue.add(e)},Pt.prototype.removeFace=function(e){e.octree?e.octree._remove(e):this.bvh.queue.delete(e)},Pt.prototype.updateBVH=function(){for(let e of this.bvh.queue)if(!this.bvh.root.isInside(e))return this.bvh.queue.clear(),void this.initBVH();const e={center:vec3.create(),halfSize:vec3.create()};for(let t of this.bvh.queue)this.bvh.root.getBound(e),this.bvh.root.insert(t,e);this.bvh.root.check(new Set),this.bvh.queue.clear()},Pt.prototype.rayPick=function(e){null===this.bvh.root?this.initBVH():this.updateBVH();var t,o=null,n=Number.POSITIVE_INFINITY;for(let r of this.bvh.root.intersectExtent(e))r.eachEdge(function(i){var s=_e(e,[r.center,i.origin,i.destination()]);0!=s&&s<n&&(n=s,o=i,t=r.center)});return o?{t:n,model:this,center:t,edge:o}:null},Pt.prototype.getSelectedSorted=function(){let e=Array.from(this.selectedSet);return e.sort((e,t)=>e.index-t.index),e},Pt.duplicate=function(e){const t=new Map,o=new Pt(e.bench),n=o.geometry;for(let o of e.geometry.vertices){const e=n.addVertex(o);t.set(o.index,e.index)}for(let o of e.geometry.faces){let e=[];o.eachVertex(function(o){e.push(t.get(o.index))}),n.addPolygon(e,o.material)}return o._updatePreviewAll(),o.name=e.name+"_copy1",o},Pt.prototype.merge=function(e){this.geometry.merge(function*(){for(let t of e)yield t.geometry}),this.selectedSet=new Set(function*(){for(let t of e)yield*t.selectedSet}())},Pt.prototype.separate=function(){const e=[],t=this.geometry.separateOut();let o=0;for(let n of t){const t=new Pt(this.bench);t.geometry=n,t.name=o>0?this.name+"_sep"+o.toString():this.name,o++,e.push(t)}return e},Pt.prototype.detachFace=function(e,t){const o=this.geometry.detachFace(e),n=new Pt(this.bench);return n.geometry.faces=e,n.geometry.edges=o.edges,n.geometry.vertices=o.vertices,n.name=this.name+"_cut"+t.toString(),n},Pt.prototype.setVisible=function(e){if(e){if(!this.status.visible)return this.status.visible=!0,this.geometry.show(),!e}else if(this.status.visible)return this.status.visible=!1,this.geometry.hide(),!e;return null},Pt.prototype.toggleLock=function(e){if(e){if(!this.status.locked)return this.status.locked=!0,!e}else if(this.status.locked)return this.status.locked=!1,!e;return null},Pt.prototype.toggleWireMode=function(e){if(e){if(!this.status.wireMode)return this.status.wireMode=!0,this.geometry.setTransparency(!0),!e}else if(this.status.wireMode)return this.status.wireMode=!1,this.geometry.setTransparency(!1),!e;return null},Pt.prototype.isLock=function(){return this.status.locked},Pt.prototype.isVisible=function(){return this.status.visible},Pt.prototype.isWireMode=function(){return this.status.wireMode},Pt.prototype._getGeometrySize=function(){return{face:this.geometry.faces.size,edge:this.geometry.edges.size,vertex:this.geometry.vertices.size}},Pt.prototype._updatePreviewAll=function(){this.bench.updateAffected()},Pt.prototype.changeFromBodyToFaceSelect=function(){return this.snapshotSelectionBody()},Pt.prototype.changeFromBodyToEdgeSelect=function(){const e=this.snapshotSelectionBody();if(this.hasSelection()){this._resetSelectBody();for(let e of this.geometry.edges)this.selectedSet.add(e),e.selectEdge(!0)}return e},Pt.prototype.changeFromBodyToVertexSelect=function(){const e=this.snapshotSelectionBody();if(this.hasSelection()){this._resetSelectBody();for(let e of this.geometry.vertices)this.selectedSet.add(e),e.setSelect(!0)}return e},Pt.prototype.changeFromBodyToMultiSelect=function(){const e=this.snapshotSelectionBody();return this.hasSelection()&&this._resetSelectBody(),e},Pt.prototype.restoreSelection=function(e,t){t._restoreSelection(this,e)},Pt.prototype.restoreFaceSelection=function(e){for(let t of e.selectedFaces)this.selectFace(t)},Pt.prototype.restoreEdgeSelection=function(e){for(let t of e.wingedEdges)this.selectEdge(t.left)},Pt.prototype.restoreVertexSelection=function(e){for(let t of e.vertices)this.selectVertex(t)},Pt.prototype.restoreBodySelection=function(e){e.body.size>0&&this.selectBody()},Pt.prototype.restoreFromBodyToFaceSelect=function(e){e?(this._resetSelectBody(),this.restoreFaceSelection(e)):this.changeFromBodyToFaceSelect()},Pt.prototype.restoreFromBodyToEdgeSelect=function(e){e?(this._resetSelectBody(),this.restoreEdgeSelection(e)):this.changeFromBodyToEdgeSelect()},Pt.prototype.restoreFromBodyToVertexSelect=function(e){e?(this._resetSelectBody(),this.restoreVertexSelection(e)):this.changeFromBodyToVertexSelect()},Pt.prototype.restoreFromBodyToMultiSelect=function(e){this.changeFromBodyToMutliSelect()},Pt.prototype._resetSelectBody=function(){const e=this.snapshotSelectionBody();return this.selectedSet.delete(this.geometry),this.geometry.setSelect(!1),e},Pt.prototype._selectBodyLess=function(){const e=this.snapshotSelectionBody();return this.hasSelection()&&this.selectBody(),e},Pt.prototype._selectBodyAll=function(){const e=this.snapshotSelectionBody();return this.hasSelection()||this.selectBody(),e},Pt.prototype._selectBodyInvert=function(){const e=this.snapshotSelectionBody();return this.selectBody(),e},Pt.prototype.selectBody=function(){return this.hasSelection()?(this.geometry.setSelect(!1),this.selectedSet.delete(this.geometry)):(this.selectedSet.add(this.geometry),this.geometry.setSelect(!0),geometryStatus(function(e,t){let o=bt(e);return o?t?_t(o,t):o:`Error: ${e} don't exist`}("body_status",{name:this.name,polygonSize:this.geometry.faces.size,edgeSize:this.geometry.edges.size,vertexSize:this.geometry.vertices.size}))),this.hasSelection()},Pt.prototype.hiliteBody=function(e){this.geometry.setHilite(e)},Pt.prototype.hasSelection=function(){return this.selectedSet.size>0},Pt.prototype.selectionSize=function(){return this.selectedSet.size},Pt.prototype.snapshotSelection=function(){return new Set(this.selectedSet)},Pt.prototype.snapshotSelectionFace=function(){return{selectedFaces:new Set(this.selectedSet)}},Pt.prototype.snapshotSelectionEdge=function(){return{wingedEdges:new Set(this.selectedSet)}},Pt.prototype.snapshotSelectionVertex=function(){return{vertices:new Set(this.selectedSet)}},Pt.prototype.snapshotSelectionBody=function(){return{body:new Set(this.selectedSet)}},Pt.prototype.dragSelectVertex=function(e,t){if(this.selectedSet.has(e)){if(!1===t)return this.selectedSet.delete(e),e.setSelect(!1),!0}else if(!0===t)return this.selectedSet.add(e),e.setSelect(!0),geometryStatus("select vertex: "+e.index),!0;return!1},Pt.prototype.selectVertex=function(e){var t;return this.selectedSet.has(e)?(this.selectedSet.delete(e),t=!1):(this.selectedSet.add(e),t=!0,geometryStatus("select vertex: "+e.index)),e.setSelect(t),t},Pt.prototype._resetSelectVertex=function(){var e=this.snapshotSelectionVertex();for(let e of this.selectedSet)e.resetState();return this.selectedSet=new Set,e},Pt.prototype._selectVertexMore=function(){const e=this.snapshotSelectionVertex(),t=this;for(let o of e.vertices)o.eachInEdge(function(e){t.selectedSet.has(e.origin)||t.selectVertex(e.origin)});return e},Pt.prototype._selectVertexLess=function(){const e=this.snapshotSelectionVertex();for(let t of e.vertices)for(let o of t.oneRing())if(!e.vertices.has(o)){this.selectVertex(t);break}return e},Pt.prototype._selectVertexAll=function(){const e=this.snapshotSelectionVertex();for(let t of this.geometry.vertices)t.isLive()&&!e.vertices.has(t)&&this.selectVertex(t);return e},Pt.prototype._selectVertexInvert=function(){const e=this.snapshotSelectionVertex();for(let e of this.geometry.vertices)e.isLive()&&this.selectVertex(e);return e},Pt.prototype._selectVertexAdjacent=function(){return this._selectVertexMore()},Pt.prototype._selectVertexSimilar=function(){const e=this.snapshotSelectionVertex(),t=new SimilarVertex(e.vertices);for(let o of this.geometry.vertices)o.isLive()&&!e.vertices.has(o)&&t.find(o)&&this.selectVertex(o);return e},Pt.prototype.changeFromVertexToFaceSelect=function(){const e=this.snapshotSelectionVertex();var t=this,o=this._resetSelectVertex();for(let e of o.vertices)e.eachOutEdge(function(e){t.selectedSet.has(e.face)||t.selectFace(e.face)});return e},Pt.prototype.changeFromVertexToEdgeSelect=function(){const e=this.snapshotSelectionVertex();var t=this,o=this._resetSelectVertex();for(let e of o.vertices)e.eachOutEdge(function(e){t.selectedSet.has(e.wingedEdge)||t.selectEdge(e)});return e},Pt.prototype.changeFromVertexToBodySelect=function(){const e=this.snapshotSelectionVertex();return this.hasSelection()&&(this._resetSelectVertex(),this.selectBody()),e},Pt.prototype.changeFromVertexToMultiSelect=function(){const e=this.snapshotSelectionVertex();return this._resetSelectVertex(),e},Pt.prototype.restoreFromVertexToFaceSelect=function(e){e?(this._resetSelectVertex(),this.restoreFaceSelection(e)):this.changeFromVertexToFaceSelect()},Pt.prototype.restoreFromVertexToEdgeSelect=function(e){e?(this._resetSelectVertex(),this.restoreEdgeSelection(e)):this.changeFromVertexToEdgeSelect()},Pt.prototype.restoreFromVertexToBodySelect=function(e){e?(this._resetSelectVertex(),this.restoreBodySelection(e)):this.changeFromVertexToBodySelect()},Pt.prototype.restoreFromVertexToMultiSelect=function(e){this.changeFromVertexToMultiSelect()},Pt.prototype.changeFromMultiToEdgeSelect=function(){return{}},Pt.prototype.changeFromMultiToFaceSelect=function(){return{}},Pt.prototype.changeFromMultiToVertexSelect=function(){return{}},Pt.prototype.changeFromMultiToBodySelect=function(){return{}},Pt.prototype.restoreFromMultiToEdgeSelect=function(e){},Pt.prototype.restoreFromMultiToFaceSelect=function(e){},Pt.prototype.restoreFromMultiToVertexSelect=function(e){},Pt.prototype.restoreFromMultiToBodySelect=function(e){},Pt.prototype.dragSelectEdge=function(e,t){var o=e.wingedEdge;if(this.selectedSet.has(o)){if(!1===t)return this.selectedSet.delete(o),o.selectEdge(!1),!0}else if(!0===t)return this.selectedSet.add(o),o.selectEdge(!0),!0;return!1},Pt.prototype.selectEdge=function(e){var t,o=e.wingedEdge;return this.selectedSet.has(o)?(this.selectedSet.delete(o),t=!1):(this.selectedSet.add(o),t=!0,geometryStatus("select edge: "+o.index)),o.selectEdge(t),t},Pt.prototype.computeSnapshot=function(e){for(let t of e.faces)t.update()},Pt.prototype.restoreMoveSelection=function(e){let t=0;for(let o of e.vertices)vec3.copy(o,e.position.subarray(t,t+3)),t+=3;this.computeSnapshot(e)},Pt.prototype.moveSelection=function(e,t){if(e.direction){let o=0;for(let n of e.vertices)vec3.scaleAndAdd(n,n,e.direction.subarray(o,o+3),t),o+=3}else for(let o of e.vertices)vec3.add(o,o,t);this.computeSnapshot(e)},Pt.prototype.rotateSelection=function(e,t,o){const n=vec3.create(),r=vec3.fromValues(1,1,1);this.transformSelection(e,(e,i)=>{mat4.fromRotationTranslationScaleOrigin(e,t,n,r,o||i)})},Pt.prototype.scaleSelection=function(e,t,o){const n=vec3.fromValues(o[0]?t*o[0]:1,o[1]?t*o[1]:1,o[2]?t*o[2]:1);this.transformSelection(e,(e,t)=>{mat4.fromScaling(e,n)})},Pt.prototype.transformSelection=function(e,t){const o=mat4.create(),n=e.vertices[Symbol.iterator]();for(let r of e.matrixGroup){t(o,r.center);for(let e=0;e<r.count;e++){const e=n.next().value;vec3.transformMat4(e,e,o)}}this.computeSnapshot(e)},Pt.prototype.snapshotPositionAll=function(){return this.snapshotPosition(this.geometry.vertices)},Pt.prototype.snapshotPosition=function(e,t){var o={faces:new Set,vertices:null,wingedEdges:new Set,position:null,direction:t};o.vertices=e;const n=e.length?e.length:e.size;o.position=new Float32Array(3*n);let r=0;for(let e of o.vertices)e.eachOutEdge(function(e){e.isNotBoundary()&&!o.faces.has(e.face)&&o.faces.add(e.face),o.wingedEdges.has(e.wingedEdge)||o.wingedEdges.add(e.wingedEdge)}),o.position.set(e,r),r+=3;return o},Pt.prototype.snapshotEdgePosition=function(){var e=new Set;for(let o of this.selectedSet)for(let n of o){var t=n.origin;e.has(t)||e.add(t)}return this.snapshotPosition(e)},Pt.prototype.snapshotFacePosition=function(){var e=new Set;for(let t of this.selectedSet)t.eachVertex(function(t){e.has(t)||e.add(t)});return this.snapshotPosition(e)},Pt.prototype.snapshotVertexPosition=function(){const e=new Set(this.selectedSet);return this.snapshotPosition(e)},Pt.prototype.snapshotBodyPosition=function(){let e=new Set;return this.hasSelection()&&(e=new Set(this.geometry.vertices)),this.snapshotPosition(e)},Pt.prototype.snapshotFacePositionAndNormal=function(){const e=new Set;let t=new Map;const o=[0,0,0];for(let n of this.selectedSet)n.eachVertex(function(r){if(e.has(r)){const e=t.get(r);n.getNormal(o),vec3.dot(e,o)<.999&&vec3.add(e,e,o)}else{e.add(r);const o=[0,0,0];n.getNormal(o),t.set(r,o)}});const n=new Float32Array(3*e.size);let r=0;for(let[e,o]of t)n[r++]=o[0],n[r++]=o[1],n[r++]=o[2];return this.snapshotPosition(e,n)},Pt.prototype.snapshotVertexPositionAndNormal=function(){const e=new Set(this.selectedSet),t=new Float32Array(3*e.size);t.fill(0);let o=0;for(let n of e){let e=t.subarray(o,o+3);n.eachOutEdge(function(t){t.isNotBoundary()&&vec3.add(e,e,t.face.normal)}),vec3.normalize(e,e),o+=3}return this.snapshotPosition(e,t)},Pt.prototype.snapshotEdgePositionAndNormal=function(){const e=new Set,t=new Map;vec3.create();for(let o of this.selectedSet){const n=o.left.face,r=o.right.face;for(let i of o){let o,s=i.origin;e.has(s)?o=t.get(s):(e.add(s),o=new Set,t.set(s,o)),null!==n&&o.add(n),null!==r&&o.add(r)}}const o=new Float32Array(3*e.size);o.fill(0);let n=0;for(let[e,r]of t){let e=o.subarray(n,n+3);for(let t of r)vec3.add(e,e,t.normal);n+=3}return this.snapshotPosition(e,o)},Pt.prototype.snapshotTransformEdgeGroup=function(){const e=new Set,t=[];let o=this.geometry.findEdgeGroup(this.selectedSet);for(let n of o){let o=0;const r=vec3.create();for(let t of n)for(let n of t.eachVertex())e.has(n)||(e.add(n),o++,vec3.add(r,r,n));vec3.scale(r,r,1/o),t.push({center:r,count:o})}const n=this.snapshotPosition(e);return n.matrixGroup=t,n},Pt.prototype.snapshotTransformFaceGroup=function(){const e=new Set,t=[];let o=ct.findFaceGroup(this.getSelectedSorted());const n=vec3.create();for(let r of o){let o=0;vec3.set(n,0,0,0);for(let t of r)t.eachVertex(function(t){e.has(t)||(e.add(t),o++,vec3.add(n,n,t))});vec3.scale(n,n,1/o),t.push({center:n,count:o})}const r=this.snapshotPosition(e);return r.matrixGroup=t,r},Pt.prototype.snapshotTransformBodyGroup=function(){let e=new Set;const t=vec3.create();if(this.hasSelection()){for(let o of this.geometry.vertices)o.isLive()&&(e.add(o),vec3.add(t,t,o));vec3.scale(t,t,1/e.size)}const o=this.snapshotPosition(e);return o.matrixGroup=[{center:t,count:e.size}],o},Pt.prototype.snapshotTransformVertexGroup=function(){let e=new Set;const t=vec3.create();if(this.hasSelection()){for(let o of this.selectedSet)e.add(o),vec3.add(t,t,o);vec3.scale(t,t,1/e.size)}const o=this.snapshotPosition(e);return o.matrixGroup=[{center:t,count:e.size}],o},Pt.prototype._resetSelectEdge=function(){const e=this.snapshotSelectionEdge();for(let e of this.selectedSet)e.selectEdge(!1);return this.selectedSet=new Set,e},Pt.prototype._selectEdgeMore=function(){const e=this.snapshotSelectionEdge();for(let t of e.wingedEdges)for(let e of t)e.eachEdge(e=>{this.selectedSet.has(e.wingedEdge)||this.selectEdge(e)});return e},Pt.prototype._selectEdgeLess=function(){const e=this.snapshotSelectionEdge();for(let t of e.wingedEdges)for(let o of t.oneRing())if(!e.wingedEdges.has(o)){this.selectEdge(t.left);break}return e},Pt.prototype._selectEdgeAll=function(){const e=this.snapshotSelectionEdge();for(let t of this.geometry.edges)t.isLive()&&!e.wingedEdges.has(t)&&this.selectEdge(t.left);return e},Pt.prototype._selectEdgeInvert=function(){const e=this.snapshotSelectionEdge();for(let e of this.geometry.edges)e.isLive()&&this.selectEdge(e.left);return e},Pt.prototype._selectEdgeAdjacent=function(){const e=this.snapshotSelectionEdge();for(let t of e.wingedEdges)for(let e of t.adjacent())this.selectedSet.has(e)||this.selectEdge(e.left);return e},Pt.prototype._selectEdgeSimilar=function(){const e=this.snapshotSelectionEdge(),t=new SimilarWingedEdge(e.wingedEdges);for(let o of this.geometry.edges)o.isLive&&!e.wingedEdges.has(o)&&t.find(o)&&this.selectEdge(o.left);return e},Pt.prototype.changeFromEdgeToFaceSelect=function(){const e=this.snapshotSelectionEdge(),t=this._resetSelectEdge();for(let e of t.wingedEdges)for(let t of e)this.selectedSet.has(t.face)||this.selectFace(t.face);return e},Pt.prototype.changeFromEdgeToVertexSelect=function(){const e=this.snapshotSelectionEdge(),t=this._resetSelectEdge();for(let e of t.wingedEdges)for(let t of e)this.selectedSet.has(t.origin)||this.selectVertex(t.origin);return e},Pt.prototype.changeFromEdgeToBodySelect=function(){const e=this.snapshotSelectionEdge();return this.hasSelection()&&(this._resetSelectEdge(),this.selectBody()),e},Pt.prototype.changeFromEdgeToMultiSelect=function(){const e=this.snapshotSelectionEdge();return this.hasSelection()&&this._resetSelectEdge(),e},Pt.prototype.restoreFromEdgeToFaceSelect=function(e){e?(this._resetSelectEdge(),this.restoreFaceSelection(e)):this.changeFromEdgeToFaceSelect()},Pt.prototype.restoreFromEdgeToVertexSelect=function(e){e?(this._resetSelectEdge(),this.restoreVertexSelection(e)):this.changeFromEdgeToVertexSelect()},Pt.prototype.restoreFromEdgeToBodySelect=function(e){e?(this._resetSelectEdge(),this.restoreBodySelection(e)):this.changeFromEdgeToBodySelect()},Pt.prototype.restoreFromEdgeToMultiSelect=function(e){this.changeFromEdgeToMultiSelect()},Pt.prototype._setFaceSelectionOff=function(e){e.setSelect(!1),this.selectedSet.delete(e)},Pt.prototype._setFaceSelectionOn=function(e){e.setSelect(!0),this.selectedSet.add(e)},Pt.prototype.dragSelectFace=function(e,t){if(this.selectedSet.has(e)){if(!1===t)return this._setFaceSelectionOff(e),!0}else if(!0===t)return this._setFaceSelectionOn(e),!0;return geometryStatus("polygon face # "+e.index),!1},Pt.prototype.selectFace=function(e){var t;return this.selectedSet.has(e)?(this._setFaceSelectionOff(e),y("faceSelectOff",e.index),t=!1):(this._setFaceSelectionOn(e),y("faceSelectOn",e.index),t=!0),geometryStatus("polygon face # "+e.index),t},Pt.prototype._resetSelectFace=function(){const e=this.snapshotSelectionFace();this.selectedSet=new Set;for(let t of e.selectedFaces)t.setSelect(!1);return e},Pt.prototype._selectFaceMore=function(){const e=this.snapshotSelectionFace();for(let t of e.selectedFaces)for(let e of t.oneRing())null===e||this.selectedSet.has(e)||this.selectFace(e);return e},Pt.prototype._selectFaceLess=function(){const e=this.snapshotSelectionFace();for(let t of e.selectedFaces)for(let o of t.adjacent())if(!e.selectedFaces.has(o)){this.selectFace(t);break}return e},Pt.prototype._selectFaceAll=function(){const e=this.snapshotSelectionFace();for(let t of this.geometry.faces)t.isLive()&&!e.selectedFaces.has(t)&&this.selectFace(t);return e},Pt.prototype._selectFaceInvert=function(){const e=this.snapshotSelectionFace();for(let e of this.geometry.faces)e.isLive()&&this.selectFace(e);return e},Pt.prototype._selectFaceAdjacent=function(){const e=this.snapshotSelectionFace();for(let t of e.selectedFaces)for(let e of t.adjacent())null===e||this.selectedSet.has(e)||this.selectFace(e);return e},Pt.prototype._selectFaceSimilar=function(){const e=this.snapshotSelectionFace(),t=new SimilarFace(e.selectedFaces);for(let o of this.geometry.faces)o.isLive()&&!e.selectedFaces.has(o)&&t.find(o)&&this.selectFace(o);return e},Pt.prototype.changeFromFaceToEdgeSelect=function(){const e=this.snapshotSelectionFace();var t=this,o=this._resetSelectFace();for(let e of o.selectedFaces)e.eachEdge(function(e){t.selectedSet.has(e.wingedEdge)||t.selectEdge(e)});return e},Pt.prototype.changeFromFaceToVertexSelect=function(){const e=this.snapshotSelectionFace();var t=this,o=this._resetSelectFace();for(let e of o.selectedFaces)e.eachVertex(function(e){t.selectedSet.has(e)||t.selectVertex(e)});return e},Pt.prototype.changeFromFaceToBodySelect=function(){const e=this.snapshotSelectionFace();return this.hasSelection()&&(this._resetSelectFace(),this.selectBody()),e},Pt.prototype.changeFromFaceToMultiSelect=function(){const e=this.snapshotSelectionFace();return this.hasSelection()&&this._resetSelectFace(),e},Pt.prototype.restoreFromFaceToEdgeSelect=function(e){e?(this._resetSelectFace(),this.restoreEdgeSelection(e)):this.changeFromFaceToEdgeSelect()},Pt.prototype.restoreFromFaceToVertexSelect=function(e){e?(this._resetSelectFace(),this.restoreVertexSelection(e)):this.changeFromFaceToVertexSelect()},Pt.prototype.restoreFromFaceToBodySelect=function(e){e?(this._resetSelectFace(),this.restoreBodySelection(e)):this.changeFromFaceToBodySelect()},Pt.prototype.restoreFromFaceToMultiSelect=function(e){this.changeFromFaceToMultiSelect()},Pt.prototype.extractFace=function(){var e=this.geometry.vertices.size,t=(this.geometry.edges.size,this.geometry.faces.size),o=this.geometry.extractPolygon(this.selectedSet);return this._resizeBoundingSphere(t),this._resizePreview(e,t),o},Pt.prototype.creaseEdge=function(){return this.extrudeEdge(!0)},Pt.prototype.extrudeEdge=function(e=!1){const t=this._getGeometrySize();let o=new Set,n=[];function r(e){for(let t of e.extrude)o.add(t.wingedEdge);for(let t of e.lift)n.push(t)}const i=vec3.create();let s=new Set,a=new Set,l=[],c=[],d=[],u=new Set;for(let e of this.selectedSet)for(let t of e){if(u.has(t))continue;let e=t.next;for(;e!==t;){if(!this.selectedSet.has(e.wingedEdge)){for(;!this.selectedSet.has(e.next.wingedEdge);)e=e.next;break}e=e.next}if(e===t){for(let e of t.face.hEdges())u.add(e);let o=this.geometry.liftCornerEdge(e);n.push(o.pair),r(this.geometry.extrudeEdge(o.pair,o))}else{t=e;do{let o=e;for(e=e.next;this.selectedSet.has(e.wingedEdge);)u.add(e),e=e.next;let r=!1,f=!1,h=e;if(a.has(e.pair)?a.delete(e.pair):h===h.pair.next.pair.next?r=!0:(vec3.lerp(i,e.origin,e.destination(),.2),h=e=this.geometry.splitEdge(e,i),s.add(e),n.push(e.pair)),s.has(o.pair))s.delete(o.pair);else if(o===o.next.pair.next.pair)f=!0;else{vec3.lerp(i,o.origin,o.destination(),.8);let e=this.geometry.splitEdge(o.pair,i).pair;a.add(e),n.push(e),o===t&&(t=e),o=e}let p={start:o,end:h};for(l.push(p),r&&c.push(p),f&&d.push(p);!this.selectedSet.has(e.next.wingedEdge);)e=e.next}while(e!==t)}}for(let e of c){let t=e.end;t.face.getCentroid(i),vec3.lerp(i,t.origin,i,.2);const o=this.geometry.addVertex(i);t=this.geometry._liftDanglingEdge(t.prev(),o),n.push(t.pair),e.end=t}for(let e of d){let t=e.start;t.face.getCentroid(i),vec3.lerp(i,t.destination(),i,.2);const o=this.geometry.addVertex(i);t=this.geometry._liftDanglingEdge(t,o),n.push(t.pair),e.start=t.pair}for(let e of l){r(this.geometry.extrudeEdge(e.start,e.end))}for(let t of s){let r=t.pair;if(e){let e=r.next;const t=e.pair.next.pair;if(a.has(t)&&e.face.numberOfVertex>3&&e.pair.face.numberOfVertex>3){if(a.has(e.next.pair)&&s.has(e.pair.prev().pair)){vec3.lerp(i,e.origin,e.destination(),.5);let t=this.geometry.splitEdge(e,i);n.push(t.pair),e=t}let t=this.geometry.insertEdge(e,r);o.add(t.wingedEdge),this.geometry.slideToNext(e.pair);continue}}for(;;){if(r=r.next.pair,a.has(r)){let e=this.geometry.insertEdge(r.pair,t.pair);o.add(e.wingedEdge);break}{vec3.lerp(i,r.destination(),r.origin,.2);let e=this.geometry.splitEdge(r.pair,i);r=e.pair,n.push(r);let s=this.geometry.insertEdge(e,t.pair);o.add(s.wingedEdge)}t=r.pair}}return this._updatePreviewAll(t,this.geometry.affected),{collapsibleWings:o,liftEdges:n}},Pt.prototype.undoExtrudeEdge=function(e){const t=this._getGeometrySize();if(e.dissolveEdges)for(let t of e.dissolveEdges)t.wingedEdge.isLive()&&this.geometry.dissolveEdge(t,e.collapsibleWings);for(let t of e.liftEdges)this.geometry.collapseEdge(t,e.collapsibleWings);this._updatePreviewAll(t,this.geometry.affected)},Pt.prototype.extrudeVertex=function(){const e=this._getGeometrySize(),t=[],o=[],n=vec3.create();for(let e of this.selectedSet){let r,i=null,s=e.outEdge;do{vec3.lerp(n,s.origin,s.destination(),.25);let e=this.geometry.splitEdge(s,n);if(t.push(e),s=e.pair.next,i){let t=this.geometry.insertEdge(e,i);o.push(t),i=e.pair}else r=e,i=e.pair}while(s!==r);let a=this.geometry.insertEdge(r,i);o.push(a)}return this._updatePreviewAll(e,this.geometry.affected),{insertEdges:o,splitEdges:t}},Pt.prototype.undoExtrudeVertex=function(e){const t=this._getGeometrySize();for(let t of e.insertEdges)this.geometry.removeEdge(t);for(let t of e.splitEdges)this.geometry.collapseEdge(t.pair);this._updatePreviewAll(t,this.geometry.affected)},Pt.prototype.extrudeFace=function(e){const t=this._getGeometrySize();e||((e={}).edgeLoops=ct.findContours(this.selectedSet)),e.edgeLoops=this.geometry.liftContours(e.edgeLoops),e.extrudeEdges=this.geometry.extrudeContours(e.edgeLoops),this._updatePreviewAll(t,this.geometry.affected);const o=this._resetSelectFace();for(let e of o.selectedFaces)this.selectFace(e);return e},Pt.prototype.collapseExtrudeEdge=function(e){const t=e.extrudeEdges,o=new Set,n=this._getGeometrySize();for(let e of t)e.origin.eachOutEdge(function(e){o.add(e.face)}),this.geometry.collapseEdge(e);this._updatePreviewAll(n,this.geometry.affected);const r=this._resetSelectFace();for(let e of r.selectedFaces)this.selectFace(e);for(let e of o)e.isLive()&&e.update()},Pt.prototype.findExtFaceContours=function(){const e=new Set,t=new Set,o=[];for(let n of this.selectedSet)for(let r of n.hEdges()){let n=r.pair;if(!e.has(n)&&!this.selectedSet.has(n.face)){const r=[];let i=n;do{r.push(i),e.add(i);let o=!0;for(;!this.selectedSet.has(i.next.pair.face);)i=i.next.pair,o=!1;o&&t.add(i.face),i=i.next}while(i!==n);o.push(r)}}return{contourLoops:o,cornerFaces:t}},Pt.prototype.bumpFace=function(){const e=this._getGeometrySize(),t=this.findExtFaceContours().contourLoops,o=vec3.create(),n=new Map;let r=new Set,i=new Set,s=new Set,a=this;function l(e,t){let o=a.geometry.insertEdge(e,t);r.add(o.wingedEdge),i.add(o.pair)}for(let e of t){let t=null,i=null,a=e[e.length-1];for(let c of e){let e=a.next;if(e!==c)do{let a=e;if(r.has(e.next.wingedEdge)||s.has(e.next))if(i)e.next.next!==i&&l(a,i);else if(null===t)t=e;else{n.get(e.face).add(e)}else if(vec3.lerp(o,e.origin,e.destination(),.5),a=this.geometry.splitEdge(e,o),s.add(a.pair),i)l(a,i);else if(null===t)t=a;else{n.get(a.face).add(a)}i=a.pair,e=a.pair.next}while(e!==c);else{n.has(e.face)||n.set(e.face,new Set);const o=n.get(e.face);i&&(o.add(i.prev()),i=null),o.add(a),null===t&&(t=void 0)}a=c}if(i){if(n.has(i.face)){n.get(i.face).add(i.prev())}t&&t.next.next!==i&&l(t,i)}}for(let[e,t]of n){const o=this.geometry.insertFan(e,t);for(let e of o)r.add(e.wingedEdge),i.add(e)}return this._updatePreviewAll(e,this.geometry.affected),{liftEdges:s,collapsibleWings:r,dissolveEdges:i}},Pt.prototype.cutEdge=function(e){const t=this.selectedSet,o=this._getGeometrySize(),n=[],r=[];let i=vec3.create(),s=vec3.create();for(let o of t){let t=o.left;vec3.sub(i,t.origin,t.destination());for(let o=1;o<e;++o){const a=(e-o)/e;vec3.scale(s,i,a),vec3.add(s,t.destination(),s);const l=this.geometry.splitEdge(t,s);n.push(t.origin),r.push(l.pair)}}return this._updatePreviewAll(o,this.geometry.affected),{vertices:n,halfEdges:r}},Pt.prototype.collapseSplitOrBevelEdge=function(e){const t=this._getGeometrySize();for(let t of e.halfEdges)t.wingedEdge.isLive()&&this.geometry.collapseEdge(t,e.collapsibleWings);this._updatePreviewAll(t,this.geometry.affected)},Pt.prototype.connectVertex=function(){const e=this._getGeometrySize(),t=this.geometry.connectVertex(this.selectedSet),o=[];for(let e of t)o.push(e.wingedEdge);return this._updatePreviewAll(e,this.geometry.affected),{halfEdges:t,wingedEdges:o}},Pt.prototype.dissolveConnect=function(e){const t=e.halfEdges,o=this._getGeometrySize();for(let e=t.length-1;e>=0;--e){const o=t[e];this.geometry.removeEdge(o.pair)}this._updatePreviewAll(o,this.geometry.affected)},Pt.prototype.dissolveSelectedEdge=function(){const e=[],t=this._getGeometrySize();for(let t of this.selectedSet){let o=this.geometry.dissolveEdge(t.left),n={halfEdge:t.left,undo:o};e.push(n)}return this.selectedSet.clear(),this._updatePreviewAll(t,this.geometry.affected),e},Pt.prototype.reinsertDissolveEdge=function(e){const t=this._getGeometrySize();for(let t=e.length-1;t>=0;--t){let o=e[t];this.geometry.restoreDissolveEdge(o.undo),this.selectEdge(o.halfEdge)}this._updatePreviewAll(t,this.geometry.affected)},Pt.prototype.collapseSelectedEdge=function(){const e=[],t=[],o=this._getGeometrySize(),n=new Map;for(let e of this.selectedSet){let o=null;if(e.isLive()){let t,r=e.left.origin;n.has(r)?(t=n.get(r),n.delete(r),vec3.add(t.pt,t.pt,r),t.count++):(t={pt:new Float32Array(3),count:1},vec3.copy(t.pt,r));let i=e.right.origin;if(n.has(i)){const e=n.get(i);vec3.add(e.pt,t.pt,e.pt),e.count+=t.count}else n.set(i,t);o=this.geometry.collapseEdge(e.left)}let r={halfEdge:e.left,undo:o};t.push(r)}this.selectedSet.clear();const r=[];for(let[t,o]of n){r.push(t);const n=new Float32Array(3);vec3.copy(n,t),e.push({vertex:t,savePt:n}),vec3.add(o.pt,o.pt,n),vec3.scale(o.pt,o.pt,1/(o.count+1)),t.set(o.pt),this.geometry.addAffectedEdgeAndFace(t)}return this._updatePreviewAll(o,this.geometry.affected),{collapse:{edges:t,vertices:e},vertices:r}},Pt.prototype.restoreCollapseEdge=function(e){const t=e.collapse,o=this._getGeometrySize();this.selectedSet.clear();const n=t.edges;for(let e=n.length-1;e>=0;--e){let t=n[e];t.undo&&this.geometry.restoreCollapseEdge(t.undo)}for(let e of n)this.selectEdge(e.halfEdge);const r=t.vertices;for(let e of r)e.vertex.set(e.savePt),this.geometry.addAffectedEdgeAndFace(e.vertex);this._updatePreviewAll(o,this.geometry.affected)},Pt.prototype.dissolveSelectedFace=function(){const e=this._getGeometrySize(),t=new Set;for(let e of this.selectedSet)e.eachEdge(function(e){t.add(e.wingedEdge)});const o=ct.findContours(this.selectedSet);for(let e of o)for(let o of e){let e=o.outer;t.has(e.wingedEdge)&&t.delete(e.wingedEdge)}const n=[];for(let e of t)n.unshift(this.geometry.dissolveEdge(e.left));const r=this.selectedSet,i=new Set;for(let e of this.selectedSet)e.isLive()&&i.add(e);return this.selectedSet=i,this._updatePreviewAll(e,this.geometry.affected),{edges:n,selection:r}},Pt.prototype.undoDissolveFace=function(e){const t=this._getGeometrySize();for(let t of e.edges)this.geometry.restoreDissolveEdge(t);this.selectedSet.clear();for(let t of e.selection)this.selectFace(t);this._updatePreviewAll(t,this.geometry.affected)},Pt.prototype.collapseSelectedFace=function(){const e=this.selectedSet;this.changeFromFaceToEdgeSelect();const t=this.collapseSelectedEdge();return t.selectedFaces=e,t},Pt.prototype.undoCollapseFace=function(e){this.restoreCollapseEdge(e),this._resetSelectEdge()},Pt.prototype.dissolveSelectedVertex=function(){const e=this._getGeometrySize(),t={array:[],selectedFaces:[]};for(let e of this.selectedSet){let o=this.geometry.dissolveVertex(e);t.array.unshift(o),t.selectedFaces.push(o.polygon)}return this._resetSelectVertex(),this._updatePreviewAll(e,this.geometry.affected),t},Pt.prototype.undoDissolveVertex=function(e){const t=this._getGeometrySize();for(let t of e.array)this.geometry.restoreDissolveVertex(t),this.selectVertex(t.vertex);this._updatePreviewAll(t,this.geometry.affected)},Pt.prototype.bevelEdge=function(){const e=this._getGeometrySize(),t=this.selectedSet,o=this.geometry.bevelEdge(t);o.wingedEdges=new Set,o.faces=new Set;for(let e of o.vertices)for(let t of e.edgeRing())o.wingedEdges.add(t.wingedEdge),o.faces.add(t.face);return this._updatePreviewAll(e,this.geometry.affected),o},Pt.prototype.bevelFace=function(){const e=this._getGeometrySize(),t=this.selectedSet;let o=new Set;for(let e of t)for(let t of e.hEdges())o.add(t.wingedEdge);const n=this.geometry.bevelEdge(o);n.wingedEdges=new Set,n.faces=new Set;for(let e of n.vertices)for(let t of e.edgeRing())n.wingedEdges.add(t.wingedEdge),n.faces.add(t.face);this._updatePreviewAll(e,this.geometry.affected);const r=this._resetSelectFace();for(let e of r.selectedFaces)this.selectFace(e);return n},Pt.prototype.bevelVertex=function(){const e=this._getGeometrySize(),t=this.selectedSet,o=this.geometry.bevelVertex(t);o.wingedEdges=new Set,o.faces=new Set;for(let e of o.vertices)for(let t of e.edgeRing())o.wingedEdges.add(t.wingedEdge),o.faces.add(t.face);return this._updatePreviewAll(e,this.geometry.affected),o},Pt.prototype.edgeLoop=function(e){let t=0;const o=new Set(this.selectedSet),n=[];for(let r of o)for(let o of r){for(;(o=o.next.pair.next)&&!this.selectedSet.has(o.wingedEdge)&&4===o.destination().numberOfEdge();)++t%e==0&&(this.selectEdge(o),n.push(o))}return n},Pt.prototype.edgeRing=function(e){let t=0;const o=new Set(this.selectedSet),n=[];for(let r of o)for(let o of r){for(;(o=o.pair.next.next)&&!this.selectedSet.has(o.wingedEdge)&&o.next.next.next.next===o;)++t%e==0&&(this.selectEdge(o),n.push(o))}return n},Pt.prototype.bridge=function(e,t){if(2===this.selectedSet.size){for(let o of e.oneRing())if(o===t)return null;const o=this._getGeometrySize(),n=vec3.create(),r=this.geometry.bridgeFace(e,t,n);return r.selectedFaces=this.selectedSet,this._resetSelectFace(),this._updatePreviewAll(o,this.geometry.affected),r}return null},Pt.prototype.undoBridge=function(e){if(e){const t=this._getGeometrySize();this.geometry.undoBridgeFace(e),this._updatePreviewAll(t,this.geometry.affected)}},Pt.prototype.insetFace=function(){const e=this._getGeometrySize(),t={};t.edgeLoops=this.geometry.findInsetContours(this.selectedSet),t.edgeLoops=this.geometry.liftContours(t.edgeLoops),t.extrudeEdges=this.geometry.extrudeContours(t.edgeLoops);let o=0;for(let e of this.selectedSet)o+=e.numberOfVertex;t.vertices=[],t.faces=new Set,t.wingedEdges=new Set,t.position=new Float32Array(3*o),t.direction=new Float32Array(3*o),t.vertexLimit=Number.MAX_SAFE_INTEGER;let n=0;for(let e of this.selectedSet){let o=null;t.faces.add(e);for(let r of e.hEdges()){t.vertices.push(r.origin),t.faces.add(r.pair.face),t.wingedEdges.add(r.wingedEdge),t.wingedEdges.add(r.pair.next.wingedEdge);let e=t.position.subarray(n,n+3),i=t.direction.subarray(n,n+3);n+=3,vec3.copy(e,r.origin),o||(o=r.prev()),vec3.scale(i,r.destination(),.5),vec3.scaleAndAdd(i,i,o.origin,.5),vec3.sub(i,i,r.origin);const s=vec3.length(i);s<t.vertexLimit&&(t.vertexLimit=s),vec3.normalize(i,i),o=r}}this._updatePreviewAll(e,this.geometry.affected);const r=this._resetSelectFace();for(let e of r.selectedFaces)this.selectFace(e);return t},Pt.prototype.invertBody=function(){this.geometry.invert()},Pt.prototype.flipBodyAxis=function(e,t){this.geometry.flip(e,t),this.geometry.invert()},Pt.prototype.bodyCentroid=function(){const e=vec3.create();let t=0;for(let o of this.geometry.vertices)vec3.add(e,e,o),++t;return t>0&&vec3.scale(e,e,1/t),e},Pt.prototype.weldableVertex=function(e){if(1==this.selectedSet.size){const t=this.selectedSet.values().next().value.outEdge;let o=t;do{if(o.destination()===e)return o;o=o.pair.next}while(o!==t)}return!1},Pt.prototype.weldVertex=function(e){this.selectVertex(e.origin),this.selectVertex(e.destination());let t=this.geometry.collapseEdge(e);return this._updatePreviewAll(),t},Pt.prototype.undoWeldVertex=function(e){this.geometry.restoreCollapseEdge(e),this.selectVertex(e.hEdge.destination()),this.selectVertex(e.hEdge.origin),this._updatePreviewAll()},Pt.prototype.intrudeFace=function(){const e={};if(0==this.selectedSet.size)return e;e.dissolve=this.dissolveSelectedFace();const t=new Map,o=e=>{let o=t.get(e);return o||(o=this.geometry.addVertex(e),t.set(e,o)),o.index},n=[],r=[],i=Array.from(this.geometry.faces);for(let e of i){const t=[];for(let n of e.hEdges())t.push(o(n.origin));if(this.selectedSet.has(e)){let o,n,i=0;for(let s of e.hEdges()){const e=s.origin.index,a=t[i];i>0&&r.push([o,e,a,n]),++i,o=e,n=a}r.push([o,e.halfEdge.origin.index,t[0],n])}else t.reverse(),n.push(this.geometry.addPolygon(t,tt.default))}this._updatePreviewAll(),e.holed=this.holeSelectedFace();for(let e of n)this.selectFace(e);e.invert=n,e.connect=[];for(let t of r)e.connect.push(this.geometry.addPolygon(t,tt.default));return this._updatePreviewAll(),e},Pt.prototype.undoIntrudeFace=function(e){for(let t of e.connect)this.geometry.makeHole(t);for(let t of e.invert)this.selectFace(t);const t=new Set;for(let o of e.invert){for(let e of o.hEdges())this.geometry._freeVertex(e.origin),t.add(e.wingedEdge);this.geometry._freePolygon(o)}for(let e of t)this.geometry._freeEdge(e.left);this.undoHoleSelectedFace(e.holed),this.undoDissolveFace(e.dissolve)},Pt.prototype.holeSelectedFace=function(){const e=new Set(this.selectedSet),t=[];for(let o of e)this.selectFace(o),t.push(this.geometry.makeHole(o));return t},Pt.prototype.undoHoleSelectedFace=function(e){for(let t of e){const e=this.geometry.undoHole(t);this.selectFace(e)}},Pt.prototype.loopCut=function(){const e=new Set(this.geometry.faces);let t;const o=n=>{t.add(n),e.delete(n);for(let t of n.hEdges())!this.selectedSet.has(t.wingedEdge)&&e.has(t.pair.face)&&o(t.pair.face)};let n=[];for(let r of this.selectedSet)for(let i of r)e.has(i.face)&&(t=new Set,o(i.face),n.push(t));if(n.length<2)return geometryStatus("less than 2 partitions"),null;n=n.sort((e,t)=>e.size-t.size);const r=new Set(this.selectedSet);for(let e of r)this.selectEdge(e.left);const i={separateCages:[],fillFaces:[],contourLoops:[],selectedSet:r},s=new Set;for(let e=0;e<n.length;++e){const t=n[e];let o=[],r=this;if(e!==n.length-1){let n=ct.findContours(t);for(let a of n)if(a.length>0&&!s.has(a[0].outer.face)){this.geometry.liftContour(a);const n=this.geometry._createPolygon(a[0].outer,a.size);o.push(n),r=this.detachFace(t,e),i.contourLoops.push(a)}}for(let e of s)r.geometry.faces.has(e)&&(r.selectedSet.add(e),s.delete(e));r.dissolveSelectedFace(),i.fillFaces=i.fillFaces.concat(Array.from(r.selectedSet)),r.selectedSet=new Set;for(let e of o)s.add(e);r!==this&&i.separateCages.push(r)}return i},Pt.prototype.undoLoopCut=function(e){this.merge(e.separateCages);for(let t of e.fillFaces)this.geometry.removePolygon(t);for(let t of e.contourLoops)this.geometry.weldContour(t);for(let t of e.selectedSet)this.selectEdge(t.left)},Pt.prototype._putOn=function(e){let t=this.selectedSet.values().next().value;const o=t.center,n=vec3.create();vec3.copy(n,t.normal),vec3.negate(n,n);const r=mat4.create();!function(e,t,o){let n=vec3.dot(t,o);if(Math.abs(n)>1-Ae){const n=vec3.fromValues(Math.abs(t[0]),Math.abs(t[1]),Math.abs(t[2]));n[0]<n[1]?n[0]<n[2]?(n[0]=1,n[1]=n[2]=0):(n[2]=1,n[0]=n[1]=0):n[1]<n[2]?(n[1]=1,n[0]=n[2]=0):(n[2]=1,n[0]=n[1]=0);let r=vec3.fromValues(n[0]-t[0],n[1]-t[1],n[2]-t[2]),i=vec3.fromValues(n[0]-o[0],n[1]-o[1],n[2]-o[2]),s=2/vec3.dot(r,r),a=2/vec3.dot(i,i),l=s*a*vec3.dot(r,i);for(let t=0;t<3;t++){let o=4*t;for(let n=0;n<3;n++)e[o+n]=-s*r[t]*r[n]-a*i[t]*i[n]+l*i[t]*r[n];e[o+t]+=1}}else{let r=vec3.create();vec3.cross(r,t,o);let i=(1-n)/vec3.dot(r,r),s=i*r[0],a=i*r[2],l=s*r[1],c=s*r[2],d=a*r[1];e[0]=n+s*r[0],e[1]=l+r[2],e[2]=c-r[1],e[4]=l-r[2],e[5]=n+i*r[1]*r[1],e[6]=d+r[0],e[8]=c+r[1],e[9]=d-r[0],e[10]=n+a*r[2]}}(r,n,e.normal);const i=mat4.create();mat4.fromTranslation(i,e.center),mat4.mul(i,i,r),vec3.negate(o,o);const s=mat4.create();mat4.fromTranslation(s,o),mat4.mul(i,i,s);for(let e of this.geometry.vertices)vec3.transformMat4(e,e,i),this.geometry.addAffectedVertex(e),this.geometry.addAffectedEdgeAndFace(e);for(let e of this.geometry.faces)vec3.transformMat4(e.normal,e.normal,r);this._updatePreviewAll()},Pt.prototype.putOnVertex=function(e){const t=vec3.create();e.getNormal(t),this._putOn({normal:t,center:e})},Pt.prototype.putOnEdge=function(e){const t=vec3.create();e.wingedEdge.getNormal(t);const o=vec3.create();vec3.add(o,e.origin,e.destination()),vec3.scale(o,o,.5),this._putOn({normal:t,center:o})},Pt.prototype.putOnFace=function(e){this._putOn({normal:e.normal,center:e.center})},Pt.prototype.getSelectedFaceContours=function(){let e={};e.edgeLoops=ct.findContours(this.selectedSet),e.edges=new Set;for(let t of e.edgeLoops)for(let o of t)e.edges.add(o.outer.wingedEdge);return e},Pt.prototype.liftFace=function(e,t){e.edgeLoops=this.geometry.liftContours(e.edgeLoops),e.extrudeEdges=this.geometry.extrudeContours(e.edgeLoops),this._updatePreviewAll();const o=e.extrudeEdges.length;for(let n=0;n<o;++n){const r=e.extrudeEdges[n];if(r.next.wingedEdge===t.wingedEdge){this.geometry.collapseEdge(r),n===o-1?(this.geometry.collapseEdge(e.extrudeEdges[0]),e.extrudeEdges=e.extrudeEdges.slice(1,o-1)):(this.geometry.collapseEdge(e.extrudeEdges[n+1]),e.extrudeEdges.splice(n,2));break}}this._updatePreviewAll();const n=this._resetSelectFace();for(let e of n.selectedFaces)this.selectFace(e);return e},Pt.prototype.mirrorFace=function(){const e=this.getSelectedSorted(),t=mat4.create(),o=new Set,n=new Set,r=new Map;function i(e){r.clear();for(let t of e.hEdges())r.set(t.origin,t.origin),o.add(t.origin),n.add(t.wingedEdge);!function(e,t,o){const n=-vec3.dot(t,o);e[0]=-2*t[0]*t[0]+1,e[1]=-2*t[1]*t[0],e[2]=-2*t[2]*t[0],e[3]=0,e[4]=-2*t[0]*t[1],e[5]=-2*t[1]*t[1]+1,e[6]=-2*t[2]*t[1],e[7]=0,e[8]=-2*t[0]*t[2],e[9]=-2*t[1]*t[2],e[10]=-2*t[2]*t[2]+1,e[11]=0,e[12]=-2*t[0]*n,e[13]=-2*t[1]*n,e[14]=-2*t[2]*n,e[15]=1}(t,e.normal,e.halfEdge.origin)}const s=e=>{let o=r.get(e);return o||(o=this.geometry.addVertex(e),vec3.transformMat4(o,o,t),r.set(e,o)),o.index},a=Array.from(this.geometry.faces),l=[];for(let t of e){i(t);const e=[];for(let o of a)if(o!==t){const t=[];for(let e of o.hEdges())t.push(s(e.origin));t.reverse(),e.push(t)}l.push(e)}this._updatePreviewAll();const c=[];for(let t=0;t<e.length;++t){const o=e[t];this.selectFace(o);const n=this.geometry.makeHole(o),r=l[t],i=[];for(let e of r)i.push(this.geometry.addPolygon(e,tt.default));c.push({holed:n,newMirrors:i})}return this._updatePreviewAll(),{mirrorGroups:c,protectVertex:o,protectWEdge:n}},Pt.prototype.undoMirrorFace=function(e){for(let t of e.mirrorGroups){const o=new Set;for(let n of t.newMirrors){for(let t of n.hEdges())e.protectVertex.has(t.origin)||this.geometry._freeVertex(t.origin),e.protectWEdge.has(t.wingedEdge)?t.next=t.next.pair.next:o.add(t.wingedEdge);this.geometry._freePolygon(n)}for(let e of o)this.geometry._freeEdge(e.left);this.undoHoleSelectedFace([t.holed])}this._updatePreviewAll()},Pt.prototype.cornerEdge=function(){const e=this.getSelectedSorted(),t=[],o=[],n=[],r=[],i=vec3.create();for(let s of e){let e,a=s.left;if(a.face&&(5==a.face.numberOfVertex?(e=s.right).face&&3!==e.face.numberOfVertex&&(e=null):3===a.face.numberOfVertex&&(e=a,(a=s.right).face&&5!==a.face.numberOfVertex&&(a=null))),e&&a){t.push(e.face),t.push(a.face),vec3.add(i,e.origin,a.origin),vec3.scale(i,i,.5);let s=this.geometry.splitEdge(a,i);o.push(a.origin),n.push(s.pair);let l=this.geometry.insertEdge(s,a.next.next.next);r.push(l.pair),t.push(l.face)}}let s=0,a=new Float32Array(3*r.length);for(let e of r){const t=a.subarray(s,s+3);vec3.sub(t,e.origin,e.destination()),vec3.normalize(t,t),s+=3}const l=this.snapshotPosition(o,a);this._updatePreviewAll();for(let e of n)this.selectEdge(e);return l.splitEdges=n,l.dissolveEdges=r,l},Pt.prototype.undoCornerEdge=function(e){for(let t of e.dissolveEdges)this.geometry.removeEdge(t);for(let t of e.splitEdges)this.selectEdge(t),this.geometry.collapseEdge(t);this._updatePreviewAll()},Pt.prototype.slideEdge=function(){const e=this.snapshotSelectionEdge(),t=[[0,0,1],[0,1,0],[1,0,0],[0,0,-1],[0,-1,0],[-1,0,0]],o=new Map,n=vec3.create();for(let r of e.wingedEdges)for(let e of r){let r=o.get(e.origin);r||(r={positive:vec3.create(),negative:vec3.create()},o.set(e.origin,r));const i=e.prev(),s=e.pair.next;let a,l;Pe(n,s,i.pair);for(let e=0;e<6;++e){let o=t[e],r=vec3.dot(o,n);0===e?(a=r,l=0):a<r&&(a=r,l=e)}l>2?(vec3.sub(n,e.origin,i.origin),vec3.add(r.negative,r.negative,n),vec3.sub(n,s.destination(),s.origin),vec3.add(r.positive,r.positive,n)):(vec3.sub(n,i.origin,e.origin),vec3.add(r.positive,r.positive,n),vec3.sub(n,s.origin,s.destination()),vec3.add(r.negative,r.negative,n))}let r=0;const i=[],s=new Float32Array(3*o.size),a=new Float32Array(3*o.size);for(const[e,t]of o){i.push(e);const o=s.subarray(r,r+3);vec3.copy(o,t.positive),vec3.normalize(o,o);const n=a.subarray(r,r+3);vec3.copy(n,t.negative),vec3.normalize(n,n),r+=3}const l=this.snapshotPosition(i,s);return l.directionPositive=s,l.directionNegative=a,l},Pt.prototype.positiveDirection=function(e){e.direction=e.directionPositive},Pt.prototype.negativeDirection=function(e){e.direction=e.directionNegative},Pt.prototype.flattenEdge=function(e){const t=this.snapshotEdgePosition(),o=vec3.create(),n=new Set,r=this.geometry.findEdgeGroup(this.getSelectedSorted());for(let t of r){n.clear(),vec3.set(o,0,0,0);for(let e of t)for(let t of e)n.has(t.origin)||(vec3.add(o,o,t.origin),n.add(t.origin),this.geometry.addAffectedEdgeAndFace(t.origin));vec3.scale(o,o,1/n.size),Be(n,e,o)}return this._updatePreviewAll(),t},Pt.prototype.flattenFace=function(e){const t=this.snapshotFacePosition(),o=ct.findFaceGroup(this.getSelectedSorted()),n=vec3.create(),r=new Set;let i=e;e||(i=vec3.create());for(let t of o){r.clear(),vec3.set(n,0,0,0);for(let o of t){for(let e of o.hEdges())r.has(e.origin)||(r.add(e.origin),vec3.add(n,n,e.origin),this.geometry.addAffectedEdgeAndFace(e.origin));e||vec3.add(i,i,o.normal)}vec3.scale(n,n,1/r.size),e||vec3.normalize(i,i),Be(r,i,n)}return this._updatePreviewAll(),t},Pt.prototype.flattenVertex=function(e){if(this.selectedSet.size>1){const t=this.getSelectedSorted(),o=this.snapshotVertexPosition(),n=vec3.create();for(let e of t)vec3.add(n,n,e),this.geometry.addAffectedEdgeAndFace(e);return vec3.scale(n,n,1/t.length),Be(t,e,n),this._updatePreviewAll(),o}return null},Pt.prototype.planeCuttableFace=function(e){for(let t of this.bvh.root.intersectBound(e))if(this.selectedSet.has(t))for(let o of t.hEdges()){const t=Le(null,e,o);if(t>0&&t<1)return!0}return!1},Pt.prototype._planeCutFace=function(e){const t=new Set,o=[],n=vec3.create();for(let r of e){const e=[];for(let t of this.bvh.root.intersectBound(r))this.selectedSet.has(t)&&e.push(t);e.sort((e,t)=>e.index-t.index);const i=[],s=new Set;for(let t of e)for(let e of t.hEdges())s.has(e.wingedEdge)||(i.push(e),s.add(e.wingedEdge));for(let e of i){const i=Le(n,r,e);if(0==i)t.add(e.origin);else if(i>0&&i<1){let r=this.geometry.splitEdge(e,n);o.push(r.pair),t.add(e.origin)}}}return this._updatePreviewAll(),{selectedFaces:this.selectedSet,vertices:t,halfEdges:o}},Pt.prototype.planeCutFace=function(e){return this._planeCutFace([e])},Pt.prototype.planeCutBody=function(e){const t=this._planeCutFace([e]);return{body:t.selectedFaces,vertices:t.vertices,halfEdges:t.halfEdges}},Pt.prototype.sliceBody=function(e,t){const o=vec3.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=vec3.fromValues(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);this.geometry.getExtent(o,n);const r=vec3.create();vec3.sub(r,n,o);const i=[],s=vec3.create(),a=t-1;for(let t=1;t<=a;++t)vec3.lerp(s,o,n,t/(a+1)),i.push(new Je(e,s));const l=this._planeCutFace(i);return{body:l.selectedFaces,vertices:l.vertices,halfEdges:l.halfEdges}},Pt.prototype.getBodySelection=function(e,t){this.geometry.getExtent(t.min,t.max);for(let t of this.selectedSet)e.push(t)},Pt.prototype.makeHolesFromBB=function(e){const t=[];for(let o of e)this.selectedSet.delete(o),t.unshift(this.geometry.makeHole(o));return t},Pt.findWeldContours=function(e){const t=new Map,o=[];function n(e,n){let r;return e.cage===n.cage?t.has(e.cage)?r=t.get(e.cage):(r=[],o.push(r),r.push(e.cage),o.set(e.cage,r),o.set(n.cage,r)):t.has(e.cage)?(r=t.get(e.cage),t.has(n.cage)||(t.set(n.cage,r),r.push(n.cage))):t.has(n.cage)?(r=t.get(n.cage),t.set(e.cage,r),r.push(e.cages),loopUse.push()):(r=[],o.push(r),r.push(e.cage,n.cage),t.set(e.cage,r),t.set(n.cage,r)),r}const r=[],i=new Map,s=ct.findContours(e.selection);for(let t of s){const o=e.pair.get(t[0].outer),s=e.pair.get(o.hEdge);if(i.has(o.hEdge)){if(i.get(o.hEdge).length!==t.length)return!1;for(let o=0;o<t.length;++o){let n=e.pair.get(t[o].outer);if(!e.pair.has(n.hEdge))return!1;t[o].inner=n.hEdge.pair}r.push({combine:n(o,s),edgeLoop:t})}else for(let e=0;e<t.length;++e){const o=t[e].outer;i.set(o,t)}}return{combineCages:o,edgeLoops:r}},Pt.weldableFace=function(e,t,o){if(e.polygon.numberOfVertex!==t.polygon.numberOfVertex)return!1;if(vec3.dot(e.polygon.normal,t.polygon.normal)>0)return!1;const n=o*o;if(vec3.sqrDist(e.center,t.center)>n)return!1;if(Math.abs(e.radius-t.radius)>o)return!1;const r=[];for(let e of t.polygon.hEdges())r.unshift(e);for(let t of e.polygon.hEdges())for(let e=0;e<r.length;++e){let o=t,i=r[e],s=[],a=e;do{if(vec3.sqrDist(o.origin,i.destination())>n){s=void 0;break}s.push({target:o,source:i}),o=o.next,i=r[a=++a%r.length]}while(o!==t);if(s)return s}return!1},Pt.findOverlapFace=function(e,t,o){const n=new Set,r=new Set,i=new Map;for(let s=0;s<t.length;++s){const a=t[s];if(!n.has(a))for(let l=s+1;l<t.length;l++){const s=t[l];if(s.isLive()&&!n.has(s)){if(Math.abs(a.center[e[0]]-s.center[e[0]])>o)break;const t=Pt.weldableFace(a,s,o);if(t){n.add(s),n.add(a),r.add(s.polygon),r.add(a.polygon);for(let e of t)i.set(e.target,{hEdge:e.source,cage:s.octree.bvh}),i.set(e.source,{hEdge:e.target,cage:a.octree.bvh})}}}}return{pair:i,merged:n,selection:r}},Pt.weldHole=function(e){const t=new Map;for(let o of e.merged){let e=t.get(o.octree.bvh);void 0===e&&(e=[],t.set(o.octree.bvh,e)),e.push(o)}const o=[];for(let[e,n]of t)o.push([e,e.makeHolesFromBB(n)]),e._updatePreviewAll();return o},Pt.undoWeldHole=function(e){for(let[t,o]of e){for(let e of o)t.geometry.undoHole(e);t._updatePreviewAll()}},Pt.weldBody=function(e,t){const o=[];for(let{combine:n,edgeLoop:r}of t.edgeLoops){const t=e.get(n);t.combine.geometry.weldContour(r),t.combine._updatePreviewAll(),t.preview=t.combine,t.snapshot||(t.snapshot={vertices:new Set});for(let e of r)t.snapshot.vertices.add(e.outer.origin);o.push([t.preview,r])}return o},Pt.undoWeldBody=function(e){for(let[t,o]of e)t.geometry.restoreContour(o),t._updatePreviewAll()},Pt.prototype.hardnessEdge=function(e){let t={operand:e,selection:[]};for(let o of this.selectedSet)o.setHardness(e)&&t.selection.push(o);return t.selection.length>0?t:null},Pt.prototype.undoHardnessEdge=function(e){let t=e.operand;0===t?t=1:1===t&&(t=0);for(let o of e.selection)o.setHardness(t)},Pt.prototype.assignFaceMaterial=function(e){const t=new Map;for(let o of this.selectedSet)if(e!==o.material){let n=t.get(o.material);n?n.push(o):t.set(o.material,[o]),o.assignMaterial(e)}return t.size>0?t:void 0},Pt.prototype.undoAssignFaceMaterial=function(e){for(const[t,o]of e.entries())for(const e of o)e.assignMaterial(t)},Pt.prototype.selectFaceMaterial=function(e){const t=this._resetSelectFace();for(let t of this.geometry.faces)t.material===e&&this.selectFace(t);return t},Pt.prototype.selectEdgeMaterial=function(e){const t=this._resetSelectEdge();for(let t of this.geometry.edges)for(let o of t)if(o.face&&o.face.material===e){this.selectEdge(o);break}return t},Pt.prototype.selectVertexMaterial=function(e){const t=this._resetSelectVertex();for(let t of this.geometry.vertices)for(let o of t.edgeRing())if(o.face&&o.face.material===e){this.selectVertex(t);break}return t},Pt.prototype.selectBodyMaterial=function(e){const t=this._resetSelectBody();for(let t of this.geometry.faces)if(t.material===e){this.selectBody();break}return t},Pt.prototype.setVertexColor=function(e){const t=3*this.selectedSet.size*5,o={hEdges:[],vertexColor:new Re(new Uint8Array(t))},n=new Set;for(let t of this.selectedSet)for(let r of t.edgeRing())o.hEdges.push(r),o.vertexColor.alloc(Re.uint8resize),r.getVertexColor(o.vertexColor),o.vertexColor.inc(),r.setVertexColor(e),n.add(r.face);o.vertexColor.reset();for(let e of n)e.updateCentroidColor();return o},Pt.prototype.undoVertexColor=function(e){const t=new Set;e.vertexColor.reset();for(let o of e.hEdges)o.setVertexColor(e.vertexColor),t.add(o.face);for(let e of t)e.updateCentroidColor()},Pt.prototype.setFaceColor=function(e){const t=3*this.selectedSet.size*5,o={hEdges:[],vertexColor:new Re(new Uint8Array(t))};for(let t of this.selectedSet){for(let n of t.hEdges())o.hEdges.push(n),o.vertexColor.alloc(Re.uint8resize),n.getVertexColor(o.vertexColor),o.vertexColor.inc(),n.setVertexColor(e);t._setColor(e)}return o},Pt.prototype.setBodyColor=function(e){const t=3*this.geometry.edges.size*2,o={hEdges:[],vertexColor:new Re(new Uint8Array(t))};for(let t of this.geometry.faces)if(t.isLive()){for(let n of t.hEdges())o.hEdges.push(n),o.vertexColor.alloc(Re.uint8resize),n.getVertexColor(o.vertexColor),o.vertexColor.inc(),n.setVertexColor(e);t._setColor(e)}return o};class Bt extends se{constructor(e){super(),this.previewCage=e}free(){this.previewCage.freeBuffer()}doIt(){$n(this.previewCage)}undo(){Zn(this.previewCage)}}class Tt{constructor(e,t){e&&(this.importMenuText={name:e[0],ext:e[1]}),t&&(this.exportMenuText={name:t[0],ext:t[1]})}export(e){return this._reset(),this._export(e)}import(e){this._reset();const t=this;let o=new FileReader;o.onload=function(e){const n=o.result;t._import(n);const r=t.objs,i=[];for(let e of r)i.push(new Bt(e));i.length>1?Er(i):i.length>0&&wr(i[0]);for(let[e,o]of t.materialCatalog)Yn(o);t._readAuxFiles(),Jn()},this.readAsText()?o.readAsText(e):o.readAsArrayBuffer(e)}_readAuxFiles(){}_reset(){this.objs=[],this.obj=null,this.objView=null,this.materialCatalog=new Map,this.currentMaterial=tt.default,this.realVertices=[],this.polygonCount=0,this.vertexCount=0,this.non_manifold=[]}static addLoadStore(e){(e.importMenuText||e.exportMenuText)&&Tt.LOADSTORE.add(e)}static setDefault(e){Tt.DEFAULT&&Tt.LOADSTORE.add(Tt.DEFAULT),Tt.DEFAULT=e,Tt.LOADSTORE.delete(e)}}Tt.LOADSTORE=new Set,Tt.DEFAULT=null;class It extends Tt{constructor(){super(["Wavefront","obj"],["Wavefront","obj"])}extension(){return"obj"}readAsText(){return!0}_export(e){let t=1;const o=new Map;let n="#wings3d.net wavefront export\n";for(const r of e){const e=r.geometry;n+="o "+r.name+"\n",n+="\n#vertex total "+e.vertices.size+"\n";for(let r of e.vertices)n+="v "+r[0]+" "+r[1]+" "+r[2]+"\n",o.has(r.index)||o.set(r.index,t++);const i=new Map;for(let t of e.faces){let e=i.get(t.material);e||(e=[],i.set(t.material,e)),e.push(t)}for(let[e,t]of i){n+=`\nusemtl ${e.name}\n`,n+="#face list total "+t.length+"\n";for(let e of t){n+="f";for(let t of e.hEdges())n+=" "+o.get(t.origin.index);n+="\n"}}}return new Blob([n],{type:"text/plain;charset=utf-8"})}_import(e){const t=e.match(/^([vfogs]|vt|usemtl|mtllib)(?:\s+(.+))$/gm);if(t){for(let e of t){let t=e.match(/\S+/g),o=t.shift();"function"==typeof this[o]?this[o](t):console.log("unexpected tag: "+o)}return{world:this.objs,material:this.material}}}_readAuxFiles(){const e=super._readAuxFiles.bind(this);!function(e,t){if(W.list=[],!W.input){const t=document.forms.importFileListForm;if(t){const o=t.fileListInput;o&&(o.addEventListener("change",function(n){for(let n of o.files)e.has(n.name)&&(e.set(n.name,n),t.querySelector(`input[name="${n.name}"]`).checked=!0);o.value=null}),W.input=o,W.ul=t.getElementsByTagName("ul"),W.ul&&(W.ul=W.ul[0]))}}Y("#importFileListForm",null,o=>{W.ul&&(W.ul.innerHTML=""),t(e)},t=>{if(W.ul)for(let[t,o]of e){const e=document.createRange().createContextualFragment(`<li><input type="checkbox" name="${t}" disabled>${t}</li>`);W.ul.appendChild(e)}})}(this.mtl,t=>{let o=[];for(let[e,n]of t){let e=new Promise(e=>{let t=new FileReader;t.readAsText(n),t.onload=()=>e(t.result)});o.push(e)}Promise.all(o).then(t=>{let o=new Ot;o.setMaterialCatalog(this.materialCatalog);for(let e of t)o._import(e);e()})})}_reset(){super._reset(),this.mtl=new Map}o(e){this.objView=qn(),this.obj=this.objView.geometry,this.objs.push(this.objView),this.obj.clearAffected(),this.objView.name=e}g(e){this.objView||(this.objView=qn(),this.obj=this.objView.geometry,this.objs.push(this.objView))}s(e){}v(e){const t=this.obj.addVertex(e.slice(0,3));this.realVertices.push(t.index),this.vertexCount++}vt(e){}f(e){const t=[];for(let o of e){let e=o.split("/")[0]-1;e>=0&&e<this.obj.vertices.size?t.push(this.realVertices[e]):console.log("face index out of bound: "+e)}null===this.obj.addPolygon(t,this.currentMaterial)&&this.non_manifold.push(this.polygonCount),this.polygonCount++}usemtl(e){const t=e[0];let o=this.materialCatalog.get(t);o||(o=tt.create(t),this.materialCatalog.set(t,o)),this.currentMaterial=o}mtllib(e){for(let t of e)this.mtl.set(t,null)}}class Ot extends Tt{constructor(){super(null,null)}extension(){return"mtl"}setMaterialCatalog(e){this.catalog=e}_import(e){this._reset();const t=e.match(/^(newmtl|Ka|Kd|Ks|Ns|Tr|d|illum)(?:\s+(.+))$/gm);if(t){for(let e of t){this[(e=e.match(/\S+/g))[0]](e)}return{world:this.objs,material:this.material}}}newmtl(e){const t=e[1];this.currentMaterial=null,this.catalog&&(this.currentMaterial=this.catalog.get(t)),this.currentMaterial||(this.currentMaterial=tt.create(t),this.materialCatalog.set(t,this.currentMaterial))}_parseRGB(e){return[parseFloat(e[1])||0,parseFloat(e[2])||0,parseFloat(e[3])||0]}Ka(e){this.currentMaterial.material.ambientMaterial=this._parseRGB(e)}Kd(e){this.currentMaterial.setDiffuse(this._parseRGB(e))}Ks(e){this.currentMaterial.material.specularMaterial=this._parseRGB(e)}Ns(e){let t=(parseFloat(e[1])||0)/1e3;this.currentMaterial.material.shininessMaterial=Math.min(1,Math.max(0,t))}d(e){this.currentMaterial.material.opacityMaterial=parseFloat(e[1])||1}Tr(e){this.currentMaterial.material.opacityMaterial=1-(parseFloat(e[1])||0)}illum(e){}}class zt extends Tt{constructor(){super(["Web3D","x3d"],["Web3D","x3d"])}extension(){return"x3d"}readAsText(){return!0}_reset(){super._reset(),this.def=new Map,this.count={appearance:0,cage:0}}_export(e){const t=(new DOMParser).parseFromString("<?xml version=\"1.0\" encoding=\"utf-8\"?>\n         <!DOCTYPE X3D PUBLIC \"ISO//Web3D//DTD X3D 3.3//EN\" \"http://www.web3d.org/specifications/x3d-3.3.dtd\">\n         <X3D profile='Interchange' version='3.3'  xmlns:xsd='http://www.w3.org/2001/XMLSchema-instance' xsd:noNamespaceSchemaLocation =' http://www.web3d.org/specifications/x3d-3.0.xsd '>\n         <head>\n            <meta name='title' content=''/>\n            <meta name='creator' content=''/>\n            <meta name='created' content=''/>\n            <meta name='modified' content=''/>\n            <meta name='description' content=''/>\n            <meta name='generator' content='Wings3D.net, https://www.wings3d.net'/>\n            <meta name='license' content=''/>\n         </head> \n         <Scene></Scene>\n         </X3D>","application/xml"),o=t.querySelector("Scene"),n=new Map;for(let r of e){const e=r.geometry,i=new Map;let s="",a=0;for(let t of e.vertices)i.set(t.index,a++),s=`${s} ${t[0]} ${t[1]} ${t[2]}`;let l=t.createElement("Coordinate");const c=r.name+"Coord";l.setAttribute("DEF",c),l.setAttribute("point",s),n.set(c,l);const d=new Map;for(let t of e.faces){let e=d.get(t.material);e||(e=[],d.set(t.material,e)),e.push(t)}const u=t.createElement("Group"),f=r.name+"Group";u.setAttribute("DEF",f),o.appendChild(u),n.set(f,u);for(const[e,o]of d){const r=t.createElement("Shape");u.appendChild(r);const s=e.name+"PBR",a=t.createElement("Appearance");r.appendChild(a);const d=t.createElement("PhysicalMaterial");if(a.appendChild(d),n.has(s))d.setAttribute("USE",s);else{d.setAttribute("DEF",s);const t=e.pbr;d.setAttribute("baseColor",`${t.baseColor[0]} ${t.baseColor[1]} ${t.baseColor[2]}`),d.setAttribute("roughnessFactor",`${t.roughness}`),d.setAttribute("metallicFactor",`${t.metallic}`),d.setAttribute("transparency",`${1-t.opacity}`)}let f="";for(let e of o){for(let t of e.hEdges())f=`${f} ${i.get(t.origin.index)}`;f=`${f} -1`}const h=t.createElement("IndexedFaceSet");r.appendChild(h),h.setAttribute("coordIndex",f),l||(l=t.createElement("Coordinate")).setAttribute("USE",c),h.appendChild(l),l=null}}const r=new XMLSerializer;return new Blob([r.serializeToString(t)],{type:"text/plain;charset=utf-8"})}_import(e){const t=(new DOMParser).parseFromString(e,"application/xml").querySelector("Scene");if(t){let e={children:[]};for(let o of t.children)this._parseNode(o,e);for(let t of e.children)$n(t);e.cage&&$n(e.cage)}}_parseNode(e,t){"function"==typeof this[e.tagName]&&this[e.tagName](e,t)}_getUse(e){let t=e.getAttribute("USE");return t&&this.def.has(t)?this.def.get(t):null}Group(e,t){const o={children:[]};for(const t of e.children)this._parseNode(t,o);o.children.length>0||o.cage&&(o.cage.name=e.getAttribute("name"),t.children.push(o.cage))}Shape(e,t){t.cage||(t.cage=new Pt(Xn.draftBench),t.coords=new Map);for(const o of e.children)this._parseNode(o,t)}Appearance(e,t){let o=this._getUse(e);if(!o){let t=e.getAttribute("DEF");const n=t;t||(t="Material_"+this.count.appearance++),o=tt.create(t),n&&this.def.set(t,o)}t.appearance=o;for(const o of e.children)this._parseNode(o,t)}PhysicalMaterial(e,t){let o=this._getUse(e);if(!o){let t=e.getAttribute("DEF");t&&this.def.set(t,e),o=e}const n={};let r;(r=e.getAttribute("baseColor"))&&(n.baseColor=r.trim().split(/[,\s]+/).map(Number)),(r=e.getAttribute("roughnessFactor"))&&(n.roughness=r),(r=e.getAttribute("metallicFactor"))&&(n.metallic=r),(r=e.getAttribute("transparency"))&&(n.opacity=1-r),t.appearance.setValues(n)}Material(e,t){let o=this._getUse(e);if(!o){let t=e.getAttribute("DEF");t&&this.def.set(t,e),o=e}const n={};n.diffuseMaterial=e.getAttribute("diffuseColor")||[1,1,1],n.specularMaterial=e.getAttribute("specularColor")||[0,0,0],n.shininessMaterial=e.getAttribute("shininess")||0,n.emissionMaterial=e.getAttribute("emissiveColor")||[0,0,0],n.opacityMaterial=1-(e.getAttribute("transparency")||0),t.appearance.pbr=tt.convertTraditionalToMetallicRoughness(n)}IndexedFaceSet(e,t){let o=this._getUse(e);if(o)e=o;else{let t=e.getAttribute("DEF");t&&this.def.set(t,e)}for(const o of e.children)this._parseNode(o,t);const n=t.appearance||tt.default;let r=0,i=e.getAttribute("coordIndex");i=i.trim().split(/[,\s]+/);for(let e=0;e<i.length;++e){const o=parseInt(i[e],10);-1===o?(t.cage.geometry._addPolygon(r,e,i,n),r=e+1):i[e]=t.remapIndex[o]}}Coordinate(e,t){let o=this._getUse(e);if(!o||!t.coords.has(o)){if(!o){let t=(o=e).getAttribute("DEF");t&&this.def.set(t,o)}let n=[],r=o.getAttribute("point");r=r.trim().split(/[,\s]+/);const i=[0,0,0];for(let e=0;e<r.length;e+=3)i[0]=parseFloat(r[e])||0,i[1]=parseFloat(r[e+1])||0,i[2]=parseFloat(r[e+2])||0,n.push(t.cage.geometry.addVertex(i).index);t.remapIndex=n,t.coords.set(e,n)}}Color(e){}ColorRGBA(e){}TextureCoordinate(){}MultiTextureCoordinate(){}}class Dt{constructor(e){if(this.modeString=e,"Multi"===e)return;e=e.toLowerCase();const t=this;this.contextMenu={menu:document.querySelector("#"+e+"-context-menu")},this.contextMenu.menu&&(this.contextMenu.menuItems=this.contextMenu.menu.querySelectorAll(".context-menu__item"));const o=[[1,0,0],[0,1,0],[0,0,1]],n=["X","Y","Z"];for(let o=0;o<3;++o)R(e+"Move"+n[o],function(e){yr(new Ut(t,o))});R({body:I.bodyMoveFree,face:I.faceMoveFree,edge:I.edgeMoveFree,vertex:I.vertexMoveFree}[e].name,function(e){yr(new Yt(t))});const r={face:I.faceMoveNormal,edge:I.edgeMoveNormal,vertex:I.vertexMoveNormal};r[e]&&R(r[e].name,function(e){yr(new Xt(t))}),R({face:I.faceScaleUniform,edge:I.edgeScaleUniform,vertex:I.vertexScaleUniform,body:I.bodyScaleUniform}[e].name,e=>{yr(new qt(this,[1,1,1]))});for(let t=0;t<3;++t)R(e+"Rotate"+n[t],e=>{const o=[0,0,0];o[t]=1,yr(new Wt(this,o))});const i={face:I.faceBevel,edge:I.edgeBevel,vertex:I.vertexBevel};i[e]&&R(i[e].name,e=>{yr(new $t(this))});let s={face:[I.faceExtrudeX,I.faceExtrudeY,I.faceExtrudeZ],edge:[I.edgeExtrudeX,I.edgeExtrudeY,I.edgeExtrudeZ],vertex:[I.vertexExtrudeX,I.vertexExtrudeY,I.vertexExtrudeZ]}[e];if(s)for(let e=0;e<3;++e)R(s[e].name,t=>{yr(new Kt(this,e))});const a={face:I.faceExtrudeFree,edge:I.edgeExtrudeFree,vertex:I.vertexExtrudeFree};a[e]&&R(a[e].name,e=>{yr(new Jt(this))});const l={face:I.faceExtrudeNormal,edge:I.edgeExtrudeNormal,vertex:I.vertexExtrudeNormal};l[e]&&R(l[e].name,e=>{yr(new Qt(this))});let c={face:[I.faceFlattenX,I.faceFlattenY,I.faceFlattenZ],edge:[I.edgeFlattenX,I.edgeFlattenY,I.edgeFlattenZ],vertex:[I.vertexFlattenX,I.vertexFlattenY,I.vertexFlattenZ]}[e];if(c)for(let e=0;e<3;++e)R(c[e].name,t=>{const n=new to(this,this.flatten,[o[e]]);n.doIt()&&wr(n)});const d=[[0,1,1],[1,0,1],[1,1,0]],u={face:[I.faceScaleAxisX,I.faceScaleAxisY,I.faceScaleAxisZ],edge:[I.edgeScaleAxisX,I.edgeScaleAxisY,I.edgeScaleAxisZ],vertex:[I.vertexScaleAxisX,I.vertexScaleAxisY,I.vertexScaleAxisZ],body:[I.bodyScaleAxisX,I.bodyScaleAxisY,I.bodyScaleAxisZ]}[e],f={face:[I.faceScaleRadialX,I.faceScaleRadialY,I.faceScaleRadialZ],edge:[I.edgeScaleRadialX,I.edgeScaleRadialY,I.edgeScaleRadialZ],vertex:[I.vertexScaleRadialX,I.vertexScaleRadialY,I.vertexScaleRadialZ],body:[I.bodyScaleRadialX,I.bodyScaleRadialY,I.bodyScaleRadialZ]}[e];for(let e=0;e<3;++e)R(u[e].name,t=>{yr(new qt(this,o[e]))}),R(f[e].name,t=>{yr(new qt(this,d[e]))});const h={face:[I.facePlaneCutX,I.facePlaneCutY,I.facePlaneCutZ],body:[I.bodyPlaneCutX,I.bodyPlaneCutY,I.bodyPlaneCutZ]}[e];if(h)for(let e=0;e<3;++e)R(h[e].name,t=>{xr(new eo(this,o[e]))});const p=e=>{const t=e.currentTarget;let o=function(e){return[parseInt(e.slice(1,3),16),parseInt(e.slice(3,5),16),parseInt(e.slice(5,7),16)]}(t.value);const n=new to(this,this.setVertexColor,[o],this.undoVertexColor);n.doIt()&&wr(n),t.removeEventListener("change",p)},g={vertex:I.vertexColor,face:I.faceColor,body:I.bodyColor};g[e]&&R(g[e].name,e=>{e.currentTarget.addEventListener("change",p)})}modeName(){return this.modeString}getContextMenu(){return this.hasSelection()?this.contextMenu:null}snapshotSelected(e,...t){const o=[];for(let n of this.selectedCage()){const r=e.call(n,...t);(r||!1===r)&&o.push({preview:n,snapshot:r})}return o}snapshotSelectable(e,...t){const o=[];for(let n of this.selectableCage()){const r=e.call(n,...t);(r||!1===r)&&o.push({preview:n,snapshot:r})}return o}snapshotTarget(e,t,...o){const n=[];for(let r of e){const e=t.call(r,...o);(e||!1===e)&&n.push({preview:r,snapshot:e})}return n}doAll(e,t,...o){if(e)for(let n of e)t.call(n.preview,n.snapshot,...o);else for(let e of this.eachCage())t.call(e,void 0,...o)}resultAll(e,...t){for(let o of this.selectedCage())if(e.call(o,...t))return!0;return!1}*eachCage(){const e=Kn();for(let t of e)yield t}*selectableCage(){const e=Kn();for(let t of e)!t.isLock()&&t.isVisible()&&(yield t)}*selectedCage(){const e=Kn();for(let t of e)!t.isLock()&&t.isVisible()&&t.hasSelection()&&(yield t)}*notSelectedCage(){const e=Kn();for(let t of e)t.isLock()||!t.isVisible()||t.hasSelection()||(yield t)}*visibleCage(){const e=Kn();for(let t of e)t.isVisible()&&(yield t)}*visibleWireCage(e){const t=Kn();for(let o of t)o.isVisible()&&o.isWireMode()===e&&(yield o)}hasSelection(){for(let e of this.selectableCage())if(!e.isLock()&&e.hasSelection())return!0;return!1}restoreMoveSelection(e){this.doAll(e,Pt.prototype.restoreMoveSelection)}moveSelection(e,t){this.doAll(e,Pt.prototype.moveSelection,t)}restoreSelectionPosition(e){this.doAll(e,Pt.prototype.restoreMoveSelection)}scaleSelection(e,t,o){this.doAll(e,Pt.prototype.scaleSelection,t,o)}rotateSelection(e,t,o){this.doAll(e,Pt.prototype.rotateSelection,t,o)}snapshotSelection(){return this.snapshotSelected(Pt.prototype["snapshotSelection"+this.modeName()])}_doSelection(e,t=!1){e="_select"+this.modeName()+e;const o=[];for(let n of this.eachCage())(t||n.hasSelection())&&o.push({preview:n,snapshot:n[e]()});return o.length>0&&{undo:this.undoDoSelection,snapshots:o}}similarSelection(){return this._doSelection("Similar")}adjacentSelection(){return this._doSelection("Adjacent")}invertSelection(){return this._doSelection("Invert",!0)}allSelection(){return this._doSelection("All",!0)}lessSelection(){return this._doSelection("Less")}moreSelection(){return this._doSelection("More")}resetSelection(){for(let e of this.selectedCage())this._resetSelection(e)}restoreSelection(e){this.doAll(e,Pt.prototype.restoreSelection,this)}undoDoSelection(e){this.resetSelection(),this.restoreSelection(e)}selectObject(e,t){return t.checked?this.snapshotTarget(e,Pt.prototype["_select"+this.modeName()+"All"]):this.snapshotTarget(e,Pt.prototype["_resetSelect"+this.modeName()])}undoSelectObject(e,t){t.checked&&this.doAll(e,Pt.prototype["_resetSelect"+this.modeName()]),this.doAll(e,Pt.prototype.restoreSelection,this)}toggleObjectLock(e,t){return this.snapshotTarget(e,Pt.prototype.toggleLock,t.checked)}undoToggleObjectLock(e){this.doAll(e,Pt.prototype.toggleLock)}toggleObjectVisibility(e,t){return this.snapshotTarget(e,Pt.prototype.setVisible,!t.checked)}undoObjectVisibility(e){return this.doAll(e,Pt.prototype.setVisible)}toggleObjectWireMode(e,t){return this.snapshotTarget(e,Pt.prototype.toggleWireMode,t)}undoToggleObjectWireMode(e){return this.doAll(e,Pt.prototype.toggleWireMode)}selectMaterialCmd(e){return new to(this,this._selectMaterial,e,this.undoDoSelection)}_selectMaterial(e){return this.snapshotSelectable(Pt.prototype["select"+this.modeName()+"Material"],e)}undoVertexColor(e){this.doAll(e,Pt.prototype.undoVertexColor)}isVertexSelectable(){return!1}isEdgeSelectable(){return!1}isFaceSelectable(){return!1}toggleMulti(e){}polygonShader(e,t){e.useShader(xe)}edgeShader(e,t){t?e.useShader(Se):e.useShader(Fe)}vertexShader(e,t){return t&&e.useShader(be),t}}class Nt{constructor(e,t,o,n){this.madsor=e,this.select=new Map,this.select.set(t,[o]),this.onOff=n}dragSelect(e,t){var o=this.select.get(e);void 0===o&&(o=[],this.select.set(e,o)),this.madsor.dragSelect(e,t,o,this.onOff)}}class Rt extends se{constructor(e){super(),this.input=e}doIt(){this.input.checked=!this.input.checked}undo(){this.input.checked=!this.input.checked}}class kt extends se{constructor(e,t,o){super(),this.snapshots=o,this.redoToggle=e,this.undoToggle=t}doIt(){this.redoToggle()}undo(){this.undoToggle(this.snapshots)}}class jt extends ae{constructor(e,t,o){super(),this.madsor=e,this.snapshots=t,this.movement=o}isDoable(){return this.snapshots.length>0}doIt(){return this.snapshots.length>0&&(this._transformSelection(this.movement),!0)}undo(){this.madsor.restoreSelectionPosition(this.snapshots)}handleMouseMove(e,t){this._transformSelection(this._updateMovement(e,t))}_transformSelection(e){this.madsor.moveSelection(this.snapshots,e)}}class Ht extends jt{constructor(e,t,o){super(e,null,t),this.cmd=o}doIt(){return this.cmd?(this.cmd.doIt(),this.snapshots=this.cmd.snapshotPosition()):this.snapshots=this.snapshotPosition(),super.doIt(),!0}undo(){this.cmd?this.cmd.undo():super.undo()}}class Ut extends jt{constructor(e,t){super(e,e.snapshotPosition(),[0,0,0]),this.axis=t}_updateMovement(e){let t=this._calibrateMovement(e.movementX),o=[0,0,0];return o[this.axis]=t,this.movement[this.axis]+=t,o}}class Gt extends Ht{constructor(e,t){super(e,0,t)}handleMouseMove(e,t){let o=this._calibrateMovement(e.movementX);o>0?this.movement<0&&this.movement+o>=0&&(this.madsor.moveSelection(this.snapshots,-this.movement),o+=this.movement,this.movement=0,this.madsor.doAll(this.snapshots,Pt.prototype.positiveDirection)):this.movement>=0&&this.movement+o<0&&(this.madsor.moveSelection(this.snapshots,-this.movement),o+=this.movement,this.movement=0,this.madsor.doAll(this.snapshots,Pt.prototype.negativeDirection)),this.movement+=o,this.madsor.moveSelection(this.snapshots,o)}}class Xt extends jt{constructor(e,t=!1,o){o||(o=e.snapshotPositionAndNormal()),super(e,o,0),this.noNegative=t}_updateMovement(e){let t=this._calibrateMovement(e.movementX);return this.movement+=t,this.noNegative&&this.movement<0&&(t-=this.movement,this.movement=0),t}}class Yt extends jt{constructor(e){super(e,e.snapshotPosition(),[0,0,0])}_updateMovement(e,t){let o=this._calibrateMovement(e.movementX),n=this._calibrateMovement(-e.movementY);var r=t.inverseCameraVectors(),i=[r.x[0]*o+r.y[0]*n,r.x[1]*o+r.y[1]*n,r.x[2]*o+r.y[2]*n];return vec3.add(this.movement,this.movement,i),i}}class qt extends jt{constructor(e,t){const o=e.snapshotTransformGroup();super(e,o,1),this.axis=t}_transformSelection(e){this.madsor.scaleSelection(this.snapshots,e,this.axis)}_updateMovement(e,t){let o=this._xPercentMovement(e);return o=o<0?1+Math.abs(o):1/(1+o),this.movement*=o,o}}class Wt extends se{constructor(e,t,o){super(),this.madsor=e,this.snapshots=e.snapshotTransformGroup(),this.movement=0,this.axisVec3=vec3.clone(t),this.center=o}handleMouseMove(e){const t=5*this._xPercentMovement(e),o=quat.create();quat.setAxisAngle(o,this.axisVec3,t),this.madsor.rotateSelection(this.snapshots,o,this.center),this.movement+=t}doIt(){const e=quat.create();quat.setAxisAngle(e,this.axisVec3,this.movement),this.madsor.rotateSelection(this.snapshots,e,this.center)}undo(){this.madsor.restoreSelectionPosition(this.snapshots)}}class $t extends jt{constructor(e){const t=e.snapshotSelection();super(e,e.bevel(),0),this.selection=t,this.vertexLimit=Number.MAX_SAFE_INTEGER;for(let e of this.snapshots)this.vertexLimit=Math.min(this.vertexLimit,e.vertexLimit)}_updateMovement(e){let t=this._calibrateMovement(e.movementX);return this.movement+t>this.vertexLimit?t=this.vertexLimit-this.movement:this.movement+t<0&&(t=0-this.movement),this.movement+=t,t}doIt(){this.snapshots=this.madsor.bevel(),super.doIt()}undo(){this.madsor.undoBevel(this.snapshots,this.selection)}}class Zt extends le{constructor(e){super(),this.madsor=e,this.contourEdges=e.extrude()}doIt(){this.contourEdges=this.madsor.extrude(this.contourEdges),super.doIt()}undo(){super.undo(),this.madsor.undoExtrude(this.contourEdges)}}class Kt extends Zt{constructor(e,t){super(e),this.moveHandler=new Ut(e,t)}}class Jt extends Zt{constructor(e){super(e),this.moveHandler=new Yt(e)}}class Qt extends Zt{constructor(e){super(e),this.moveHandler=new Xt(e)}}class eo extends ce{constructor(e,t){super(!0,!0,!0,t),this.madsor=e,this.center=vec3.create()}hilite(e,t){if(e.plane){if(this.plane=new Je(this.planeNormal,e.plane.center),this.madsor.planeCuttable(this.plane))return e.plane.hilite=!0,!0;e.plane.hilite=!1,delete this.plane}return!0}select(e){return!!this.plane&&this.doIt()}doIt(){return!!(this.plane&&(this.cut=this.madsor.planeCut(this.plane),this.cut.length>0))&&(Rn(this.cut),this.vertexConnect=Gn().connectVertex(),this.vertexConnect.doIt())}undo(){this.vertexConnect&&(this.vertexConnect.undo(),delete this.vertexConnect,this.madsor.undoPlaneCut(this.cut))}}class to extends se{constructor(e,t,o,n,r){super(),this.madsor=e,this.doCmd=t,this.doParams=o,this.undoCmd=n,this.undoParams=r}doIt(e){return this.snapshots=this.doCmd.call(this.madsor,...this.doParams?this.doParams:[]),this.snapshots.length>0}undo(e){this.undoCmd?this.undoCmd.call(this.madsor,this.snapshots,...this.undoParams?this.undoParams:[]):this.madsor.restoreSelectionPosition(this.snapshots)}snapshotPosition(){return this.snapshots}}class oo extends Dt{constructor(){super("Vertex");const e=this;R(I.vertexConnect.name,e=>{const t=this.connectVertex();t.doIt()&&wr(t)}),k(I.vertexDissolve.name,function(t){const o=new so(e);o.doIt(),wr(o)},this,"Delete"),k(I.vertexCollapse.name,function(t){const o=new ao(e);o.doIt(),wr(o)},this,"Backspace"),R(I.vertexWeld.name,e=>{let t=[];for(let e of this.selectedCage())1==e.selectionSize()&&t.push(e);if(1==t.length){xr(new lo(this,t[0]))}else geometryStatus("You can only Weld one vertex")})}snapshotPosition(){return this.snapshotSelected(Pt.prototype.snapshotVertexPosition)}snapshotPositionAndNormal(){return this.snapshotSelected(Pt.prototype.snapshotVertexPositionAndNormal)}snapshotTransformGroup(){return this.snapshotSelected(Pt.prototype.snapshotTransformVertexGroup)}bevel(){let e=this.snapshotSelected(Pt.prototype.bevelVertex);return kn(e),e}undoBevel(e,t){this.restoreSelectionPosition(e),this.doAll(e,Pt.prototype.collapseSplitOrBevelEdge),Rn(t)}extrude(){return this.snapshotSelected(Pt.prototype.extrudeVertex)}undoExtrude(e){this.doAll(e,Pt.prototype.undoExtrudeVertex)}andConnectVertex(e){const t=new io(this);t.doIt()?Er([e,t]):e.undo()}connectVertex(){return new io(this)}connect(){return this.snapshotSelected(Pt.prototype.connectVertex)}dissolveConnect(e){this.doAll(e,Pt.prototype.dissolveConnect)}dissolve(){return this.snapshotSelected(Pt.prototype.dissolveSelectedVertex)}undoDissolve(e){this.doAll(e,Pt.prototype.undoDissolveVertex)}flatten(e){return this.snapshotSelected(Pt.prototype.flattenVertex,e)}setVertexColor(e){return this.snapshotSelected(Pt.prototype.setVertexColor,e)}dragSelect(e,t,o,n){null!==t.vertex&&e.dragSelectVertex(t.vertex,n)&&o.push(t.vertex)}selectStart(e,t){if(null!==t.vertex){var o=e.selectVertex(t.vertex);return new no(this,e,t.vertex,o)}return null}isVertexSelectable(){return!0}_resetSelection(e){e._resetSelectVertex()}_restoreSelection(e,t){e.restoreVertexSelection(t)}toggleFunc(e){var t,o;e instanceof To?(t=kn,o=this.snapshotSelected(Pt.prototype.changeFromVertexToFaceSelect)):e instanceof Eo?(t=jn,o=this.snapshotSelected(Pt.prototype.changeFromVertexToEdgeSelect)):e instanceof co?(t=Hn,o=this.snapshotSelected(Pt.prototype.changeFromVertexToBodySelect)):(t=Un,o=this.snapshotSelected(Pt.prototype.changeFromVertexToMultiSelect)),wr(new kt(t,Rn,o))}restoreMode(e,t){e instanceof To?this.doAll(t,Pt.prototype.restoreFromVertexToFaceSelect):e instanceof Eo?this.doAll(t,Pt.prototype.restoreFromVertexToEdgeSelect):e instanceof co?this.doAll(t,Pt.prototype.restoreFromVertexToBodySelect):this.doAll(t,Pt.prototype.restoreFromVertexToMultiSelect)}vertexShader(e){return e.useShader(be),!0}}class no extends Nt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new ro(this.select)}}class ro extends se{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)for(var o=0;o<t.length;++o)e.selectVertex(t[o])}undo(){this.doIt()}}class io extends se{constructor(e){super(),this.madsor=e}doIt(){return this.cageArray=this.madsor.connect(),this.cageArray.length>0&&(jn(this.cageArray),!0)}undo(){Rn(),this.madsor.dissolveConnect(this.cageArray)}}class so extends se{constructor(e){super(),this.madsor=e}doIt(){this.dissolve=this.madsor.dissolve()}undo(){this.madsor.undoDissolve(this.dissolve)}}class ao extends se{constructor(e){super(),this.madsor=e}doIt(){this.dissolve=this.madsor.dissolve(),kn(this.dissolve)}undo(e){e.resetSelection(),Rn(),this.madsor.undoDissolve(this.dissolve)}}class lo extends ce{constructor(e,t){super(!0,!1,!1),this.madsor=e,this.preview=t}hilite(e,t){return!(t!==this.preview||!e.vertex)&&!1!==this.preview.weldableVertex(e.vertex)}select(e){const t=e.vertex;return!(!t||(this.collapseHEdge=this.preview.weldableVertex(t),0==this.collapseHEdge))&&this.doIt()}doIt(){return this.restore=this.preview.weldVertex(this.collapseHEdge),!0}undo(){this.preview.undoWeldVertex(this.restore)}}class co extends Dt{constructor(){super("Body");const e=this;k(I.bodyDelete.name,function(t){const o=new ho(e.getSelected());wr(o),o.doIt()},this,"Backspace"),R(I.bodyRename.name,function(t){Y("#renameDialog",t,function(t){const o=X(t),n=new po(e.getSelected(),o);wr(n),n.doIt()},function(t){G(t,e.getSelected())})});const t=[I.bodyDuplicateMoveX,I.bodyDuplicateMoveY,I.bodyDuplicateMoveZ];for(let o=0;o<3;++o)R(t[o].name,function(t){yr(new mo(e,o,e.getSelected()))});R(I.bodyDuplicateMoveFree.name,function(t){yr(new vo(e,e.getSelected()))}),R(I.bodyInvert.name,e=>{const t=new yo(this);t.doIt(),wr(t)}),R(I.bodyCombine.name,e=>{const t=new xo(this);t.doIt()&&wr(t)}),R(I.bodySeparate.name,e=>{const t=new So(this);t.doIt()&&wr(t)});const o=[I.bodyFlipX,I.bodyFlipY,I.bodyFlipZ];for(let e=0;e<3;++e)R(o[e].name,t=>{const o=new bo(this,e);o.doIt(),wr(o)});const n=[[1,0,0],[0,1,0],[0,0,1]],r=[I.bodySliceX,I.bodySliceY,I.bodySliceZ];for(let e=0;e<3;++e)R(r[e].name,t=>{Y("#sliceBodyDialog",t,t=>{const o=t.querySelector('input[name="amountRange"');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new to(this,this.slice,[n[e],t],this.undoPlaneCut);if(o.doIt()){Gn().andConnectVertex(o)}}}})});R(I.bodyWeld.name,e=>{const t=new to(this,this.weld,void 0,this.undoWeld);t.doIt()&&wr(t)})}getSelected(){const e=[];for(let t of this.selectedCage())e.push(t);return e}snapshotPosition(){return this.snapshotSelected(Pt.prototype.snapshotBodyPosition)}snapshotTransformGroup(){return this.snapshotSelected(Pt.prototype.snapshotTransformBodyGroup)}combine(e){if(void 0===e){e=[];for(let t of this.selectedCage())e.push(t)}if(e.length>=2){const t=Qn(e);return t.name=e[0].name,t.selectBody(),{combine:t,oldSelection:e}}return null}undoCombine(e){if(e){Zn(e.combine);for(let t of e.oldSelection)$n(t)}}separate(){const e=[];for(let t of this.selectedCage()){let o=t.separate();o.length>0&&e.push({preview:t,snapshot:o})}for(let t of e){Zn(t.preview);for(let e of t.snapshot)$n(e)}return e}undoSeparate(e){for(let t of e){for(let e of t.snapshot)Zn(e);$n(t.preview)}}invert(){for(let e of this.selectedCage())e.invertBody();Jn(),this.hiliteView=null}flipAxis(e,t){this.doAll(e,Pt.prototype.flipBodyAxis,t),Jn()}planeCuttable(e){return this.resultAll(Pt.prototype.planeCuttableFace,e)}planeCut(e){return this.snapshotSelected(Pt.prototype.planeCutBody,e)}undoPlaneCut(e){this.doAll(e,Pt.prototype.collapseSplitOrBevelEdge),Hn(e)}slice(e,t){const o=this.snapshotSelected(Pt.prototype.sliceBody,e,t);return Rn(o),o}weld(e=.001){const t={min:vec3.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:vec3.fromValues(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE)},o=[];for(let e of this.selectedCage())e.getBodySelection(o,t);let n=function(e){let t,o,n,r=vec3.create();return vec3.sub(r,e.max,e.min),r[0]>r[1]?r[0]>r[2]&&(t=0,r[1]>r[2]?(o=1,n=2):(o=2,n=1)):(r[1],r[2]),[t,o,n]}(t);o.sort((e,t)=>{for(let o=0;o<3;++o){let r=e.center[n[o]]-t.center[n[o]];if(0!==r)return r}return e.polygon.index-t.polygon.index});const r=Pt.findOverlapFace(n,o,e),i=Pt.findWeldContours(r);if(!1!==i){const e=Pt.weldHole(r),t=[],o=new Map;for(let e of i.combineCages){const n=this.combine(e);o.set(e,n),t.push(n)}const n=Pt.weldBody(o,i);return Rn(t),[{holes:e,weldContours:n,combinedCages:t}]}return[]}undoWeld(e){const t=e[0];Hn(),Pt.undoWeldBody(t.weldContours);for(let e of t.combinedCages)this.undoCombine(e);Pt.undoWeldHole(t.holes)}setVertexColor(e){return this.snapshotSelected(Pt.prototype.setBodyColor,e)}centroid(){return this.snapshotSelected(Pt.prototype.bodyCentroid)}dragSelect(e,t,o,n){t.edge}selectStart(e,t){if(null!==t.cage){var o=e.selectBody();return new uo(this,e,t.edge,o)}}selectBody(e){for(let t of e)t.selectBody()}similarSelection(){const e=new Set;for(let t of this.selectedCage()){const o=t._getGeometrySize(),n=3*o.vertex+2*o.edge+o.face;e.add(n)}const t=[];for(let o of this.notSelectedCage()){const n=o._getGeometrySize(),r=3*n.vertex+2*n.edge+n.face;e.has(r)&&(o.selectBody(),t.push(o))}return t.length>0&&{undo:this.selectBody,snapshots:t}}adjacentSelection(){return!1}moreSelection(){return!1}_resetSelection(e){e._resetSelectBody()}_restoreSelection(e,t){e.restoreBodySelection(t)}toggleFunc(e){var t,o;e instanceof To?(t=kn,o=this.snapshotSelected(Pt.prototype.changeFromBodyToFaceSelect)):e instanceof oo?(t=Rn,o=this.snapshotSelected(Pt.prototype.changeFromBodyToVertexSelect)):e instanceof Eo?(t=jn,o=this.snapshotSelected(Pt.prototype.changeFromBodyToEdgeSelect)):(t=Un,o=this.snapshotSelected(Pt.prototype.changeFromBodyToMultiSelect)),wr(new kt(t,Hn,o))}restoreMode(e,t){e instanceof To?this.doAll(t,Pt.prototype.restoreFromBodyToFaceSelect):e instanceof oo?this.doAll(t,Pt.prototype.restoreFromBodyToVertexSelect):e instanceof Eo?this.doAll(t,Pt.prototype.restoreFromBodyToEdgeSelect):this.doAll(t,Pt.prototype.restoreFromBodyToMultiSelect)}}class uo extends Nt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new fo(this.select)}}class fo extends se{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)t.length>0&&e.selectBody()}undo(){this.doIt()}}class ho extends se{constructor(e){super(),this.previewCages=e}doIt(){this.undoCage=[];for(let e of this.previewCages)this.undoCage.push([e,e.parent]),Zn(e)}undo(){for(let[e,t]of this.undoCage)$n(e,t)}}class po extends se{constructor(e,t){super(),this.previewCages=e,this.newName=t,this.oldName=new Map}doIt(){for(let e of this.previewCages)this.newName.hasOwnProperty(e.uuid)&&(this.oldName.has(e)||this.oldName.set(e,e.name),e.name=this.newName[e.uuid],geometryStatus("Object new name is "+e.name))}undo(){for(let[e,t]of this.oldName)e.name=t,geometryStatus("Object restore name to "+e.name)}}class go extends se{constructor(e){super(),this.originalCages=e,this.duplicateCages=[];for(let t of e){let e=Pt.duplicate(t);this.duplicateCages.push(e)}}_toggleOriginalSelected(){for(let e of this.originalCages)e.selectBody()}doIt(){for(let e of this.duplicateCages)$n(e),e.selectBody();this._toggleOriginalSelected()}undo(){for(let e of this.duplicateCages)e.selectBody(),Zn(e);this._toggleOriginalSelected()}}class mo extends Ut{constructor(e,t,o){const n=new go(o);n.doIt(),super(e,t),this.duplicateBodyCommand=n}doIt(){this.duplicateBodyCommand.doIt(),super.doIt()}undo(){super.undo(),this.duplicateBodyCommand.undo()}}class vo extends Yt{constructor(e,t){const o=new go(t);o.doIt(),super(e),this.duplicateBodyCommand=o}doIt(){return this.duplicateBodyCommand.doIt(),super.doIt(),!0}undo(){super.undo(),this.duplicateBodyCommand.undo()}}class yo extends se{constructor(e){super(),this.madsor=e}doIt(){return this.madsor.invert(),!0}undo(){this.madsor.invert()}}class xo extends se{constructor(e){super(),this.madsor=e}doIt(){return this.combine=this.madsor.combine(),!!this.combine}undo(){this.madsor.undoCombine(this.combine),this.combine=null}}class So extends se{constructor(e){super(),this.madsor=e}doIt(){return this.separate=this.madsor.separate(),this.separate.length>0}undo(){this.madsor.undoSeparate(this.separate),this.separate=null}}class bo extends se{constructor(e,t){super(),this.madsor=e,this.axis=t,this.pivot=e.centroid()}doIt(){return this.madsor.flipAxis(this.pivot,this.axis),!0}undo(){this.madsor.flipAxis(this.pivot,this.axis)}}class Eo extends Dt{constructor(){super("Edge");const e=this;for(let t of[I.cutLine2,I.cutLine3,I.cutLine4,I.cutLine5,I.cutLine10]){const o=t.name,n=o.substring("cutLine".length);R(o,function(t){e.cutEdge(n)})}R(I.cutAsk.name,function(t){Y("#cutLineDialog",t,function(t){const o=t.querySelector('input[name="Segments"');if(o){const t=parseInt(o.value,10);NaN!=t&&t>0&&t<100&&e.cutEdge(t)}})}),R(I.cutAndConnect.name,function(t){e.cutAndConnect()}),k(I.edgeDissolve.name,function(t){const o=e.dissolve();o.length>0&&wr(new Ao(e,o))},this,"Backspace"),R(I.edgeCollapse.name,function(t){const o=new _o(e);o.doIt()&&wr(o)}),R(I.edgeCrease.name,e=>{yr(new Mo(this))});for(let[t,o]of[[I.edgeLoop1,"l"],[I.edgeLoop2,void 0],[I.edgeLoop3,void 0]]){const n=t.name,r=n.substring("edgeLoop".length);R(n,function(t){const o=new Vo(e,r);o.doIt()&&wr(o)},o)}R(I.edgeLoopN.name,function(t){Y("#cutLineDialog",t,function(t){const o=t.querySelector('input=[name="Segments"');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new Vo(e,t);o.doIt()&&wr(o)}}})});for(let[t,o]of[[I.edgeRing1,"g"],[I.edgeRing2,void 0],[I.edgeRing3,void 0]]){const n=t.name,r=n.substring("edgeRing".length);R(n,function(t){const o=new Lo(e,r);o.doIt()&&wr(o)},o)}R(I.edgeRingN.name,function(t){Y("#cutLineDialog",t,function(t){const o=t.querySelector('input[name="Segments"');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new Lo(e,t);o.doIt()&&wr(o)}}})}),R(I.edgeLoopCut.name,e=>{const t=new Po(this);t.doIt()&&wr(t)}),R(I.edgeCorner.name,e=>{yr(new Bo(this))}),R(I.edgeSlide.name,e=>{const t=new Gt(this,new to(this,this.slide));t.doIt(),yr(t)});for(let[e,t]of[[I.edgeSoft,0],[I.edgeHard,1],[I.edgeInvert,2]])R(e.name,e=>{const o=new to(this,this.hardness,[t],this.undoHardness);o.doIt()&&wr(o)})}snapshotPosition(){return this.snapshotSelected(Pt.prototype.snapshotEdgePosition)}snapshotPositionAndNormal(){return this.snapshotSelected(Pt.prototype.snapshotEdgePositionAndNormal)}snapshotTransformGroup(){return this.snapshotSelected(Pt.prototype.snapshotTransformEdgeGroup)}loopCut(){const e=this.snapshotSelected(Pt.prototype.loopCut);for(let t of e)for(let e of t.snapshot.separateCages)$n(e),e.selectBody();return e}undoLoopCut(e){this.doAll(e,Pt.prototype.undoLoopCut);for(let t of e)for(let e of t.snapshot.separateCages)Zn(e)}bevel(){const e=this.snapshotSelected(Pt.prototype.bevelEdge);return kn(e),e}undoBevel(e,t){this.restoreSelectionPosition(e),this.collapseEdge(e),jn(t)}crease(){return this.snapshotSelected(Pt.prototype.creaseEdge)}extrude(){return this.snapshotSelected(Pt.prototype.extrudeEdge)}undoExtrude(e){this.doAll(e,Pt.prototype.undoExtrudeEdge)}cutEdge(e){const t=new Fo(this,e);wr(t),t.doIt()}cutAndConnect(){const e=new Fo(this,2);e.doIt(),Gn().andConnectVertex(e)}cut(e){return this.snapshotSelected(Pt.prototype.cutEdge,e)}edgeLoop(e){return this.snapshotSelected(Pt.prototype.edgeLoop,e)}edgeRing(e){return this.snapshotSelected(Pt.prototype.edgeRing,e)}collapseEdge(e){this.doAll(e,Pt.prototype.collapseSplitOrBevelEdge)}dissolve(){return this.snapshotSelected(Pt.prototype.dissolveSelectedEdge)}reinsertDissolve(e){this.doAll(e,Pt.prototype.reinsertDissolveEdge)}collapse(){return this.snapshotSelected(Pt.prototype.collapseSelectedEdge)}restoreEdge(e){this.doAll(e,Pt.prototype.restoreCollapseEdge)}corner(){return this.snapshotSelected(Pt.prototype.cornerEdge)}undoCorner(e){this.doAll(e,Pt.prototype.undoCornerEdge)}hardness(e){return this.snapshotSelected(Pt.prototype.hardnessEdge,e)}undoHardness(e,t){this.doAll(e,Pt.prototype.undoHardness,t)}slide(){return this.snapshotSelected(Pt.prototype.slideEdge)}flatten(e){return this.snapshotSelected(Pt.prototype.flattenEdge,e)}dragSelect(e,t,o,n){null!==t.edge&&e.dragSelectEdge(t.edge,n)&&o.push(t.edge)}selectStart(e,t){if(null!==t.edge){var o=e.selectEdge(t.edge);return new wo(this,e,t.edge,o)}return null}isEdgeSelectable(){return!0}_resetSelection(e){e._resetSelectEdge()}_restoreSelection(e,t){e.restoreEdgeSelection(t)}toggleFunc(e){var t,o;e instanceof To?(t=kn,o=this.snapshotSelected(Pt.prototype.changeFromEdgeToFaceSelect)):e instanceof oo?(t=Rn,o=this.snapshotSelected(Pt.prototype.changeFromEdgeToVertexSelect)):e instanceof co?(t=Hn,o=this.snapshotSelected(Pt.prototype.changeFromEdgeToBodySelect)):(t=Un,o=this.snapshotSelected(Pt.prototype.changeFromEdgeToMultiSelect)),wr(new kt(t,jn,o))}restoreMode(e,t){e instanceof To?this.doAll(t,Pt.prototype.restoreFromEdgeToFaceSelect):e instanceof oo?this.doAll(t,Pt.prototype.restoreFromEdgeToVertexSelect):e instanceof co?this.doAll(t,Pt.prototype.restoreFromEdgeToBodySelect):this.doAll(t,Pt.prototype.restoreFromEdgeToMultiSelect)}edgeShader(e){e.useShader(Se)}}class wo extends Nt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new Co(this.select)}}class Co extends se{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)for(var o=0;o<t.length;++o)e.selectEdge(t[o])}undo(){this.doIt()}}class Fo extends se{constructor(e,t){super(),this.madsor=e,this.numberOfSegments=t,this.selectedEdges=e.snapshotSelection()}doIt(){const e=this.madsor.cut(this.numberOfSegments);Rn(e),this.snapshots=e}undo(){this.madsor.collapseEdge(this.snapshots),jn(this.selectedEdges)}}class Ao extends se{constructor(e,t){super(),this.madsor=e,this.dissolveEdges=t}doIt(){this.madsor.dissolve()}undo(){this.madsor.reinsertDissolve(this.dissolveEdges)}}class _o extends se{constructor(e){super(),this.madsor=e}doIt(){const e=this.madsor.collapse();return e.length>0&&(this.collapse=e,Rn(this.collapse),!0)}undo(){Gn().resetSelection(),jn(),this.madsor.restoreEdge(this.collapse)}}class Mo extends le{constructor(e){super(),this.madsor=e,this.contourEdges=e.crease(),this.moveHandler=new Xt(e)}doIt(){this.contourEdges=this.madsor.crease(this.contourEdges),super.doIt()}undo(){super.undo(),this.madsor.undoExtrude(this.contourEdges)}}class Vo extends se{constructor(e,t){super(),this.madsor=e,this.nth=t,this.selectedEdges=e.snapshotSelection()}doIt(){return this.madsor.edgeLoop(this.nth).length>0}undo(){this.madsor.resetSelection(),this.madsor.restoreSelection(this.selectedEdges)}}class Lo extends se{constructor(e,t){super(),this.madsor=e,this.nth=t,this.selectedEdges=e.snapshotSelection()}doIt(){return this.madsor.edgeRing(this.nth).length>0}undo(){this.madsor.resetSelection(),this.madsor.restoreSelection(this.selectedEdges)}}class Po extends se{constructor(e){super(),this.madsor=e}doIt(){return this.loopCut=this.madsor.loopCut(),this.loopCut.length>0&&(Hn(),!0)}undo(){this.loopCut.length>0&&(jn(),this.madsor.undoLoopCut(this.loopCut))}}class Bo extends le{constructor(e){super(),this.madsor=e,this.cornerEdges=e.corner(),this.moveHandler=new Xt(e,!1,this.cornerEdges)}doIt(){this.cornerEdges=this.madsor.corner(),super.doIt()}undo(){this.madsor.undoCorner(this.cornerEdges)}}class To extends Dt{constructor(){super("Face");var e=this;k(I.faceDissolve.name,function(t){const o=new zo(e);o.doIt()?wr(o):geometryStatus("Selected Face not dissolveable")},this,"Backspace"),R(I.faceCollapse.name,function(t){const o=new Do(e);o.doIt(),wr(o)}),R(I.faceBridge.name,e=>{let t=this.getBridgeFaces();if(2===t.length){const e=t[0],o=t[1];if(e.face.numberOfVertex==o.face.numberOfVertex){let t,n;e.preview!==o.preview?((t=new Ro(e.preview,o.preview)).doIt(),n=new No(t.getCombine(),e.face,o.face)):n=new No(e.preview,e.face,o.face),n.doIt(),t?Er([t,n]):wr(n)}}}),R(I.faceInset.name,e=>{this.hasSelection()?yr(new ko(this)):geometryStatus("No selected face")}),R(I.faceBump.name,e=>{yr(new jo(this))}),R(I.faceIntrude.name,e=>{yr(new Ho(this))}),R(I.faceLift.name,e=>{const t=this.snapshotSelected(Pt.prototype.snapshotTransformFaceGroup);if(1===t.length){const e=t[0];xr(new Uo(this,e.preview))}}),R(I.facePutOn.name,e=>{let t=[];for(let e of this.selectedCage())1==e.selectionSize()&&t.push(e);if(1==t.length){xr(new Go(this,t[0]))}else geometryStatus("You can only PutOn one face")}),R(I.faceMirror.name,e=>{const t=new Xo(this);t.doIt(),wr(t)}),R(I.faceFlattenNormal.name,e=>{const t=new to(this,this.flatten);t.doIt()&&wr(t)})}snapshotPosition(){return this.snapshotSelected(Pt.prototype.snapshotFacePosition)}snapshotPositionAndNormal(){return this.snapshotSelected(Pt.prototype.snapshotFacePositionAndNormal)}snapshotTransformGroup(){return this.snapshotSelected(Pt.prototype.snapshotTransformFaceGroup)}bevel(){return this.snapshotSelected(Pt.prototype.bevelFace)}undoBevel(e,t){this.restoreSelectionPosition(e),this.doAll(e,Pt.prototype.collapseSplitOrBevelEdge),this.resetSelection(),this.restoreSelection(t)}bump(){return this.snapshotSelected(Pt.prototype.bumpFace)}undoBump(e){this.doAll(e,Pt.prototype.undoExtrudeEdge)}extrude(){return this.snapshotSelected(Pt.prototype.extrudeFace)}undoExtrude(e){this.doAll(e,Pt.prototype.collapseExtrudeEdge)}collapseEdgeNew(e){this.doAll(e,Pt.prototype.collapseExtrudeEdge)}dissolve(){return this.snapshotSelected(Pt.prototype.dissolveSelectedFace)}undoDissolve(e){this.doAll(e,Pt.prototype.undoDissolveFace)}collapse(){return this.snapshotSelected(Pt.prototype.collapseSelectedFace)}undoCollapse(e){this.doAll(e,Pt.prototype.undoCollapseFace)}intrude(){return this.snapshotSelected(Pt.prototype.intrudeFace)}undoIntrude(e){return this.doAll(e,Pt.prototype.undoIntrudeFace)}getBridgeFaces(){const e=[];for(let t of this.selectedCage()){const o=t.snapshotSelection();for(let n of o)e.push({preview:t,face:n})}return e}inset(){return this.snapshotSelected(Pt.prototype.insetFace)}mirror(){return this.snapshotSelected(Pt.prototype.mirrorFace)}undoMirror(e){return this.doAll(e,Pt.prototype.undoMirrorFace)}flatten(e){return this.snapshotSelected(Pt.prototype.flattenFace,e)}planeCuttable(e){return this.resultAll(Pt.prototype.planeCuttableFace,e)}planeCut(e){return this.snapshotSelected(Pt.prototype.planeCutFace,e)}undoPlaneCut(e){this.doAll(e,Pt.prototype.collapseSplitOrBevelEdge),kn(e)}assignMaterial(e){return this.snapshotSelected(Pt.prototype.assignFaceMaterial,e)}undoAssignMaterial(e){return this.doAll(e,Pt.prototype.undoAssignFaceMaterial)}setVertexColor(e){return this.snapshotSelected(Pt.prototype.setFaceColor,e)}dragSelect(e,t,o,n){null!==t.face&&e.dragSelectFace(t.face,n)&&o.push(t.face)}selectStart(e,t){if(null!==t.face){var o=e.selectFace(t.face);return new Io(this,e,t.face,o)}}isFaceSelectable(){return!0}_resetSelection(e){e._resetSelectFace()}_restoreSelection(e,t){e.restoreFaceSelection(t)}toggleFunc(e){var t,o;e instanceof Eo?(t=jn,o=this.snapshotSelected(Pt.prototype.changeFromFaceToEdgeSelect)):e instanceof oo?(t=Rn,o=this.snapshotSelected(Pt.prototype.changeFromFaceToVertexSelect)):e instanceof co?(t=Hn,o=this.snapshotSelected(Pt.prototype.changeFromFaceToBodySelect)):(t=Un,o=this.snapshotSelected(Pt.prototype.changeFromFaceToMultiSelect)),wr(new kt(t,kn,o))}restoreMode(e,t){e instanceof Eo?this.doAll(t,Pt.prototype.restoreFromFaceToEdgeSelect):e instanceof oo?this.doAll(t,Pt.prototype.restoreFromFaceToVertexSelect):e instanceof co?this.doaAll(t,Pt.prototype.restoreFromFaceToBodySelect):this.doAll(t,Pt.prototype.restoreFromFaceToMultiSelect)}}class Io extends Nt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new Oo(this.select)}}class Oo extends se{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)for(var o=0;o<t.length;++o)e.selectFace(t[o])}undo(){this.doIt()}}class zo extends se{constructor(e){super(),this.madsor=e}doIt(){const e=this.madsor.dissolve();return e.length>0&&(this.dissolve=e,!0)}undo(){this.madsor.undoDissolve(this.dissolve)}}class Do extends se{constructor(e){super(),this.madsor=e}doIt(){const e=this.madsor.collapse();return e.length>0&&(this.collapse=e,Rn(this.collapse),!0)}undo(){Gn().resetSelection(),this.madsor.undoCollapse(this.collapse),kn(this.collapse)}}class No extends se{constructor(e,t,o){super(),this.cage=e,this.target=t,this.source=o}doIt(){this.bridge=this.cage.bridge(this.target,this.source)}undo(){this.cage.undoBridge(this.bridge),this.cage.restoreFaceSelection(this.bridge)}}class Ro extends se{constructor(e,t){super(),this.targetCage=e,this.sourceCage=t}getCombine(){return this.combine}doIt(){return this.combine=Qn([this.targetCage,this.sourceCage]),this.combine.name=this.targetCage.name,!0}undo(){Zn(this.combine),$n(this.targetCage),$n(this.sourceCage)}}class ko extends jt{constructor(e){super(e),this.movement=0,this.doIt()}doIt(){this.snapshots=this.madsor.inset(),this.madsor.moveSelection(this.snapshots,this.movement),this.vertexLimit=Number.MAX_SAFE_INTEGER;for(let e of this.snapshots)this.vertexLimit=Math.min(this.vertexLimit,e.snapshot.vertexLimit)}handleMouseMove(e){let t=this._calibrateMovement(e.movementX);return this.movement+t>this.vertexLimit?t=this.vertexLimit-this.movement:this.movement+t<0&&(t=0-this.movement),this.movement+=t,this.madsor.moveSelection(this.snapshots,t),t}undo(){this.madsor.collapseEdgeNew(this.snapshots)}}class jo extends le{constructor(e){super(),this.madsor=e,this.bump=e.bump(),this.moveHandler=new Xt(e)}doIt(){this.bump=this.madsor.bump(this.bump),super.doIt()}undo(){super.undo(),this.madsor.undoBump(this.bump)}}class Ho extends le{constructor(e){super(),this.madsor=e,this.intrude=e.intrude(),this.moveHandler=new Xt(e,!0)}doIt(){return this.intrude=this.madsor.intrude(),super.doIt(),!0}undo(){super.undo(),this.madsor.undoIntrude(this.intrude)}}class Uo extends ce{constructor(e,t){super(!1,!0,!1),this.madsor=e,this.preview=t,this.contours=this.preview.getSelectedFaceContours()}hilite(e,t){return!(t!==this.preview||!e.edge)&&this.contours.edges.has(e.edge.wingedEdge)}select(e){return!(!e.edge||!this.contours.edges.has(e.edge.wingedEdge))&&(this.axis=vec3.create(),vec3.sub(this.axis,e.edge.destination(),e.edge.origin),this.hiliteEdge=e.edge,this.lift=this.preview.liftFace(this.contours,e.edge),this.moveHandler=new Wt(this.madsor,this.axis,e.edge.origin),!0)}doIt(){return this.lift=this.preview.liftFace(this.contours,this.hiliteEdge),super.doIt(),!0}undo(){super.doIt(),this.preview.collapseExtrudeEdge(this.lift)}}class Go extends ce{constructor(e,t){super(!0,!0,!0),this.madsor=e,this.preview=t,this.snapshot=t.snapshotPositionAll()}hilite(e,t){return t!==this.preview}select(e,t){return e.vertex?(this.vertex=e.vertex,this.doIt(),!0):e.edge?(this.edge=e.edge,this.doIt(),!0):!!e.face&&(this.face=e.face,this.doIt(),!0)}doIt(){if(this.vertex)this.preview.putOnVertex(this.vertex);else if(this.edge)this.preview.putOnEdge(this.edge);else{if(!this.face)return!1;this.preview.putOnFace(this.face)}return!0}undo(){this.preview.restoreMoveSelection(this.snapshot)}}class Xo extends se{constructor(e){super(),this.madsor=e}doIt(){this.mirror=this.madsor.mirror()}undo(){this.madsor.undoMirror(this.mirror)}}class Yo extends Dt{constructor(){super("Multi")}selectMaterialCmd(e){return On(),Gn().selectMaterialCmd(e)}isFaceSelectable(){return!0}isEdgeSelectable(){return!0}isVertexSelectable(){return!0}toggleMulti(e){e.face?On():e.vertex?In():zn()}toggleFunc(e){let t,o;e instanceof To?(t=kn,o=this.snapshotSelected(Pt.prototype.changeFromMultiToFaceSelect)):e instanceof oo?(t=Rn,o=this.snapshotSelected(Pt.prototype.changeFromMultiToVertexSelect)):e instanceof Eo?(t=jn,o=this.snapshotSelected(Pt.prototype.changeFromMultiToEdgeSelect)):(t=jn,o=this.snapshotSelected(Pt.prototype.changeFromMultiToBodySelect)),wr(new kt(t,Un,o))}restoreMode(e,t){e instanceof To?this.doAll(t,Pt.prototype.restoreFromMultiToFaceSelect):e instanceof oo?this.doAll(t,Pt.prototype.restoreFromMultiToVertexSelect):e instanceof Eo?this.doAll(t,Pt.prototype.restoreFromMultiToEdgeSelect):this.doAll(t,Pt.prototype.restoreFromMultiToBodySelect)}polygonShader(e,t){e.useShader(xe)}edgeShader(e,t){t?e.useShader(Se):e.useShader(Fe)}vertexShader(e,t){return!!t&&(e.useShader(be),!0)}}const qo=function(e,t,o,r=2048){lt.call(this,r),this.materialList=o,this.preview={centroid:{},indexLength:0,visibleLength:0,isAltered:!1},this.preview.shaderData=n.createShaderData();var s=i.attribLayout(3),a=i.attribLayout(4);this.preview.shaderData.createAttribute("polygonIndex",a,n.STATIC_DRAW),this.preview.shaderData.createSampler("faceState",2,3,n.UNSIGNED_BYTE),this.preview.shaderData.createSampler("groupState",3,1,n.UNSIGNED_BYTE),this.preview.shaderData.createSampler("positionBuffer",0,3,n.FLOAT),this.preview.shaderData.createSampler("centerBuffer",1,3,n.FLOAT),this.preview.shaderData.createIndex("triangleList"),this.setTheme(e,t),this.preview.shaderData.createSampler("materialColor",4,3,n.FLOAT),this.preview.shaderData.createAttribute("indexBuffer",a,n.STATIC_DRAW),this.preview.shaderData.createSampler("edgeState",1,1,n.UNSIGNED_BYTE),this.preview.shaderData.createSampler("edgeVertexColor",5,3,n.UNSIGNED_BYTE),this.preview.shaderData.createSampler("centerVertexColor",6,3,n.UNSIGNED_BYTE),this.preview.shaderData.createAttribute("vertexIndex",s,n.DYNAMIC_DRAW),this.previewBody={hilite:!1},this.previewPlane={},this.previewPlane.shaderData=n.createShaderData(),this.previewPlane.shaderData.setUniform4fv("faceColor",[1,0,0,1]),this.previewPlane.shaderData.createAttribute("position",s,n.STATIC_DRAW),this.previewPlane.rectangle=new Float32Array(12),this.previewPlane.shaderData.resizeAttribute("position",3*Float32Array.BYTES_PER_ELEMENT*4),this.previewPlane.pts=[];for(let e=0;e<4;++e)this.previewPlane.pts[e]=this.previewPlane.rectangle.subarray(3*e,3*(e+1))};qo.prototype=Object.create(lt.prototype),Object.defineProperty(qo.prototype,"constructor",{value:qo,enumerable:!1,writable:!0}),qo.theme={unselectedEdgeColor:[0,0,0,1],hardEdgeColor:[1,.5,0,1],selectedColor:[.65,0,0,1],selectedHilite:[.7,.7,0,1],unselectedHilite:[0,.65,0,1],unselectedVertexColor:[0,0,0,1],maskedVertexColor:[.5,1,0,.8],faceColor:[.7898538076923077,.8133333333333334,.6940444444444445,1],sculptMagnetColor:[0,0,1,.1],tweakMagnetColor:[0,0,1,.06],tweakVectorColor:[1,.5,0]},qo.pref={unselectedVertexSize:4,selectedVertexSize:5,maskedVertexSize:8,unselectedEdgeWidth:2,selectedEdgeWidth:2,hardEdgeWidth:2},qo.CONST=function(){const e={EDGEWIDTH:1.1};return e}(),qo.prototype.setTheme=function(e,t){Object.entries(e).forEach(([e,t])=>{this.preview.shaderData.setUniform4fv(e,Oe(t)),qo.theme[e]=Oe(t)}),Object.entries(t).forEach(([e,t])=>{qo.pref[e]=t,this.preview.shaderData.setUniform1f(e,t)}),this.preview.shaderData.setUniform4fv("edgeColor",function(e){const t=new Float32Array(32),o=new ke(t);return o.set(e.unselectedEdgeColor).inc(),o.set(e.hardEdgeColor).inc(),o.set(e.selectedColor).inc(),o.set(e.selectedColor).inc(),o.set(e.unselectedHilite).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite).inc(),o.set(e.selectedHilite),t}(qo.theme)),this.preview.shaderData.setUniform1fv("edgeWidth",function(e){const t=new Float32Array(8);return t[0]=e.unselectedEdgeWidth,t[1]=e.unselectedEdgeWidth,t[2]=e.selectedEdgeWidth,t[3]=e.selectedEdgeWidth,t[4]=e.unselectedEdgeWidth,t[5]=e.unselectedEdgeWidth,t[6]=e.selectedEdgeWidth,t[7]=e.selectedEdgeWidth,t}(qo.pref)),this.preview.shaderData.setUniform4fv("vertexColor",function(e){const t=new Float32Array(32),o=new ke(t);return o.set(e.unselectedVertexColor).inc(),o.set(e.selectedColor).inc(),o.set(e.maskedVertexColor).inc(),o.set(e.maskedVertexColor).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite),t}(qo.theme)),this.preview.shaderData.setUniform1fv("sizeOfVertex",function(e){const t=new Float32Array(8);return t[0]=e.unselectedVertexSize,t[1]=1.5*e.selectedVertexSize,t[2]=1.5*e.maskedVertexSize,t[3]=1.5*e.maskedVertexSize,t[4]=1.5*e.selectedVertexSize,t[5]=1.5*e.selectedVertexSize,t[6]=1.5*e.maskedVertexSize,t[7]=1.5*e.maskedVertexSize,t}(qo.pref)),this.preview.shaderData.setUniform4fv("faceColor",function(e){const t=new Float32Array(16),o=new ke(t);return o.set(e.faceColor).inc(),o.set(e.selectedColor).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite),t}(qo.theme))},qo.prototype.freeBuffer=function(){this.preview.shaderData.freeAllAttributes(),this.preview.shaderData=null,this.previewEdge.shaderData.freeAllAttributes(),this.previewEdge.shaderData=null},qo.prototype.isModified=function(){return st.index.isAltered()||it.index.isAltered()||rt.index.isAltered()||st.position.isAltered()||at.state.isAltered()||rt.state.isAltered()||ct.state.isAltered()||tt.color.isAltered()||it.triangleList.isAltered()||it.color.isAltered()},qo.prototype.draw=function(e,t){try{this.preview.shaderData.updateAttributeEx("polygonIndex",it.index,at.centerIndex),this.preview.shaderData.updateSampler("positionBuffer",st.position),this.preview.shaderData.updateSampler("centerBuffer",Ze.center),this.preview.shaderData.updateSampler("edgeVertexColor",it.color),this.preview.shaderData.updateSampler("centerVertexColor",at.color),this.preview.shaderData.updateSampler("faceState",at.state),this.preview.shaderData.updateSampler("groupState",ct.state),this.preview.shaderData.updateSampler("materialColor",tt.color),this.preview.shaderData.updateIndex("triangleList",it.triangleList,it.index.usedSize/4,e.STATIC_DRAW),e.bindAttribute(this.preview.shaderData,["polygonIndex"]),e.bindUniform(this.preview.shaderData,["faceColor","faceState","faceStateHeight","groupState","groupStateHeight","materialColor","materialColorHeight","edgeVertexColor","edgeVertexColorHeight","centerVertexColor","centerVertexColorHeight","positionBuffer","positionBufferHeight","centerBuffer","centerBufferHeight"]),e.bindIndex(this.preview.shaderData,"triangleList"),e.drawElements(e.TRIANGLES,it.triangleList.usedSize,e.UNSIGNED_INT,0)}catch(e){console.log(e)}},qo.prototype.drawVertex=function(e,t){try{this.preview.shaderData.updateAttribute("vertexIndex",st.index),e.bindAttribute(this.preview.shaderData,["vertexIndex"]),this.preview.shaderData.updateSampler("groupState",ct.state),this.preview.shaderData.updateSampler("positionBuffer",st.position),e.bindUniform(this.preview.shaderData,["vertexColor","sizeOfVertex","groupState","groupStateHeight","positionBuffer","positionBufferHeight"]),e.drawArrays(e.POINTS,0,st.index.usedSize/3)}catch(e){console.log(e)}},qo.prototype.drawEdge=function(e,t){try{this.preview.shaderData.updateAttribute("indexBuffer",rt.index),e.bindAttribute(this.preview.shaderData,["indexBuffer"]),this.preview.shaderData.updateSampler("positionBuffer",st.position),this.preview.shaderData.updateSampler("edgeState",rt.state),this.preview.shaderData.updateSampler("groupState",ct.state),e.bindUniform(this.preview.shaderData,["edgeColor","edgeWidth","groupState","groupStateHeight","positionBuffer","positionBufferHeight","edgeState","edgeStateHeight"]),e.drawArrays(e.TRIANGLES,0,rt.index.usedSize/4)}catch(e){console.log(e)}},qo.prototype.drawPlane=function(){const e=vec3.create(),t=vec3.fromValues(0,1,0),o=quat.create(),n=mat4.create(),r=vec3.create();return function(i,s){vec3.copy(r,s.halfSize),vec3.normalize(r,r),vec3.cross(e,r,t),vec3.normalize(e,e),quat.rotationTo(o,e,s.normal),mat4.fromQuat(n,o),vec3.copy(r,s.halfSize),vec3.negate(this.previewPlane.pts[0],r);let a=this.previewPlane.pts[1];a[0]=r[0],a[1]=-r[1],a[2]=r[2],vec3.copy(this.previewPlane.pts[2],r),vec3.negate(this.previewPlane.pts[3],a);for(let e=0;e<4;++e){const t=this.previewPlane.pts[e];vec3.transformMat4(t,t,n),vec3.add(t,s.center,t)}this.previewPlane.shaderData.uploadAttribute("position",0,this.previewPlane.rectangle),s.hilite?this.previewPlane.shaderData.setUniform4fv("faceColor",[0,1,0,1]):this.previewPlane.shaderData.setUniform4fv("faceColor",[.1,.1,.1,1]),i.disable(i.CULL_FACE),i.useShader(we),i.bindTransform(),i.bindAttribute(this.previewPlane.shaderData,["position"]),i.bindUniform(this.previewPlane.shaderData,["faceColor"]),i.drawArrays(i.TRIANGLE_FAN,0,4),i.disableShader(),i.enable(i.CULL_FACE)}}();function Wo(e){e.preventDefault()}function $o(e){e.preventDefault(),e.stopPropagation(),e.target===this&&this.classList.remove("dropZone")}function Zo(e){e.preventDefault(),e.stopPropagation(),this.classList.add("dropZone")}!function(){Mt.nameSetters.push(function(e){this.guiStatus&&this.guiStatus.textNode&&(this.guiStatus.textNode.textContent=e)});const e=Mt.prototype.numberOfCage;Mt.prototype.numberOfCage=function(){const t=e.call(this);return this.guiStatus&&this.guiStatus.count&&(this.guiStatus.count.textContent=t),t},Pt.nameSetters.push(function(e){this.guiStatus&&this.guiStatus.textNode&&(this.guiStatus.textNode.textContent=e)}),Pt.prototype.updateStatus=function(){this.isVisible()&&0!==this.selectedSet.size?this.guiStatus&&!this.guiStatus.select.checked&&(this.guiStatus.select.checked=!0):this.guiStatus&&this.guiStatus.select.checked&&(this.guiStatus.select.checked=!1)}}();class Ko{constructor(e,t,o){this.label=e,this.treeView=t,this.world=o,this.drag={cage:null,li:null};const n=this;o&&(o.guiStatus.count=e.querySelector(".resultCount")),o.guiStatus.ul=t,e.addEventListener("drop",function(e){$o.call(this,e),n.treeView.id===e.dataTransfer.getData("text")&&(n.treeView.insertBefore(n.drag.li,n.treeView.firstChild),Wn(o,n.drag.cage),n.drag.li=n.drag.cage=null)}),e.addEventListener("dragover",Wo),e.addEventListener("dragenter",Zo),e.addEventListener("dragleave",$o),e.addEventListener("contextmenu",function(e){e.preventDefault();let t=document.querySelector("#geometryGraphWorld");t&&(U(t,H(e)),ne(t),er(o,[o]))},!1)}static addRenameListener(e,t){e.textContent=t.name,t.guiStatus.textNode=e;const o=function(e){if(13==e.keyCode){if(this.textContent!==t.name){const e={};e[t.uuid]=this.textContent;const o=new po([t],e);wr(o),o.doIt()}this.contentEditable=!1,this.removeEventListener("keydown",o)}};return e.addEventListener("dblclick",function(e){this.contentEditable=!0,this.focus(),this.addEventListener("keydown",o)}),e.addEventListener("blur",function(e){this.textContent=t.name,this.contentEditable=!1,this.removeEventListener("keydown",o)}),e}addGroup(e,t){const o=this;let n=t.guiStatus.li;if(!n){n=document.createElement("li"),t.guiStatus.li=n;const e=t.uuid,r=document.createRange().createContextualFragment(`<input type="checkbox" id="${e}"><label for="${e}" class="folder"></label><p><span></span><span class="resultCount">0</span></p><ul></ul>`);Ko.addRenameListener(r.querySelector("span"),t);const i=r.querySelector("ul");t.guiStatus.ul=i;const s=r.querySelector("p");t.guiStatus.count=r.querySelector(".resultCount"),n.appendChild(r),s.addEventListener("drop",function(e){$o.call(this,e),o.treeView.id===e.dataTransfer.getData("text")&&(i.insertBefore(o.drag.li,i.firstChild),Wn(t,o.drag.cage),o.drag.li=o.drag.cage=null)}),s.addEventListener("dragover",Wo),s.addEventListener("dragenter",Zo),s.addEventListener("dragleave",$o)}e.appendChild(n)}addObject(e,t=this.treeView){const o=this;let n=e.guiStatus.li;if(!n){n=document.createElement("li"),e.guiStatus.li=n,n.classList.add("objectName"),n.draggable=!0,n.addEventListener("dragstart",function(t){t.stopPropagation(),t.dataTransfer.setData("text",o.treeView.id),o.drag.li=this,o.drag.cage=e});const t=document.createRange().createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallWhole"></span></label>');let r=t.querySelector("input");r.addEventListener("change",t=>{!e.isLock()&&e.isVisible()?(er(e.parent,[e]),B(0,"toggleObjectSelect",t)):t.target.checked=!t.target.checked}),e.guiStatus.select=r,n.appendChild(t);const i=Ko.addRenameListener(document.createElement("span"),e);i.addEventListener("contextmenu",function(t){t.preventDefault();let o=document.querySelector("#geometryGraphText");o&&(U(o,H(t)),ne(o),er(e.parent,[e]))},!1),n.appendChild(i);const s=document.createRange().createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallShow"></span></label>');(r=s.querySelector("input")).addEventListener("change",t=>{e.isLock()?t.target.checked=!t.target.checked:(er(e.parent,[e]),B(0,"toggleObjectVisibility",t))}),e.guiStatus.visibility=r,n.appendChild(s);const a=document.createRange().createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallUnlock"></span></label>');(r=a.querySelector("input")).addEventListener("change",t=>{er(e.parent,[e]),B(0,"toggleObjectLock",t)}),n.appendChild(a),e.guiStatus.locked=r;const l=document.createRange().createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallWire"></span></label>');(r=l.querySelector("input")).addEventListener("change",t=>{er(e.parent,[e]),B(0,"toggleWireMode",t)}),n.appendChild(l)}t.appendChild(n)}removeObject(e){const t=e.guiStatus.li;t.parentNode.removeChild(t),e.removeFromParent()}}class Jo{constructor(e){this.view=e,this.list=[]}static addRenameListener(e,t){const o=function(e){13==e.keyCode&&(""!=this.textContent?t.name=this.textContent:this.textContent=t.name,this.contentEditable=!1,this.removeEventListener("keydown",o))};return e.addEventListener("dblclick",function(e){this.contentEditable=!0,this.focus(),this.addEventListener("keydown",o)}),e.addEventListener("blur",function(e){this.textContent=t.name,this.contentEditable=!1,this.removeEventListener("keydown",o)}),e}[Symbol.iterator](){return this.list[Symbol.iterator]()}}class Qo extends Jo{constructor(e,t){super(t);let o=document.querySelector("#importImageMenu");o&&e.addEventListener("contextmenu",function(e){e.preventDefault(),U(o,H(e)),ne(o)},!1)}loadImage(e){let t=new FileReader;t.onload=o=>{const n={img:null,li:null,uuid:Ne(),name:"",popup:null},r=n.img=document.createElement("img");r.src=t.result,r.onload=function(){n.popup=ie(this,e.name)};let i=n.li=document.createElement("li"),s=document.createRange().createContextualFragment('<span class="smallIcon smallImage"></span>');s.firstElementChild.addEventListener("click",e=>{document.body.appendChild(n.popup)}),i.appendChild(s);let a=document.createRange().createContextualFragment(`<span>${e.name}</span>`);n.name=a.firstElementChild,a.firstElementChild.addEventListener("contextmenu",function(e){e.preventDefault();let t=document.querySelector("#importImageTextMenu");t&&(U(t,H(e)),ne(t),er(null,[n]))},!1),i.appendChild(a),this.view.appendChild(i),this.list.push(n)},t.readAsDataURL(e)}showImage(e){document.body.appendChild(e[0].popup)}deleteImage(e){const t=e[0];t.popup.remove(),this.view.removeChild(t.li),this.list.splice(this.list.indexOf(t),1)}}class en extends Jo{constructor(e,t){super(t);let o=document.querySelector("#createMaterialMenu");o&&e.addEventListener("contextmenu",function(e){e.preventDefault(),U(o,H(e)),ne(o)},!1)}addMaterial(e){const t=e;let o=t.li=document.createElement("li"),n=document.createRange().createContextualFragment('<span class="materialIcon"></span>');t.pict=n.firstElementChild,t.pict.addEventListener("click",e=>{this.editMaterial(e,[t])}),t.pict.style.backgroundColor=De(...t.pbr.baseColor),o.appendChild(n);let r=document.createRange().createContextualFragment(`<span>${t.name}</span>`);t.text=r.firstElementChild,t!==tt.default&&Jo.addRenameListener(t.text,t),t.text.addEventListener("contextmenu",function(e){e.preventDefault();let o=document.querySelector("#materialMenu");o&&(U(o,H(e)),ne(o),er(null,[t]))},!1),o.appendChild(r);let i=document.createRange().createContextualFragment(`<span class="resultCount">${t.usageCount}</span>`);if(t.guiStatus.count=i.firstElementChild,o.appendChild(i),this.view.appendChild(o),this.submenu||(this.submenu=document.querySelector('[data-menuid="faceMaterialMenu"]'),this.submenu&&(this.submenu=this.submenu.nextElementSibling)),this.submenu){t.menu={},o=t.menu.li=document.createElement("li");let e=document.createRange().createContextualFragment("<a></a>");t.menu.a=e.firstElementChild,o.appendChild(e);let n=document.createRange().createContextualFragment(`<span>${t.name}</span>`);t.menu.text=n.firstElementChild,t.menu.a.appendChild(n);let r=document.createRange().createContextualFragment('<span style="width: 1rem;"></span>');t.menu.color=r.firstElementChild,t.menu.a.appendChild(r),t.menu.color.style.backgroundColor=De(...t.pbr.baseColor),t.menu.a.addEventListener("click",function(e){er(null,[t]),B(e.button,"assignMaterial",e)}),this.submenu.prepend(o)}this.list.push(t)}createMaterial(e){const t=this,o=t.newName();Y("#materialSetting",e,function(e){const n=X(e);t.addMaterial(tt.create(o,n))},function(e){e.reset(),en.resetCSS();const t=e.querySelector("h3 > span");t&&(t.textContent=o)})}duplicateMaterial(e){const t=e[0];let o=t.name.split(/\d+$/);o=o.length>1?o[0]+(parseInt(t.name.match(/\d+$/),10)+1):t.name+"2",this.addMaterial(tt.create(o,t.pbr))}editMaterial(e,t){const o=t[0];Y("#materialSetting",e,function(e){const t=X(e);o.setValues(t),o.menu.color.style.backgroundColor=o.pict.style.backgroundColor=De(...o.pbr.baseColor)},function(e){e.reset(),en.resetCSS();const t=e.querySelector("h3 > span");t&&(t.textContent=o.name);for(let[t,n]of Object.entries(o.pbr)){const o=e.querySelector(`div > [name=${t}]`);o&&(isNaN(n)?o.value=De(n[0],n[1],n[2]):o.value=n,o.onchange&&o.onchange())}})}deleteMaterial(e){const t=e[0];t!==tt.default&&(this.view.removeChild(t.li),this.list.splice(this.list.indexOf(t),1),this.submenu.removeChild(t.menu.li))}newName(){return`New Material ${this.list.length}`}renameMaterial(e,t){const o=t[0];o!==tt.default&&Y("#renameDialog",e,function(e){const t=X(e);o.name=t[o.uuid],o.menu.text.textContent=o.text.textContent=o.name},function(e){G(e,t)})}static resetCSS(){const e=document.documentElement.style;e.setProperty("--baseColorMax","#FFFFFF"),e.setProperty("--emissionMax","#FFFFFF")}}const tn='data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-folder"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>';let on;async function nn(e,t,o,n){return new Promise(function(r,i){if(!on){const e=document.getElementById("contentPicker");e||i("No dialog exist");const t=e.querySelector(".breadcrumb");t||i("No contentSelect Nav");const o=e.querySelector(".filePicker");o||i("No contentSelect fileList Pane");const n=e.querySelector(".fileSelected");n||i("no fileSelected input"),(on={main:e,nav:t,filePane:o,selected:null,nameInput:n,resolve:null,reject:null,logoClass:"",updateNav:function(e){const t=e.split("/");let o=this.nav.querySelectorAll("a"),n=t.length-o.length;if(n>0){const e=document.createRange().createContextualFragment("<li><a></a></li>".repeat(n));this.nav.appendChild(e),o=this.nav.querySelectorAll("a")}else if(n<0){for(;n++<0;)this.nav.removeChild(this.nav.lastChild);o=this.nav.querySelectorAll("a")}let r,i="";for(let e=0;e<t.length;++e){r=o[e];const n=t[e],s=r.textContent!==n;r.classList.remove("current"),n.length>0&&(i+="/"+n),r.dataset.filepath=i,s&&(r.textContent=n)}o[o.length-1].classList.add("current"),this.nav.dataset.filepath=e},updateFolder:async function(e){function t(e,t){const o=e.querySelector("input");o.dataset.filepath=t.path,o.dataset.filename=t.name;let n=e.querySelectorAll("span");n[0].textContent=t.name,t.isFile?(e.querySelector("img").src="#",o.classList.remove("folder"),n[1].textContent=function(e,t=1){if(0===e)return"0 Bytes";const o=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(o))+" "+["bytes","kB","MB","GB","TB","PB","EB","ZB","YB"][n]}(t.size),n[1].setAttribute("data-after",t.modified.toLocaleString("en-US",{year:"2-digit",month:"short",day:"numeric"}))):(e.querySelector("img").src=tn,o.classList.add("folder"),n[1].textContent="",n[1].setAttribute("data-after",""))}this.updateNav(e);const{fileItems:o,cursor:n}=await this.readFolder(e);let r=this.filePane.querySelectorAll("label"),i=o.length-r.length;if(i>0){const e=document.createRange().createContextualFragment('<label class="fileItem"><input type="radio" name="selectFile"><img><span class="filename"></span><span class="sizeDate"></span></label>'.repeat(i));this.filePane.appendChild(e),r=this.filePane.querySelectorAll("label")}else if(i<0){for(;i++<0;)this.filePane.removeChild(this.filePane.lastChild);r=this.filePane.querySelectorAll("label")}for(let e=0;e<o.length;++e)t(r[e],o[e])},handleSubmit:function(e){if(e.preventDefault(),on.main.style.display="none",document.body.removeChild(on.main.parentNode),document.body.appendChild(on.main),"ok"===this.submitButton.value){const e=this.nav.dataset.filepath+"/"+this.nameInput.value;this.resolve([e])}else"cancel"===this.submitButton.value&&this.reject("cancel")},handleNav:function(e){let t;for(e.stopPropagation(),t=e.target;!t.matches("a");t=t.parentNode);t.classList.contains("current")||this.updateFolder(t.dataset.filepath)},handleFileItems:function(e){e.stopPropagation(),e.target.matches("input")&&(e.target.classList.contains("folder")?this.updateFolder(e.target.dataset.filepath):(this.selected&&this.selected!==e.target&&this.selected.parentNode.classList.toggle("selected"),e.target.parentNode.classList.toggle("selected"),e.target.checked?(this.selected=e.target,this.nameInput.value=this.selected.dataset.filename):this.main.querySelectorAll('[type="submit"][value="ok"]').forEach(e=>{e.disabled=!0})))}}).filePane.addEventListener("change",e=>{on.handleFileItems(e)}),on.nav.addEventListener("click",e=>{on.handleNav(e)}),on.main.addEventListener("submit",e=>{on.handleSubmit(e)});for(let e of on.main.querySelectorAll("[type=submit]"))e.addEventListener("click",t=>{t.stopPropagation(),on.submitButton=e})}on.resolve=r,on.reject=i,on.readFolder=t,void 0===n?(on.main.querySelector(".title").textContent="Open",on.nameInput.value="",on.nameInput.disabled=!0):(on.main.querySelector(".title").textContent="SaveAs",on.nameInput.value=n,on.nameInput.disbled=!1),on.nav.querySelector(".home").src=e,on.updateFolder(o);const s=document.createElement("div");s.classList.add("overlay"),s.addEventListener("keydown",function(e){e.stopPropagation()}),s.appendChild(on.main),on.main.style.display="block",s.classList.add("realCenterModal"),on.main.reset(),document.body.appendChild(s)})}const rn={method:"GET",username:null,password:null,data:null,headers:{"Content-Type":"application/x-www-form-urlencoded"},responseType:"",timeout:null,withCredentials:!1};function sn(e,t={},o,n){let r=Object.assign({},rn);r=Object.assign(r,t);const i=new XMLHttpRequest,s=new Promise(function(t,n){o&&i.addEventListener("progress",function(e){if(e.lengthComputable){const t=parseInt(100*e.loaded/e.total);o(t)}}),i.addEventListener("load",function(){i.status>=200&&i.status<300?t({data:i.response,xhr:i}):n({status:i.status,statusText:i.statusText,responseText:i.response})}),i.open(r.method,e,!0,r.username,r.password),i.responseType=r.responseType;for(const[e,t]of Object.entries(r.headers))i.setRequestHeader(e,t);r.timeout&&(i.timeout=r.timeout,i.ontimeout=function(e){n({status:408,statusText:"Request timeout"})}),r.withCredentials&&(i.withCredentials=!0),i.send(r.data)});return s.cancel=function(){i.abort(),n&&n()},s}let an=function(){};let ln=function(){},cn=0,dn=0;let un,fn,hn,pn={};function gn(){return pn}function mn(){return new Promise(function(e,t){if(fn)e(fn);else if(fn=window.localStorage.getItem("dropboxAccessToken"))e(fn);else{const o=780,n=580,r=window.top.outerHeight/2+window.top.screenY-o/2,i=window.top.outerWidth/2+window.top.screenX-n/2,s=window.location.protocol+"//"+window.location.host+"/dropbox-login.html",a=window.open(s,"_blank",`alwaysRaised=1, toolbar=0, menubar=0, status=0, height=${o}, width=${n}, top=${r}, left=${i}`);if(a){let o;window.addEventListener("message",o=function(n){try{const r=JSON.parse(n.data);if(!(r instanceof Array))return;if("dialogLogin"===r.shift()){a.close();const n=r.shift();n.access_token?(fn=n.access_token,window.localStorage.setItem("dropboxAccessToken",fn),e(fn)):t(n),window.removeEventListener("message",o)}}catch(e){}}),a.addEventListener("load",()=>{a.postMessage(["setClientID",un],"*")})}else t("open window failed, popup blocked?")}})}async function vn(e){const t={method:"POST",responseType:"json",headers:{Authorization:`Bearer ${await mn()}`,"Content-Type":"application/json"},data:JSON.stringify({path:e,recursive:!1,include_deleted:!1,include_has_explicit_shared_members:!1,include_mounted_folders:!0,include_non_downloadable_files:!0})};return await sn("https://api.dropboxapi.com/2/files/list_folder",t).then(e=>(function(e){return"json"===e.xhr.responseType?[e,e.data]:[e,JSON.parse(e.data)]})(e)).then(([e,t])=>{const o=[],n=[];for(let e of t.entries)if("folder"===e[".tag"])o.push({isFile:!1,name:e.name,path:e.path_lower,pathDisplay:e.path_display});else{let t=new Date(e.client_modified);n.push({isFile:!0,name:e.name,path:e.path_lower,pathDisplay:e.path_display,modified:t,size:e.size})}let r;return t.entries.has_more&&(r=t.entries.cursor),{fileItems:o.concat(n),cursor:r}})}function yn(e){e&&(un=e.getAttribute("data-app-key"),e.querySelector(".home").src=xn,e.addEventListener("click",function(e){try{!async function(e,t,o){const n=gn(),r=await mn();let i;(o>0||!hn)&&(i=(await nn(xn,vn,"","untitled"))[0]);const s=e();i=i?i+"."+t:hn.path_display,sn("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{Authorization:"Bearer "+r,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:i,mode:"overwrite",autorename:!1,mute:!1})},data:s},n.progress,n.cancel).then(e=>(hn=JSON.parse(e.xhr.response)).name)}(ln,dn,cn)}catch(e){console.log(e)}}))}const xn='data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 235.45 200"><defs><style>.cls-1{fill:%230061ff;}</style></defs><title>DropboxGlyph</title><polygon class="cls-1" points="58.86 0 0 37.5 58.86 75 117.73 37.5 58.86 0"/><polygon class="cls-1" points="176.59 0 117.73 37.5 176.59 75 235.45 37.5 176.59 0"/><polygon class="cls-1" points="0 112.5 58.86 150 117.73 112.5 58.86 75 0 112.5"/><polygon class="cls-1" points="176.59 75 117.73 112.5 176.59 150 235.45 112.5 176.59 75"/><polygon class="cls-1" points="58.86 162.5 117.73 200 176.59 162.5 117.73 125 58.86 162.5"/></svg>';function Sn(e){e&&(un=e.getAttribute("data-app-key"),e.querySelector(".home").src=xn,e.addEventListener("click",async function(e){try{const e=await async function(e){const t=gn(),o=await mn(),n=await nn(xn,vn,e),r={method:"POST",responseType:"arraybuffer",headers:{Authorization:`Bearer ${o}`,"Dropbox-API-Arg":JSON.stringify({path:n[0]})}},i=await sn("https://content.dropboxapi.com/2/files/download",r,t.progress,t.cancel);return new Blob([i.data],{type:"application/octet-stream"})}("");an.import(e)}catch(e){console.log(e)}}))}function bn(){!function(e){pn=Object.assign(pn,e)}({success:function(e){},progress:function(e){},cancel:function(){},error:function(e){}})}let En,wn;function Cn(e,t,o,n=0){if(!En){if(!(En=document.getElementById("cloudSaveDialog")))return alert("Error: no SaveDialog"),!1;bn(),yn(document.getElementById("dropboxSave"));const e=document.getElementById("localSave");e&&e.addEventListener("click",function(e){const t=ln();window.saveAs(t,"untitled."+dn)})}!function(e,t,o){ln=e,cn=o,dn=t}(t,o,n),q("#cloudSaveDialog",function(){},null,e)}function Fn(e,t){if(!wn){if(!(wn=document.getElementById("cloudOpenDialog")))return alert("Error: no OpenDialog"),!1;bn(),Sn(document.getElementById("dropboxOpen"));const e=document.querySelector("#importFile");if(e){e.addEventListener("change",function(t){let o=this.files;for(let e of o)an.import(e);e.value=""});const t=document.getElementById("localOpen");t&&t.addEventListener("click",function(t){e.click()})}}an=t,q("#cloudOpenDialog",function(){},null,e)}const An={showEdges:!0,showBackfaces:!0,showNormals:!1,showBB:!0,showBBCenter:!0,showColors:!0,showMaterials:!0,showTextures:!0,showNormalMaps:!0,showWireBackfaces:!1,showGroundplane:!0,showCamImagePlane:!1,showAxes:!0,infoVerbose:!1,constrainAxes:!0,clipPlane:!1,orthogonalView:!1,filterTexture:!0,frameDisregardsMirror:!1,useSceneLights:!1,forceOrthoAlongAxis:!1,workmode:!0,allowRotation:!0,allowInfoText:!0,showMiniAxis:!0},_n={activeVectorColor:[0,1,0],clipPlaneColor:[.8,.3,0],defaultAxis:[[0,0,0],[1,0,0]],gridColor:"#4D4D4D",draftBench:{unselectedEdgeColor:"#000000",hardEdgeColor:"#FF8000",selectedColor:"#A60000",selectedHilite:"#B3B300",unselectedHilite:"#00A600",unselectedVertexColor:"#000000",faceColor:"#C9CFB1",sculptMagnetColor:"#0000FF",tweakMagnetColor:"#0000FF",tweakVectorColor:"#FF8000"},draftBenchPref:{unselectedVertexSize:4,selectedVertexSize:5,maskedVertexSize:8,unselectedEdgeWidth:2,selectedEdgeWidth:2,hardEdgeWidth:2},normalVectorColor:[0,1,0],colorX:"#B3001A",colorY:"#5FD100",colorZ:"#004DCC",negColorX:"#CCCCCC",negColorY:"#CCCCCC",negColorZ:"#CCCCCC",geometryBackground:"#CCCCCC",css:{menubarBackground:"#3C3B37",menubarText:"#FFFFFF",menuBackground:"#3C3B37",menuText:"#FFFFFF",menuHighlight:"#F07746",menuHighlightText:"#FFFFFF",infoLineBackground:"#F2F1F0",infoLineText:"#4C4C4C",infoBackground:"#6161617F",infoText:"#FFFFFF"}},Mn={geometryBackground:"FF",infoBackground:"7F"};function Vn(e,t){Object.entries(e).forEach(([o,n])=>{"object"!=typeof n||Array.isArray(n)?t(e,o,n):Vn(n,t)})}function Ln(e){Vn(_n,(t,o,n)=>{let r=e.querySelector(`input[type=color][name=${o}]`);r&&(9===n.length?r.value=n.slice(0,7):r.value=n),(r=e.querySelector(`input[type=number][name=${o}]`))&&(r.value=n)}),Vn(An,(t,o,n)=>{const r=e.querySelector(`input[type=checkbox][name=${o}]`);r&&(r.checked=n)}),Vn(An,(e,t,o)=>{})}function Pn(e){Vn(_n,(t,o,n)=>{let r=e.querySelector(`input[type=color][name=${o}]`);r&&(t[o]=Mn[o]?r.value+Mn[o]:r.value),(r=e.querySelector(`input[type=number][name=${o}]`))&&(t[o]=r.value)});const t=document.documentElement;Object.entries(_n.css).forEach(([e,o])=>{7===o.length?t.style.setProperty(`--${e}`,o):9===o.length&&t.style.setProperty(`--${e}`,function(e){return`rgba(${parseInt(e.slice(1,3),16)}, ${parseInt(e.slice(3,5),16)}, ${parseInt(e.slice(5,7),16)}, ${parseInt(e.slice(7,9),16)/255})`}(o))}),Xn.draftBench.setTheme(_n.draftBench,_n.draftBenchPref),Vn(An,(t,o,n)=>{const r=e.querySelector(`input[type=checkbox][name=${o}]`);r&&(t[o]=r.checked)}),We()}const Bn={face:null,edge:null,vertex:null,body:null,multi:null,current:null};function Tn(e){let t=document.getElementById("toggle"+e+"ModeFor");t&&!t.checked&&t.click()}function In(){Bn.current!==Bn.vertex&&(Bn.current.toggleFunc(Bn.vertex),Bn.current=Bn.vertex,Tn("Vertex"),We())}function On(){Bn.current!==Bn.face&&(Bn.current.toggleFunc(Bn.face),Bn.current=Bn.face,Tn("Face"),We())}function zn(){Bn.current!==Bn.edge&&(Bn.current.toggleFunc(Bn.edge),Bn.current=Bn.edge,Tn("Edge"),We())}function Dn(){Bn.current!==Bn.body&&(Bn.current.toggleFunc(Bn.body),Bn.current=Bn.body,Tn("Body"),We())}function Nn(){Bn.current!==Bn.multi&&(Bn.current.toggleFunc(Bn.multi),Bn.current=Bn.multi,Tn("Multi"),We())}function Rn(e){Bn.current!==Bn.vertex&&(Bn.current.restoreMode(Bn.vertex,e),Bn.current=Bn.vertex,Tn("Vertex"),We())}function kn(e){Bn.current!==Bn.face&&(Bn.current.restoreMode(Bn.face,e),Bn.current=Bn.face,Tn("Face"),We())}function jn(e){Bn.current!==Bn.edge&&(Bn.current.restoreMode(Bn.edge,e),Bn.current=Bn.edge,Tn("Edge"),We())}function Hn(e){Bn.current!==Bn.body&&(Bn.current.restoreMode(Bn.body,e),Bn.current=Bn.body,Tn("Body"),We())}function Un(e){Bn.current!==Bn.multi&&(Bn.current.restoreMode(Bn.multi,e),Bn.current=Bn.multi,Tn("Multi"),We())}const Gn=()=>Bn.current,Xn={world:new Mt,draftBench:void 0,geometryGraph:void 0,imageList:void 0,materialList:void 0,lightList:void 0,currentObjects:void 0,currentParent:void 0,fileName:""};function Yn(e){Xn.materialList.addMaterial(e)}function qn(){return $n(new Pt(Xn.draftBench))}function Wn(e,t){t.removeFromParent(),e.insert(t),Xn.world.numberOfCage()}function $n(e,t=Xn.world){return t.insert(e),Xn.geometryGraph.addObject(e,t.guiStatus.ul),e.setVisible(!0),We(),Xn.world.numberOfCage(),e}function Zn(e){const t=e.removeFromParent();return t&&(e.setVisible(!1),We(),Xn.geometryGraph.removeObject(e),Xn.world.numberOfCage()),t}function Kn(){return Xn.world.getCage()}function Jn(){We()}function Qn(e){let t=new Pt(Xn.draftBench);for(let t of e)Zn(t);return t.merge(e),$n(t),t}function er(e,t){Xn.currentObjects=t,Xn.currentParent=e}const tr={cage:null,edge:null,vertex:null,face:null,plane:null};let or;const nr={camera:null,mousemove:null,mouseSelect:null},rr={center:vec3.create(),halfSize:vec3.create(),normal:vec3.create(),hilite:!1},ir=()=>nr.mouseSelect?nr.mouseSelect.isVertexSelectable():!Bn.current||Bn.current.isVertexSelectable(),sr=()=>nr.mouseSelect?nr.mouseSelect.isEdgeSelectable():!Bn.current||Bn.current.isEdgeSelectable(),ar=()=>nr.mouseSelect?nr.mouseSelect.isFaceSelectable():!Bn.current||Bn.current.isFaceSelectable(),lr=()=>!!nr.mouseSelect&&nr.mouseSelect.getPlaneNormal();function cr(e,t,o){let n=null,r=null,i=null,s=null;if(tr.plane=null,null!==e){const o=vec3.create(),a=vec3.create(),l=vec3.create(),c=e.destination(),d=e.origin;vec3.sub(o,t,d),vec3.sub(a,t,c),vec3.sub(l,c,d);const u=vec3.length(o),f=vec3.length(a),h=vec3.length(l),p=h/4,g=ir(),m=sr(),v=ar(),y=lr(),x=e.face;if(y&&(vec3.copy(rr.halfSize,x.getBVHRoot().getHalfSize()),vec3.copy(rr.normal,nr.mouseSelect.getPlaneNormal())),g&&(u<f?(!m&&!v||u<p)&&(n=e.origin):(!m&&!v||f<p)&&(n=e.destination()),n&&y&&(vec3.copy(rr.center,n),tr.plane=rr)),m&&null===n){vec3.cross(o,o,a),vec3.sub(a,c,d);const t=vec3.length(o)/h;(!g&&!v||t<p)&&(r=e,y&&(vec3.add(rr.center,r.origin,r.destination()),vec3.scale(rr.center,rr.center,.5),tr.plane=rr))}v&&null===n&&null===r&&(i=e.face,y&&(vec3.copy(rr.center,x.center),tr.plane=rr)),g||m||v||(s=or)}n!==tr.vertex&&(null!==tr.vertex&&tr.vertex.setHilite(!1),null!==n&&(nr.mouseSelect&&!nr.mouseSelect.hilite({vertex:n,plane:tr.plane},or)?n=null:n.setHilite(!0)),tr.vertex=n),r!==tr.edge&&(null!==tr.edge&&tr.edge.setHilite(!1),null!==r&&(nr.mouseSelect&&!nr.mouseSelect.hilite({edge:r,plane:tr.plane},or)?r=null:r.setHilite(!0)),tr.edge=r),i!==tr.face&&(null!==tr.face&&tr.face.setHilite(!1),null!==i&&(nr.mouseSelect&&!nr.mouseSelect.hilite({face:i,plane:tr.plane},or)?i=null:i.setHilite(!0)),tr.face=i),s!==tr.cage&&(null!==tr.cage&&tr.cage.hiliteBody(!1),s&&s.hiliteBody(!0),tr.cage=s),tr.vertex||tr.edge||tr.face||(tr.plane=null)}let dr=null;let ur=null;function fr(){null!==ur&&(wr(ur.finish()),ur=null)}function hr(e){0==e.button&&(null!==nr.camera?(nr.camera.doIt(),nr.camera=null,y(I.cameraModeExit,pe),help("L:Select   M:Start Camera   R:Show Menu   [Alt]+R:Tweak menu")):null!==nr.mousemove?(wr(nr.mousemove),nr.mousemove=null):null!==nr.mouseSelect?nr.mouseSelect.select(tr)&&(nr.mouseSelect.isMoveable()?nr.mousemove=nr.mouseSelect:wr(nr.mouseSelect),nr.mouseSelect=null):null!==dr&&(Bn.current.toggleMulti(tr),ur=Bn.current.selectStart(dr.model,tr),We()))}function pr(e){null!==nr.camera?help("L:Accept   M:Drag to Pan  R:Cancel/Restore to View   Move mouse to tumble"):help("L:Select   M:Start Camera   R:Show Menu   [Alt]+R:Tweak menu")}function gr(e){fr()}function mr(e){0==e.button?fr():1==e.button&&null===nr.camera&&(e.stopImmediatePropagation(),nr.camera=new fe,y(I.cameraModeEnter,pe),help("L:Accept   M:Drag to Pan  R:Cancel/Restore to View   Move mouse to tumble"))}function vr(e){if(null!==nr.camera)nr.camera.handleMouseMove(e);else if(null!==nr.mousemove)nr.mousemove.handleMouseMove(e,pe),We();else{var t=n.getViewport();const l={left:e.currentTarget.offsetLeft,top:e.currentTarget.offsetTop};for(let t=e.currentTarget.offsetParent;t;t=t.offsetParet)l.left+=t.offsetLeft,l.top+=t.offsetTop;var o=e.pageX-l.left,r=t[3]+1-(e.pageY-l.top);o<0&&(o=0),o>t[2]&&(o=t[2]),r<0&&(r=0),r>t[3]&&(r=t[3]);var i=Ar(!1),s=n.unProject(o,r,0,i.modelView,i.projection),a=n.unProject(o,r,1,i.modelView,i.projection);vec3.sub(a,a,s),vec3.normalize(a,a),!function(e){let t=null;for(let o of Xn.world.getCage())if(!o.isLock()&&o.isVisible()){const n=o.rayPick(e);null!==n&&(null===t||t.t>n.t)&&(t=n)}if(null!==t){or=t.model,dr=t;let o=vec3.create();vec3.scaleAndAdd(o,e.origin,e.direction,t.t),cr(t.edge,o,t.center),We()}else null!==dr&&(cr(null),We());dr=t}(new Qe(s,a)),null!==ur&&null!==dr&&(ur.dragSelect(dr.model,tr),We())}}function yr(e){nr.mousemove=e}function xr(e){nr.mouseSelect=e}function Sr(e){var t,o=e.deltaX,n=e.deltaY,r=e.deltaZ;if((o||n||r)&&e.deltaMode){var i=360;1==e.deltaMode&&(i=18),o*=i,n*=i,r*=i}t=n,he.wheelZooms&&me(he.wheelZoomFactor,t)}const br={queue:[],current:-1};function Er(e){wr(new ue(e))}function wr(e){for(;br.queue.length-1>br.current;){br.queue.pop().free()}br.queue.push(e),br.current++,We()}function Cr(){br.queue.length-1>br.current&&(br.queue[++br.current].doIt(Bn.current),We())}function Fr(){if(br.current>=0){br.queue[br.current--].undo(Bn.current),We()}}function Ar(e){let t=function(e){const t=n.getViewport(),o=(t[2]-t[0])/(t[3]-t[1]),r=pe,i=An.orthogonalView;!i&&r.alongAxis&&(i=An.force_ortho_along_axis);var s=mat4.create();if(i){const e=r.distance*Math.tan(r.fov*Math.PI/180/2);mat4.ortho(s,-e*o,e*o,-e,e,r.zNear,r.zFar)}else mat4.perspective(s,r.fov,o,r.zNear,r.zFar);return mat4.mul(n.projection,e,s),n.projection}(mat4.create()),o=function(e=!1){const t=pe;let o=!1;e&&(o=An.useSceneLights);mat4.fromTranslation(n.modelView,vec3.fromValues(t.panX,t.panY,-t.distance)),mat4.rotateX(n.modelView,n.modelView,t.elevation*Math.PI/180),mat4.rotateY(n.modelView,n.modelView,t.azimuth*Math.PI/180),mat4.translate(n.modelView,n.modelView,t.origin);return{useScentLights:o,modelView:n.modelView}}(e);return{projection:t,modelView:o.modelView,useSceneLights:o.useSceneLights}}function _r(e){let t=0;for(let e of Xn.world.getCage())e.updateStatus(),++t;0!==t&&(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(1,1),Bn.face.polygonShader(e,tr.face||tr.cage),e.bindTransform(),Xn.draftBench.draw(e,Bn.current),e.disable(e.POLYGON_OFFSET_FILL),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),Bn.current.edgeShader(e,sr()),e.bindTransform(),Xn.draftBench.drawEdge(e,Bn.current),Bn.current.vertexShader(e,ir())&&(e.bindTransform(),Xn.draftBench.drawVertex(e,Bn.current)),e.disable(e.BLEND),tr.plane&&Xn.draftBench.drawPlane(e,tr.plane))}p(function(){Bn.face=new To,Bn.edge=new Eo,Bn.vertex=new oo,Bn.body=new co,Bn.multi=new Yo,Bn.current=Bn.multi,Xn.draftBench=new qo(_n.draftBench,_n.draftBenchPref,Xn.materialList);const e=[{id:I.deselect,fn:"resetSelection",hotKey:" "},{id:I.more,fn:"moreSelection",hotKey:"+"},{id:I.less,fn:"lessSelection",hotKey:"-"},{id:I.similar,fn:"similarSelection",hotkey:"i"},{id:I.all,fn:"allSelection",hotKey:"a",meta:"ctrl"},{id:I.invert,fn:"invertSelection",hotKey:"i",meta:"ctrl+shift"},{id:I.adjacent,fn:"adjacentSelection"}];for(let t of e)R(t.id.name,function(e){const o=new de(t.fn);o.doIt(Bn.current)&&wr(o)},t.hotKey,t.meta);R(I.openSidebar.name,e=>{const t=document.querySelector("#sidebar"),o=document.querySelector("#openSidebarFor");t&&o&&(o.checked?t.style.display="none":t.style.display="flex")});const t=[{id:I.undoEdit,fn:Fr,hotKey:" "},{id:I.redoEdit,fn:Cr,hotKey:" "},{id:I.toggleVertexMode,fn:In,hotKey:" "},{id:I.toggleEdgeMode,fn:zn,hotKey:" "},{id:I.toggleFaceMode,fn:On,hotKey:" "},{id:I.toggleBodyMode,fn:Dn,hotKey:" "},{id:I.toggleMultiMode,fn:Nn,hotkey:" "}];for(let e of t)R(e.id.name,function(t){help("wings3d - "+t.currentTarget.id),e.fn()});const o=[{id:I.toggleGround,propName:"showGroundplane",selector:"#toggleGroundFor"},{id:I.toggleAxes,propName:"showAxes",selector:"#toggleAxesFor"},{id:I.toggleOrtho,propName:"orthogonalView",selector:"#toggleOrthoFor"}];for(let e of o)R(e.id.name,t=>{const o=document.querySelector(e.selector);o&&(An[e.propName]=!o.checked,We())});R(I.preferenceButton.name,e=>{q("#preferenceForm",Pn,Ln)}),Xn.geometryGraph=function(e,t,o){const n=document.querySelector(e),r=document.querySelector(t);return n&&r?new Ko(n,r,o):null}("#objectListLabel","#objectList",Xn.world),P([],0,I.toggleObjectSelect.name,e=>{Bn.current===Bn.multi&&On();const t=new Rt(e.target),o=new to(Gn(),Gn().selectObject,[Xn.currentObjects,e.target],Gn().undoSelectObject,[e.target]);o.doIt(),Er([t,o])}),P([],0,I.toggleObjectVisibility.name,e=>{const t=new Rt(e.target),o=new to(Gn(),Gn().toggleObjectVisibility,[Xn.currentObjects,e.target],Gn().undoObjectVisibility);o.doIt(),Er([t,o])}),P([],0,I.toggleObjectLock.name,e=>{const t=new Rt(e.target),o=new to(Gn(),Gn().toggleObjectLock,[Xn.currentObjects,e.target],Gn().undoToggleObjectLock);o.doIt(),Er([t,o])}),P([],0,I.toggleWireMode.name,e=>{const t=new Rt(e.target),o=new to(Gn(),Gn().toggleObjectWireMode,[Xn.currentObjects,e.target.checked],Gn().undoToggleObjectWireMode);o.doIt(),Er([t,o])}),R(I.objectDelete.name,e=>{const t=new ho(Xn.currentObjects);wr(t),t.doIt()}),R(I.objectDuplicate.name,e=>{const t=new go(Xn.currentObjects);wr(t),t.doIt()}),R(I.createGroup.name,e=>{const t=new Mt;t.name="new_folder";let o=Xn.currentParent;o||(o=Xn.world),o.insert(t),Xn.geometryGraph.addGroup(o.guiStatus.ul,t)}),R(I.createGroupWorld.name,e=>{const t=new Mt;t.name="new_folder";let o=Xn.world;o.insert(t),Xn.geometryGraph.addGroup(o.guiStatus.ul,t)}),Xn.imageList=function(e,t){const o=document.querySelector(t),n=document.querySelector(e);return n&&o?new Qo(n,o):null}("#imageListLabel","#imageList"),R(I.importImageFileGUI.name,function(e){!function(e){const t=document.querySelector("#importFile");t&&(t.click(),t.addEventListener("change",function(o){let n=this.files;for(let t of n)e(t);t.value=""}))}(function(e){Xn.imageList.loadImage(e)})}),R(I.showImage.name,function(e){Xn.imageList.showImage(Xn.currentObjects)}),R(I.deleteImage.name,function(e){Xn.imageList.deleteImage(Xn.currentObjects)}),Xn.materialList=function(e,t){const o=document.querySelector(t),n=document.querySelector(e);if(n&&o){const e=new en(n,o);return e.addMaterial(tt.default),e}return null}("#materialListLabel","#materialList"),R(I.createMaterial.name,function(e){Xn.materialList.createMaterial(e)}),R(I.editMaterial.name,function(e){Xn.materialList.editMaterial(e,Xn.currentObjects)}),R(I.deleteMaterial.name,function(e){0===Xn.currentObjects[0].usageCount?Xn.materialList.deleteMaterial(Xn.currentObjects):alert("Materials is in use")}),R(I.renameMaterial.name,function(e){Xn.materialList.renameMaterial(e,Xn.currentObjects)}),R(I.duplicateMaterial.name,function(e){Xn.materialList.duplicateMaterial(Xn.currentObjects)}),R(I.assignMaterial.name,function(e){if(Bn.current===Bn.face){const e=new to(Gn(),Gn().assignMaterial,[Xn.currentObjects[0]],Gn().undoAssignMaterial);wr(e),e.doIt()}else help("Cannot Assign Material without selecting Face")}),R(I.selectMaterial.name,function(e){const t=Gn().selectMaterialCmd([Xn.currentObjects[0]]);t.doIt(),wr(t)});let r=document.querySelectorAll("li.dropdown > a");for(let e of r){const t=e.getAttribute("data-menuid");if(t){let o=e.nextElementSibling;o&&o.classList.contains("popup")&&o.classList.contains("menu")&&R(t,function(e){var t;(t=o)!==J&&(Q=t,J||oe())})}}r=document.querySelectorAll("li.dropside > a");for(let e of r){const t=e.getAttribute("data-menuid");if(t){let o=e.nextElementSibling;o&&o.classList.contains("popup")&&o.classList.contains("menu")&&R(t,function(e){K(o),e.stopPropagation()})}}document.addEventListener("keydown",function(e){!function(e,t){const o=S(t.altKey,t.ctrlKey,t.shiftKey),n=t.key.toLowerCase();let r=z.get(n);if(r){for(let n of r)if(o===n.meta&&n.mode===e)return void B(0,n.id,t);for(let e of r)if(o===e.meta&&null===e.mode)return void B(0,e.id,t)}}(Gn(),e)}),n.canvas.addEventListener("mouseenter",pr,!1),n.canvas.addEventListener("mousedown",hr,!1),n.canvas.addEventListener("mouseup",mr,!1),n.canvas.addEventListener("mouseleave",gr,!1),n.canvas.addEventListener("mousemove",vr,!1),n.canvas.addEventListener("wheel",Sr,!1);let i={menu:document.querySelector("#create-context-menu")};n.canvas.addEventListener("contextmenu",function(e){if(t=e,!(nr.camera||nr.mousemove||nr.mouseSelect)||(t.preventDefault(),t.stopImmediatePropagation(),nr.camera?(nr.camera.undo(),nr.camera=null,y(I.cameraModeExit,pe),help("L:Select   M:Start Camera   R:Show Menu   [Alt]+R:Tweak menu")):nr.mousemove?(nr.mousemove.undo(),nr.mousemove=null,We()):(nr.mouseSelect=null,We()),0)){e.preventDefault();let t=Gn().getContextMenu();t&&t.menu||(t=i),U(t.menu,H(e)),ne(t.menu)}var t},!1),Tt.addLoadStore(new It);let s=new zt;Tt.setDefault(s);for(let e of Tt.LOADSTORE){if(e.importMenuText){const t=e.importMenuText;j("fileImport","import"+t.name,`${t.name} (.${t.ext})...`,function(t){Fn(t,e)})}if(e.exportMenuText){const t=e.exportMenuText;j("fileExport","export"+t.name,`${t.name} (.${t.ext})...`,function(t){Cn(t,()=>e.export(Kn()),e.extension())})}}R(I.save.name,function(e){Cn(e,()=>s.export(Kn()),s.extension())}),R(I.open.name,function(e){Fn(e,s)}),requestAnimationFrame(function e(t){!function(e){let t=0;for(let e of Xn.world.getCage())++t;t>0&&Xn.draftBench.isModified()&&We(),$e(e,_r)}(n),requestAnimationFrame(e)})});let Mr=null;const Vr={stops:new Map,routes:[],currentStation:-1};let Lr=null,Pr={};function Br(e){Pr.next&&(Pr.next.style.display=e?"inline-block":"none")}function Tr(){return Lr||Vr.routes[Vr.currentStation]}function Ir(e){const t=Pr.bubble.getElementsByClassName(e);if(t.length>0)return t[0]}let Or,zr,Dr=function(e){if(e<0||e>=Vr.routes.length)console.log("bad step number in tutor guide");else{if(e===Vr.routes.length-1&&(Pr.next.textContent="Done"),Vr.currentStation>=0&&Vr.currentStation<Vr.routes.length){Tr().done()}Vr.currentStation=e;const t=Tr();Br(t.option("showNext")),t.show()}};function Nr(){Vr.currentStation>-1&&Vr.routes[Vr.currentStation].done(),Pr.bubble.classList.add("hide"),Pr.next.textContent="Next",Vr.stops.clear(),Vr.routes.length=0,Vr.currentStation=-1,x(kr,!1)}function Rr(){Dr(Vr.currentStation+1)}function kr(e,t){if(Vr.currentStation>=0){Tr().expect(e,t),"createCube"===e&&(Mr=value)}}var jr;p(function(e){Pr.bubble=document.getElementById("tutorGuide"),Pr.bubble&&(Pr.close=Ir("close"),Pr.close&&Pr.close.addEventListener("click",function(e){Nr()}),Pr.next=Ir("next"),Pr.next&&Pr.next.addEventListener("click",function(e){"Done"===Pr.next.textContent?Nr():Rr()}),Pr.title=Ir("tutor-title"),Pr.content=Ir("tutor-content"),Pr.select=Ir("tutor-selection"),Pr.progressBar=Ir("tutor-progress"),Pr.progressDone=Ir("tutor-progress-done"),Pr.progressIndicator=Ir("tutor-progress-indicator"))}),document.addEventListener("DOMContentLoaded",function(){var e={previewCage:null};function t(){wr(new Bt(e.previewCage)),e.previewCage.name="Cube"+(e.creationCount+1),y("createCube",e.previewCage),e.previewCage=null,e.creationCount++}e.cubeParams={numberOfCut:1,spherize:!1,size:{x:2,y:2,z:2},rotate:{x:0,y:0,z:0},translate:{x:0,y:0,z:0},putOnGround:!1},e.creationCount=0,e.resetCubeParams=function(){e.cubeParams.numberOfCut=1,e.cubeParams.spherize=!1,e.cubeParams.size.x=e.cubeParams.size.y=e.cubeParams.size.z=2,e.cubeParams.rotate.x=e.cubeParams.rotate.y=e.cubeParams.rotate.z=0,e.cubeParams.translate.x=e.cubeParams.translate.y=e.cubeParams.translate.z=0,e.cubeParams.putOnGround=!1},e.cancelPreview=function(){null!==e.previewCage&&(Zn(e.previewCage),e.previewCage.freeBuffer(),e.previewCage=null)},e.updatePreview=function(){null!==e.previewCage&&(Zn(e.previewCage),e.previewCage.freeBuffer(),e.previewCage=null),Or(e.cubeParams.size,e.cubeParams.numberOfCut,e.cubeParams.translate,e.cubeParams.rotate,e.cubeParams.putOnGround)},Or=function(t,o,n,r,i){let s=qn(),a=s.geometry;var l={};function c(e){var t=e[0],o=e[1],n=e[2],r=t.toFixed(6)+","+o.toFixed(6)+","+n.toFixed(6);return l.hasOwnProperty(r)||(l[r]=a.addVertex(e)),l[r].index}function d(e){var t=0,n=[],r=[];for(let i=0;i<=o;++i){for(let t=0;t<=o;++t)n.push(c(e(i,t)));if(i>0){for(let e=0;e<o;++e)r.push(n[t+e]),r.push(n[t+e+1]),r.push(n[t+e+1+o+1]),r.push(n[t+e+o+1]),a.addPolygon(r,tt.default),r.length=0;t+=o+1}}}let u=quat.create();quat.fromEuler(u,r.x,r.y,r.z);const f=mat3.create();mat3.fromQuat(f,u);const h=vec3.fromValues(-t.x/2,-t.y/2,-t.z/2),p=vec3.fromValues(n.x,n.y,n.z);i&&(p[1]=-h[1]);const g=vec3.fromValues(t.x,0,0),m=vec3.fromValues(0,t.y,0),v=vec3.fromValues(0,0,t.z);vec3.transformMat3(h,h,f),vec3.transformMat3(g,g,f),vec3.transformMat3(m,m,f),vec3.transformMat3(v,v,f);const y=vec3.create(),x=[],S=[],b=[];for(let e=0;e<=o;++e){const t=e/o,n=vec3.create();vec3.scale(n,g,t),x.push(n);const r=vec3.create();vec3.scale(r,m,t),S.push(r);const i=vec3.create();vec3.scale(i,v,t),b.push(i)}vec3.add(y,h,g),d(function(e,t){return vec3.fromValues(y[0]-x[t][0]+S[e][0]+p[0],y[1]-x[t][1]+S[e][1]+p[1],y[2]-x[t][2]+S[e][2]+p[2])}),d(function(e,t){return[y[0]-x[e][0]+b[t][0]+p[0],y[1]-x[e][1]+b[t][1]+p[1],y[2]-x[e][2]+b[t][2]+p[2]]}),vec3.add(y,y,v),d(function(e,t){return[y[0]+S[e][0]-b[t][0]+p[0],y[1]+S[e][1]-b[t][1]+p[1],y[2]+S[e][2]-b[t][2]+p[2]]}),vec3.add(y,h,v),d(function(e,t){return[y[0]+x[t][0]+S[e][0]+p[0],y[1]+x[t][1]+S[e][1]+p[1],y[2]+x[t][2]+S[e][2]+p[2]]}),d(function(e,t){return[h[0]+S[e][0]+b[t][0]+p[0],h[1]+S[e][1]+b[t][1]+p[1],h[2]+S[e][2]+b[t][2]+p[2]]}),vec3.add(y,h,g),vec3.add(y,y,m),vec3.add(y,y,v),d(function(e,t){return[y[0]-x[e][0]-b[t][0]+p[0],y[1]-x[e][1]-b[t][1]+p[1],y[2]-x[e][2]-b[t][2]+p[2]]}),e.previewCage=s,Jn()};var o=document.getElementById("createCubeForm");if(null===o){(o=document.createElement("form")).setAttribute("id","createCubeForm"),o.innerHTML='\n         <span class="close">&times;</span>\n         <h3>Cube Options</h3>\n         <fieldset> \n            <legend>Number of Cuts</legend>\n            <input name="numberOfCuts" type="range" min="1" max="20" value="1" onchange="this.nextElementSibling.value=this.value" />\n            <input name="numberOfCuts" type="number" min="1" max="20" value="1" step="1" onchange="this.previousElementSibling.value=this.value" />\n         </fieldset>\n         <div>\n            <label>X <input type="number" name="size_x" value="2.0" step="0.5"></label><br>\n            <label>Y <input type="number" name="size_y" value="2.0" step="0.5"></label><br>\n            <label>Z <input type="number" name="size_z" value="2.0" step="0.5"></label>\n         </div>\n         <fieldset>\n            <legend>Spherize</legend>\n            <label><input type=\'radio\' name=\'sphere\' value=\'true\' disabled>Yes</label>\n            <label><input type=\'radio\' name=\'sphere\' value=\'false\' checked disabled>No<label>\n         </fieldset>\n         <fieldset>\n            <label>Rotate</label>\n            <span>\n               <label>X <input type="number" name="rotate_x" value="0.0" step="1"></label><br>\n               <label>Y <input type="number" name="rotate_y" value="0.0" step="1"></label><br>\n               <label>Z <input type="number" name="rotate_z" value="0.0" step="1"></label>    \n            </span>\n            <label>Move</label>\n            <span>\n               <label>X <input type="number" name="translate_x" value="0.0" step="0.5"></label><br>\n               <label>Y <input type="number" name="translate_y" value="0.0" step="0.5"></label><br>\n               <label>Z <input type="number" name="translate_z" value="0.0" step="0.5"></label>\n            </span>\n            <div>\n               <label><input type="checkbox" name="ground">Put on Ground</label>\n            </div>\n         </fieldset>\n          <button type="reset" value="Reset">Reset</button>\n          <button type="submit" value="Ok">Ok</button>\n      ',o.style.display="none",o.style.position="absolute",o.className+="dialog",document.body.appendChild(o),o.getElementsByClassName("close")[0].addEventListener("click",function(t){o.style.display="none",e.cancelPreview()}),o.addEventListener("submit",function(e){e.preventDefault(),o.style.display="none",t()});var n=function(t){e.cubeParams.numberOfCut=Number(t.target.value),e.updatePreview()},r=document.querySelectorAll('#createCubeForm input[name="numberOfCuts"]');r[0].addEventListener("change",n),r[1].addEventListener("change",n);var i=document.querySelectorAll('#createCubeForm input[name^="size_"]');i[0].addEventListener("change",function(t){e.cubeParams.size.x=Number(t.target.value),e.updatePreview()}),i[1].addEventListener("change",function(t){e.cubeParams.size.y=Number(t.target.value),e.updatePreview()}),i[2].addEventListener("change",function(t){e.cubeParams.size.z=Number(t.target.value),e.updatePreview()});const s=document.querySelectorAll('#createCubeForm input[name^="translate_"]');s[0].addEventListener("change",function(t){e.cubeParams.translate.x=Number(t.target.value),e.updatePreview()}),s[1].addEventListener("change",function(t){e.cubeParams.translate.y=Number(t.target.value),e.updatePreview()}),s[2].addEventListener("change",function(t){e.cubeParams.translate.z=Number(t.target.value),e.updatePreview()});const a=document.querySelectorAll('#createCubeForm input[name="ground"]');a[0].addEventListener("change",function(t){a[0].checked?(s[1].disabled=!0,e.cubeParams.putOnGround=!0):(s[1].disabled=!1,e.cubeParams.putOnGround=!1),e.updatePreview()});const l=document.querySelectorAll('#createCubeForm input[name^="rotate_"]');l[0].addEventListener("change",function(t){e.cubeParams.rotate.x=Number(t.target.value),e.updatePreview()}),l[1].addEventListener("change",function(t){e.cubeParams.rotate.y=Number(t.target.value),e.updatePreview()}),l[2].addEventListener("change",function(t){e.cubeParams.rotate.z=Number(t.target.value),e.updatePreview()}),o.addEventListener("change",function(e){e.stopPropagation(),null!==e.target.name&&help(e.target.name+" = "+e.target.value)}),o.addEventListener("reset",function(t){e.resetCubeParams(),e.updatePreview()})}const s=I.createCube.name;R(s,function(o){e.updatePreview(),t()}),function(e,t){const o=document.querySelectorAll(`[${D}="${e}"]`);o?N(null,o,2,e,t):console.log("ContextClick: could not find menuItem "+e)}(s,function(e){var t=H(e);zr(t),y(I.createCubeDialog)}),R(I.createCubePref.name,function(e){var t=H(e);zr(t),y(I.createCubeDialog)}),zr=function(t){o.style.display="block",U(o,t),e.previewCage=null,o.reset()}},!1),jr="glcanvas","loading"!=document.readyState?w(jr):(g=jr,document.addEventListener("DOMContentLoaded",m))},function(e,t){}]);
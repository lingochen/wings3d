!function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)o.d(n,r,function(t){return e[t]}.bind(null,r));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){o(1),e.exports=o(2)},function(e,t,o){"use strict";function n(e,t=1){if(0===e)return"0 Bytes";const o=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(o))+" "+["B","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function r(e){const t=e.replace(/^.*[\\\/]/,""),o=t.lastIndexOf(".");let n="",r=t;return o>=0&&(r=t.substring(0,o),n=t.substring(o+1,t.length)),[r,n]}function i(e){let t="";for(let o of e)t=t.length>0?t+", ."+o:"."+o;return t}function s(e){let t="";for(let o of e)t=t.length>0?t+"|"+o:o;return new RegExp(`.(${t})$`,"i")}function a(e){if(e&&"/"!==e[0]){e=`${g().currentDirectory}/${e}`}return e}function l(e,t){return new Promise((function(o,n){const r=e();if(r){let e;r.focus(),r.location.href=t(),window.addEventListener("message",e=function(t){const i=t.data;if(!(i instanceof Array))return;if("oauth2Login"===i.shift()){r.close();const t=i.shift();t.access_token?o(t):n(new Error(t)),window.removeEventListener("message",e)}});const i=setInterval((function(){r.closed&&(clearInterval(i),window.removeEventListener("message",e),n(new Error("Authorization failed")))}),1e3)}else n(new Error("open window failed, popup blocked?"))}))}let c;async function d(e,t,o){return new Promise((function(s,a){if(!c){const e=document.getElementById("contentPicker");e||a("No dialog exist");const t=e.querySelector(".breadcrumb");t||a("No contentSelect Nav");const o=e.querySelector(".filePicker");o||a("No contentSelect fileList Pane");const i=e.querySelector(".fileSelected");i||a("no fileSelected input");const s=e.querySelector(".fileExt");s||a("no fileExt label"),c={main:e,nav:t,filePane:o,selected:null,nameInput:i,ext:s,resolve:null,reject:null,logoClass:"",updateNav:function(e){p({currentDirectory:e});const t=e.split("/");let o=this.nav.querySelectorAll("a"),n=t.length-o.length;if(n>0){const e=document.createRange().createContextualFragment("<li><a></a></li>".repeat(n));this.nav.appendChild(e),o=this.nav.querySelectorAll("a")}else if(n<0){for(;n++<0;)this.nav.removeChild(this.nav.lastChild);o=this.nav.querySelectorAll("a")}let r,i="";for(let e=0;e<t.length;++e){r=o[e];const n=t[e],s=r.textContent!==n;r.classList.remove("current"),n.length>0&&(i+="/"+n),r.dataset.filepath=i,s&&(r.textContent=n)}o[o.length-1].classList.add("current"),this.nav.dataset.filepath=e},updateFolder:async function(e){function t(e){const t=document.createElement("label");return t.classList.add("fileItem"),t.dataset.filepath=e.path,t.dataset.filename=e.name,t.fileInfo=e,t}function o(e,o){for(let n of o){const o=t(n);o.classList.add("folder");const r=g().folderSVG||"#";o.insertAdjacentHTML("beforeend",`<input type="radio" name="selectFile"><img src='${r}'><span class="filename">${n.name}</span>`),e.appendChild(o)}return o.length>0}function r(e,o){for(let r of o){const o=t(r),i=n(r.size),s=r.modified.toLocaleString("en-US",{year:"2-digit",month:"short",day:"numeric"});o.insertAdjacentHTML("beforeend",`<input type="radio" name="selectFile"><img src='#'><span class="filename">${r.name}</span><span class="size">${i}</span><span class="date">${s}</span>`),e.appendChild(o)}return o.length>0}this.updateNav(e),this.currentDirectory=e;let{folders:i,files:s,cursor:a}=await this.readFolder(e,this.fileTypes);const l=document.createDocumentFragment();for(o(l,i),r(l,s),this.filePane.innerHTML="",this.filePane.appendChild(l);a;){let t=await a();if(e!==this.currentDirectory)break;if(o(l,t.folders)){let e=this.filePane.querySelectorAll(".folder:last-child");e.length?this.filePane.insertBefore(l,e[0].nextSibling):this.filePane.insertBefore(l,this.filePane.firstChild)}r(l,t.files),this.filePane.appendChild(l),a=t.cursor}},handleNav:function(e){let t;for(e.stopPropagation(),t=e.target;!t.matches("a");t=t.parentNode);t.classList.contains("current")||this.updateFolder(t.dataset.filepath)},handleFileItems:function(e){if(e.stopPropagation(),e.target.matches("input")){const t=e.target.parentNode;t.classList.contains("folder")?(e.target.checked=!1,this.updateFolder(t.dataset.filepath)):(this.selected&&this.selected!==t&&this.selected.classList.toggle("selected"),t.classList.toggle("selected"),this.selected=t,this.nameInput.value=t.dataset.filename)}},handleSaveAs:function(e){e.stopPropagation(),this.selected&&(this.selected.classList.toggle("selected"),this.selected=null),this.main.querySelectorAll('[type="submit"][value="ok"]').forEach(e=>{e.disabled=!1})},handleSubmit:function(e){if(e.preventDefault(),c.main.style.display="none",document.body.removeChild(c.main.parentNode),document.body.appendChild(c.main),this.reset(),"ok"===this.submitButton.value)if(this.selected){const e=this.selected.fileInfo;this.selected=null,this.resolve(e)}else{let[e,t]=r(this.nameInput.value);if(e.length>0){0===t.length&&(t=this.fileTypes[0]);const o=e+"."+t;this.resolve({isFile:!0,directory:this.nav.dataset.filepath,name:o})}}this.reject(new Error("No file selected"))},reset:function(){for(;this.filePane.firstChild;)this.filePane.removeChild(this.filePane.lastChild)}},c.filePane.addEventListener("change",e=>{c.handleFileItems(e)}),c.nav.addEventListener("click",e=>{c.handleNav(e)}),c.main.addEventListener("submit",e=>{c.handleSubmit(e)}),c.nameInput.addEventListener("change",e=>{c.handleSaveAs(e)}),c.nameInput.addEventListener("keypress",e=>{c.handleSaveAs(e)});for(let e of c.main.querySelectorAll("[type=submit]"))e.addEventListener("click",t=>{t.stopPropagation(),c.submitButton=e})}c.resolve=s,c.reject=a,c.readFolder=t,c.nav.querySelector(".home").src=e,c.fileTypes=o.ext,c.updateFolder(o.path);const l=document.createElement("div");l.classList.add("overlay"),l.addEventListener("keydown",(function(e){e.stopPropagation()})),l.appendChild(c.main),c.main.style.display="block",l.classList.add("realCenterModal"),c.main.reset(),c.ext.textContent=i(o.ext),void 0===o.name?(c.main.querySelector(".title").textContent="Open",c.nameInput.value="",c.nameInput.disabled=!0):(c.main.querySelector(".title").textContent="SaveAs",c.nameInput.value=o.name,c.nameInput.disabled=!1),document.body.appendChild(l)}))}function u(e,t,o,n){const r=Object.assign({method:"GET",username:null,password:null,responseType:"",withCredentials:!1},e),i=Object.assign({},o),s=g().progress,a=g().cancel,l=new XMLHttpRequest,c=new Promise((function(e,o){s&&l.addEventListener("progress",(function(e){if(e.lengthComputable){const t=parseInt(100*e.loaded/e.total);s(t)}})),l.addEventListener("load",(function(){l.status>=200&&l.status<300?e({data:l.response,xhr:l}):o({status:l.status,statusText:l.statusText,responseText:l.response})})),l.open(r.method,t,!0,r.username,r.password),l.responseType=r.responseType;for(const[e,t]of Object.entries(i))l.setRequestHeader(e,t);r.timeout&&(l.timeout=r.timeout,l.ontimeout=function(e){o({status:408,statusText:"Request timeout"})}),r.withCredentials&&(l.withCredentials=!0),l.send(n)}));return c.cancel=function(){l.abort(),a&&a()},c}function h(e){return"json"===e.xhr.responseType?[e,e.data]:[e,JSON.parse(e.data)]}o.r(t);let f={currentDirectory:"",folderSVG:"#"};function p(e){f=Object.assign(f,e)}function g(){return f}class m{constructor(e){this.file=e}static _createImage(e){const t=document.createElement("img");return t.src=URL.createObjectURL(e),t.onload=function(){URL.revokeObjectURL(this.src)},t}image(){return this.download("blob").then(e=>m._createImage(e.data))}arrayBuffer(){return this.download().then(e=>e.data)}text(){return this.download().then(e=>{const t=new DataView(e.data);return new TextDecoder("utf-8").decode(t)})}async uploadBlob(e){return e.type.indexOf("text")>=0?this.upload(e,"text/plain; charset=dropbox-cor s-hack"):this.upload(e,"application/octet-stream")}get path(){return`${this.directory}/${this.name}`}get root(){let e=this.name.lastIndexOf(".");return e>=0?this.name.substring(0,e):this.name}}const{mat4:v}=glMatrix;let x=null;function y(e,t){return x=function(e,t){var o={currentShader:null},n=document.getElementById(e);if(!n)return null;t=void 0!==t?t:{depth:!0,stencil:!0,antialias:!0,preserveDrawingBuffer:!0};const r=n.getContext("webgl",t);if(!r)return alert("Unable to initialize WebGL"),null;{let e=r.getExtension("OES_standard_derivatives");if(null===e)return console.log("No OES_standard_derivatives"),null;if(e=r.getExtension("OES_element_index_uint"),null===e)return console.log("No OES_element_index_uint"),null;if(e=r.getExtension("OES_texture_float"),null===e)return console.log("No floating texture"),null;if(e=r.getExtension("OES_texture_half_float"),null===e)return console.log("No half float texture"),null;r.HALF_FLOAT=e.HALF_FLOAT_OES;let t=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS);if(t<8)return console.log("Only "+t+" vertex texture units available"),null;r.textureSize=r.getParameter(r.MAX_TEXTURE_SIZE),console.log("WebGL 1 init with extension")}return r.pixelStorei(r.UNPACK_ALIGNMENT,1),r.resizeToDisplaySize=function(){var e=r.canvas,t=e.clientWidth,o=e.clientHeight;return(e.width!=t||e.height!=o)&&(e.width=t,e.height=o,r.viewport(0,0,t,o),!0)},r.projection=v.create(),r.modelView=v.create(),o.transform={projection:function(e,t){e.uniformMatrix4fv(t,!1,e.projection)},worldView:function(e,t){e.uniformMatrix4fv(t,!1,e.modelView)}},r.getViewport=function(){return r.getParameter(r.VIEWPORT)},r.compileGLSL=function(e,t){var o=r.loadShader(r.VERTEX_SHADER,e);if(!o)return console.log("failed to compile vertex shader"),null;var n=r.loadShader(r.FRAGMENT_SHADER,t);if(!n)return console.log("failed to compile fragment shader"),null;var i=r.createProgram();if(r.attachShader(i,o),r.attachShader(i,n),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS)){var s=r.getProgramInfoLog(i);return console.log("failed to link program: "+s),r.deleteProgram(i),r.deleteShader(n),r.deleteShader(o),null}return i},r.loadShader=function(e,t){var o=r.createShader(e);if(r.shaderSource(o,t),r.compileShader(o),!r.getShaderParameter(o,r.COMPILE_STATUS)){var n=r.getShaderInfoLog(o);return console.log("failed to compile shader: "+n),r.deleteShader(o),null}return o},r.createShaderProgram=function(e,t){var o=r.compileGLSL(e,t);if(o){for(var n,i={},s=r.getProgramParameter(o,r.ACTIVE_ATTRIBUTES),a=0;a<s;++a){if(!(n=r.getActiveAttrib(o,a)))return console.log("Something wrong, getActiveAttrib failed"),null;i[n.name]={loc:r.getAttribLocation(o,n.name),type:n.type}}var l={},c={world:null,worldView:null,worldViewProjection:null,view:null,projection:null};for(s=r.getProgramParameter(o,r.ACTIVE_UNIFORMS),a=0;a<s;++a){if(!(n=r.getActiveUniform(o,a)))return console.log("Something wrong, getActiveUniform failed"),null;if(c.hasOwnProperty(n.name))c[n.name]=r.getUniformLocation(o,n.name);else{let e=n.name;"[0]"===e.substr(-3)&&(e=e.substr(0,e.length-3)),l[e]={loc:r.getUniformLocation(o,n.name),size:n.size,type:n.type}}}return new w(o,c,i,l)}},r.createBufferHandle=function(e,t=r.ARRAY_BUFFER,o=r.STATIC_DRAW){if(ArrayBuffer.isView(e)){var n=r.createBuffer();return r.bindBuffer(t,n),r.bufferData(t,e,o),r.bindBuffer(t,null),n}return console.log("not typedArray"),null},r.setBufferAndAttrib=function(e,t,o=3){r.bindBuffer(r.ARRAY_BUFFER,e),r.vertexAttribPointer(t,o,r.FLOAT,!1,0,0),r.enableVertexAttribArray(t)},r.bindAttributeToProgram=function(e,t){r.bindBuffer(r.ARRAY_BUFFER,t.handle),r.vertexAttribPointer(e,t.size,t.type,t.normalized,t.stride,t.offset),r.enableVertexAttribArray(e)},r.bindIndex=function(e,t){const o=e.index[t];o&&r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,o)},r.bindAttribute=function(e,t){o.currentShader.bindAttribute(r,e.attribute,t)},r.bindUniform=function(e,t){o.currentShader.bindUniform(r,e.uniform,t)},r.bindTransform=function(){o.currentShader.bindTransform(r,o.transform)},r.pushTransform=function(e){},r.popTransform=function(){},r.useShader=function(e){o.currentShader=e,r.useProgram(e.progHandle)},r.disableShader=function(){o.currentShader&&o.currentShader.disableVertexAttributeArray(r)},r.drawVertex=function(e){r.bindTransform(),r.bindShaderData(e.shaderData,!1),e.drawVertex(r)},r.drawSelect=function(e){r.bindTransform(),e.bindSelectorShaderData(r),e.drawSelect(r)},r.createShaderData=function(){return new S},r.CHECKERBOARD=function(){const e=document.createElement("canvas").getContext("2d");e.canvas.width=e.canvas.height=128;for(var t=0;t<e.canvas.height;t+=16)for(var o=0;o<e.canvas.width;o+=16)e.fillStyle=16&(o^t)?"#FFF":"#DDD",e.fillRect(o,t,16,16);return e.canvas}(),r.resizeImage=function(e){let t=1;(e.width>r.textureSize||e.height>r.textureSize)&&(t=maxSize/Math.max(e.width,e.height));const o=Math.pow(2,Math.floor(Math.log(t*e.width)/Math.LN2)),n=Math.pow(2,Math.floor(Math.log(t*e.height)/Math.LN2));if(o!==e.width||n!==e.height){const t=document.createElement("canvas").getContext("2d");return t.canvas.width=o,t.canvas.height=n,t.drawImage(e,0,0,o,n),console.warn("Texture has been resized from ("+e.width+", "+e.height+") to ("+o+", "+n+")."),t.canvas}return e},r}(e,t),x}const b=function(e,t,o,n){var r;this.handle=e,this.format=1===(r=o)?x.LUMINANCE:2===r?x.LUMINANCE_ALPHA:3===r?x.RGB:4===r?x.RGBA:void console.log("unsupport format size: "+r),this.formatChannel=o,this.type=n,this.height=0,this.unit=t};b.getSize=function(e,t=1){const o=Math.ceil(e/x.textureSize);return x.textureSize*o*t},b.prototype.getSize=function(){return x.textureSize*this.height*this.formatChannel},b.prototype.deleteBuffer=function(){x.deleteTexture(this.handle)},b.prototype.bufferData=function(e){this.height=Math.ceil(e.length/this.formatChannel/x.textureSize),x.bindTexture(x.TEXTURE_2D,this.handle),x.texImage2D(x.TEXTURE_2D,0,this.format,x.textureSize,this.height,0,this.format,this.type,e),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE)},b.prototype.bufferSubData=function(e,t,o,n){if(o)if(n){let e=o+n;o=Math.floor(o/this.formatChannel)*this.formatChannel,e=Math.ceil(e/this.formatChannel)*this.formatChannel,n=e-o}else n=t.length-o;else o=0,n||(n=t.length);const r=Math.ceil(n/this.formatChannel),i=Math.floor(e/x.textureSize),s=Math.ceil((e+r)/x.textureSize),a=s-i;let l=0,c=x.textureSize;1===a?(l=e%x.textureSize,c=r,t=t.subarray(o,o+n)):t=t.subarray(i*c*this.formatChannel,s*c*this.formatChannel),x.bindTexture(x.TEXTURE_2D,this.handle),x.texSubImage2D(x.TEXTURE_2D,0,l,i,c,a,this.format,this.type,t),x.getError()!==x.NO_ERROR&&console.log("error"),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE)};const S=function(){this.attribute={},this.uniform={},this.index={},this.sampler={}};S.attribLayout=function(e=3,t=x.FLOAT,o=!1,n=0,r=0){return{size:e,type:t,normalized:o,stride:n,offset:r}},S.prototype.setupAttribute=function(e,t,o,n){this.createAttribute(e,t,n),this.resizeAttribute(e,o.byteLength),this.uploadAttribute(e,0,o)},S.prototype.createAttribute=function(e,t,o){if(this.attribute[e])console.log("Shader Data: "+e+" already initialized");else{var n=x.createBuffer();this.attribute[e]={handle:n,byteLength:0,usage:o,size:t.size,type:t.type,normalized:t.normalized,stride:t.stride,offset:t.offset}}},S.prototype.resizeAttribute=function(e,t){var o=this.attribute[e];o&&o.byteLength!=t&&(x.bindBuffer(x.ARRAY_BUFFER,o.handle),x.bufferData(x.ARRAY_BUFFER,t,o.usage),o.byteLength=t)},S.prototype.deleteAttribute=function(e){var t=this.attribute[e];t&&(x.deleteBuffer(t.handle),this.attribute[e]=null)},S.prototype.freeAllAttributes=function(){var e=[];for(var t in this.attribute)e.push(t);for(var o=0;o<e.length;++o)this.deleteAttribute(e[o])},S.prototype.uploadAttribute=function(e,t,o){var n=this.attribute[e];n?(x.bindBuffer(x.ARRAY_BUFFER,n.handle),x.bufferSubData(x.ARRAY_BUFFER,t,o)):console.log("Shader Data: "+e+" not initialized")},S.prototype.updateAttribute=function(e,t){t.gpuSize!==t.usedSize?(t.gpuSize=t.usedSize,this.resizeAttribute(e,4*t.usedSize),this.uploadAttribute(e,0,t.buffer.subarray(0,t.usedSize)),t._resetCounter()):t.isAltered()&&(this.uploadAttribute(e,4*t.alteredMin,t.buffer.subarray(t.alteredMin,t.alteredMax+1)),t._resetCounter())},S.prototype.createIndex=function(e){this.index[e]?console.log("Shader Index: "+e+" already initialized"):this.index[e]=x.createBuffer()},S.prototype.updateIndex=function(e,t,o,n=x.STATIC_DRAW){let r=this.index[e];if(r){if(t.isLengthAltered()){x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,r);const e=t.buffer.subarray(0,t.usedSize),i=new Uint32Array(e);for(let t=2;t<i.length;t+=3)e[t]<0&&(i[t]=-e[t]-1+o);x.bufferData(x.ELEMENT_ARRAY_BUFFER,i,n),t._resetCounter(),t._resetLength()}else if(t.isAltered()){x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,r);const e=t.getChanged(),n=new Uint32Array(e.array);for(let t=2;t<n.length;t+=3)e.array[t]<0&&(n[t]=-e.array[t]-1+o);x.bufferSubData(x.ELEMENT_ARRAY_BUFFER,e.byteOffset,n),t._resetCounter()}}else console.log("unknown index: "+e)},S.prototype.createSampler=function(e,t,o,n){let r=null;if(this.sampler[e])console.log("Shader Data: "+e+" already initialized");else{const i=x.createTexture();r=new b(i,t,o,n),this.sampler[e]=r,this.setUniformSampler(e,r)}return r},S.prototype.getSampler=function(e){return this.sampler[e]},S.prototype.updateSampler=function(e,t){const o=this.getSampler(e);if(o){const n=e+"Height";if(o.getSize()!==t.buffer.length)o.bufferData(t.buffer),t._resetCounter(),this.setUniform1f(n,o.height);else if(t.isAltered()){let e=t.getInterval(o.formatChannel);o.bufferSubData(e.start/o.formatChannel,t.buffer,e.start,e.end-e.start),t._resetCounter()}}else console.log("unknown sampler: "+e)},S.prototype.setUniform1f=function(e,t){this.uniform[e]={value:new Float32Array(1),binder:S.uniform1fFn},this.uniform[e].value=t},S.uniform1fFn=function(e,t,o){e.uniform1f(t,o)},S.prototype.setUniform1fv=function(e,t){const o={value:new Float32Array(t),binder:S.uniform1fvFn};this.uniform[e]=o},S.uniform1fvFn=function(e,t,o){try{e.uniform1fv(t,o)}catch(e){console.log(e)}},S.prototype.setUniform3fv=function(e,t){const o={value:new Float32Array(t),binder:S.uniform3fvFn};this.uniform[e]=o},S.uniform3fvFn=function(e,t,o){e.uniform3fv(t,o)},S.prototype.setUniform4fv=function(e,t){const o={value:new Float32Array(t),binder:S.uniform4fvFn};this.uniform[e]=o},S.uniform4fvFn=function(e,t,o){e.uniform4fv(t,o)},S.prototype.setUniformSampler=function(e,t){this.uniform[e]={value:{unit:t.unit,handle:t.handle},binder:S.uniformSampler},this.uniform[e+"Height"]={value:t.height,binder:S.uniform1f}},S.prototype.setUniformTexture=function(e,t,o){this.uniform[e]={value:{unit:o,handle:t},binder:S.uniformSampler}},S.uniformSampler=function(e,t,o){e.activeTexture(e.TEXTURE0+o.unit),e.bindTexture(e.TEXTURE_2D,o.handle),e.uniform1i(t,o.unit)};var w=function(e,t,o,n){this.progHandle=e,this.transform=t,this.attribute=o,this.uniform=n};w.prototype.disableVertexAttributeArray=function(e){for(var t in this.attribute)this.attribute.hasOwnProperty(t)&&e.disableVertexAttribArray(this.attribute[t].loc)},w.prototype.bindAttribute=function(e,t,o){try{for(let n of o)if(t.hasOwnProperty(n)&&this.attribute.hasOwnProperty(n)){const o=t[n];e.bindAttributeToProgram(this.attribute[n].loc,o)}}catch(e){console.log(e)}},w.prototype.bindUniform=function(e,t,o){try{for(let r of o)if(t.hasOwnProperty(r)&&this.uniform.hasOwnProperty(r)){var n=t[r];n.binder(e,this.uniform[r].loc,n.value)}}catch(e){console.log(e)}},w.prototype.bindTransform=function(e,t){try{for(var o in this.transform){if(t.hasOwnProperty(o))(0,t[o])(e,this.transform[o])}}catch(e){console.log(e)}},w.prototype.getTypeByName=function(e){};const E=function(e){this.buffer=null,this.component=e,this.usedSize=0,this.gpuSize=0,this.alteredMin=0,this.alteredMax=-1};E.prototype.byteLength=function(){return this.usedSize*this.byteSize()},E.prototype.getBuffer=function(){return this.buffer.subarray(0,this.usedSize)},E.prototype.getChanged=function(){let e=Math.floor(this.alteredMin/this.component)*this.component,t=(Math.floor(this.alteredMax/this.component)+1)*this.component;return{byteOffset:e*this.byteSize(),array:this.buffer.subarray(e,t)}},E.prototype.getInterval=function(e){const t={start:0,end:0};return this.isAltered()&&(t.start=Math.floor(this.alteredMin/e)*e,t.end=(Math.floor(this.alteredMax/e)+1)*e),t},E.prototype.alloc=function(){const e=this.usedSize;return this.usedSize+=this.component,this.usedSize>this.buffer.length&&this.expand(),e},E.prototype.computeAllocateSize=function(e){return Math.ceil(e/x.textureSize)*x.textureSize*this.component},E.prototype.expand=function(){const e=this.buffer.length;let t=Math.ceil(e/this.component*1.5);const o=this.buffer;this.buffer=this._allocateBuffer(t),this.buffer.set(o)},E.prototype.get=function(e){return this.buffer[e]},E.prototype.set=function(e,t){return this.buffer[e]!==t&&(this.buffer[e]=t,e<this.alteredMin&&(this.alteredMin=e),e>this.alteredMax&&(this.alteredMax=e),!0)},E.prototype._resetCounter=function(){this.alteredMin=this.buffer?this.buffer.length:0,this.alteredMax=-1},E.prototype._resetLength=function(){this.gpuSize=this.usedSize},E.prototype.isAltered=function(){return this.alteredMin<=this.alteredMax},E.prototype.isLengthAltered=function(){return this.gpuSize!==this.usedSize};const C=function(e,t){E.call(this,e),t||(t=x.textureSize),this.buffer=this._allocateBuffer(t)};C.prototype=Object.create(E.prototype),Object.defineProperty(C.prototype,"constructor",{value:C,enumerable:!1,writable:!0}),C.prototype._allocateBuffer=function(e){return new Float32Array(this.computeAllocateSize(e))},C.prototype.byteSize=function(){return 4};const A=function(e,t){E.call(this,e),t||(t=x.textureSize),this.buffer=this._allocateBuffer(t)};A.prototype=Object.create(E.prototype),Object.defineProperty(A.prototype,"constructor",{value:A,enumerable:!1,writable:!0}),A.prototype._allocateBuffer=function(e){return new Uint8Array(this.computeAllocateSize(e))},A.prototype.byteSize=function(){return 1};const F=function(e,t){E.call(this,e),t||(t=x.textureSize),this.buffer=this._allocateBuffer(t)};F.prototype=Object.create(E.prototype),Object.defineProperty(F.prototype,"constructor",{value:F,enumerable:!1,writable:!0}),F.prototype._allocateBuffer=function(e){return new Int32Array(this.computeAllocateSize(e))},F.prototype.byteSize=function(){return 4};const M=function(e,t){E.call(this,e),t||(t=x.textureSize),this.buffer=this._allocateBuffer(t)};M.prototype=Object.create(E.prototype),Object.defineProperty(M.prototype,"constructor",{value:M,enumerable:!1,writable:!0}),M.prototype._allocateBuffer=function(e){return new Uint32Array(this.computeAllocateSize(e))},M.prototype.byteSize=function(){return 4};const _=function(){let e=new Float32Array(1),t=new Int32Array(e.buffer);return function(o){e[0]=o;var n=t[0],r=n>>16&32768,i=n>>12&2047,s=n>>23&255;return s<103?r:s>142?(r|=31744,r|=(255==s?0:1)&&8388607&n):s<113?r|=((i|=2048)>>114-s)+(i>>113-s&1):(r|=s-112<<10|i>>1,r+=1&i)}}(),T=function(e){let t=(31744&e)>>10,o=1023&e;return(e>>15?-1:1)*(t?31===t?o?NaN:1/0:Math.pow(2,t-15)*(1+o/1024):o/1024*6103515625e-14)},P=function(e,t){E.call(this,e),t||(t=x.textureSize),this.buffer=this._allocateBuffer(t),this.freePool=new Set,this.refCount=[]};P.prototype=Object.create(E.prototype),Object.defineProperty(P.prototype,"constructor",{value:P,enumerable:!1,writable:!0}),P.prototype.reserve=function(e){if(e){if(!this.freePool.delete(e))throw new Error("non-existence deleted Index found: "+e);return e}{let e;return this.freePool.size>0?(e=this.freePool.values().next().value,this.freePool.delete(e),this.refCount[e]=0):(e=E.prototype.alloc.call(this)/this.component,this.refCount.push(0)),e}},P.prototype.bind=function(e){this.refCount[e]++},P.prototype.prune=function(e){const t=--this.refCount[e];if(0===t)this.freePool.add(e);else if(t<0)throw new Error("RefCount error")},P.prototype.pruneGet=function(e){const t={index:e};return this.prune(e)&&(t.value=this.create(),this.getValue(e,t.value)),t};class L extends P{constructor(e){super(3,e)}_allocateBuffer(e){return new Uint8Array(this.computeAllocateSize(e))}byteSize(){return 1}create(){return[255,255,255]}setValue(e,t){e*=this.component,this.set(e++,t[0]),this.set(e++,t[1]),this.set(e,t[2])}getValue(e,t){return e*=this.component,t[0]=this.buffer[e++],t[1]=this.buffer[e++],t[2]=this.buffer[e],t}}class V extends P{constructor(e){super(8,e)}_allocateBuffer(e){return new Uint16Array(this.computeAllocateSize(e))}byteSize(){return 2}create(){return[0,0,0,0,0,0,0,0]}getChannel(e,t,o){e=e*this.component+2*t,o[0]=T(this.buffer[e++]),o[1]=T(this.buffer[e])}getValue(e,t){e*=this.component;for(let o=0;o<this.component;++o)t[o]=T(this.buffer[e+o])}setChannel(e,t,o){e=e*this.component+2*t,this.set(e++,_(o[0])),this.set(e,_(o[1]))}setValue(e,t){e*=this.component;for(let o=0;o<this.component;++o)this.set(e+o,_(t[o]))}}const I=function(){this.freePool=[],this.array=new Uint32Array(3)};I.prototype.alloc=function(e){},I.prototype.free=function(e){},I.prototype.set=function(e,t){},glMatrix.glMatrix.setMatrixArrayType(Array);let B=!1,R=[];function O(e){return B?e():R.push(e),this}let N="";function D(e){document.removeEventListener("DOMContentLoaded",D),H(N)}void 0===NodeList.prototype[Symbol.iterator]&&(NodeList.prototype[Symbol.iterator]=Array.prototype[Symbol.iterator]);let k=[];function z(e,t){for(let o of k)o(e,t)}function U(e,t){if(t)k.push(e);else{let t=k.indexOf(e);t>-1&&k.splice(t,1)}}function j(){let e=0,t=0,o=arguments.length>32?32:arguments.length;for(;t<o;e|=arguments[t]<<t++);return e}function H(e){y(e),B=!0;for(let e of R)e();window.addEventListener("beforeunload",X)}function X(e){return e.returnValue="Are you sure you want to quit?","Are you sure you want to quit?"}let q;const G=[null,null,null];function Y(e){return e.preventDefault(),!1}function $(e){e.button<=2?G[e.button]=e.currentTarget:console.log("Amazing: mouse button is "+e.button)}function W(e){if(e.button<=2){let t=G[e.button];t&&t===e.currentTarget&&K(e.button,e.currentTarget.getAttribute("data-menuid"),e)}G[0]=G[1]=G[2]=null}function Z(e,t,o,n){if(Q.hasOwnProperty(o)){if(!Array.isArray(Q[o])){Q[o]=[null,null,null];for(const t of e)t.addEventListener("pointerdown",$),t.addEventListener("pointerup",W),t.addEventListener("contextmenu",Y)}Q[o][t]=n}}function K(e,t,o){if(Q.hasOwnProperty(t)){const n=Q[t][e];n&&(q?q(t,o)&&n(o):n(o))}else console.log("unrecognized action: "+t)}function J(e){console.log(e.name+" action is not implemented")}const Q={cameraModeEnter:()=>{J(void 0)},cameraModeExit:()=>{J(void 0)},cameraZoom:()=>{J(void 0)},contextMenu:()=>{J(void 0)},fileMenu:()=>{J(void 0)},importMenu:()=>{J(void 0)},exportMenu:()=>{J(void 0)},save:()=>{J(void 0)},saveAs:()=>{notImpelmented(void 0)},open:()=>{J(void 0)},clearNew:()=>{J(void 0)},windowMenu:()=>{J(void 0)},geometryWindow:()=>{J(void 0)},singlePane:()=>{J(void 0)},horizontalPane:()=>{J(void 0)},verticalPane:()=>{J(void 0)},quadPane:()=>{J(void 0)},openSidebar:()=>{J(void 0)},toggleVertexMode:()=>{J(void 0)},toggleEdgeMode:()=>{J(void 0)},toggleFaceMode:()=>{J(void 0)},toggleBodyMode:()=>{J(void 0)},toggleMultiMode:()=>{J(void 0)},redoEdit:()=>{J(void 0)},undoEdit:()=>{J(void 0)},preferenceButton:()=>{J(void 0)},toggleOrtho:()=>{J(void 0)},toggleGround:()=>{J(void 0)},toggleAxes:()=>{J(void 0)},toggleTweak:()=>{J(void 0)},tweakMoveFree:()=>{J(void 0)},tweakMoveNormal:()=>{J(void 0)},tweakScaleFree:()=>{J(void 0)},tweakScaleUniform:()=>{J(void 0)},axisConstraintsMenu:()=>{notImpelmented(void 0)},constraintX:()=>{J(void 0)},constraintY:()=>{J(void 0)},constraintZ:()=>{J(void 0)},createCube:()=>{J(void 0)},createCubePref:()=>{J(void 0)},createMaterial:()=>{J(void 0)},createCone:()=>{J(void 0)},createConePref:()=>{J(void 0)},createCylinder:()=>{J(void 0)},createCylinderPref:()=>{J(void 0)},createSphere:()=>{J(void 0)},createSpherePref:()=>{J(void 0)},createTorus:()=>{J(void 0)},createTorusPref:()=>{J(void 0)},createPlane:()=>{J(void 0)},createPlanePref:()=>{J(void 0)},createSpiral:()=>{J(void 0)},createSpiralPref:()=>{J(void 0)},createSpring:()=>{J(void 0)},createSpringPref:()=>{J(void 0)},createTetrahedron:()=>{J(void 0)},createTetrahedronPref:()=>{J(void 0)},createOctahedron:()=>{J(void 0)},createOctahedronPref:()=>{J(void 0)},createOctotoad:()=>{J(void 0)},createOctotoadPref:()=>{J(void 0)},createDodecahedron:()=>{J(void 0)},createDodecahedronPref:()=>{J(void 0)},createIcosahedron:()=>{J(void 0)},createIcosahedronPref:()=>{J(void 0)},toggleObjectSelect:()=>{J(void 0)},toggleObjectVisibility:()=>{J(void 0)},toggleObjectLock:()=>{J(void 0)},toggleWireMode:()=>{J(void 0)},objectRename:()=>{J(void 0)},objectDelete:()=>{J(void 0)},objectDuplicate:()=>{J(void 0)},createGroup:()=>{J(void 0)},createGroupWorld:()=>{J(void 0)},importImageFileGUI:()=>{J(void 0)},showImage:()=>{J(void 0)},deleteImage:()=>{J(void 0)},deleteTexture:()=>{J(void 0)},createMaterial:()=>{J(void 0)},editMaterial:()=>{J(void 0)},deleteMaterial:()=>{J(void 0)},renameMaterial:()=>{J(void 0)},duplicateMaterial:()=>{J(void 0)},assignMaterial:()=>{J(void 0)},selectMaterial:()=>{J(void 0)},selectMenu:()=>{J(void 0)},deselect:()=>{J(void 0)},more:()=>{J(void 0)},less:()=>{J(void 0)},similar:()=>{J(void 0)},all:()=>{J(void 0)},inverse:()=>{J(void 0)},adjacent:()=>{J(void 0)},edgeLoopMenu:()=>{J(void 0)},edgeLoop1:()=>{J(void 0)},nthEdgeLoopMenu:()=>{J(void 0)},edgeLoop2:()=>{J(void 0)},edgeLoop3:()=>{J(void 0)},edgeLoopN:()=>{J(void 0)},edgeRing1:()=>{J(void 0)},nthEdgeRingMenu:()=>{J(void 0)},edgeRing2:()=>{J(void 0)},edgeRing3:()=>{J(void 0)},edgeRingN:()=>{J(void 0)},byMenu:()=>{J(void 0)},edgeBoundary:()=>{J(void 0)},toolsMenu:()=>{J(void 0)},fixMeshMenu:()=>{J(void 0)},closeCrack:()=>{J(void 0)},openTweak:()=>{J(void 0)},bodyDelete:()=>{J(void 0)},bodyRename:()=>{J(void 0)},bodyDuplicateMoveMenu:()=>{J(void 0)},bodyDuplicateMoveX:()=>{J(void 0)},bodyDuplicateMoveY:()=>{J(void 0)},bodyDuplicateMoveZ:()=>{J(void 0)},bodyDuplicateMoveFree:()=>{J(void 0)},bodyMoveMenu:()=>{J(void 0)},bodyMoveX:()=>{J(void 0)},bodyMoveY:()=>{J(void 0)},bodyMoveZ:()=>{J(void 0)},bodyMoveFree:()=>{J(void 0)},bodyRotateMenu:()=>{J(void 0)},bodyRotateX:()=>{J(void 0)},bodyRotateY:()=>{J(void 0)},bodyRotateZ:()=>{J(void 0)},bodyRotateFree:()=>{J(void 0)},bodyInvert:()=>{J(void 0)},bodyCombine:()=>{J(void 0)},bodySeparate:()=>{J(void 0)},bodyFlipMenu:()=>{J(void 0)},bodyFlipX:()=>{J(void 0)},bodyFlipY:()=>{J(void 0)},bodyFlipZ:()=>{J(void 0)},bodyScaleUniform:()=>{J(void 0)},bodyScaleAxis:()=>{J(void 0)},bodyScaleAxisX:()=>{J(void 0)},bodyScaleAxisY:()=>{J(void 0)},bodyScaleAxisZ:()=>{J(void 0)},bodyScaleRadial:()=>{J(void 0)},bodyScaleRadialX:()=>{J(void 0)},bodyScaleRadialY:()=>{J(void 0)},bodyScaleRadialZ:()=>{J(void 0)},bodyPlaneCut:()=>{J(void 0)},bodyPlaneCutX:()=>{J(void 0)},bodyPlaneCutY:()=>{J(void 0)},bodyPlaneCutZ:()=>{J(void 0)},bodySlice:()=>{J(void 0)},bodySliceX:()=>{J(void 0)},bodySliceY:()=>{J(void 0)},bodySliceZ:()=>{J(void 0)},bodyWeld:()=>{J(void 0)},bodyColor:()=>{J(void 0)},cutMenu:()=>{J(void 0)},cutLine2:()=>{J(void 0)},cutLine3:()=>{J(void 0)},cutLine4:()=>{J(void 0)},cutLine5:()=>{J(void 0)},cutLine10:()=>{J(void 0)},cutAsk:()=>{J(void 0)},cutAndConnect:()=>{J(void 0)},edgeBevel:()=>{J(void 0)},edgeDissolve:()=>{J(void 0)},edgeCollapse:()=>{J(void 0)},edgeMoveMenu:()=>{J(void 0)},edgeMoveX:()=>{J(void 0)},edgeMoveY:()=>{J(void 0)},edgeMoveZ:()=>{J(void 0)},edgeMoveFree:()=>{J(void 0)},edgeMoveNormal:()=>{J(void 0)},edgeRotateMenu:()=>{J(void 0)},edgeRotateX:()=>{J(void 0)},edgeRotateY:()=>{J(void 0)},edgeRotateZ:()=>{J(void 0)},edgeRotateFree:()=>{J(void 0)},edgeExtrudeMenu:()=>{J(void 0)},edgeExtrudeNormal:()=>{J(void 0)},edgeExtrudeFree:()=>{J(void 0)},edgeExtrudeX:()=>{J(void 0)},edgeExtrudeY:()=>{J(void 0)},edgeExtrudeZ:()=>{J(void 0)},edgeCrease:()=>{J(void 0)},edgeLoopCut:()=>{J(void 0)},edgeCorner:()=>{J(void 0)},edgeSlide:()=>{J(void 0)},edgeFlatten:()=>{J(void 0)},edgeFlattenX:()=>{J(void 0)},edgeFlattenY:()=>{J(void 0)},edgeFlattenZ:()=>{J(void 0)},edgeScaleUniform:()=>{J(void 0)},edgeScaleAxis:()=>{J(void 0)},edgeScaleAxisX:()=>{J(void 0)},edgeScaleAxisY:()=>{J(void 0)},edgeScaleAxisZ:()=>{J(void 0)},edgeScaleRadial:()=>{J(void 0)},edgeScaleRadialX:()=>{J(void 0)},edgeScaleRadialY:()=>{J(void 0)},edgeScaleRadialZ:()=>{J(void 0)},edgeHardness:()=>{J(void 0)},edgeSoft:()=>{J(void 0)},edgeHard:()=>{J(void 0)},edgeInvert:()=>{J(void 0)},faceExtrudeMenu:()=>{J(void 0)},faceExtrudeX:()=>{J(void 0)},faceExtrudeY:()=>{J(void 0)},faceExtrudeZ:()=>{J(void 0)},faceExtrudeFree:()=>{J(void 0)},faceExtrudeNormal:()=>{J(void 0)},faceDissolve:()=>{J(void 0)},faceCollapse:()=>{J(void 0)},faceMoveMenu:()=>{J(void 0)},faceMoveX:()=>{J(void 0)},faceMoveY:()=>{J(void 0)},faceMoveZ:()=>{J(void 0)},faceMoveFree:()=>{J(void 0)},faceMoveNormal:()=>{J(void 0)},faceRotateMenu:()=>{J(void 0)},faceRotateX:()=>{J(void 0)},faceRotateY:()=>{J(void 0)},faceRotateZ:()=>{J(void 0)},faceRotateFree:()=>{J(void 0)},faceScaleUniform:()=>{J(void 0)},faceBridge:()=>{J(void 0)},faceInset:()=>{J(void 0)},faceBevel:()=>{J(void 0)},faceBump:()=>{J(void 0)},faceIntrude:()=>{J(void 0)},facePutOn:()=>{J(void 0)},faceLift:()=>{J(void 0)},faceMirror:()=>{J(void 0)},faceFlatten:()=>{J(void 0)},faceFlattenNormal:()=>{J(void 0)},faceFlattenX:()=>{J(void 0)},faceFlattenY:()=>{J(void 0)},faceFlattenZ:()=>{J(void 0)},faceScaleAxis:()=>{J(void 0)},faceScaleAxisX:()=>{J(void 0)},faceScaleAxisY:()=>{J(void 0)},faceScaleAxisZ:()=>{J(void 0)},faceScaleRadial:()=>{J(void 0)},faceScaleRadialX:()=>{J(void 0)},faceScaleRadialY:()=>{J(void 0)},faceScaleRadialZ:()=>{J(void 0)},facePlaneCut:()=>{J(void 0)},facePlaneCutX:()=>{J(void 0)},facePlaneCutY:()=>{J(void 0)},facePlaneCutZ:()=>{J(void 0)},faceMaterialMenu:()=>{J(void 0)},faceColor:()=>{J(void 0)},faceExtractMenu:()=>{J(void 0)},faceExtractNormal:()=>{J(void 0)},faceExtractX:()=>{J(void 0)},faceExtractY:()=>{J(void 0)},faceExtractZ:()=>{J(void 0)},faceExtractFree:()=>{J(void 0)},vertexConnect:()=>{J(void 0)},vertexDissolve:()=>{J(void 0)},vertexCollapse:()=>{J(void 0)},vertexMoveMenu:()=>{J(void 0)},vertexMoveX:()=>{J(void 0)},vertexMoveY:()=>{J(void 0)},vertexMoveZ:()=>{J(void 0)},vertexMoveFree:()=>{J(void 0)},vertexMoveNormal:()=>{J(void 0)},vertexRotateMenu:()=>{J(void 0)},vertexRotateX:()=>{J(void 0)},vertexRotateY:()=>{J(void 0)},vertexRotateZ:()=>{J(void 0)},vertexRotateFree:()=>{J(void 0)},vertexBevel:()=>{J(void 0)},vertexExtrudeMenu:()=>{J(void 0)},vertexExtrudeNormal:()=>{J(void 0)},vertexExtrudeFree:()=>{J(void 0)},vertexExtrudeX:()=>{J(void 0)},vertexExtrudeY:()=>{J(void 0)},vertexExtrudeZ:()=>{J(void 0)},vertexWeld:()=>{J(void 0)},vertexFlatten:()=>{J(void 0)},vertexFlattenX:()=>{J(void 0)},vertexFlattenY:()=>{J(void 0)},vertexFlattenZ:()=>{J(void 0)},vertexScaleUniform:()=>{J(void 0)},vertexScaleAxis:()=>{J(void 0)},vertexScaleAxisX:()=>{J(void 0)},vertexScaleAxisY:()=>{J(void 0)},vertexScaleAxisZ:()=>{J(void 0)},vertexScaleRadial:()=>{J(void 0)},vertexScaleRadialX:()=>{J(void 0)},vertexScaleRadialY:()=>{J(void 0)},vertexScaleRadialZ:()=>{J(void 0)},vertexColor:()=>{J(void 0)},helpMenu:()=>{J(void 0)},about:()=>{J(void 0)},introduction:()=>{J(void 0)},basicCommands:()=>{J(void 0)},tableTutor:()=>{J(void 0)}};const ee=function(){return function(t){return fetch(t).then(e)};function e(e){let t=e.headers.get("content-type");if(t.includes("application/json")||t.includes("application/jason"))return function(e){return e.json().then(t=>e.ok?t:Promise.reject(Object.assign({},t,{status:e.status,statusText:e.statusText})))}(e);if(t.includes("text/html"))return function(e){return e.text().then(t=>e.ok?t:Promise.reject({status:e.status,statusText:e.statusText,err:t}))}(e);throw new Error(`Sorry, content-type ${t} not supported`)}}();"function"!=typeof Blob.prototype.text&&(Blob.prototype.text=function(){return new Response(this).text()}),"function"!=typeof Blob.prototype.arrayBuffer&&(Blob.prototype.arrayBuffer=function(){return new Response(this).arrayBuffer()});const te=new Map;function oe(e,t,o,n,r,i,s){if(Z(t,o,n,r),void 0!==i){!function(e,t,o,n=""){o=o.toLowerCase();const r=j((n=n.toLowerCase()).indexOf("alt")>-1,n.indexOf("ctrl")>-1,n.indexOf("shift")>-1);te.has(o)||te.set(o,[]),te.get(o).unshift({mode:e,meta:r,id:t})}(e,n,i,s);const o=s?`${s}+${i}`:i;for(let e of t)e.classList.add("hotkey"),e.setAttribute("data-hotkey",o.toUpperCase())}}function ne(e,t,o,n){const r=document.querySelectorAll(`[data-menuId="${e}"]`);r?oe(null,r,0,e,t,o,n):console.log("Click: could not find menuItem "+e)}function re(e,t,o,n,r){const i=document.querySelectorAll(`[data-menuId="${e}"]`);i?oe(o,i,0,e,t,n,r):console.log("Click: could not find menuItem "+e)}function ie(e,t,o,n,r,i){const s=document.querySelector(`[data-menuId="${e}"]`),a=document.createElement("li"),l=document.createElement("a");l.setAttribute("data-menuId",t),l.textContent=o,a.appendChild(l),s.appendChild(a),function(e){Q[e]=()=>{J(this)}}(t),oe(null,[l],0,t,n,r,i)}function se(e){const t={x:0,y:0};return e.pageX||e.pageY?(t.x=e.pageX,t.y=e.pageY):(e.clientX||e.clientY)&&(t.x=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,t.y=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),t}function ae(e,t){const o=e.getBoundingClientRect();var n=o.width+4,r=o.height+4,i=window.innerWidth,s=window.innerHeight;i-t.x<n?e.style.left=i-n+"px":e.style.left=t.x+"px",s-t.y<r?e.style.top=s-r+"px":e.style.top=t.y+"px"}function le(e,t){const o=e.querySelector("div");let n=e.querySelectorAll("label");for(let e of n)o.removeChild(e);for(let e of t){const t=document.createElement("label");t.textContent=e.name;const n=document.createElement("input");n.type="text",n.name=e.uuid,n.placeholder=e.name,t.appendChild(n),o.appendChild(t)}}function ce(e){const t={};for(let o of e.elements)o.name&&o.value&&(t[o.name]=o.value);return t}function de(e,t,o,n){fe(e,o,n,t)}function ue(e){"Enter"==e.key&&e.preventDefault()}let he=null;function fe(e,t,o,n,r){const i=document.querySelector(e);if(i){null===he&&(he=document.createElement("div"),he.classList.add("overlay"),he.addEventListener("keydown",(function(e){e.stopPropagation()})));const e=i.cloneNode(!0);e.id="",he.appendChild(e),e.style.display="block",n?he.classList.add("realCenterModal"):he.classList.add("centerModal"),o&&o(e),document.body.prepend(he),e.addEventListener("keydown",ue,!0);const l={submitSuccess:!1},c=e.querySelectorAll("[type=submit]");function s(e){l.submitSuccess=!0,l.button=e.currentTarget}function a(e){l.submitSuccess=!1,l.button=e.currentTarget}for(let e of c)0=="ok".localeCompare(e.value,"en",{sensitivity:"base"})?e.addEventListener("click",s):e.addEventListener("click",a);e.addEventListener("submit",(function o(n){n.preventDefault(),e.removeEventListener("submit",o),document.body.removeChild(he),he.removeChild(e),l.submitSuccess?t(e,l.button):r&&r(e,l.button)}))}}async function pe(e,t){return new Promise((o,n)=>{fe(e,(function(e,t){o([e,t])}),t,"ev",(function(e,t){o([e,t])}))})}async function ge(e){return new Promise((t,o)=>{!function(e,t,o){const n=document.querySelector("#importFile");n&&(n.accept=e,n.value="",n.click(),n.addEventListener("change",(function(e){t(Array.from(n.files))})))}(e,e=>{t(e)})})}function me(e){return new Promise((t,o)=>{!function(e,t){0===ve.fileNames.size&&de("#importFileListForm",null,()=>{ve.form=void 0,ve.input=void 0,ve.ul=void 0,ve.close=void 0,ve.fileNames.clear()},e=>{ve.form=e;const t=e.fileListInput;t&&(t.addEventListener("change",(function(e){for(let e of t.files)if(ve.fileNames.has(e.name)){const[t,o]=ve.fileNames.get(e.name);ve.ul.removeChild(t),o([e]),ve.fileNames.delete(e.name)}0===ve.fileNames.size&&ve.close.click()})),ve.input=t,ve.ul=e.querySelector("ul"),ve.close=e.querySelector("button"))});if(ve.ul){const o=document.createElement("li");o.textContent=t,ve.ul.appendChild(o);const n=r(t).join(".");ve.fileNames.set(n,[o,e])}}(e=>{t(e)},e)})}const ve={form:void 0,input:void 0,ul:void 0,close:void 0,fileNames:new Map};!function(){let e=document.createElement("style");document.head.appendChild(e),e.appendChild(document.createTextNode("")),e.sheet}();const xe=[];function ye(){if(0===xe.length)return!1;const e=xe.pop();e.classList.remove("toggleOn");const t=e.parentElement;t.classList.remove("hideAfter","showBefore","slideUp");const o=t.parentElement;let n=o.firstElementChild;do{n.classList.remove("slideOut")}while(n=n.nextElementSibling);if(xe.length>0){const e=o.previousElementSibling;e&&"A"==e.tagName&&(e.style.visibility="inherit",e.parentElement.style.visibility="inherit")}return!0}function be(e){if(xe.length>0&&xe[xe.length-1]===e)ye();else{const t=e.parentElement;t.classList.add("showBefore","hideAfter","slideUp");const o=t.parentElement;if(xe.length>0){const e=o.previousElementSibling;e&&"A"==e.tagName&&(e.style.visibility="hidden",e.parentElement.style.visibility="hidden")}let n=o.firstElementChild;do{n!==t&&n.classList.add("slideOut")}while(n=n.nextElementSibling);xe.push(e),e.classList.add("toggleOn")}}let Se=!1,we=!1;function Ee(){if(Se)for(Se.classList.remove("toggleOn"),Se=!1;ye(););if(we){Se=we,we=!1,Se.classList.add("toggleOn");const e=Se.parentNode.getBoundingClientRect();Se.style.left=e.left+"px"}}let Ce=!1;function Ae(e){Ce&&2===e.button||e.target!==Se&&(Ee(),Se||document.removeEventListener("pointerup",Ae)),Ce=!1}function Fe(e,t){Se?Ee():document.addEventListener("pointerup",Ae,!1),Ce=!0,Se=e,Se.classList.add("toggleOn")}function Me(e){e!==Se&&(we=e,Se||document.addEventListener("pointerup",Ae,!1))}const _e=function(){let e=!1,t=[0,0],o=null;const n={mouseDown:function(n,r){e=!0,o=r,t=[o.offsetLeft-n.clientX,o.offsetTop-n.clientY]},mouseUp:function(t){e=!1,o=null},mouseMove:function(n){if(e){const e={x:n.clientX,y:n.clientY};o.style.left=e.x+t[0]+"px",o.style.top=e.y+t[1]+"px"}}};return document.addEventListener("pointerup",n.mouseUp),document.addEventListener("pointermove",n.mouseMove),n}();function Te(){let e=document.createElement("div");e.classList.add("popup");let t=document.createRange().createContextualFragment('<span class="close">&times;</span>');t.firstElementChild.addEventListener("click",(function(t){document.body.removeChild(e)})),e.appendChild(t);let o=document.createElement("h3");o.addEventListener("pointerdown",t=>{_e.mouseDown(t,e)}),e.appendChild(o);let n=document.createElement("div");return n.classList.add("wrap"),e.appendChild(n),document.body.appendChild(e),function(e){let t=window.innerWidth,o=window.innerHeight,n=e.getBoundingClientRect();e.style.left=Math.round((t-n.width)/2)+"px",e.style.top=Math.round((o-n.height)/2)+"px"}(e),document.body.removeChild(e),e}class Pe{free(){}isDoable(){return!0}}class Le extends Pe{commit(){throw"unimplemented"}rescind(){throw"unimplemented"}}class Ve extends Pe{commit(){this.moveHandler&&this.moveHandler.commit()}rescind(){this.moveHandler&&this.moveHandler.rescind()}isMoveable(){return!!this.moveHandler}getInputSetting(){return this.moveHandler?this.moveHandler.getInputSetting():[]}handleInput(e,t,o){this.moveHandler&&this.moveHandler.handleInput(e,t,o)}handleMouseMove(e,t,o){this.moveHandler&&this.moveHandler.handleMouseMove(e,t,o)}doIt(){this.moveHandler&&this.moveHandler.doIt()}undo(){this.moveHandler&&this.moveHandler.undo()}}class Ie extends Ve{constructor(e,t,o,n){super(),this.selectable={isVertex:e,isEdge:t,isFace:o},this.planeNormal=n}isVertexSelectable(){return this.selectable.isVertex}isEdgeSelectable(){return this.selectable.isEdge}isFaceSelectable(){return this.selectable.isFace}getPlaneNormal(){return this.planeNormal}}class Be extends Pe{constructor(e,...t){super(),this.commandName=e,this.params=t}doIt(e){return this.params?this.result=e[this.commandName](...this.params):this.result=e[this.commandName](),!1!==this.result}undo(e){this.result.undo.call(e,this.result.snapshots)}}class Re extends Pe{constructor(e){super(),this.editCommands=e}doIt(){for(let e of this.editCommands)e.doIt()}undo(){for(let e=this.editCommands.length-1;e>=0;--e)this.editCommands[e].undo()}}const{vec3:Oe,mat4:Ne}=glMatrix,De={cameraMode:"WingsCam",numButtons:3,camRotationSpeed:.5,panSpeed:25,panSpeedArrowKeys:50,wheelAdds:!1,whScrollInfo:!0,whPanSpeed:50,whRotationSpeed:.15,highLightZoomAim:!1,wheelZooms:!0,wheelZoomFactorAlt:5e-4,wheelZoomFactor:.005,dragSpeed:8.5,dragRotateSpeed:8.5,dragScaleSpeed:8.5};class ke extends Le{constructor(e){super(),this.saveView={origin:[0,0,0]},ze(this.saveView,e),this.view=e}handleMouseMove(e){4==e.buttons?this.view.pan(e.movementX,0):this.view.rotate(e.movementX,e.movementY)}commit(){}rescind(){this.undo()}doIt(){}undo(){ze(this.view,this.saveView)}}function ze(e,t){e.origin[0]=t.origin[0],e.origin[1]=t.origin[1],e.origin[2]=t.origin[2],e.azimuth=t.azimuth,e.elevation=t.elevation,e.distance=t.distance,e.panX=t.panX,e.panY=t.panY,e.fov=t.fov,e.zNear=t.zNear,e.zFar=t.zFar}class Ue{constructor(){this.view={origin:[0,0,0],azimuth:-45,elevation:25,distance:8,panX:0,panY:0,fov:45,zNear:.1,zFar:1e3},this.alongAxis=!1,this.isModified=!0}inverseCameraVectors(){const e=Ne.create();Ne.fromTranslation(e,Oe.fromValues(-this.view.panX,-this.view.panY,this.view.distance)),Ne.rotateY(e,e,-this.view.azimuth*Math.PI/180),Ne.rotateX(e,e,-this.view.elevation*Math.PI/180),Ne.translate(e,e,[-this.view.origin[0],-this.view.origin[1],-this.view.origin[2]]);const t={x:[e[0],e[1],e[2]],y:[e[4],e[5],e[6]],z:[e[8],e[9],e[10]]};return Oe.normalize(t.x,t.x),Oe.normalize(t.y,t.y),Oe.normalize(t.z,t.z),t}calibrateMovement(e){const t=De.dragSpeed;return e*(this.view.distance/(300*(11-t)*(11-t))*(this.view.fov/60))}rotateMovement(e){return e*(1/(8*(10.1-De.dragRotateSpeed))*(Math.PI/180))}scaleMovement(e){const t=De.dragScaleSpeed;return e*(this.view.distance/(900*(11-t)*(11-t)))}get origin(){return this.view.origin}set origin(e){Oe.exactEquals(this.view.origin,e)&&(Oe.copy(this.view.origin,e),this.isModified=!0)}get azimuth(){return this.view.azimuth}set azimuth(e){e!=this.view.azimuth&&(this.view.azimuth=e,this.isModified=!0)}get elevation(){return this.view.elevation}set elevation(e){this.view.elevation!=e&&(this.view.elevation=e,this.isModified=!0)}get distance(){return this.view.distance}set distance(e){this.view.distance!=e&&(z(Q.cameraZoom,e-this.view.distance),this.view.distance=e,this.isModified=!0)}get panX(){return this.view.panX}set panX(e){this.view.panX!=e&&(this.view.panX=e,this.isModified=!0)}get panY(){return this.view.panY}set panY(e){this.view.panY!=e&&(this.view.panY=e,this.isModified=!0)}get fov(){return this.view.fov}set fov(e){this.view.fov!=e&&(this.view.fov=e,this.isModified=!0)}get zNear(){return this.view.zNear}set zNear(e){this.view.zNear!=e&&(this.view.zNear=e,this.isModified=!0)}get zFar(){return this.view.zFar}set zFar(e){this.view.zFar!=e&&(this.view.zFar=e,this.isModified=!0)}getMouseMoveHandler(){return new ke(this)}aimZoom(e,t){}rotate(e,t){this.azimuth+=e*De.camRotationSpeed,this.elevation+=t*De.camRotationSpeed}wheelRotate(e,t){if(De.wheelZooms&&De.wheelAdds){const o=2*De.wheelRotationSpeed;this.azimuth=this.view.azimuth+e*o,this.elevation=this.view.elevation+t*o,this.alongAxis=!1}}wheelZoom(e,t){const o=Math.max(Math.abs(this.view.distance),.2)*(t*e);this.distance+=o}zoomStepAlt(e){De.wheelZooms&&this.wheelZoom(De.wheelZoomFactorAlt,e)}zoomStep(e){De.wheelZooms&&this.wheelZoom(De.wheelZoomFactor,e)}zoom(e){this.distance=this.view.distance+Math.max(Math.abs(this.view.distance),.2)*e/80}pan(e,t){const o=.05*this.view.distance/(101-De.panSpeed);this.panX+=e*o,this.panY+=t*o}keyPan(e,t){const o=this.view.distance*(De.panSpeedArrowKeys/100);this.panX+=e*o,this.panY+=t*o}keyPanLeftArrow(){this.keyPan(.05,0)}keyPanRightArrow(){this.keyPan(-.05,0)}keyPanUpArrow(){this.keyPan(0,.05)}keyPanDownArrow(){this.keyPan(0,-.05)}wheelPan(e,t){if(De.wheelZooms&&De.wheelAdds){const o=this.view.distance*(De.wheelPanSpeed/100);this.panX+=e*o,this.panY-=t*o}}}let je={vertexShader:["attribute vec3 position;","uniform mat4 worldView;","uniform mat4 projection;","void main(void) {","   gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),fragShader:["uniform lowp vec4 uColor;","void main(void) {","   gl_FragColor = uColor;","}"].join("\n")},He={vertexShader:["attribute vec3 aVertexPosition;","attribute vec3 aVertexColor;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","varying lowp vec4 vColor;","void main(void) {","   gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);","   vColor = vec4(aVertexColor, 1.0);","}"].join("\n"),fragShader:["varying lowp vec4 vColor;","void main(void) {","   gl_FragColor = vColor;","}"].join("\n")},Xe={vertex:(e,t)=>`  uniform mat4 projection;\n   uniform mat4 worldView;\n   uniform vec4 faceColor[4];\n   uniform float currentBaseColorTexture;\n\n   // (vertex, halfEdge, face, group) index\n   attribute highp vec4 polygonIndex;\n   // (color, normal, texCoord)\n   attribute highp vec3 a_AttributeIndex;\n\n   // positionTexture, stateTexture, faceTexture, materialTexture, edgeColorTexture, normalTexture, texCoordTexture.\n   uniform highp sampler2D positionBuffer;\n   uniform sampler2D groupState;\n   uniform sampler2D faceState;\n   uniform sampler2D materialColor;\n   uniform sampler2D attributeColor;\n   uniform sampler2D attributeTexCoord;\n   uniform float positionBufferHeight;\n   uniform float faceStateHeight;\n   uniform float groupStateHeight;\n   uniform float materialColorHeight;\n   uniform float attributeColorHeight;\n   uniform float attributeTexCoordHeight;\n\n\n   varying vec4 color;                    // color of material * vertex \n   varying vec4 stateColor;               // selected, or hiliteColor, or just original color\n   varying vec2 baseColorUV;\n\n   ${e}\n\n   ${t}\n\n   void main() {\n      gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n      if ((polygonIndex.w < 0.0) || (polygonIndex.z < 0.0) || (polygonIndex.x < 0.0)) {  // non \n         return;\n      }\n      float gState = texture2D(groupState, index2TexCoord(polygonIndex.w, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n      if (gState < 8.0) {\n         float transparency = 1.0;\n         if (gState >= 4.0) {\n            transparency = 0.0;\n            gState -= 4.0;       // == gState & ~4;\n         }\n         vec3 polyState = texture2D(faceState, index2TexCoord(polygonIndex.z, faceStateHeight)).xyz;\n         int state = int(max(gState, polyState.x * 255.0)); // luminance === {l, l, l, 1}; l is [0-1]         \n         if (state < 4) {\n            float matIndex = materialIndex(polyState) * 5.;\n\n            if (texture2D(materialColor, index2TexCoord(matIndex+3.0, materialColorHeight)).x != currentBaseColorTexture) { // skipped if not the currentTexture\n               return;\n            }\n\n            transparency = transparency * texture2D(materialColor, index2TexCoord(matIndex+1., materialColorHeight)).z;\n            color = vec4(texture2D(materialColor, index2TexCoord(matIndex, materialColorHeight)).xyz, transparency);   // material color\n            if (state == 0) {\n               if (transparency == 0.0) { // whole triangle is transparent.\n                  return;\n               }\n               stateColor = vec4(1.0, 1.0, 1.0, 1.0);//color;       // current Material color\n            } else {\n               for (int i = 1; i < 4; i++) {\n                  if (i == state) {\n                     stateColor = faceColor[i];\n                     break;\n                  }\n               }\n               //color = mix(stateColor, color, 0.5);\n            }\n            float channel = texture2D(materialColor, index2TexCoord(matIndex+4.0, materialColorHeight)).x;\n            baseColorUV = texture2D(attributeTexCoord, index2TexCoord(a_AttributeIndex.z*4.0+channel, attributeTexCoordHeight)).ra;\n\n            vec3 pos = texture2D(positionBuffer, index2TexCoord(polygonIndex.x, positionBufferHeight)).xyz;\n            vec3 vertexColor = texture2D(attributeColor, index2TexCoord(a_AttributeIndex.x, attributeColorHeight)).rgb;\n            gl_Position = projection * worldView * vec4(pos, 1.0);\n            // modulate vertexColor;\n            color = color * vec4(vertexColor, 1.0);\n         }\n      }\n   }\n`,fragment:"precision mediump float;     // stipple/screendoor shader\n   varying vec4 color;\n   varying vec4 stateColor;\n\n   varying vec2 baseColorUV;\n   uniform sampler2D baseColorTexture;\n\n\n   void main(void) {\n      //vec2 oddEven = floor( fract(gl_FragCoord.xy * 0.5) + 0.5 ); // floor( value + 0.5 ) == round( value );\n      //float result = oddEven.x + oddEven.y;\n\n      //if (result == 1.0) {\n         gl_FragColor = stateColor * color * texture2D(baseColorTexture, baseColorUV);\n      //} else {\n         //gl_FragColor = stateColor * texture2D(baseColorTexture, baseColorUV);\n      //}\n   }\n"},qe={vertex:e=>`//#extension OES_texture_float : enable\n      uniform mat4 projection; \n      uniform mat4 worldView;\n      // color of various state\n      uniform vec4 edgeColor[8];\n      uniform float edgeWidth[8];\n\n      // (vertex, wEdge, face, group)\n      attribute highp vec4 indexBuffer;\n\n      // position texture (x,y,z), state texture(uint8)\n      uniform highp sampler2D positionBuffer;\n      uniform sampler2D edgeState;\n      uniform sampler2D groupState;\n      uniform float positionBufferHeight;\n      uniform float edgeStateHeight;\n      uniform float groupStateHeight;\n\n      varying vec3 vBC;\n      varying float lineWidth;\n      varying vec4 color;\n\n      ${e}\n\n      void main() {\n         gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n         if ((indexBuffer.w < 0.0) || (indexBuffer.z < 0.0)) {  // no group, or no face\n            return;\n         }\n         float gState = texture2D(groupState, index2TexCoord(indexBuffer.w, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n         if (gState < 8.0) {\n            vBC = vec3(1.0, 0.0, 1.0);\n            float indexBufferY = indexBuffer.y;\n            if (indexBufferY < 0.0) {\n               vBC.y = 1.0;\n               indexBufferY = (-indexBufferY) - 1.0;     // convert to positive\n            }\n            int state = int(texture2D(edgeState, index2TexCoord(indexBufferY, edgeStateHeight)).x * 255.0); // luminance === {l, l, l, 1}; l is [0-1]\n            for (int i = 0; i < 8; i++) {\n               if (i == state) {\n                  color = edgeColor[i];\n                  lineWidth = edgeWidth[i];\n                  break;\n               }\n            }\n            vec3 pos = texture2D(positionBuffer, index2TexCoord(indexBuffer.x, positionBufferHeight)).xyz;\n         \n            gl_Position = projection * worldView * vec4(pos, 1.0);\n         }\n      }\n   `,fragment:"#extension GL_OES_standard_derivatives : enable\n      precision mediump float;\n      varying vec3 vBC;\n      varying float lineWidth;\n      varying vec4 color;\n\n      float edgeFactor() {\n         vec3 d = fwidth(vBC);\n         vec3 a3 = smoothstep(vec3(0.0), d*lineWidth, vBC);\n         return min(min(a3.x, a3.y), a3.z);\n      }\n\n      void main() {\n         // coloring by edge\n         float edge = edgeFactor();\n         if (edge < 1.0) {\n            gl_FragColor = vec4(color.rgb, (1.0-edge)*0.95);\n         } else {\n            discard;\n         }\n      }\n   "},Ge={vertex:e=>`uniform mat4 worldView;\n      uniform mat4 projection;\n\n      uniform vec4 vertexColor[8];\n      uniform float sizeOfVertex[8];\n\n      // draw point array;\n      attribute highp vec3 vertexIndex;                 // (vIndex, state, group)\n\n      // attribute texture\n      uniform highp sampler2D positionBuffer;\n      uniform sampler2D groupState;\n      uniform float positionBufferHeight;\n      uniform float groupStateHeight;\n\n      // output\n      varying vec4 color;\n\n      ${e}\n\n      void main(void) {\n         gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n         if (vertexIndex.z < 0.0) {\n            return;\n         }\n         float gState = texture2D(groupState, index2TexCoord(vertexIndex.z, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n         if ((gState < 8.0) && (vertexIndex.y < 128.0)) {\n            vec3 pos = texture2D(positionBuffer, index2TexCoord(vertexIndex.x, positionBufferHeight)).xyz;\n            gl_Position = projection * worldView * vec4(pos, 1.0);\n\n            int vState = int(vertexIndex.y);\n            for (int i = 0; i < 8; ++i) {\n               if (i == vState) {\n                  color = vertexColor[i];\n                  gl_PointSize = sizeOfVertex[i];\n                  break;\n               }\n            }\n         }\n      }\n   `,fragment:"precision lowp float;\n      varying vec4 color;\n\n      void main(void) {\n         gl_FragColor = color;\n      }\n   "},Ye=(["attribute vec4 aVertexPosition;","attribute vec2 aTexCoord;","uniform mat4 uMVMatrix;","uniform mat4 uPMatrix;","varying vec2 v_texcoord;","void main() {","gl_Position =  uPMatrix * uMVMatrix * aVertexPosition;","v_texcoord = aTexCoord;","}"].join("\n"),["precision mediump float;","varying vec2 v_texcoord;","uniform sampler2D u_texture;","void main() {","gl_FragColor = texture2D(u_texture, v_texcoord);","}"].join("\n"),{vertex:["attribute vec3 position;","uniform vec3 faceColor;","uniform mat4 worldView;","uniform mat4 projection;","varying vec3 vPosition;","varying vec3 vLight;","varying vec3 vColor;","void main(void) {","   gl_Position = projection * worldView * vec4(position, 1.0);","   vPosition =  (worldView * vec4(position, 1.0)).xyz;","   vColor = faceColor;","   vLight = vec3(0.0, 0.0, -1.0);","}"].join("\n"),fragment:["#extension GL_OES_standard_derivatives : enable","precision mediump float;\n","varying vec3 vPosition;","varying vec3 vLight;","varying vec3 vColor;","void main() {","  vec3 n = normalize(cross(dFdy(vPosition), dFdx(vPosition)));","  float diffuseFactor = dot(normalize(n), vLight);","  if (diffuseFactor > 0.0) {","    gl_FragColor = vec4(vColor * diffuseFactor, 1.0);","  } else {","    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);","  }","}"].join("\n")}),$e={vertex:["attribute vec3 position;","uniform mat4 worldView;","uniform mat4 projection;","void main(void) {","  gl_Position = projection * worldView * vec4(position, 1.0);","}"].join("\n"),fragment:["precision mediump float;","uniform vec4 faceColor;","void main(void) {","  gl_FragColor = faceColor;","}"].join("\n")},We={vertex:["attribute vec3 position;","uniform mat4 worldView;","uniform mat4 projection;","void main() {","  gl_Position = projection * worldView * vec4(position, 1.0);","  gl_PointSize = 8.8;","}"].join("\n"),fragment:["precision lowp float;","uniform vec4 uColor;","void main() {","float distance = distance( gl_PointCoord, vec2(0.5,0.5) );","if ( distance >= 0.5 ) {","discard;","}","gl_FragColor = uColor;","}"].join("\n")},Ze={vertex:e=>`//#extension OES_texture_float : enable\n      uniform mat4 projection; \n      uniform mat4 worldView;\n      // color of various state\n      uniform vec4 edgeColor[8];\n\n      // (vertex, wEdge, face, group)\n      attribute highp vec4 indexBuffer;\n\n      // position texture (x,y,z), state texture(uint8)\n      uniform highp sampler2D positionBuffer;\n      uniform sampler2D groupState;\n      uniform float positionBufferHeight;\n      uniform float groupStateHeight;\n\n      varying vec3 vBC;\n      varying vec4 color;\n\n      ${e}\n\n      void main() {\n         gl_Position = vec4(2.0, 2.0, 2.0, 1.0);         // culled as default.\n         if ((indexBuffer.w < 0.0) || (indexBuffer.z < 0.0)) {  // no group, or no face\n            return;\n         }\n\n         float gState = texture2D(groupState, index2TexCoord(indexBuffer.w, groupStateHeight)).x * 255.0; // luminance === {l, l, l, 1}; l is [0-1]\n         if (gState < 8.0) {\n            vBC = vec3(1.0, 0.0, 1.0);\n            if (indexBuffer.y < 0.0) {\n               vBC.y = 1.0;\n            }\n            color = edgeColor[0];                        // unselected color\n \n            vec3 pos = texture2D(positionBuffer, index2TexCoord(indexBuffer.x, positionBufferHeight)).xyz;\n            gl_Position = projection * worldView * vec4(pos, 1.0);\n         }\n      }\n   `,fragment:"#extension GL_OES_standard_derivatives : enable\n      precision mediump float;\n      varying vec3 vBC;\n      varying vec4 color;\n\n      float edgeFactor() {\n         vec3 d = fwidth(vBC);\n         vec3 a3 = smoothstep(vec3(0.0), d, vBC);\n         return min(min(a3.x, a3.y), a3.z);\n      }\n\n      void main() {\n         // coloring by edge\n         float edge = edgeFactor();\n         if (edge < 1.0) {\n            gl_FragColor = vec4(color.rgb, (1.0-edge)*0.95);\n         } else {\n            discard;\n         }\n      }\n   "},Ke={vertex:"attribute vec3 position;\n      attribute vec3 normal;\n      attribute vec2 uv;\n      uniform vec3 baseColor;\n      \n      uniform mat4 world;\n      uniform mat4 worldViewProjection;\n\n      varying vec3 wsNormal;\n      varying vec3 wsPosition;\n      varying vec3 vBaseColor;\n      varying vec2 vTexCoord;\n      void main(void) {\n         wsNormal = (world * vec4(normal, 1.0)).xyz;\n         wsPosition = (world * vec4(position, 1.0)).xyz;\n         gl_Position = worldViewProjection * vec4(position, 1.0);\n         vBaseColor = baseColor;\n         vTexCoord = uv;\n      }",fragment:(e,t)=>`precision mediump float;\n\n      ${e}\n      // material value is here\n      ${t}   \n\n      varying vec3 wsNormal; \n      varying vec3 wsPosition;\n      uniform vec3 wsEyepoint;\n      uniform vec3 lightDir;\n      //uniform vec4 wsLightpos;\n      uniform vec3 lightDiffuse;\n      uniform vec3 lightSpecular;\n      //uniform vec3 lightAtt;\n\n      void main(void) {\n         vec3 n = normalize(wsNormal); //getNormal();\n         vec3 v = normalize(wsEyepoint-wsPosition);  // point to camera\n         PBRInfo pbr = calcViews(n, v, lightDir);\n         pbr = calcMaterial(pbr);\n\n         // Calculate the shading terms for the microfacet specular shading model\n         vec3  F = specularReflection(pbr);\n         float G = geometricOcclusion(pbr);\n         float D = microfacetDistribution(pbr);\n\n         // Calculation of analytical lighting contribution\n         vec3 diffuseContrib = (1.0 - max(max(F.r, F.g), F.b)) * diffuse(pbr);\n         diffuseContrib *= lightDiffuse;\n         vec3 specContrib = F * G * D / (4.0 * pbr.NdotL * pbr.NdotV);\n         specContrib *= lightSpecular;\n         // Obtain final intensity as reflectance (BRDF) scaled by the energy of the light (cosine law)\n         vec3 frag_color = pbr.NdotL * (diffuseContrib + specContrib);\n         frag_color +=  getEmission();\n         gl_FragColor = vec4(pow(frag_color,vec3(1.0/2.2)), pbr.opaque);\n      }`};O((function(){const e=`vec2 index2TexCoord(float index, float height) {\n         return vec2( mod(index, float(${x.textureSize})) / float(${x.textureSize}), floor(index/float(${x.textureSize})) / height);\n      }\n   `;Ye=x.createShaderProgram(Ye.vertex,Ye.fragment),$e=x.createShaderProgram($e.vertex,$e.fragment),We=x.createShaderProgram(We.vertex,We.fragment),Ze=x.createShaderProgram(Ze.vertex(e),Ze.fragment),qe=x.createShaderProgram(qe.vertex(e),qe.fragment),Ge=x.createShaderProgram(Ge.vertex(e),Ge.fragment),Xe=x.createShaderProgram(Xe.vertex(e,"float materialIndex(vec3 v) {\n         return dot(v, vec3(0., 255., 255.*255.));\n      }\n     "),Xe.fragment),Ke=x.createShaderProgram(Ke.vertex,Ke.fragment('const float M_PI = 3.141592653589793;\n\n      // Encapsulate the various inputs used by the various functions in the shading equation\n      struct PBRInfo {\n         float NdotL;                  // cos angle between normal and light direction\n         float NdotV;                  // cos angle between normal and view direction\n         float NdotH;                  // cos angle between normal and half vector\n         float LdotH;                  // cos angle between light direction and half vector\n         float VdotH;                  // cos angle between view direction and half vector\n         float perceptualRoughness;    // roughness value, as authored by the model creator (input to shader)\n         float metalness;              // metallic value at the surface\n         vec3 reflectance0;            // full reflectance color (normal incidence angle)\n         vec3 reflectance90;           // reflectance color at grazing angle\n         float alphaRoughness;         // roughness mapped to a more linear change in the roughness (proposed by [2])\n         vec3 diffuseColor;            // color contribution from diffuse lighting\n         vec3 specularColor;           // color contribution from specular lighting\n         float occlusion;\n         float opaque;\n      };\n\n      vec4 SRGBtoLINEAR(vec4 srgbIn) {\n         vec3 bLess = step(vec3(0.04045),srgbIn.xyz);\n         vec3 linOut = mix( srgbIn.xyz/vec3(12.92), pow((srgbIn.xyz+vec3(0.055))/vec3(1.055),vec3(2.4)), bLess );\n         return vec4(linOut,srgbIn.w);\n      }\n\n      PBRInfo calcViews(vec3 Norm, vec3 View, vec3 Ligth) {\n         PBRInfo pbr;\n         vec3 Half = normalize(Ligth+View);           // halfv between l and v\n         pbr.NdotL = clamp(dot(Norm, Ligth), 0.001, 1.0);\n         pbr.NdotV = abs(dot(Norm, View)) + 0.001;\n         pbr.NdotH = clamp(dot(Norm, Half), 0.0, 1.0);\n         pbr.LdotH = clamp(dot(Ligth, Half), 0.0, 1.0);\n         pbr.VdotH = clamp(dot(View, Half), 0.0, 1.0);\n         return pbr;\n      }\n\n      // The following equation models the Fresnel reflectance term of the spec equation (aka F())\n      // Implementation of fresnel from [4], Equation 15\n      vec3 specularReflection(PBRInfo pbrInputs){\n         return pbrInputs.reflectance0 +\n            (pbrInputs.reflectance90 - pbrInputs.reflectance0)\n            * pow(clamp(1.0 - pbrInputs.VdotH, 0.0, 1.0), 5.0);\n      }\n\n      // This calculates the specular geometric attenuation (aka G()),\n      // where rougher material will reflect less light back to the viewer.\n      // This implementation is based on [1] Equation 4, and we adopt their modifications to\n      // alphaRoughness as input as originally proposed in [2].\n      float geometricOcclusion(PBRInfo pbrInputs) {\n         float NdotL = pbrInputs.NdotL;\n         float NdotV = pbrInputs.NdotV;\n         float r = pbrInputs.alphaRoughness*pbrInputs.alphaRoughness;\n\n         float attenuationL = NdotL / (NdotL + sqrt(r + (1.0 - r) * (NdotL * NdotL)));\n         float attenuationV = NdotV / (NdotV + sqrt(r + (1.0 - r) * (NdotV * NdotV)));\n         return 8.0 * attenuationL * attenuationV;\n      }\n\n      // The following equation(s) model the distribution of microfacet normals across the area being drawn (aka D())\n      // Implementation from "Average Irregularity Representation of a Roughened Surface for Ray Reflection" by T. S. Trowbridge, and K. P. Reitz\n      // Follows the distribution function recommended in the SIGGRAPH 2013 course notes from EPIC Games [1], Equation 3.\n      float microfacetDistribution(PBRInfo pbrInputs) {\n         float roughnessSq = pbrInputs.alphaRoughness * pbrInputs.alphaRoughness;\n         float f = (pbrInputs.NdotH * roughnessSq - pbrInputs.NdotH) * pbrInputs.NdotH + 1.0;\n         return roughnessSq / (M_PI * f * f);\n      }\n\n      // Basic Lambertian diffuse\n      // Implementation from Lambert\'s Photometria https://archive.org/details/lambertsphotome00lambgoog\n      // See also [1], Equation 1\n      vec3 diffuse(PBRInfo pbrInputs) {\n         return pbrInputs.diffuseColor / M_PI;\n      }\n      ',"\n      uniform int useDiffuseMap;\n      uniform int usePBRMap;\n      uniform int useEmissionMap;\n      \n      uniform sampler2D diffuseMap;\n      uniform sampler2D PBRMap;\n      uniform sampler2D emissionMap;\n      \n      uniform float metallic;\n      uniform float roughness;\n      uniform vec3  emission;\n      \n      varying vec2 vTexCoord;\n      varying vec3 vBaseColor;  // diffuse * vertex_color\n      \n      vec3 getBasecolor() {\n         if (useDiffuseMap > 0) {\n            return vBaseColor*SRGBtoLINEAR(texture2D(diffuseMap, vTexCoord)).rgb;\n         }\n         return vBaseColor;\n      }\n      \n      vec3 getEmission() {\n         if (useEmissionMap > 0) {\n            return SRGBtoLINEAR(texture2D(emissionMap, vTexCoord)).rgb * emission;\n         }\n         return emission;\n      }\n      \n      vec4 getPbrOmr() {  // red = occlusion blue = roughness green = metallic\n         vec4 mrSample = vec4(1.0, roughness, metallic, 1.0);\n         if (usePBRMap > 0) {\n            mrSample *= texture2D(PBRMap, vTexCoord);\n         }\n         return clamp(mrSample, 0.04, 0.96);\n      }\n      \n      float getOcclusion() {\n         if (usePBRMap > 0) {\n            return texture2D(PBRMap, vTexCoord).x;\n         }\n         return 1.0;\n      }\n      \n      PBRInfo calcMaterial(PBRInfo pbr) {\n         vec3 baseColor = getBasecolor();\n         vec3 f0 = vec3(0.04);\n         vec3 omr = getPbrOmr().rgb;\n         float rgh = omr.g;\n         float met = omr.b;\n         vec3 diffuse  = mix(baseColor.rgb, vec3(0.0), met);\n         vec3 specular = mix(f0, baseColor.rgb, met);\n      \n         float reflectance = max(max(specular.r, specular.g), specular.b);\n         float reflectance90 = clamp(reflectance * 25.0, 0.0, 1.0);\n         vec3 specularEnvironmentR0 = specular.rgb;\n         vec3 specularEnvironmentR90 = vec3(1.0, 1.0, 1.0) * reflectance90;\n      \n         pbr.perceptualRoughness = rgh;\n         pbr.alphaRoughness = rgh*rgh;\n      \n         pbr.reflectance0 = specularEnvironmentR0;\n         pbr.reflectance90 = specularEnvironmentR90;\n      \n         pbr.diffuseColor = diffuse;\n         pbr.specularColor = specular;\n         pbr.opaque = 1.0;\n         pbr.occlusion = omr.r;\n         return pbr;\n      }\n      "))}));const{vec3:Je}=glMatrix;function Qe(e){return[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255]}function et(e){return[parseInt(e.slice(1,3),16)/255,parseInt(e.slice(3,5),16)/255,parseInt(e.slice(5,7),16)/255,1]}function tt(e){return e=Math.min(Math.max(e,0),1),Math.round(255*e).toString(16).padStart(2,"0")}function ot(e,t,o){return`#${e=tt(e)}${t=tt(t)}${o=tt(o)}`}function nt(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}const rt=function(e,t=0){this.buffer=e,this.offset=t};rt.prototype.init=function(e,t=0){return this.buffer=e,this.offset=t,this},rt.prototype.reset=function(){return this.offset=0,this},rt.uint8resize=function(e){const t=new Uint8Array(1.5*e.length);return t.set(e),t},rt.prototype.alloc=function(e){return this.offset>=this.buffer.length&&(this.buffer=e(this.buffer)),this.buffer},rt.prototype.inc=function(){return this.offset+=3,this},rt.prototype.dec=function(){return this.offset-=3,this},rt.prototype.set=function(e){return this.buffer[this.offset]=e[0],this.buffer[this.offset+1]=e[1],this.buffer[this.offset+2]=e[2],this},Object.defineProperties(rt.prototype,{0:{get:function(){return this.buffer[this.offset]},set:function(e){return this.buffer[this.offset]=e,e}},1:{get:function(){return this.buffer[this.offset+1]},set:function(e){return this.buffer[this.offset+1]=e,e}},2:{get:function(){return this.buffer[this.offset+2]},set:function(e){return this.buffer[this.offset+2]=e,e}},length:{get:function(){return 3},set:function(e){}}});const it=function(e,t=0){this.buffer=e,this.offset=t};it.prototype.inc=function(){return this.offset+=4,this},it.prototype.dec=function(){return this.offset-=4,this},it.prototype.set=function(e){return this.buffer[this.offset]=e[0],this.buffer[this.offset+1]=e[1],this.buffer[this.offset+2]=e[2],this.buffer[this.offset+3]=e[3],this},Object.defineProperties(it.prototype,{0:{get:function(){return this.buffer[this.offset]},set:function(e){return this.buffer[this.offset]=e,e}},1:{get:function(){return this.buffer[this.offset+1]},set:function(e){return this.buffer[this.offset+1]=e,e}},2:{get:function(){return this.buffer[this.offset+2]},set:function(e){return this.buffer[this.offset+2]=e,e}},3:{get:function(){return this.buffer[this.offset+3]},set:function(e){return this.buffer[this.offset+3]=e,e}},length:{get:function(){return 4},set:function(e){}}});const{vec3:st,vec4:at,mat4:lt}=glMatrix;function ct(e,t){var o=st.create(),n=st.create();st.sub(o,t[1],t[0]),st.sub(n,t[2],t[0]);var r=st.create();st.cross(r,e.direction,n);var i=st.dot(o,r);if(i<1e-6)return 0;var s=1/i,a=st.create();st.sub(a,e.origin,t[0]);var l=st.dot(a,r)*s;if(l<0||l>1)return 0;var c=st.create();st.cross(c,a,o);var d=st.dot(e.direction,c)*s;return d<0||l+d>1?0:st.dot(n,c)*s}const dt=function(){const e=st.create();return function(t,o){st.sub(e,o.center,t.origin);const n=st.dot(e,e),r=st.dot(e,t.direction);return!(r<0&&n>o.radius2)&&!(n-r*r>o.radius2)}}(),ut=function(){const e=st.create();return function(t,o){return gt(e,o.center,t),st.squaredDistance(e,o.center)<o.radius2}}();function ht(e,t,o){const n=o.origin,r=o.destination();let i,s=st.dot(t.normal,n)-t.d,a=st.dot(t.normal,r)-t.d;if(Math.abs(s)<1e-6&&(s=0),Math.abs(a)<1e-6&&(a=0),s*a>0)return-2;if(0==s){if(0==a)return-1;i=0}else 0==a&&(i=1);if(e){if(void 0===i){st.sub(e,t.pt,n);const o=st.dot(t.normal,e);st.sub(e,r,n),i=o/st.dot(t.normal,e)}st.scaleAndAdd(e,n,e,i)}return void 0!==i?i:.5}const ft=function(){let e=[0,0,0];return function(t,o,n){return st.cross(e,o,n),Math.atan2(st.dot(e,t),st.dot(o,n))}}();function pt(e,t,o){const n=st.create();for(let r of e){st.sub(n,r,o);let e=st.dot(n,t);st.scale(n,t,e),st.sub(r,r,n)}}function gt(e,t,o){const n=st.dot(o.normal,t)-o.d;st.scaleAndAdd(e,t,o.normal,-n)}function mt(e,t,o,n,r,i){var s=lt.create(),a=at.create(),l=at.create();return lt.multiply(s,r,n),null==lt.invert(s,s)?(l[3]=0,l):(a[0]=(e-i[0])/i[2]*2-1,a[1]=(t-i[1])/i[3]*2-1,a[2]=2*o-1,a[3]=1,at.transformMat4(l,a,s),0==l[3]||(l[0]/=l[3],l[1]/=l[3],l[2]/=l[3],l[3]=1),l)}function vt(e,t,o){const n=at.create();return at.transformMat4(n,at.transformMat4(n,e,t),o)}class xt{constructor(e,t){this.normal=e,this.d=st.dot(t,e),this.pt=t}static fromNormalPoint(e,t){const o=st.clone(e);return st.normalize(o,o),new xt(o,st.clone(t))}static fromPoints(e,t,o){const n=[0,0,0],r=[0,0,0];return st.sub(n,o,t),st.sub(r,e,t),st.cross(n,n,r),st.normalize(n,n),new xt(n,st.clone(t))}closestPoint(e,t){gt(e,t,this)}intersectAABB(e){return function(e,t){const o=t.halfSize[0]*Math.abs(e.normal[0])+t.halfSize[1]*Math.abs(e.normal[1])+t.halfSize[2]*Math.abs(e.normal[2]),n=st.dot(e.normal,t.center)-e.d;return Math.abs(n)<=o}(this,e)}intersectSphere(e){return ut(this,e)}distanceToPoint(e){return st.dot(e,this.normal)-this.d}intersectLine(e,t,o){st.sub(e,t,o),st.normalize(e,e);const n=st.dot(this.normal,e);if(Math.abs(n)>1e-6){const o=(this.d-st.dot(this.normal,t))/n;return st.scaleAndAdd(e,t,e,o),o}return 0}}class yt{constructor(e,t,o,n,r,i){this.planes=[e,t,o,n,r,i]}static fromProjectionMatrix(e){}containPoint(e){for(let t=0;t<6;t++)if(this.planes[t].distanceToPoint(e)<0)return!1;return!0}overlapHEdge(e){let t=e.origin,o=e.destination();for(let e=0;e<6;++e){const n=this.planes[e].distanceToPoint(t),r=this.planes[e].distanceToPoint(o);if(n<0&&r<0)return!1;if(!(n>0&&r>0)){const r=[0,0,0];this.planes[e].intersectLine(r,t,o),n<0?t=r:o=r}}return!0}overlapPolygon(e){let t=[];for(let o of e.hEdges())t.push(o.origin);for(const e of this.planes){let o=t;t=[];for(let n=0;n<o.length;++n){let r=o[n],i=o[(n+o.length-1)%o.length];if(e.distanceToPoint(r)>0){if(e.distanceToPoint(i)<0){const o=[0,0,0];e.intersectLine(o,i,r),t.push(o)}t.push(r)}else if(e.distanceToPoint(i)>0){const o=[0,0,0];e.intersectLine(o,i,r),t.push(o)}}}return t.length>0}overlapSphere(e){let t=1;for(let o=0;o<6;o++){let n=this.planes[o].distanceToPoint(e.center);if(n<-e.radius)return-1;n<e.radius&&(t=0)}return t}}class bt{constructor(e,t){this.origin=e,this.direction=t,this.invDir=st.fromValues(1/t[0],1/t[1],1/t[2])}intersectSphere(e){return dt(this,e)}intersectAAExtent(e){return function(e,t){let o=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY;for(let r=0;r<3;++r){let i=(t.min[r]-e.origin[r])*e.invDir[r],s=(t.max[r]-e.origin[r])*e.invDir[r];if(e.invDir[r]<0){let e=i;i=s,s=e}if(o=i>o?i:o,n=s<n?s:n,n<=o)return!1}return n>0}(this,e)}}const{vec3:St}=glMatrix,wt=function(){this.cntrOffset=wt.center.alloc(),this.radius=0,this.radius2=0,this.octree=null};wt.center=null,Object.defineProperties(wt.prototype,{0:{get:function(){return wt.center.buffer[this.cntrOffset]},set:function(e){wt.center.set(this.cntrOffset,e)}},1:{get:function(){return wt.center.buffer[this.cntrOffset+1]},set:function(e){wt.center.set(this.cntrOffset+1,e)}},2:{get:function(){return wt.center.buffer[this.cntrOffset+2]},set:function(e){wt.center.set(this.cntrOffset+2,e)}},3:{get:function(){return this.radius},set:function(e){return this.radius=e,this.radius=e*e,e}},center:{get:function(){return this},set:function(e){wt.center.set(this.cntrOffset,e[0]),wt.center.set(this.cntrOffset+1,e[1]),wt.center.set(this.cntrOffset+2,e[2])}}}),wt.prototype.isIntersect=function(e){return dt(e,this)},wt.prototype.setSphere=function(e){wt.center.set(this.cntrOffset,e.center[0]),wt.center.set(this.cntrOffset+1,e.center[1]),wt.center.set(this.cntrOffset+2,e.center[2]),this.radius=e.radius,this.radius2=e.radius*e.radius,this.octree&&this.octree._move(this)},wt.prototype.getBVHRoot=function(){return this.octree.bvh.bvh.root},wt.computeSphere=function(e,t){t[0]=t[1]=t[2]=0;var o={center:t,radius:0};return e.eachVertex((function(e){St.add(o.center,o.center,e)})),St.scale(o.center,o.center,1/e.numberOfVertex),e.eachVertex((function(e){var t=St.distance(o.center,e);t>o.radius&&(o.radius=t)})),o},wt.prototype.getCentroid=function(e){const t=this.cntrOffset;return e[0]=wt.center.buffer[t],e[1]=wt.center.buffer[t+1],e[2]=wt.center.buffer[t+2],e};class Et{constructor(e,t,o){this.bvh=e,this.level=o,this.node=[],t&&(this.bound={center:St.clone(t.center),halfSize:St.clone(t.halfSize)})}*[Symbol.iterator](){if(yield this,this.leaf)for(let e=0;e<8;++e){const t=this.leaf[e];t&&(yield*t)}}getHalfSize(){return this.bound.halfSize}getBound(e){St.copy(e.center,this.bound.center),St.copy(e.halfSize,this.bound.halfSize)}getLooseBound(e){St.copy(e.center,this.bound.center),St.scale(e.halfSize,this.bound.halfSize,Et.kLOOSENESS)}getExtent(e,t=1){for(let o=0;o<3;++o){const n=this.bound.halfSize[o]*t;e.min[o]=this.bound.center[o]-n,e.max[o]=this.bound.center[o]+n}}getLooseExtent(e){this.getExtent(e,Et.kLOOSENESS)}static getOctant(e,t){let o=0;const n=[1,2,4];for(let r=0;r<3;++r){if(t.halfSize[r]/=2,e.radius>t.halfSize[r])return-1;e.center[r]<t.center[r]?(o+=n[r],t.center[r]-=t.halfSize[r]):t.center[r]+=t.halfSize[r]}return o}check(e){if(this.node)for(let t of this.node)e.has(t)?console.log("octree problems"):e.add(t);else{for(let t=0;t<8;++t){const o=this.leaf[t];o&&o.check(e)}for(let t=8;t<this.leaf.length;++t){const o=this.leaf[t];e.has(o)?console.log("octree problems"):e.add(o)}}}free(){if(this.node)for(let e of this.node)e.octree=null;else{for(let e=0;e<8;++e){const t=this.leaf[e];t&&t.free()}for(let e=8;e<this.leaf.length;++e){this.leaf[e].octree=null}}}insert(e,t){if(this.node){if(this.node.push(e),e.octree=this,this.node.length>=Et.kTHRESHOLD){this.leaf=[null,null,null,null,null,null,null,null];let e,o={center:St.create(),halfSize:St.create()};const n=this.node;delete this.node;for(let r of n)St.copy(o.center,t.center),St.copy(o.halfSize,t.halfSize),e=this.insert(r,o);return e}}else{let o=Et.getOctant(e,t);if(o>=0){let n=this.leaf[o];return null===n&&(n=new Et(this.bvh,t,this.level+1),this.leaf[o]=n),n.insert(e,t)}this.leaf.push(e),e.octree=this}return this}_move(e){this.isInside(e)||(this._remove(e),this.bvh.moveSphere(e))}_remove(e){e.octree===this?(this.node?this.node.splice(this.node.indexOf(e),1):this.leaf.splice(this.leaf.indexOf(e),1),e.octree=null):console.log("LooseOctree _remove error")}isInside(e){for(let t=0;t<3;++t){let o=this.bound.halfSize[t];if(o<e.radius||this.bound.center[t]+o<e.center[t]||this.bound.center[t]-o>e.center[t])return!1}return!0}*intersectExtent(e){const t={min:St.create(),max:St.create()};this.getLooseExtent(t),e.intersectAAExtent(t)&&(yield*this._extentIntersect(e,t))}*_extentIntersect(e,t){if(this.node)for(let t of this.node)e.intersectSphere(t)&&(yield t);else{for(let t=8;t<this.leaf.length;++t){const o=this.leaf[t];e.intersectSphere(o)&&(yield o)}for(let o=0;o<8;++o){const n=this.leaf[o];n&&(n.getLooseExtent(t),e.intersectAAExtent(t)&&(yield*n._extentIntersect(e,t)))}}}*intersectBound(e){const t={center:St.create(),halfSize:St.create()};this.getLooseBound(t),e.intersectAABB(t)&&(yield*this._boundIntersect(e,t))}*_boundIntersect(e,t){if(this.node)for(let t of this.node)e.intersectSphere(t)&&(yield t);else{for(let t=8;t<this.leaf.length;++t){const o=this.leaf[t];e.intersectSphere(o)&&(yield o)}for(let o=0;o<8;++o){const n=this.leaf[o];n&&(n.getLooseBound(t),e.intersectAABB(t)&&(yield*n._boundIntersect(e,t)))}}}}function Ct(e){return At(e)}function At(e){const t=[],o=e.halfEdge;let n=e.halfEdge.next;do{t.push(o.index,n.index,n.next.index),n.setTriangle(o),n=n.next}while(n.next!==o);return n.setEdgeTriangle(o.next),o.setEdgeTriangle(n),t}Et.kTHRESHOLD=88,Et.kLOOSENESS=1.5;const Ft={name:"",usageCount:0,baseColor:Qe("#C9CFB1"),roughness:.8,metallic:.1,emission:Qe("#000000"),opacity:1,baseColorTexture:0,roughnessTexture:0,normalTexture:0,occlusionTexture:0,emissionTexture:0,baseColorTexcoord:0,roughnessTexcoord:0,normalTexcoord:0,occlusionTexcoord:0,emissionTexcoord:0},Mt=[],_t=[];class Tt{constructor(e){this.uuid=nt(),this.isAltered=!1,this.pbr=Object.assign({},Ft),this.pbr.name=e;for(let e=0;e<3;++e)Pt.getWhite().assigned();this.index=Tt.color.alloc()/15,this.setGPU()}static textureTypes(){return["baseColorTexture","roughnessTexture","normalTexture","occlusionTexture","emissionTexture"]}static luminance(e){return.2125*e[0]+.7154*e[1]+.0721*e[2]}static convertTraditionalToMetallicRoughness(e){const t=Tt.luminance(e.specularMaterial);let o=1-e.shininessMaterial;return t<.1&&(o*=1-t),e.roughnessMaterial&&(o=e.roughnessMaterial),{baseColor:e.diffuseMaterial,metallic:e.metallicMaterial||.1,roughness:o,emission:e.emissionMaterial,opacity:e.opacityMaterial||1}}static create(e,t){let o;return _t.lenth>0?(o=_t.pop(),o.name=e,o.setValues(Ft)):(o=new Tt(e),Mt.push(o)),t&&o.setValues(t),o}static release(e){if(0===e.pbr.usageCount){for(let t of Tt.textureTypes())e[t]=Pt.getWhite();return _t.push(e),!0}return!1}static*getInUse(){for(const e of Mt)e.pbr.usageCount>0&&(yield e)}setGPU(){const e=15*this.index;Tt.color.set(e,this.pbr.baseColor[0]),Tt.color.set(e+1,this.pbr.baseColor[1]),Tt.color.set(e+2,this.pbr.baseColor[2]),Tt.color.set(e+3,this.pbr.roughness),Tt.color.set(e+4,this.pbr.metallic),Tt.color.set(e+5,this.pbr.opacity),Tt.color.set(e+6,this.pbr.emission[0]),Tt.color.set(e+7,this.pbr.emission[1]),Tt.color.set(e+8,this.pbr.emission[2])}setGPUTexture(){const e=15*this.index;Tt.color.set(e+9,this.pbr.baseColorTexture),Tt.color.set(e+10,this.pbr.normalTexture),Tt.color.set(e+11,this.pbr.occlusionTexture)}setValues(e){for(const t of Object.keys(e))this.pbr.hasOwnProperty(t)?"baseColor"!=t&&"emission"!=t||Array.isArray(e[t])?this.pbr[t]=e[t]:this.pbr[t]=Qe(e[t]):console.log("unknown input material: "+t);this.setGPU()}getBaseColorInHex(){return ot(...this.pbr.baseColor)}removeTexture(e){this.pbr[e]&&this.setTexture(e,Pt.getWhite())}setTexture(e,t){t.idx!==this.pbr[e].idx&&(Pt.gList[this.pbr[e]].unassigned(),this.pbr[e]=t.idx,t.assigned(),this.setGPUTexture())}hasBaseColorTexture(){return 0!==this.pbr.baseColorTexture}get baseColorTexture(){return Pt.handle(this.pbr.baseColorTexture)}set baseColorTexture(e){this.setTexture("baseColorTexture",e)}get roughnessTexture(){return Pt.handle(this.pbr.roughnessTexture)}set roughnessTexture(e){this.setTexture("roughnessTexture",e)}get normalTexture(){return Pt.handle(this.pbr.normalTexture)}set normalTexture(e){this.setTexture("normalTexture",e)}get occlusionTexture(){return Pt.handle(this.pbr.occlusionTexture)}set occlusionTexture(e){this.setTexture("occlusionTexture",e)}get emissionTexture(){return Pt.handle(this.pbr.emissionTexture)}set emissionTexture(e){this.setTexture("emissionTexture",e)}textureHash(){return""+this.pbr.baseColorTexture}isInUse(){return this.pbr.usageCount>0}assigned(){++this.pbr.usageCount,this.isAltered=!0}unassigned(){--this.pbr.usageCount,this.isAltered=!0}}Tt.color=null;class Pt{constructor(e,t){this.name=e,this.id=x.createTexture(),this.usageCount=0,this.sampler=Pt.defaultSampler(),this.setSampler(t),this.setImage(x.CHECKERBOARD)}close(){x.deleteTexture(this.id),this.id=null,this.image=null}static defaultSampler(){return{format:x.RGBA,type:x.UNSIGNED_BYTE,magFilter:x.LINEAR,minFilter:x.LINEAR,wrapS:x.REPEAT,wrapT:x.REPEAT,flipY:!1,unit:0}}static create(e,t){let o=new Pt(e,t);return Pt.gFreeList.lenth>0?(o.idx=_t.pop(),Pt.gList[o.idx]=o):(o.idx=Pt.gList.length,Pt.gList.push(o)),o}static release(e){return 0===e.usageCount&&(Pt.gFreeList.push(e.idx),Pt.gList[e.idx]=null,e.close(),!0)}static getWhite(){return Pt.WHITE||(Pt.WHITE=function(){const e=Pt.create("WHITE");return x.activeTexture(x.TEXTURE0+7),x.bindTexture(x.TEXTURE_2D,e.id),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,1,1,0,x.RGBA,x.UNSIGNED_BYTE,new Uint8Array([255,255,255,255])),e}()),Pt.WHITE}assigned(){this.usageCount++}unassigned(){this.usageCount--}bind(e){x.activeTexture(x.TEXTURE0+(e||0)),x.bindTexture(x.TEXTURE_2D,this.id)}static unbind(e){x.activeTexture(x.TEXTURE0+(e||0)),x.bindTexture(x.TEXTURE_2D,0)}static handle(e){return Pt.gList[e]}isExist(){return 0!==this.idx}setImage(e){this.image=x.resizeImage(e),x.activeTexture(x.TEXTURE0+7),x.bindTexture(x.TEXTURE_2D,this.id),this.sampler.flipY&&x.pixelStorei(x.UNPACK_FLIP_Y_WEBGL,1),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,this.sampler.magFilter),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,this.sampler.minFilter),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,this.sampler.wrapS),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,this.sampler.wrapT),x.texImage2D(x.TEXTURE_2D,0,this.sampler.format,this.sampler.format,this.sampler.type,this.image),this.sampler.minFilter!=x.NEAREST&&this.sampler.minFilter!=x.LINEAR&&x.generateMipmap(x.TEXTURE_2D),this.sampler.flipY&&x.pixelStorei(x.UNPACK_FLIP_Y_WEBGL,0)}setSampler(e){if(e)for(let[t,o]of Object.entries(e))this.sampler[t]=o}}Pt.gList=[],Pt.gFreeList=[],Pt.WHITE;const{vec3:Lt}=glMatrix,Vt=function(e,t,o){Vt.state.alloc(),Vt.index.alloc(),this.index=o,this.left=new Bt(this),this.right=new Bt(this),this.left.pair=this.right,this.left.next=this.right,this.right.pair=this.left,this.right.next=this.left,this.left.origin=e,this.right.origin=t,this.left.initAttribute(),this.right.initAttribute();const n=1+2*this.index,r=4*n;Bt.index.set(r+1,n),Bt.index.set(r+5,n+1),Bt.triangleList.set(3*(n-1),n),Bt.triangleList.set(3*(n-1)+2,n),Bt.triangleList.set(3*n,n+1),Bt.triangleList.set(3*n+2,n+1)};Vt.index=null,Vt.state=null,Vt.prototype.discardInternal=function(e){this.setGroup(-1),this.left.discardInternal(e),this.right.discardInternal(e)},Vt.prototype.archiveInternal=function(e){return{wEdge:this,left:this.left.archiveInternal(e),right:this.right.archiveInternal(e)}},Vt.prototype.restoreInternal=function(e){this.left.restoreInternal(e.left),this.right.restoreInternal(e.right)},Vt.prototype[Symbol.iterator]=function*(){yield this.left,yield this.right},Vt.prototype.isOk=function(){if(!this.left.origin||!this.left.origin.outEdge)throw"leftEdge has problem";if(!this.right.origin||!this.right.origin.outEdge)throw"rightEdge has problem"},Vt.prototype.isHard=function(){return 1&Vt.state.buffer[this.index]},Vt.prototype.setHardness=function(e){return e<2?this.setEdgeMask(e,1):this.isHard()?this.setHardness(!1,1):this.setHardness(!0,1)},Vt.prototype.selectEdge=function(e){this.setEdgeMask(e,2)},Vt.prototype.setEdgeMask=function(e,t){const o=this.index,n=Vt.state.buffer[o];return e?Vt.state.set(o,n|t):Vt.state.set(o,n&~t)},Vt.prototype.setGroup=function(e){let t=24*this.index+3;for(let o=0;o<6;o++,t+=4)Vt.index.set(t,e);t=4*(1+2*this.index),Bt.index.set(t+3,e),Bt.index.set(t+7,e)},Vt.prototype.getIndex=function(e){return 1+2*this.index+(e===this.right?1:0)},Vt.prototype.updateApex=function(e,t){const o=Vt.index.buffer;let n=24*this.index;this.right===e&&(n+=12),n<Vt.index.alteredMin&&(Vt.index.alteredMin=n);const r=e.face?e.face.index:-1;o[n++]=e.origin?e.origin.index:-1,o[n++]=this.index,o[n++]=r,n++,o[n++]=e.destination()?e.destination().index:-1,o[n++]=this.index,o[n++]=r,n++,o[n++]=t?t.origin.index:-1,o[n++]=-this.index-1,o[n]=r,n>Vt.index.alteredMax&&(Vt.index.alteredMax=n)},Vt.prototype.isLive=function(){return null!==this.left.origin&&null!==this.right.origin},Vt.prototype.adjacent=function*(){let e=this.left.next.wingedEdge;yield e;let t=this.left.prev().wingedEdge;t!==e&&(yield t),e=this.right.next.wingedEdge,yield e,t=this.right.prev().wingedEdge,t!==e&&(yield t)},Vt.prototype.oneRing=function*(){for(let e of this){let t=e.next;e=e.pair;do{yield t.wingedEdge,t=t.pair.next}while(t!==e)}},Vt.prototype.eachVertex=function*(){yield this.left.origin,yield this.right.origin},Vt.prototype.wing=function*(){yield this.left.prev(),yield this.left,yield this.left.next,yield this.right.prev(),yield this.right,yield this.right.next},Vt.prototype.getNormal=function(e){this.left.face&&Lt.add(e,e,this.left.face.normal),this.right.face&&Lt.add(e,e,this.right.face.normal),Lt.normalize(e,e)};const It={color:null,normal:null,uv:null},Bt=function(e){Bt.index.alloc(),Bt.indexAttribute.alloc(),Bt.triangleList.alloc(),this.wingedEdge=e,this._next=null,this._origin=null,this._face=null,this.pair=null};Bt.index=null,Bt.indexAttribute=null,Bt.color=null,Bt.triangleList=null,Object.defineProperties(Bt.prototype,{origin:{get:function(){return this._origin},set:function(e){if(this._origin!==e){this._origin=e;let t=4*this.getIndex(this);const o=e?e.index:-1;Bt.index.set(t,o)}}},face:{get:function(){return this._face},set:function(e){if(this._face!==e){this._face=e;const t=4*this.getIndex();e?Bt.index.set(t+2,e.index):Bt.index.set(t+2,-1)}}},next:{get:function(){return this._next},set:function(e){this._next!==e&&(this._next=e)}},index:{get:function(){return this.wingedEdge.index}}}),Bt.prototype.setTriangle=function(e){const t=this.getIndex(),o=3*(t-1);Bt.triangleList.set(o,t),Bt.triangleList.set(o+1,this.next.getIndex()),Bt.triangleList.set(o+2,e.getIndex()),this.updateApex(e)},Bt.prototype.setEdgeTriangle=function(e){const t=3*(this.getIndex()-1);Bt.triangleList.set(t,0),Bt.triangleList.set(t+1,0),Bt.triangleList.set(t+2,0),this.updateApex(e)},Bt.prototype.updateApex=function(e){this.wingedEdge.updateApex(this,e)},Bt.prototype.getIndex=function(){return this.wingedEdge.getIndex(this)},Bt.prototype.setHilite=function(e){this.wingedEdge.setEdgeMask(e,4)},Bt.prototype.getVertexColor=function(e){const t=3*this.getIndex(),o=Bt.indexAttribute.get(t);return e&&Bt.color.getValue(o,e),o},Bt.prototype.setVertexColor=function(e){let t=3*this.getIndex(),o=Bt.indexAttribute.get(t);const n=Bt.color.pruneGet(o);return Bt.color.bind(e),Bt.indexAttribute.set(t,e),n},Bt.prototype.setUV=function(e){let t=3*this.getIndex()+2,o=Bt.indexAttribute.get(t),n=It.uv.pruneGet(o);return It.uv.bind(e),Bt.indexAttribute.set(t,e),n},Bt.prototype.getUV=function(){let e=3*this.getIndex()+2;return Bt.indexAttribute.get(e)},Bt.prototype.getUVCoord=function(e,t){It.uv.getChannel(this.getUV(),e,t)},Bt.prototype.initAttribute=function(){Bt.color.bind(0);let e=3*this.getIndex();Bt.indexAttribute.set(e,0),It.uv.bind(0),Bt.indexAttribute.set(e+2,0)},Bt.prototype.discardInternal=function(e){let t=3*this.getIndex(),o=Bt.indexAttribute.get(t),n=Bt.color.pruneGet(o);n.value&&e.color.push(n),o=Bt.indexAttribute.get(t+2),n=It.uv.pruneGet(o),n.value&&e.uv.push(n),this.setEdgeTriangle(null),this.face=null,this.origin=null,this.next=this.pair},Bt.prototype.archiveInternal=function(){let e=3*this.getIndex(),t=Bt.indexAttribute.get(e);if(t<0)throw new Error("No color Attribute");let o=Bt.indexAttribute.get(e+2);if(o<0)throw new Error("No uv Attribute");return{origin:this.origin,next:this.next,color:t,uv:o}},Bt.prototype.restoreInternal=function(e){this.origin=e.origin,this.next=e.next,this.setVertexColor(e.color),this.setUV(e.uv)},Bt.prototype.isLive=function(){return this.wingedEdge.isLive()},Bt.prototype.isBoundary=function(){return null===this.face},Bt.prototype.isNotBoundary=function(){return null!==this.face},Bt.prototype.destination=function(){return this.pair.origin},Bt.prototype.prevAux=function(){if(null!==this.face){let e=this;for(;e.next!==this;)e=e.next;return e}return null},Bt.prototype.prev=function(){if(this.pair.next===this)return this.pair;var e=this,t=this.origin.findInEdge((function(t,o){return t.next===e}));if(null===t)throw"HalfEdge.prev: link list is broken, cannot find prev";return t},Bt.prototype.eachEdge=function*(){var e=this;if(e)do{yield e,e=e.pair.next}while(e&&e!==this)};const Rt=function(e){Rt.index.alloc();let t=Rt.position.alloc();this.outEdge=null,this.posOffset=t,this._index=e;const o=t;Rt.index.set(o,o/3)};Rt.index=null,Rt.position=null,Rt.isOverlap=function(e,t){let o=t[0]-e[0];if(o*=o,o>4e-6)return-1;let n=t[1]-e[1];n*=n;let r=t[2]-e[2];return r*=r,4e-6>o+n+r?1:0},Object.defineProperty(Rt.prototype,"index",{get:function(){return this.posOffset/3}}),Object.defineProperties(Rt.prototype,{0:{get:function(){return Rt.position.buffer[this.posOffset]},set:function(e){Rt.position.set(this.posOffset,e)}},1:{get:function(){return Rt.position.buffer[this.posOffset+1]},set:function(e){Rt.position.set(this.posOffset+1,e)}},2:{get:function(){return Rt.position.buffer[this.posOffset+2]},set:function(e){Rt.position.set(this.posOffset+2,e)}},length:{get:function(){return 3},set:function(e){}}}),Rt.prototype.set=function(e){Rt.position.set(this.posOffset,e[0]),Rt.position.set(this.posOffset+1,e[1]),Rt.position.set(this.posOffset+2,e[2])},Object.defineProperty(Rt.prototype,"valence",{get:function(){let e=0,t=this.outEdge,o=t;if(o)do{++e,o=o.pair.next}while(o&&o!==t);return e}}),Rt.prototype.getRestore=function(e){return e.set(this),e.inc(),{vertex:this,outEdge:this.outEdge}},Rt.prototype.setRestore=function(e,t){this.outEdge=e.outEdge,this.set(t),t.inc()},Rt.prototype.hide=function(){this.setMask(!1,128)},Rt.prototype.show=function(){this.setMask(!0,128)},Rt.prototype.resetState=function(){const e=this.posOffset+1,t=parseInt(Rt.index.buffer[e]);Rt.index.set(e,128&t)},Rt.prototype.setHilite=function(e){this.setState(e,4)},Rt.prototype.setSelect=function(e){this.setState(e,1)},Rt.prototype.setMagnet=function(e){this.setState(e,2)},Rt.prototype.setState=function(e,t){const o=this.posOffset+1,n=parseInt(Rt.index.buffer[o]);return e?Rt.index.set(o,n|t):Rt.index.set(o,n&~t)},Rt.prototype.setGroup=function(e){const t=this.posOffset+2;Rt.index.set(t,e)},Rt.prototype.restructure=function(e){let t=this.outEdge,o=this.outEdge,n=this.outEdge,r=null;for(;e.has(n.wingedEdge)&&(r=n,n=n.next.pair,t=o=n,n!==this.outEdge););do{if(e.has(n.wingedEdge)){if(null===r){let e=n;do{r=e,e=e.pair.next}while(e!==n)}r.pair.next=n.pair.next,o===n&&(o=n.pair.next)}else n.index<o.index&&(o=n),r=n;n=n.pair.next}while(n!==t);this.outEdge!==o&&(this.outEdge=o)},Rt.prototype.reorient=function(){let e=this.outEdge,t=this.outEdge;do{t.index<e.index&&(e=t),t=t.pair.next}while(t!==this.outEdge);this.outEdge=e},Rt.prototype.orient=function(e){(!this.outEdge||this.outEdge.index>e.index)&&(this.outEdge=e)},Rt.prototype.isLive=function(){return null!==this.outEdge},Rt.prototype.oneRing=function*(e){e||(e=this.outEdge);let t=e;do{const e=t.pair;yield e.origin,t=e.next}while(t!==e)},Rt.prototype.edgeRing=function*(e){e||(e=this.outEdge);let t=e;do{let e=t.pair.next;yield t,t=e}while(t!==e)},Rt.prototype.eachInEdge=function*(){var e=this.outEdge,t=e;if(t)do{const e=t.pair;t=t.pair.next,yield e}while(t&&t!==e)},Rt.prototype.findInEdge=function(e){var t=this.outEdge,o=t;if(o)do{if(e(o.pair,this))return o.pair;o=o.pair.next}while(o&&o!==t);return null},Rt.prototype.eachOutEdge=function*(){var e=this.outEdge,t=e;if(t)do{yield t,t=t.pair.next}while(t&&t!==e)},Rt.prototype.findOutEdge=function(e){var t=this.outEdge,o=t;if(o)do{if(e(o,this))return o;o=o.pair.next}while(o&&o!==t);return null},Rt.prototype.findFreeInEdge=function(){return this.findInEdge((function(e,t){return null===e.face}))},Rt.prototype.findFreeInEdgeAll=function(){const e=[],t=this.outEdge;let o=t;do{o.pair.isBoundary()&&e.push(o.pair),o=o.pair.next}while(o!==t);return e},Rt.prototype.linkEdge=function(e,t){if(null===this.outEdge)this.outEdge=e;else{var o=this.findFreeInEdge();if(null===o)return console.log("Error: Vertex.linkEdge: complex vertex "+this.index),!1;var n=o.next;o.next=e,t.next=n,e.index<this.outEdge.index&&(this.outEdge=e)}return!0},Rt.prototype.unlinkEdge=function(e,t){const o=e.prev();if(null===o)throw"Error: Could not find Prev hEdge";if(this.outEdge===e){if(o===t)return void(this.outEdge=null);this.outEdge=o.pair}o.next=t.next},Rt.prototype.isIsolated=function(){return null===this.outEdge},Rt.prototype.numberOfEdge=function(){let e=0;const t=this.outEdge;let o=t;do{e++,o=o.pair.next}while(o!==t||e>1001);return e},Rt.prototype.getNormal=function(e){const t=this.outEdge;let o=t;const n=[0,0,0],r=[0,0,0],i=[0,0,0];Lt.sub(n,o.destination(),o.origin);do{o=o.pair.next,Lt.sub(r,o.destination(),o.origin),Lt.cross(i,r,n),Lt.add(e,e,i),Lt.copy(n,r)}while(o!==t);Lt.normalize(e,e)},Rt.prototype.isOk=function(){if(!this.outEdge)throw"outEdge should not be null";{let e=this.outEdge;do{if(e.index<this.outEdge.index)throw"Vertex's outEdge is not the smallest";e=e.pair.next}while(e!==this.outEdge)}};const Ot=function(e,t,o=Tt.default){wt.call(this),this.index=Ot.state.alloc()/3,Ot.normal.alloc(),this.halfEdge=e,this.numberOfVertex=t,this.assignMaterial(o)};Ot.prototype=Object.create(wt.prototype),Object.defineProperty(Ot.prototype,"constructor",{value:Ot,enumerable:!1,writable:!0}),Ot.state=null,Ot.normal=null,Ot.triangleIndex=null,Ot.prototype.getRestore=function(){return{polygon:this,halfEdge:this.halfEdge,material:this.material}},Ot.prototype.hide=function(){this.setState(!0,4)},Ot.prototype.show=function(){this.setState(!1,4)},Ot.prototype.setHilite=function(e){this.setState(e,2)},Ot.prototype.setSelect=function(e){this.setState(e,1)},Ot.prototype.setState=function(e,t){const o=3*this.index,n=Ot.state.buffer[o];return e?Ot.state.set(o,n|t):Ot.state.set(o,n&~t)},Ot.prototype.assignMaterial=function(e){if(e!==this.material){this.material&&this.material.unassigned(),this.material=e,e.assigned();const t=3*this.index;Ot.state.set(t+1,255&e.index),Ot.state.set(t+2,(65280&e.index)>>8)}},Object.defineProperty(Ot.prototype,"normal",{get:function(){return new rt(Ot.normal.buffer,this.cntrOffset)}}),Ot.prototype.getNormal=function(e){let t=this.cntrOffset;return e[0]=Ot.normal.get(t),e[1]=Ot.normal.get(t+1),e[2]=Ot.normal.get(t+2),e},Ot.prototype.isLive=function(){return null!==this.halfEdge},Ot.prototype.isVisible=function(){return!(4&Ot.state.buffer[this.index])&&null!==this.halfEdge},Ot.prototype.buildIndex=function(e,t,o){for(let n of this.hEdges())e[t++]=n.origin.index,e[t++]=n.destination().index,e[t++]=o;return t},Ot.prototype.eachVertex=function*(){var e=this.halfEdge,t=e;do{yield t.origin,t=t.next}while(t!==e)},Ot.prototype.eachEdge=function(e){var t=this.halfEdge,o=t;do{let t=o.next;e(o),o=t}while(o!==t)},Ot.prototype.hEdges=function*(){const e=this.halfEdge;let t=e;do{let e=t.next;yield t,t=e}while(t!==e)},Ot.prototype.adjacent=function*(){const e=new Set,t=this.halfEdge;let o=t;do{let t=o.pair.face;null===t||e.has(t)||(e.add(t),yield t),o=o.next}while(o!==t)},Ot.prototype.oneRing=function*(){const e=new Set;e.add(this);const t=this.halfEdge;let o=t;do{const t=o.origin;for(let o of t.edgeRing()){const t=o.face;null===t||e.has(t)||(e.add(t),yield t)}o=o.next}while(o!==t)},Ot.prototype.computeNormal=function(){const e=Lt.create(),t=Lt.create();return function(){const o=this.halfEdge.origin,n=this.halfEdge.next.origin;this.getCentroid(e),Lt.sub(t,e,n),Lt.sub(e,o,n),Lt.cross(t,t,e),Lt.normalize(t,t);const r=3*this.index;Ot.normal.set(r,t[0]),Ot.normal.set(r+1,t[1]),Ot.normal.set(r+2,t[2])}}(),Ot.prototype._assignFace=function(){let e=this.halfEdge;do{e.face=this,e=e.next}while(e!=this.halfEdge);return this},Ot.prototype.updatePosition=function(){const e=this.halfEdge;let t=e;const o=[t.origin[0],t.origin[1],t.origin[2]],n=[t.origin[0],t.origin[1],t.origin[2]];do{Lt.min(o,o,t.origin),Lt.max(n,n,t.origin),t=t.next}while(t!==e);let r={center:[0,0,0],radius:0};Lt.sub(r.center,n,o),Lt.scale(r.center,r.center,.5),r.radius=Math.hypot(r.center[0],r.center[1],r.center[2]),Lt.add(r.center,r.center,o),this.setSphere(r),this.numberOfVertex>2&&this.computeNormal()},Ot.prototype.updateIncipient=function(){this._update(),this.triangulation?this.triangulation=Ct(this):this.triangulation=At(this)},Ot.prototype.updateFull=function(){this._update(),this.triangulation=Ct(this)},Ot.prototype._update=function(){const e=this.halfEdge;let t=this.halfEdge;this.numberOfVertex=0;const o=[t.origin[0],t.origin[1],t.origin[2]],n=[t.origin[0],t.origin[1],t.origin[2]],r=[0,0,0];do{if(Lt.min(o,o,t.origin),Lt.max(n,n,t.origin),Lt.add(r,r,t.origin),t.getIndex()<this.halfEdge.getIndex()&&(this.halfEdge=t),++this.numberOfVertex>10001)throw"something is wrong with polygon link list";if(t.face!==this)throw"impossible face polygon";t=t.next}while(t!==e);let i;3===this.numberOfVertex?(Lt.scale(r,r,1/3),i=Lt.distance(r,e.origin)):(i=Lt.distance(n,o)/2,Lt.lerp(r,o,n,.5)),this.setSphere({center:r,radius:i}),this.numberOfVertex>2&&this.computeNormal()},Ot.prototype.isOk=function(){if(!this.halfEdge)throw"halfEdge should not be null";{let e=this.halfEdge,t=0;do{if(e.index<this.halfEdge.index)throw"Polygon's halfEdge is not smallest";if(++t,t>1001)throw"Polygon has too many side";e=e.next}while(e!==this.halfEdge);if(t!==this.numberOfVertex)throw"Polygon's Number of Vertex is not consistent"}};const Nt=function(e){Tt.color=new C(15),Tt.default=Tt.create("default"),Tt.dead=Tt.create("dead"),Vt.index=new C(24),Vt.state=new A(1),Bt.index=new C(4),Bt.index.alloc(),Bt.index.set(0,-1),Bt.index.set(1,0),Bt.index.set(2,-1),Bt.index.set(3,-1),Bt.indexAttribute=new C(3),Bt.indexAttribute.alloc(),Bt.triangleList=new F(3),Bt.color=new L,Bt.color.bind(Bt.color.reserve()),Bt.color.setValue(0,[255,255,255]),It.uv=new V,It.uv.bind(It.uv.reserve()),It.uv.setValue(0,[0,0,0,0,0,0,0,0]),Rt.index=new C(3),Rt.position=this.position=new C(3,e),wt.center=new C(3,e),Ot.state=new A(3),Ot.normal=new C(3,e),Ot.triangleIndex=new I,Dt.state=new A(1),this.vertices=[],this.edges=[],this.faces=[],this.free={vertices:[],edges:[],faces:[]},this.affected={vertices:new Set,edges:new Set,faces:new Set,color:[],uv:[]}};Nt.prototype.allocVertex=function(e,t){if(this.free.vertices.length>0){let o;if(void 0===t)o=this.vertices[this.free.vertices.pop()];else{const e=Nt._indexOfFreeList(t.index,this.free.vertices);if(e<0)throw"delVertex "+e+" not found in free list";o=t,this.free.vertices.splice(e,1),o=t}return o.set(e),this.affected.vertices.add(o),o}{let t=new Rt(this.vertices.length);return t.set(e),this.vertices.push(t),this.affected.vertices.add(t),t}},Nt.prototype.allocEdge=function(e,t,o){let n,r;if(this.free.edges.length>0){if(void 0!==o){const e=Nt._indexOfFreeList(o.wingedEdge.index,this.free.edges);if(e<0)throw"delOutEdge "+o.wingedEdge.index+" not found in free list";this.free.edges.splice(e,1),n=o.wingedEdge,r=o}else n=this.edges[this.free.edges.pop()],r=n.left;r.origin=e,r.pair.origin=t,r.initAttribute(),r.pair.initAttribute()}else n=new Vt(e,t,this.edges.length),this.edges.push(n),r=n.left;return r},Nt.prototype.allocPolygon=function(e,t,o,n){let r;if(o||(o=Tt.default),this.free.faces.length>0){if(void 0!==n){const e=Nt._indexOfFreeList(n.index,this.free.faces);if(e<0)throw"delPolygon "+n.index+" not found in free list";this.free.faces.splice(e,1),r=n}else r=this.faces[this.free.faces.pop()];r.assignMaterial(o),r.halfEdge=e,r.numberOfVertex=t,r.show()}else r=new Ot(e,t,o),r.index=this.faces.length,this.faces.push(r);return r},Nt._indexOfFreeList=function(e,t){let o=0,n=t.length-1;for(;o<=n;){let r=o+(n-o>>>1),i=e-t[r];if(i>0)n=r-1;else{if(!(i<0))return r;o=r+1}}return-1},Nt.prototype._insertFreeList=function(e,t){for(var o=0,n=t.length-1;o<=n;){let r=o+(n-o>>>1),i=e-t[r];if(i>0)n=r-1;else{if(!(i<0))break;o=r+1}}t.splice(o,0,e)},Nt.prototype.freeVertex=function(e){e.outEdge=null,this._insertFreeList(e.index,this.free.vertices),this.affected.vertices.add(e)},Nt.prototype.freeHEdge=function(e){const t=e.wingedEdge,o=t.archiveInternal();return t.discardInternal(this.affected),this._insertFreeList(t.index,this.free.edges),o},Nt.prototype.freePolygon=function(e){e.halfEdge=null,e.numberOfVertex=0,e.assignMaterial(Tt.dead),e.hide(),this._insertFreeList(e.index,this.free.faces),this.affected.faces.add(e)},Nt.prototype.freeAll=function(e,t,o){function n(e,t){return t-e}for(let t of e)this.free.faces.push(t.index),t.halfEdge=null,t.numberOfVertex=0;this.free.faces.sort(n);for(let e of t)this.free.edges.push(e.index),e.left.face=null,e.left.origin=null,e.right.face=null,e.right.face=null,e.left.next=e.right,e.right.next=e.left;this.free.edges.sort(n);for(let e of o)this.free.vertices.push(e.index),e.outEdge=null;this.free.vertices.sort(n)},Nt.prototype.getVertices=function(e){return this.vertices[e]},Nt.prototype.clearAffected=function(){this.affected.vertices.clear(),this.affected.faces.clear()},Nt.prototype.addAffectedFace=function(e){this.affected.faces.add(e)},Nt.prototype.addAffectedVertex=function(e){this.affected.vertices.add(e)},Nt.prototype.addAffectedVertexFace=function(e){this.affected.vertices.add(e);for(let t of e.eachOutEdge())null!==t.face&&this.affected.faces.add(t.face)},Nt.prototype.updateAffectedVertex=function(){for(let e of this.affected.vertices)e.isLive()&&e.reorient()},Nt.prototype.updateAffected=function(){this.updateAffectedVertex();for(let e of this.affected.faces)e.isLive()&&e.updateFull();this.clearAffected()},Nt.prototype.updateAffectedIncipient=function(){this.updateAffectedVertex();for(let e of this.affected.faces)e.isLive()&&e.updateIncipient();this.clearAffected()};const Dt=function(e){this.guid=Dt.state.alloc(),this.alloc=e,this.vertices=new Set,this.faces=new Set,this.edges=new Set};Dt.state=null,Dt.prototype.checkIntegrity=function(){try{for(let e of this.faces)e.isOk();for(let e of this.edges)e.isOk();for(let e of this.vertices)e.isOk()}catch(e){alert(e)}},Dt.prototype.hide=function(){this.setState(!0,8)},Dt.prototype.show=function(){this.setState(!1,8)},Dt.prototype.setTransparency=function(e){this.setState(e,4)},Dt.prototype.setHilite=function(e){this.setState(e,2)},Dt.prototype.setSelect=function(e){this.setState(e,1)},Dt.prototype.setState=function(e,t){const o=this.guid,n=Dt.state.buffer[o];return e?Dt.state.set(o,n|t):Dt.state.set(o,n&~t)},Dt.prototype.getStat=function(e){for(let t of this.edges)for(let o of t)o.isBoundary()&&++e.boundary;e.vertices+=this.vertices.size,e.faces+=this.faces.size,e.edges+=this.edges.size},Dt.prototype.empty=function(){const e={faces:[],edges:[],vertices:[],uvs:[],colors:[]};for(let t of this.faces)e.faces.push(t.getRestore()),this.alloc.freePolygon(t);this.faces.clear();for(const t of this.edges)e.edges.push(this.alloc.freeHEdge(t.left));this.edges.clear(),e.pts=new Float32Array(3*this.vertices.size);const t=new rt(e.pts);for(let o of this.vertices)e.vertices.push(o.getRestore(t)),this.alloc.freeVertex(o);return this.vertices.clear(),e},Dt.prototype.emptyUndo=function(e){const t=new rt(e.pts);for(let o of e.vertices)this.addVertex(o.vertex),o.vertex.setRestore(o,t);for(let t of e.edges)this._createEdge(t.left.origin,t.right.origin,t.wEdge.left),t.wEdge.restoreInternal(t);for(let t of e.faces){this._createPolygon(t.halfEdge,4,t.material,t)._assignFace()}},Dt.prototype.free=function(){this.alloc.freeAll(this.faces,this.edges,this.vertices),this.faces=new Set,this.edges=new Set,this.vertices=new Set},Dt.prototype.merge=function(e,t){for(let o of t())o.extinquish(),this._merge(e,o.geometry.faces,o.geometry.edges,o.geometry.vertices)},Dt.prototype._merge=function(e,t,o,n){for(let e of n)e.setGroup(this.guid),this.vertices.add(e);for(let e of o)e.setGroup(this.guid),this.edges.add(e);for(let o of t)e.insertFace(o),this.faces.add(o)},Dt.prototype.revive=function(e){for(let e of this.vertices)e.setGroup(this.guid);for(let e of this.edges)e.setGroup(this.guid);for(let t of this.faces)e.insertFace(t)},Dt.prototype.separateOut=function(e){const t=new Set,o=[];let n;function r(e){for(let o of e.hEdges()){const e=o.pair.face;null===e||t.has(e)||(t.add(e),n.add(e),r(e))}}for(let e of this.faces)if(!t.has(e)){t.add(e);let i=new Dt(this.alloc);n=i.faces,n.add(e),r(e),o.push(i)}if(o.length>1){for(let t of o)for(let o of t.faces){e.removeFace(o);for(let e of o.hEdges())t.vertices.add(e.origin),e.origin.setGroup(t.guid),t.edges.add(e.wingedEdge),e.wingedEdge.setGroup(t.guid)}return o}return null},Dt.prototype.detachFace=function(e,t){const o=new Set,n=new Set;for(let r of t){e.removeFace(r),this.faces.delete(r);for(let e of r.hEdges())o.add(e.origin),this.vertices.delete(e.origin),n.add(e.wingedEdge),this.edges.delete(e.wingedEdge)}return{vertices:o,edges:n}},Dt.prototype.sanityCheck=function(){let e=!0;for(let[n,r]of this.vertices.entries())if(r.isLive())if(r.outEdge.origin!==r)console.log("vertex "+n+" outEdge is wrong"),e=!1;else{var t=r.outEdge,o=t;let i=null,s=0;if(o)do{if(o.pair.next===t){i=o.pair;break}o=o.pair.next,s++}while(o&&o!==t&&s<101);null===i&&(console.log("vertex "+n+" is broken"),e=!1)}return e},Dt.prototype.addAffectedFace=function(e){return this.alloc.addAffectedFace(e),this},Dt.prototype.addAffectedVertex=function(e){return this.alloc.addAffectedVertex(e),this},Dt.prototype.updateAffected=function(){this.alloc.updateAffected()},Dt.prototype.updateAffectedIncipient=function(){this.alloc.updateAffectedIncipient()},Dt.prototype.addAffectedVertexFace=function(e){this.alloc.addAffectedVertexFace(e)},Dt.prototype._createPolygon=function(e,t,o,n){let r;return r=n?n.polygon.isLive()?n.polygon:this.alloc.allocPolygon(e,t,n.material,n.polygon):this.alloc.allocPolygon(e,t,o),this.faces.add(r),this.addAffectedFace(r),r},Dt.prototype.addVertex=function(e,t){const o=this.alloc.allocVertex(e,t);return this.vertices.add(o),o.setGroup(this.guid),o},Dt.prototype._createEdge=function(e,t,o){const n=this.alloc.allocEdge(e,t,o);return n.wingedEdge.setGroup(this.guid),this.edges.add(n.wingedEdge),this.addAffectedVertex(e).addAffectedVertex(t),n},Dt.prototype._freeVertex=function(e){this.vertices.delete(e)&&(e.setGroup(-1),this.alloc.freeVertex(e))},Dt.prototype._freeEdge=function(e){this.edges.delete(e.wingedEdge)&&this.alloc.freeHEdge(e)},Dt.prototype._freePolygon=function(e){if(this.faces.delete(e)){const t={material:e.material,polygon:e};return this.alloc.freePolygon(e),t}return null},Dt.prototype.getExtent=function(e,t){for(let o of this.vertices)for(let n=0;n<3;++n){const r=o[n];r>t[n]?t[n]=r:r<e[n]&&(e[n]=r)}},Dt.prototype.addEdge=function(e,t,o,n){var r=this._createEdge(e,t).wingedEdge;if(o)r.right.next=o.next,o.next=r.left;else if(!e.linkEdge(r.left,r.right))return this._freeEdge(r.left),null;return t.linkEdge(r.right,r.left)?r.left:(e.unlinkEdge(r.left,r.right),this._freeEdge(r.right),null)},Dt.prototype.findFreeInEdge=function(e,t){const o=e.pair,n=t;if(n!==o){let e=o;do{if(e.isBoundary())return e;e=e.next.pair}while(e!==n)}return console.log("WingedTopology.addFace.findFreeInEdge: patch re-linking failed"),null},Dt.prototype.spliceAdjacent=function(e,t){if(e.next===t)return!0;const o=e.next,n=t.prev(),r=this.findFreeInEdge(t,e);if(null===r)return console.log("WingedTopology.spliceAjacent: no free inedge, bad ajacency"),!1;if(r===n)e.next=t,n.next=o;else{const i=r.next;e.next=t,r.next=o,n.next=i}return!0},Dt.prototype._unwindNewEdges=function(e){for(let t of e){let e=t.pair;t.origin.unlinkEdge(t,e),e.origin.unlinkEdge(e,t),this._freeEdge(t)}},Dt.prototype.addPolygon=function(e,t){return this._addPolygon(0,e.length,e,t)},Dt.prototype._addPolygon=function(e,t,o,n){const r=t-e;if(r<3)return console.log("Bad polygon: less than 3 edges"),-1;let i=null,s=null;var a=e,l=[],c=[];const d=new Set;for(let n=e;n<t;++n){(a=n+1)===t&&(a=e,s=l[0]);var u=this.alloc.getVertices(o[n]),h=this.alloc.getVertices(o[a]),f=this.findHalfEdge(u,h);if(null===f){if(null===(f=this.addEdge(u,h,i,s)))return this._unwindNewEdges(c),null;c.push(f),d.add(f.wingedEdge)}else{if(!f.isBoundary())return this._unwindNewEdges(c),console.log("non-manifold condition, no boundary"),null;if(d.has(f.wingedEdge))return this._unwindNewEdges(c),console.log("complex polygon detected"),null;d.add(f.wingedEdge)}i=f,l.push(f)}for(let e=0;e<r;++e)if((a=e+1)===r&&(a=0),!this.spliceAdjacent(l[e],l[a]))return this._unwindNewEdges(c),console.log("non-manifold condition, cannot splice"),null;var p=this._createPolygon(l[0],r,n);for(let e=0;e<r;++e)l[e].face=p;return p},Dt.prototype.findHalfEdge=function(e,t){return e.findOutEdge((function(e,o){return e.destination()===t}))},Dt.prototype.insertEdge=function(e,t,o,n){const r=e.destination(),i=t.origin,s=e.face,a=this._createEdge(r,i,o),l=a.pair,c=e.next,d=t.prev();e.next=a,a.next=t,d.next=l,l.next=c;let u=null;if(null!==n){u=this._createPolygon(a,4,Tt.default,n);let e=0;u.eachEdge((function(t){++e,t.face=u})),u.numberOfVertex=e}if(a.face=u,l.face=s,s){s.halfEdge.face===u&&(s.halfEdge=l);let e=0;s.eachEdge((function(t){++e})),s.numberOfVertex=e,this.addAffectedFace(s)}return a},Dt.prototype.splitEdge=function(e,t,o){const n=e.pair,r=e.prev(),i=n.next,s=e.origin,a=this.addVertex(t),l=this._createEdge(s,a,o),c=l.pair;return l.next=e,n.next=c,r.next=l,c.next=i,l.face=e.face,l.face.numberOfVertex++,this.addAffectedFace(l.face),c.face=n.face,c.face.numberOfVertex++,this.addAffectedFace(c.face),e.origin=a,a.outEdge=c,s.outEdge===e&&(s.outEdge=l),l},Dt.prototype.doubleEdge=function(e){const t=e.prev(),o=this._createEdge(e.destination(),e.origin),n=o.pair;o.next=e,n.next=e.next,e.next=o,t.next=n,n.face=e.face,e.face.halfEdge===e&&(n.face.halfEdge=n),this.addAffectedFace(n.face),this.addAffectedFace(e.pair.face);const r=this._createPolygon(o,2,Tt.default);return o.face=r,e.face=r,o},Dt.prototype.simpleSplit=function(e){const t=this._createEdge(e.destination(),e.next.origin);return t.next=e.next,e.next=t,t.face=e.face,t.face.numberOfVertex++,this.addAffectedFace(e.face),this.addAffectedFace(e.pair.face),t},Dt.prototype.prepVertex=function(e,t,o,n,r,i){i||(i=t.origin);const s=n.get(i);let a,l=e,c=!0;do{a=l.next,a.origin=i,l=a.pair,c&&(s.push(l),o.has(a.wingedEdge)||(c=!1,s.length=0,s.push(l)))}while(a!==t);if(r)for(let e of s)r.add(e)},Dt.prototype.prepVertexAdd=function(e,t,o,n,r){const i=this.addVertex(e.destination());return n.set(i,[]),this.prepVertex(e,t,o,n,r,i),i},Dt.prototype.isSplitEdgeSelected=function(e,t,o){for(let n of[e,t]){let e=0,t=0;for(let r of n.edgeRing())e++,o.has(r.wingedEdge)&&t++;if(3!==e)return!1;if(2!==t)return!1}return!0},Dt.prototype.bevelEdge=function(e){const t={vertices:[],halfEdges:[],collapsibleWings:new Set,selectedFaces:new Set},o=new Set,n=new Map,r=new Map,i=new Set,s=new Set;for(let n of e){const e=this.doubleEdge(n.left);t.selectedFaces.add(e.face),o.add(e.origin),o.add(e.destination()),r.set(n,e.wingedEdge),r.set(e.wingedEdge,n),t.collapsibleWings.add(e.wingedEdge)}for(let e of o){t.vertices.push(e),n.set(e,[]);let o=[];const a=e.outEdge;let l,c,d,u=a;do{let e=u.pair.next;r.has(u.wingedEdge)?r.get(u.wingedEdge)===e.wingedEdge&&o.push(u.pair):r.has(e.wingedEdge)||o.push(u.pair),u=e}while(u!==a);for(let e of o){if(l){const o=this.prepVertexAdd(l,e.pair,r,n,i);let s=this.simpleSplit(l);o.outEdge=s.pair,t.vertices.push(o),t.halfEdges.push(s.pair),c?s.pair.next=c.pair:d=s,c=s}l=e}if(1===o.length){const o=l.next.pair.next,i=this.doubleEdge(o.pair);r.set(o.wingedEdge,i.wingedEdge),r.set(i.wingedEdge,o.wingedEdge),t.selectedFaces.add(i.face);const s=this.prepVertexAdd(l,o,r,n),a=this.simpleSplit(l);s.outEdge=a.pair,t.vertices.push(s),t.halfEdges.push(a.pair);const c=a.pair;c.next=i,o.pair.next=c,c.face=i.face,c.face.numberOfVertex++;let d=n.get(e);d.push(i.pair),d.push(l.pair.next.pair),d=n.get(s),d[0]=d[0].prev()}else if(2===o.length){let e=o[0].next.pair;e.next=l.next,l.next=e,e.face=l.face,e.face.numberOfVertex++,this.addAffectedFace(e.face);const t=n.get(e.next.origin);if(this.isSplitEdgeSelected(e.next.origin,e.origin,r)){const o=e.next.pair;let r=o.prev();t.push(r),i.add(r);let a=o.next.next.pair;t.push(a),i.add(a);const l=n.get(e.origin);r=l[0].prev(),l[0]=r,i.add(r),a=l[1].pair.next.pair,l[1]=a,i.add(a),s.add(e.origin).add(e.destination())}else{const o=[];do{e=e.next.pair,o.push(e)}while(r.has(e.wingedEdge));if(e!==l.next)t.push(e),i.add(e);else{o.pop();for(let e of o)t.push(e),i.add(e)}}}else{this.prepVertex(l,o[0].pair,r,n,i);const e=this.simpleSplit(l);t.halfEdges.push(e.pair),e.pair.next=c.pair,d.pair.next=e.pair;const s=this._createPolygon(e.pair,o.length,Tt.default);s._assignFace(),t.selectedFaces.add(s)}}t.vertexLimit=Number.MAX_SAFE_INTEGER,t.position=new Float32Array(3*t.vertices.length),t.direction=new Float32Array(3*t.vertices.length);const a=new rt(t.position),l=new rt(t.direction),c=[0,0,0];for(let e of t.vertices){const o=n.get(e);let r=1;s.has(e)&&(r=.4);for(let n of o){Lt.copy(c,n.origin),Lt.copy(a,e),Lt.sub(c,c,a);let o=r;i.has(n.pair)&&(o=.5),t.vertexLimit=Math.min(Lt.length(c)*o,t.vertexLimit),Lt.normalize(c,c),Lt.add(l,l,c)}.4==r&&Lt.normalize(l,l),a.inc(),l.inc()}return t},Dt.prototype._simpleStitch=function(e,t,o,n){const r=n.origin,i=e.next;let s=t;do{s.origin=r,s=s.pair.next}while(s!==i);o.next=t,e.next=n},Dt.prototype.stitchVertex=function(e,t){const o=e[0].destination();1093===o.index&&console.log("impossible");const n={stitch:[]};let r=!1;for(let o=e.length-1;o>=0;--o){let n=e[o],i=n.next,s=-1,a=-1;for(let l=0;l<t.length;++l){const c=t[l],d=c.next;if(n!==d&&c!==i){if(s<0){Rt.isOverlap(i.destination(),c.origin)>0&&(s=l)}if(Rt.isOverlap(n.origin,d.destination())>0){this._simpleStitch(n,i,c,d),r=!0,a=l,e.splice(o,1);break}}}if(a>=0&&s<0)for(let e=0;e<t.length;++e){const o=t[e];if(n!==o.next&&o!==i&&Rt.isOverlap(i.destination(),o.origin)>0){s=e;break}}if(s>=0&&s!==a){const e=t[s],o=e.next;a>=0?(n=t[a],i=n.next,t.splice(s,1)):t[s]=n,this._simpleStitch(n,i,e,o),r=!0}}return n.count=0,r?(n.vertex=o,e.length>0?o.outEdge=e[0]:this._freeVertex(o),n):null},Dt.prototype.bevelVertex=function(e){const t={vertices:[],halfEdges:[],selectedFaces:[]},o=new Set;for(let n of e){let e,r=n.outEdge,i=r.pair.next,s=0;for(t.vertices.push(n),o.add(i);i!==n.outEdge;){const n=this.addVertex(i.origin);t.vertices.push(n),i.origin=n,n.outEdge=i,o.add(i);const a=i.pair.next;let l=this.simpleSplit(r.pair);t.halfEdges.push(l.pair),++s,e&&(l.pair.next=e.pair),e=l,r=i,i=a}if(s>1){let o=this.simpleSplit(r.pair);t.halfEdges.push(o),o.pair.next=e.pair;const i=n.outEdge.pair.next;i.pair.next=o.pair;const a=this._createPolygon(i.pair,s+1,Tt.default);a._assignFace(),t.selectedFaces.push(a)}else console.log("weird 2 edge vertex, to be done later")}t.vertexLimit=Number.MAX_SAFE_INTEGER,t.position=new Float32Array(3*t.vertices.length),t.direction=new Float32Array(3*t.vertices.length);const n=new rt(t.position),r=new rt(t.direction);for(let e of t.vertices)Lt.copy(n,e),Lt.sub(r,e.outEdge.destination(),n),o.has(e.outEdge.pair)?t.vertexLimit=Math.min(.5*Lt.length(r),t.vertexLimit):t.vertexLimit=Math.min(Lt.length(r),t.vertexLimit),Lt.normalize(r,r),n.inc(),r.inc();return t},Dt.prototype.liftAndExtrudeContours=function(e){let t=[];for(let o of e){this.liftContour(o);for(let e of o){let o=[];o.push(e.inner.origin.index),o.push(e.outer.origin.index),o.push(e.outer.destination().index),o.push(e.inner.destination().index),this.addPolygon(o,e.inner.face.material);const n=this.findHalfEdge(e.inner.origin,e.outer.origin);t.push(n)}}return t},Dt.prototype.findEdgeGroup=function(e){const t=new Set(e);let o=null;function n(e){t.delete(e),o.add(e);for(let o of e.oneRing())t.has(o)&&n(o)}let r=[];for(let e of t)o=new Set,n(e),r.push(o);return r},Dt.findFaceGroup=function(e){const t=new Set(e);let o=null;function n(e){t.delete(e),o.add(e);for(let o of e.eachVertex())for(let e of o.eachOutEdge()){const o=e.pair.face;t.has(o)&&n(o)}}let r=[];for(let e of t)o=new Set,n(e),r.push(o);return r},Dt.findContours=function(e){const t=new Set,o=[];for(let n of e)n.eachEdge((function(n){if(!t.has(n)&&!e.has(n.pair.face)){const r=[];let i=n;do{let o=i.next.pair;for(;o!==i&&e.has(o.face);)o=o.next.pair;const n={outer:i,inner:null};r.push(n),t.add(i),i=o.pair}while(i!==n);o.push(r)}}));return o},Dt.prototype.weldContour=function(e){let t=e[e.length-1];for(let o=0;o<e.length;++o){const n=e[o];if(t.inner.next!==n.inner){const e=n.inner;let o,r=t.inner.next;t.outer.next=r;do{r.origin=n.outer.origin,o=r.pair,r=o.next}while(r!==e);o.next=n.outer,n.outer.origin.reorient()}n.outer.face=n.inner.face,this.addAffectedFace(n.outer.face),n.inner.face.halfEdge===n.inner&&(n.outer.face.halfEdge=n.outer),t=n}for(let t of e)t.restore={origin:t.inner.origin,pt:Lt.clone(t.inner.origin),hEdge:t.inner},this._freeVertex(t.inner.origin),this._freeEdge(t.inner)},Dt.prototype._liftLoop=function(e){let t=e[e.length-1];for(let o=0;o<e.length;++o){let n=e[o],r=t.outer.next;if(r!==n.outer){let e=n.outer.prev();t.outer.next=n.outer,t.inner.next=r,e.next=n.inner;let o=r;do{o.origin.outEdge===o&&(o.origin.outEdge=n.outer),this.addAffectedVertex(o.origin),o.origin=n.inner.origin,o=o.pair.next}while(o!==n.inner)}t=n,n.inner.face=n.outer.face,n.outer.face=null,n.inner.face.halfEdge===n.outer&&(n.inner.face.halfEdge=n.inner),this.addAffectedFace(n.inner.face)}return e},Dt.prototype.liftContour=function(e){if(0===e.length)return e;let t=this.addVertex(e[0].outer.origin),o=t;for(let n=0;n<e.length;++n){let r,i=e[n].outer;r=n==e.length-1?t:this.addVertex(i.destination()),e[n].inner=this.addEdge(o,r),o=r}return this._liftLoop(e)},Dt.prototype.restoreContour=function(e){if(0===e.length)return e;for(let t of e)this.addVertex(t.restore.pt,t.restore.origin);let t;for(let o=0;o<e.length;++o){const n=e[o],r=e[(o+1)%e.length],i=this._createEdge(n.restore.origin,r.restore.origin,n.restore.hEdge);n.restore.origin.outEdge=i,t&&(t.next=i,i.pair.next=t.pair),t=i}return t.next=e[0].inner,e[0].inner.pair.next=t.pair,this._liftLoop(e)},Dt.prototype._liftEdge=function(e,t,o,n){const r=e.prev(),i=t.next,s=this._createEdge(o,e.origin,n),a=s.pair;t.next=s,s.next=i,a.next=e,r.next=a,o.outEdge=s;let l=e;do{l.origin.outEdge===l&&(l.origin.outEdge=i),l.origin=o,l=l.pair.next}while(l!==s);s.face=t.face,s.face&&s.face.numberOfVertex++,a.face=e.face,a.face&&a.face.numberOfVertex++,this.addAffectedVertexFace(o)},Dt.prototype._collapseEdge=function(e){const t=e.next,o=e.prev(),n=e.pair,r=n.next,i=n.prev(),s=e.origin,a=n.origin;this.addAffectedVertex(a),this.addAffectedVertexFace(s);let l=r;for(;l!==e;)l.origin.outEdge===l&&(l.origin.outEdge=l.pair.next),l.origin=a,l=l.pair.next;o.next=t,i.next=r;let c=e.face;c&&(c.halfEdge===e&&(c.halfEdge=t),c.numberOfVertex--),c=n.face,c&&(c.halfEdge===n&&(c.halfEdge=r),c.numberOfVertex--),a.outEdge===n&&(a.outEdge=t),this._freeEdge(e);const d=[s[0],s[1],s[2]];return this._freeVertex(s),{hEdge:e,pairNext:r,prev:o,vertex:s,pt:d}},Dt.prototype._restoreLoop=function(e,t,o){const n=e.prev(),r=this._createEdge(e.destination(),e.origin,t),i=r.pair;n.next=i,i.next=e.next,e.next=r,r.next=e,i.face=e.face;let s=null;null!==o&&(s=this._createPolygon(r,2,Tt.default,o)),e.face=s,r.face=s,i.face&&i.face.halfEdge===e&&(i.face.halfEdge=i)},Dt.prototype._collapseLoop=function(e,t){t&&!t.has(e.wingedEdge)&&(e=e.next);const o=e.next,n=e.pair,r=n.prev(),i=o.pair;o.next=n.next,r.next=o;let s=n.face;o.face=s,e.origin.outEdge===e&&(e.origin.outEdge=i),this.addAffectedVertex(e.origin),n.origin.outEdge===n&&(n.origin.outEdge=o),this.addAffectedVertex(n.origin),this.addAffectedFace(n.face),s&&s.halfEdge===n&&(s.halfEdge=o);const a=this._freePolygon(e.face);return this._freeEdge(e),{next:o,hEdge:e,polygon:a}},Dt.prototype._restoreDangling=function(e){const t=this.addVertex(e.destination.pt,e.destination.vertex);let o;if(e.origin){const n=this.addVertex(e.origin.pt,e.origin.vertex);o=this._createEdge(n,t,e.hEdge),n.outEdge=o}else o=this._createEdge(e.next.origin,t,e.hEdge),e.prev.next=o,o.pair.next=e.next;t.outEdge=o.pair,o.face=e.face,o.pair.face=e.pairFace},Dt.prototype._collapseDangling=function(e){const t={},o=e.pair,n=o.origin;if(t.destination={vertex:n,pt:[n[0],n[1],n[2]]},this._freeVertex(o.origin),t.face=e.face,t.pairFace=e.pair.face,o.next===e)t.origin={vertex:e.origin,pt:[e.origin[0],e.origin[1],e.origin[2]]},this._freeVertex(e.origin);else{let n=e.face;!n||n.outEdge!==e&&n.outEdge!==o||(n.outEdge=o.next),e.origin.outEdge===e&&(e.origin.outEdge=o.next);const r=e.prev();t.prev=r,r.next=o.next,t.next=o.next}return t.hEdge=e,this._freeEdge(e),t},Dt.prototype.collapseEdge=function(e,t){let o=e.next;let n=e.pair.next;const r=this._collapseEdge(e);return o.next.next===o&&(!o.pair.face&&o.next.pair.face&&(o=o.next),r.leftLoop=this._collapseLoop(o.next,t),o.isLive()&&(o.next===o.pair?r.leftDangling=this._collapseDangling(o):o.pair.next===o&&(r.leftDangling=this._collapseDangling(o.pair)))),n.wingedEdge.isLive()&&n.next.next===n&&(n.face&&!n.next.pair.face&&(n=n.next),r.rightLoop=this._collapseLoop(n,t),n.isLive()&&(n.next===n.pair?r.rightDangling=this._collapseDangling(n):n.pair.next===n&&(r.rightDangling=this._collapseDangling(n.pair)))),r},Dt.prototype.restoreCollapseEdge=function(e){e.rightLoop&&(e.rightDangling&&this._restoreDangling(e.rightDangling),this._restoreLoop(e.rightLoop.next,e.rightLoop.hEdge,e.rightLoop.polygon)),e.leftLoop&&(e.leftDangling&&this._restoreDangling(e.leftDangling),this._restoreLoop(e.leftLoop.next,e.leftLoop.hEdge,e.leftLoop.polygon)),this._liftEdge(e.pairNext,e.prev,this.addVertex(e.pt,e.vertex),e.hEdge)},Dt.prototype._removeEdge=function(e,t){const o=e.prev(),n=e.next,r=t.prev(),i=t.next;return o.next=i,r.next=e.next,e.origin.outEdge===e&&(e.origin.outEdge=o.pair,this.addAffectedVertex(e.origin)),t.origin.outEdge===t&&(t.origin.outEdge=r.pair,this.addAffectedVertex(t.origin)),{outPrev:o,outNext:n,outEdge:e}},Dt.prototype.removeEdge=function(e){let t=e.pair;if(null===t.face&&null!==e.face&&(t=e,e=t,null===t.face))throw"error, both side of the edges are null faces";const o=this._removeEdge(e,t);o.delFace=e.face;const n=t.face;if(null!==n){n.halfEdge===t&&(n.halfEdge=o.outPrev),n.numberOfVertex=0;for(let e of n.hEdges())++n.numberOfVertex,e.face=n;this.addAffectedFace(n)}return null!==o.delFace&&(o.delFace=this._freePolygon(o.delFace)),this._freeEdge(e),o},Dt.prototype.restoreRemoveEdge=function(e){this.insertEdge(e.outPrev,e.outNext,e.outEdge,e.delFace)},Dt.prototype.dissolveEdge=function(e,t){const o=e.pair;return e.next.pair.next===o?this.collapseEdge(o,t):o.next.pair.next===e?this.collapseEdge(e,t):this.removeEdge(e)},Dt.prototype.restoreDissolveEdge=function(e){e.outPrev?this.restoreRemoveEdge(e):this.restoreCollapseEdge(e)},Dt.prototype.connectVertex=function(e){const t=new Map;for(let o of e)for(let e of o.eachOutEdge()){let o=1;t.has(e.face)&&(o=t.get(e.face)+1),t.set(e.face,o)}const o=[];let n=[];for(let[r,i]of t)if(i>1){let t=-1,i=-1,s=r.halfEdge;for(;2==s.origin.valence;)s=s.next;const a=s;do{let o=s.origin.valence;if(t=i,2!=o&&i++,e.has(s.origin)){const e={prevEdgeNumber:t,edgeNumber:i,outEdge:s};n.push(e)}s=s.next}while(s!==a);const l=n[0];-1==l.prevEdgeNumber&&(l.prevEdgeNumber=i),o.push(n),n=[]}const r=[];for(let e of o){let t=!0,o=-1;for(let[n,r]of e.entries()){if(r.prevEdgeNumber!==r.edgeNumber||o==r.edgeNumber){t=!1;break}o=r.edgeNumber}if(t)if(2===e.length)r.push(this.insertEdge(e[0].outEdge.prev(),e[1].outEdge));else{const t=e[0].outEdge.prev();for(let o=0;o<e.length;++o){let n,i,s=e[o];o+1<e.length?(n=e[o+1],i=this.insertEdge(s.outEdge.prev(),n.outEdge)):i=this.insertEdge(s.outEdge.prev(),t.next),r.push(i)}}else{let t=e.length-1,o=0;do{let n=e[t],i=e[o];if(n.edgeNumber!=i.prevEdgeNumber){const e=this.insertEdge(n.outEdge.prev(),i.outEdge);r.push(e),t--}o++}while(o<t)}}return r},Dt.prototype.removePolygon=function(e){for(let t of e.hEdges())t.face=null;return this._freePolygon(e)},Dt.prototype.dissolveVertex=function(e){const t=[0,0,0];if(Lt.copy(t,e),e.isIsolated())return this._freeVertex(e),{pt:t,vertex:e};{this.addAffectedVertexFace(e);let o=0;const n=e.outEdge.pair;let r,i;for(let t of e.eachInEdge()){this.addAffectedVertex(t.origin);const e=t.next;i=t.pair,e.face.halfEdge===e&&(e.face.halfEdge=t),--e.face.numberOfVertex,t.next=e.next,e.next=i,i.origin=e.pair.origin,o++,r=t}const s=this._createPolygon(i,o,Tt.default),a=[];let l=e.outEdge;i=e.outEdge;do{let e=i.pair;this.addAffectedVertex(e.origin),i=i.next,e.next.next===e?(e.pair===l&&(l=e.next),a.unshift(this._collapseLoop(e))):e.pair.face=s}while(i!==l);return this._freeVertex(e),{polygon:s,pt:t,vertex:e,undoCollapseLoop:a,lastIn:r,firstIn:n}}},Dt.prototype.restoreDissolveVertex=function(e){if(e.polygon){const t=this.addVertex(e.pt,e.vertex);for(let t of e.undoCollapseLoop)this._restoreLoop(t.next,t.hEdge,t.polygon);let o=e.lastIn,n=e.lastIn.next.pair,r=e.firstIn;do{let e=o.pair;e.origin.outEdge===e&&(e.origin.outEdge=o.next),this.addAffectedVertex(e.origin),e.origin=t;let n=r.pair;n.next=o.next,o.next=n,n.face=o.face,++n.face.numberOfVertex,r=o,o=e.next.pair}while(o!==n);t.outEdge=e.firstIn.pair,this._freePolygon(e.polygon),this.addAffectedVertexFace(t)}else this.addVertex(e.pt,e.vertex);return e.vertex},Dt.prototype.bridgeFace=function(e,t){const o={target:{face:e,hEdge:e.halfEdge},source:{face:t,hEdge:t.halfEdge}},n=[],r=[];for(let t of e.hEdges())n.push(t),t.face=null;for(let e of t.hEdges())r.unshift(e),e.face=null;let i=-1,s=Number.MAX_SAFE_INTEGER;const a=Lt.create();for(let e=0;e<t.numberOfVertex;++e){let t=0;for(let o=0;o<n.length;++o)Lt.sub(a,n[o].origin,r[(e+o)%n.length].origin),t+=Lt.length(a);t<s&&(s=t,i=e)}r.unshift.apply(r,r.splice(i,r.length)),o.target.face=this._freePolygon(e),o.source.face=this._freePolygon(t);let l=null;const c=[];for(let e=0;e<n.length;++e){const t=this.addEdge(r[e].origin,n[e].origin);l&&this._createPolygon(l,4,Tt.default)._assignFace(),c.push(t),l=t}return this._createPolygon(l,4,Tt.default)._assignFace(),o.hEdges=c,o},Dt.prototype.undoBridgeFace=function(e){for(let t of e.hEdges)this.removePolygon(t.face);for(let t of e.hEdges)this._removeEdge(t,t.pair),this._freeEdge(t);this._createPolygon(e.target.hEdge,e.hEdges.length,Tt.default,e.target.face)._assignFace(),this._createPolygon(e.source.hEdge,e.hEdges.length,Tt.default,e.source.face)._assignFace()},Dt.findInsetContours=function(e){const t=[];for(let o of e){const e=[];for(let t of o.hEdges()){const o={outer:t,inner:null};e.push(o)}t.push(e)}return t},Dt.prototype._liftDanglingEdge=function(e,t){const o=e.next,n=this._createEdge(o.origin,t);return t.outEdge=n.pair,e.next=n,n.pair.next=o,n.face=n.pair.face=e.face,this.addAffectedFace(n.face),n},Dt.prototype.liftCornerEdge=function(e,t=.2){const o=Lt.create(),n=Lt.create();let r=e.next;Lt.lerp(o,r.origin,r.destination(),t),Lt.sub(n,e.origin,e.destination()),Lt.scale(n,n,t),Lt.add(o,o,n);let i=this.addVertex(o);return this._liftDanglingEdge(e,i)},Dt.prototype.extrudeEdge=function(e,t){const o=[],n=[];let r=e,i=e.next,s=i.next;for(;s!==t;){let e=this.liftCornerEdge(i);o.push(e.pair);let t=this.insertEdge(e,r);n.push(t),r=e.pair,i=s,s=s.next}let a=this.insertEdge(s,r);return n.push(a),{extrude:n,lift:o}},Dt.prototype.slideToPrev=function(e,t){t||(t=e.prev().prev());const o=t.next,n=e.pair;if(e.face.numberOfVertex<=3){const t={inEdge:e,delFace:e.face,inNext:e.next,inPrev:e.prev()};return this.this.removeEdge(e),t}return o.next=n.next,n.next=o,t.next=e,e.origin.outEdge===e&&(e.origin.outEdge=o.next),e.origin=o.origin,o.face.halfEdge===o&&(o.face.halfEdge=n),o.face=n.face,++n.face.numberOfVertex,--e.face.numberOfVertex,{inEdge:n}},Dt.prototype.slideToNext=function(e){if(e.face.numberOfVertex<=3){const t={inEdge:e,delFace:e.face,inNext:e.next,inPrev:e.prev()};return this.removeEdge(e),t}const t=e.pair,o=e.next,n=t.prev();return n.next=o,e.next=o.next,o.next=t,t.origin.outEdge===t&&(t.origin.outEdge=o),t.origin=e.next.origin,o.face.halfEdge===o&&(o.face.halfEdge=e),e.face=o.face,o.face=t.face,++t.face.numberOfVertex,--e.face.numberOfVertex,this.addAffectedFace(t.face),this.addAffectedFace(e.face),{prevPrev:n,outEdge:t}},Dt.prototype.undoSlideToNext=function(e){e.delFace?this.insertEdge(e.inPrev,e.inNext,e.inEdge,e.delFace):this.slideToPrev(e.outEdge,e.prevPrev)},Dt.prototype.insertFan=function(e,t){const o=Lt.create();e.getCentroid(o);let n=this.addVertex(o);const r=[];let i;for(let o of e.hEdges())t.has(o)&&(void 0!==i?(i=this.insertEdge(o,i.pair),r.unshift(i.pair)):(i=this._liftDanglingEdge(o,n),r.unshift(i)));return r},Dt.prototype.invert=function(){const e=[];for(let t of this.faces){this.addAffectedFace(t);for(let o of t.hEdges())e.push({hEdge:o.next.pair,next:o.pair})}for(let{hEdge:t,next:o}of e)t.next=o;for(let e of this.edges){let t=e.left.face;t.halfEdge===e.left&&(t.halfEdge=e.right),e.left.face=e.right.face,e.left.face.halfEdge===e.right&&(e.left.face.halfEdge=e.left),e.right.face=t}},Dt.prototype.flip=function(e,t){const o=2*e[t];for(let e of this.vertices)e[t]=o-e[t],this.addAffectedVertexFace(e)},Dt.prototype.makeHole=function(e){let t={hEdge:e.halfEdge,face:{polygon:e},dissolveEdges:[]},o=[];for(let t of e.hEdges())o.push(t),t.face=null;for(let e of o)if(e.wingedEdge.isLive()){const o=e.pair;null===o.face&&t.dissolveEdges.unshift(this.dissolveEdge(o))}return e.isLive()&&(t.face=this._freePolygon(e)),t},Dt.prototype.undoHole=function(e){for(let t of e.dissolveEdges)this.restoreDissolveEdge(t);if(e.face.polygon.isLive())return e.face.polygon;{const t=this._createPolygon(e.hEdge,4,e.face.material,e.face);return t._assignFace(),this.addAffectedFace(t),t}};const kt={x:!1,y:!1,z:!1};function zt(e){if(kt.x||kt.y||kt.y){const t=[0,0,0];return kt.x&&(t[0]=e[0]),kt.y&&(t[1]=e[1]),kt.z&&(t[2]=e[2]),t}return e}O(()=>{ne(Q.constraintX.name,(function(e){kt.x=!kt.x;const t=document.querySelector('input[data-menuid="constraintX"');t!==e.target&&(t.checked=kt.x)})),ne(Q.constraintY.name,(function(e){kt.y=!kt.y;const t=document.querySelector('input[data-menuid="constraintY"');t!==e.target&&(t.checked=kt.y)})),ne(Q.constraintZ.name,(function(e){kt.z=!kt.z;const t=document.querySelector('input[data-menuid="constraintZ"');t!==e.target&&(t.checked=kt.z)}))});const{vec3:Ut,quat:jt}=glMatrix;class Ht{constructor(e){if(this.modeString=e,"Multi"===e)return;e=e.toLowerCase();this.contextMenu={menu:document.querySelector("#"+e+"-context-menu")},this.contextMenu.menu&&(this.contextMenu.menuItems=this.contextMenu.menu.querySelectorAll(".context-menu__item"));const t=[[1,0,0],[0,1,0],[0,0,1]],o=["X","Y","Z"];for(let t=0;t<3;++t)ne(e+"Move"+o[t],e=>{this.doMoveAlongAxis(t)});ne({body:Q.bodyMoveFree,face:Q.faceMoveFree,edge:Q.edgeMoveFree,vertex:Q.vertexMoveFree}[e].name,e=>{this.doMoveFree()});const n={face:Q.faceMoveNormal,edge:Q.edgeMoveNormal,vertex:Q.vertexMoveNormal};n[e]&&ne(n[e].name,e=>{this.doMoveAlongNormal(!1)});ne({face:Q.faceScaleUniform,edge:Q.edgeScaleUniform,vertex:Q.vertexScaleUniform,body:Q.bodyScaleUniform}[e].name,e=>{Pi(new to(this,[1,1,1]))});for(let t=0;t<3;++t)ne(e+"Rotate"+o[t],e=>{const o=[0,0,0];o[t]=1,Pi(new oo(this,o))});ne(e+"RotateFree",e=>{Pi(new no(this))});const r={face:Q.faceBevel,edge:Q.edgeBevel,vertex:Q.vertexBevel};r[e]&&ne(r[e].name,e=>{this.doMoveLimit(new so(this,this.bevel,null,this.undoBevel,[this.snapshotSelection()]))});let i={face:[Q.faceExtrudeX,Q.faceExtrudeY,Q.faceExtrudeZ],edge:[Q.edgeExtrudeX,Q.edgeExtrudeY,Q.edgeExtrudeZ],vertex:[Q.vertexExtrudeX,Q.vertexExtrudeY,Q.vertexExtrudeZ]}[e];if(i)for(let e=0;e<3;++e)ne(i[e].name,t=>{this.doMoveAlongAxis(e,new so(this,this.extrude,null,this.undoExtrude,null))});const s={face:Q.faceExtrudeFree,edge:Q.edgeExtrudeFree,vertex:Q.vertexExtrudeFree};s[e]&&ne(s[e].name,e=>{this.doMoveFree(new so(this,this.extrude,null,this.undoExtrude,null))});const a={face:Q.faceExtrudeNormal,edge:Q.edgeExtrudeNormal,vertex:Q.vertexExtrudeNormal};a[e]&&ne(a[e].name,e=>{this.doMoveAlongNormal(!1,new so(this,this.extrude,null,this.undoExtrude,null))});let l={face:[Q.faceFlattenX,Q.faceFlattenY,Q.faceFlattenZ],edge:[Q.edgeFlattenX,Q.edgeFlattenY,Q.edgeFlattenZ],vertex:[Q.vertexFlattenX,Q.vertexFlattenY,Q.vertexFlattenZ]}[e];if(l)for(let e=0;e<3;++e)ne(l[e].name,o=>{const n=new so(this,this.flatten,[t[e]]);n.doIt()&&yi(n)});const c=[[0,1,1],[1,0,1],[1,1,0]],d={face:[Q.faceScaleAxisX,Q.faceScaleAxisY,Q.faceScaleAxisZ],edge:[Q.edgeScaleAxisX,Q.edgeScaleAxisY,Q.edgeScaleAxisZ],vertex:[Q.vertexScaleAxisX,Q.vertexScaleAxisY,Q.vertexScaleAxisZ],body:[Q.bodyScaleAxisX,Q.bodyScaleAxisY,Q.bodyScaleAxisZ]}[e],u={face:[Q.faceScaleRadialX,Q.faceScaleRadialY,Q.faceScaleRadialZ],edge:[Q.edgeScaleRadialX,Q.edgeScaleRadialY,Q.edgeScaleRadialZ],vertex:[Q.vertexScaleRadialX,Q.vertexScaleRadialY,Q.vertexScaleRadialZ],body:[Q.bodyScaleRadialX,Q.bodyScaleRadialY,Q.bodyScaleRadialZ]}[e];for(let e=0;e<3;++e)ne(d[e].name,o=>{Pi(new to(this,t[e]))}),ne(u[e].name,t=>{Pi(new to(this,c[e]))});const h={face:[Q.facePlaneCutX,Q.facePlaneCutY,Q.facePlaneCutZ],body:[Q.bodyPlaneCutX,Q.bodyPlaneCutY,Q.bodyPlaneCutZ]}[e];if(h)for(let e=0;e<3;++e)ne(h[e].name,o=>{Li(new io(this,t[e]))});const f=e=>{const t=e.currentTarget;let o=(n=t.value,[parseInt(n.slice(1,3),16),parseInt(n.slice(3,5),16),parseInt(n.slice(5,7),16)]);var n;const r=new ao((e,t)=>(Number.isInteger(e.colorIndex)?Bt.color.reserve(e.colorIndex):e.colorIndex=Bt.color.reserve(),Bt.color.setValue(e.colorIndex,o),this.setVertexColor(e.colorIndex)),(e,t)=>{this.undoVertexColor(e.snapshots)});r.doIt()&&yi(r),t.removeEventListener("change",f)},p={vertex:Q.vertexColor,face:Q.faceColor,body:Q.bodyColor};p[e]&&ne(p[e].name,e=>{e.currentTarget.addEventListener("change",f)})}doMoveAlongAxis(e,t){const o=new Zt(this,e,t);o.doIt(),Pi(o)}doMoveAlongNormal(e,t){const o=new Jt(this,e,t);o.doIt(),Pi(o)}doMoveBidirection(e){const t=new Kt(this,e);t.doIt(),Pi(t)}doMoveFree(e){const t=new Qt(this,e);t.doIt(),Pi(t)}doMoveLimit(e){const t=new ro(this,e);t.doIt(),Pi(t)}modeName(){return this.modeString}getContextMenu(){return this.hasSelection()?this.contextMenu:null}snapshotSelected(e,...t){const o=[];for(let n of this.selectedCage()){const r=e.call(n,...t);(r||!1===r)&&o.push({preview:n,snapshot:r})}return o}snapshotSelectable(e,...t){const o=[];for(let n of this.selectableCage()){const r=e.call(n,...t);(r||!1===r)&&o.push({preview:n,snapshot:r})}return o}snapshotTarget(e,t,...o){const n=[];for(let r of e){const e=t.call(r,...o);(e||!1===e)&&n.push({preview:r,snapshot:e})}return n}doAll(e,t,...o){if(e)for(let n of e)t.call(n.preview,n.snapshot,...o);else for(let e of this.eachCage())t.call(e,void 0,...o)}resultAll(e,...t){for(let o of this.selectedCage())if(e.call(o,...t))return!0;return!1}*eachCage(){const e=hi();for(let t of e)yield t}*selectableCage(){const e=hi();for(let t of e)!t.isLock()&&t.isVisible()&&(yield t)}*selectedCage(){const e=hi();for(let t of e)!t.isLock()&&t.isVisible()&&t.hasSelection()&&(yield t)}*notSelectedCage(){const e=hi();for(let t of e)t.isLock()||!t.isVisible()||t.hasSelection()||(yield t)}*visibleCage(){const e=hi();for(let t of e)t.isVisible()&&(yield t)}*visibleWireCage(e){const t=hi();for(let o of t)o.isVisible()&&o.isWireMode()===e&&(yield o)}hasSelection(){for(let e of this.selectableCage())if(!e.isLock()&&e.hasSelection())return!0;return!1}updatePosition(e){this.doAll(e,Qo.prototype.updatePosition)}restoreMoveSelection(e){this.doAll(e,Qo.prototype.restoreMoveSelection)}moveSelection(e,t){this.doAll(e,Qo.prototype.moveSelection,t)}restoreSelectionPosition(e){this.doAll(e,Qo.prototype.restoreMoveSelection)}scaleSelection(e,t,o){this.doAll(e,Qo.prototype.scaleSelection,t,o)}scaleAxisSelection(e,t,o){this.doAll(e,Qo.prototype.scaleAxisSelection,t,o)}rotateSelection(e,t,o){this.doAll(e,Qo.prototype.rotateSelection,t,o)}snapshotSelection(){return this.snapshotSelected(Qo.prototype["snapshotSelection"+this.modeName()])}_doSelection(e,t=!1){const o="_select"+this.modeName()+e.name,n=e.params||[],r=[];for(let e of this.eachCage())if(t||e.hasSelection()){const t=e[o](...n);t&&r.push({preview:e,snapshot:t})}return r.length>0&&{undo:this.undoDoSelection,snapshots:r}}tweakMove(e,t,o){const n=this._tweakMode(e,t,o),r=new Qt(this);return r.doIt(),n.setHandler(r),n}tweakMoveNormal(e,t,o){const n=this._tweakMode(e,t,o),r=new new Jt(this,!1);return r.doIt(),n.setHandler(r),n}tweakScale(e,t,o){const n=this._tweakMode(e,t,o);return n.setHandler(new eo(this)),n}tweakScaleUniform(e,t,o){const n=this._tweakMode(e,t,o);return n.setHandler(new to(this,[1,1,1])),n}frustumSelection(e,t){return this._doSelection({name:"Frustum",params:[e,t]},!0)}frustumSelectionWhole(e,t){return this._doSelection({name:"FrustumWhole",params:[e,t]},!0)}similarSelection(){return this._doSelection({name:"Similar"})}adjacentSelection(){return this._doSelection({name:"Adjacent"})}inverseSelection(){return this._doSelection({name:"Inverse"},!0)}allSelection(){return this._doSelection({name:"All"},!0)}lessSelection(){return this._doSelection({name:"Less"})}moreSelection(){return this._doSelection({name:"More"})}resetSelection(){const e=[];for(let t of this.selectedCage()){const o=this._resetSelection(t);e.push({preview:t,snapshot:o})}return e.length>0&&{undo:this.undoDoSelection,snapshots:e}}restoreSelection(e){this.doAll(e,Qo.prototype.restoreSelection,this)}undoDoSelection(e){this.resetSelection(),this.restoreSelection(e)}selectObject(e,t){return t.checked?this.snapshotTarget(e,Qo.prototype["_select"+this.modeName()+"All"]):this.snapshotTarget(e,Qo.prototype["_resetSelect"+this.modeName()])}undoSelectObject(e,t){t.checked&&this.doAll(e,Qo.prototype["_resetSelect"+this.modeName()]),this.doAll(e,Qo.prototype.restoreSelection,this)}toggleObjectLock(e,t){return this.snapshotTarget(e,Qo.prototype.toggleLock,t.checked)}undoToggleObjectLock(e){this.doAll(e,Qo.prototype.toggleLock)}toggleObjectVisibility(e,t){return this.snapshotTarget(e,Qo.prototype.setVisible,!t.checked)}undoObjectVisibility(e){return this.doAll(e,Qo.prototype.setVisible)}toggleObjectWireMode(e,t){return this.snapshotTarget(e,Qo.prototype.toggleWireMode,t)}undoToggleObjectWireMode(e){return this.doAll(e,Qo.prototype.toggleWireMode)}selectMaterialCmd(e){return new so(this,this._selectMaterial,e,this.undoDoSelection)}_selectMaterial(e){return this.snapshotSelectable(Qo.prototype["select"+this.modeName()+"Material"],e)}undoVertexColor(e){this.doAll(e,Qo.prototype.undoVertexColor)}isVertexSelectable(){return!1}isEdgeSelectable(){return!1}isFaceSelectable(){return!1}toggleMulti(e){}polygonShader(e,t){e.useShader(Xe)}edgeShader(e,t){t?e.useShader(qe):e.useShader(Ze)}vertexShader(e,t){return t&&e.useShader(Ge),t}}class Xt{constructor(e,t,o,n){this.madsor=e,this.select=new Map,this.select.set(t,[o]),this.onOff=n}dragSelect(e,t){var o=this.select.get(e);void 0===o&&(o=[],this.select.set(e,o)),this.madsor.dragSelect(e,t,o,this.onOff)}}class qt{constructor(e){this.model=e}setHandler(e){this.moveHandler=e}handleMove(e,t){this.moveHandler.handleMouseMove(e,t,!0)}}class Gt extends Pe{constructor(e){super(),this.input=e}doIt(){this.input.checked=!this.input.checked}undo(){this.input.checked=!this.input.checked}}class Yt extends Pe{constructor(e,t,o){super(),this.snapshots=o,this.redoToggle=e,this.undoToggle=t}doIt(){this.redoToggle()}undo(){this.undoToggle(this.snapshots)}}class $t extends Le{constructor(e,t,o){super(),this.madsor=e,this.snapshots=t,this.movement=o}commit(){this.madsor.updatePosition(this.snapshots)}rescind(){this.madsor.restoreSelectionPosition(this.snapshots)}isDoable(){return this.snapshots.length>0}doIt(){return this.snapshots.length>0&&(this._transformSelection(this.movement),this.madsor.updatePosition(this.snapshots),!0)}undo(){this.madsor.restoreSelectionPosition(this.snapshots),this.madsor.updatePosition(this.snapshots)}handleMouseMove(e,t,o=!1){this._transformSelection(this._processMouse(e,t,o))}handleInput(e,t,o){this._transformSelection(this._processInput(Number(e.target.value),t,o))}getInputSetting(){return[{value:this.movement,name:"D"}]}_processInput(e,t,o){return this._processMove(e-this.movement)}_processMouse(e,t){return this._processMove(t.calibrateMovement(e.movementX))}_transformSelection(e){this.madsor.moveSelection(this.snapshots,e)}}class Wt extends $t{constructor(e,t,o){super(e,null,t),this.cmd=o}snapshotPosition(){return this.cmd&&this.cmd.snapshotPosition?this.cmd.snapshotPosition():this.madsor.snapshotPosition()}doIt(){let e=!0;return this.cmd&&(e=this.cmd.doIt()),this.snapshots=this.snapshotPosition(),e&&super.doIt(),e}undo(){super.undo(),this.cmd&&this.cmd.undo()}}class Zt extends Wt{constructor(e,t,o){super(e,[0,0,0],o),this.axis=t}getInputSetting(){return[{value:this.movement[this.axis],name:"D"}]}_processInput(e,t,o){return this._processMove(e-this.movement[this.axis])}_processMove(e){let t=[0,0,0];return t[this.axis]=e,this.movement[this.axis]+=e,t}}class Kt extends Wt{constructor(e,t){super(e,0,t)}handleMouseMove(e,t){let o=t.calibrateMovement(e.movementX);o>0?this.movement<0&&this.movement+o>=0&&(this.madsor.moveSelection(this.snapshots,-this.movement),o+=this.movement,this.movement=0,this.madsor.doAll(this.snapshots,Qo.prototype.positiveDirection)):this.movement>=0&&this.movement+o<0&&(this.madsor.moveSelection(this.snapshots,-this.movement),o+=this.movement,this.movement=0,this.madsor.doAll(this.snapshots,Qo.prototype.negativeDirection)),this.movement+=o,this.madsor.moveSelection(this.snapshots,o)}}class Jt extends Wt{constructor(e,t,o){super(e,0,o),this.noNegative=t}snapshotPosition(){return this.madsor.snapshotPositionAndNormal()}_processMove(e){return this.movement+=e,this.noNegative&&this.movement<0&&(e-=this.movement,this.movement=0),e}}class Qt extends Wt{constructor(e,t){super(e,[0,0,0],t)}getInputSetting(){return[{value:this.movement[0],name:"Dx"},{value:this.movement[1],name:"Dy"},{value:this.movement[2],name:"Dz"}]}_processInput(e,t,o){let n=this.movement.slice();n[o]=e;let r=[n[0]-this.movement[0],n[1]-this.movement[1],n[2]-this.movement[2]];return this.movement=n,r}_processMouse(e,t,o){let n=t.calibrateMovement(e.movementX),r=t.calibrateMovement(-e.movementY),i=t.inverseCameraVectors(),s=[i.x[0]*n+i.y[0]*r,i.x[1]*n+i.y[1]*r,i.x[2]*n+i.y[2]*r];return o&&(s=zt(s)),Ut.add(this.movement,this.movement,s),s}}class eo extends $t{constructor(e){const t=e.snapshotTransformGroup();super(e,t,1),this.alongX=-1}getInputSetting(){return[{value:100*this.movement,name:"%"}]}_transformSelection(e){this.madsor.scaleAxisSelection(this.snapshots,e,this.axis)}_processInput(e,t,o){const n=t.inverseCameraVectors();return this.movement=Number(e.target.value)/100,0===this.alongX?this.axis=n.y:this.axis=n.x,this.movement}_processMouse(e,t,o){var n=t.inverseCameraVectors();if(this.alongX<0){const t=Math.abs(e.movementX)-Math.abs(e.movementY);t>0?this.alongX=1:t<0&&(this.alongX=0)}return this.alongX>0?(this.movement+=t.scaleMovement(e.movementX),this.axis=n.x):(this.movement+=t.scaleMovement(e.movementY),this.axis=n.y),o&&(this.axis=zt(this.axis)),this.movement}}class to extends $t{constructor(e,t){const o=e.snapshotTransformGroup();super(e,o,1),this.axis=t}getInputSetting(){return[{value:100*this.movement,name:"%"}]}_processInput(e,t,o){return this.movement=e/100,this.movement}_processMouse(e,t){return this.movement+=t.scaleMovement(e.movementX),this.movement}_transformSelection(e){this.madsor.scaleSelection(this.snapshots,e,this.axis)}}class oo extends $t{constructor(e,t,o){super(),this.madsor=e,this.snapshots=e.snapshotTransformGroup(),this.movement=0,this.axisVec3=Ut.clone(t),o&&(this.center=[o[0],o[1],o[2]])}getInputSetting(){return[{value:this.movement,name:"°"}]}handleInput(e,t,o){this.movement=Number(e.target.value),this.doIt()}handleMouseMove(e,t){this.movement+=t.rotateMovement(e.movementX),this.doIt()}doIt(){const e=jt.create();return jt.setAxisAngle(e,this.axisVec3,this.movement),this.madsor.rotateSelection(this.snapshots,e,this.center),!0}undo(){this.madsor.restoreSelectionPosition(this.snapshots)}}class no extends $t{constructor(e,t){super(),this.movement=0,this.madsor=e,this.snapshots=e.snapshotTransformGroup(),this.quatRotate=[0,0,0,1],t&&(this.center=[t[0],t[1],t[2]])}getInputSetting(){return[{value:this.movement,name:"°"}]}handleInput(e,t,o){const n=Number(e.target.value);this._processMove(n-this.movement,t.inverseCameraVectors())}handleMouseMove(e,t){const o=t.rotateMovement(e.movementX);this._processMove(o,t.inverseCameraVectors())}_processMove(e,t){this.movement+=e;const o=[0,0,0,1];jt.setAxisAngle(o,t.z,e),jt.multiply(this.quatRotate,this.quatRotate,o),this.madsor.rotateSelection(this.snapshots,this.quatRotate,this.center)}doIt(){this.madsor.rotateSelection(this.snapshots,this.quatRotate,this.center)}undo(){this.madsor.restoreSelectionPosition(this.snapshots)}}class ro extends Wt{constructor(e,t){super(e,0,t)}doIt(){if(super.doIt()){if(void 0===this.vertexLimit){this.vertexLimit=Number.MAX_SAFE_INTEGER;for(let e of this.snapshots)this.vertexLimit=Math.min(this.vertexLimit,e.snapshot.vertexLimit)}return!0}return!1}_processMove(e){return this.movement+e>this.vertexLimit?e=this.vertexLimit-this.movement:this.movement+e<0&&(e=0-this.movement),this.movement+=e,e}}class io extends Ie{constructor(e,t){super(!0,!0,!0,t),this.madsor=e,this.center=Ut.create()}hilite(e,t){if(e.plane){if(this.plane=xt.fromNormalPoint(this.planeNormal,e.plane.center),this.madsor.planeCuttable(this.plane))return e.plane.hilite=!0,!0;e.plane.hilite=!1,delete this.plane}return!0}select(e){return!!this.plane&&this.doIt()}doIt(){return!!(this.plane&&(this.cut=this.madsor.planeCut(this.plane),this.cut.length>0))&&(Qr(this.cut),this.vertexConnect=ri().connectVertex(),this.vertexConnect.doIt())}undo(){this.vertexConnect&&(this.vertexConnect.undo(),delete this.vertexConnect,this.madsor.undoPlaneCut(this.cut))}}class so extends Pe{constructor(e,t,o,n,r){super(),this.madsor=e,this.doCmd=t,this.doParams=o,this.undoCmd=n,this.undoParams=r}doIt(e){return this.snapshots=this.doCmd.call(this.madsor,...this.doParams?this.doParams:[]),this.snapshots.length>0}undo(e){this.undoCmd?this.undoCmd.call(this.madsor,this.snapshots,...this.undoParams?this.undoParams:[]):this.madsor.restoreSelectionPosition(this.snapshots)}snapshotPosition(){return this.snapshots}}class ao extends Pe{constructor(e,t){super(),this.doCmd=e,this.undoCmd=t}doIt(e){return this.snapshots=this.doCmd(this,e),this.snapshots.length>0}undo(e){this.undoCmd?this.undoCmd(this,e):this.madsor.restoreSelectionPosition(this.snapshots)}}class lo extends Ht{constructor(){super("Vertex");ne(Q.vertexConnect.name,e=>{const t=this.connectVertex();t.doIt()&&yi(t)}),re(Q.vertexDissolve.name,e=>{const t=new so(this,this.dissolve,null,this.undoDissolve,null);t.doIt(),yi(t)},this,"Delete"),re(Q.vertexCollapse.name,e=>{const t=new so(this,this.collapse,null,this.undoCollapse,null);t.doIt(),yi(t)},this,"Backspace"),ne(Q.vertexWeld.name,e=>{let t=[];for(let e of this.selectedCage())1==e.selectionSize()&&t.push(e);if(1==t.length){Li(new fo(this,t[0]))}else geometryStatus("You can only Weld one vertex")})}snapshotPosition(){return this.snapshotSelected(Qo.prototype.snapshotVertexPosition)}snapshotPositionAndNormal(){return this.snapshotSelected(Qo.prototype.snapshotVertexPositionAndNormal)}snapshotTransformGroup(){return this.snapshotSelected(Qo.prototype.snapshotTransformVertexGroup)}bevel(){let e=this.snapshotSelected(Qo.prototype.bevelVertex);return ei(e),e}undoBevel(e,t){this.doAll(e,Qo.prototype.collapseSplitOrBevelEdge),Qr(t)}extrude(){return this.snapshotSelected(Qo.prototype.extrudeVertex)}undoExtrude(e){this.doAll(e,Qo.prototype.undoExtrudeVertex)}andConnectVertex(e){const t=this.connectVertex();t.doIt()?xi([e,t]):e.undo()}connectVertex(){return new so(this,this.connect,null,this.dissolveConnect,null)}connect(){const e=this.snapshotSelected(Qo.prototype.connectVertex);return e.length>0&&ti(e),e}dissolveConnect(e){Qr(),this.doAll(e,Qo.prototype.dissolveConnect)}dissolve(){return this.snapshotSelected(Qo.prototype.dissolveSelectedVertex)}undoDissolve(e){this.doAll(e,Qo.prototype.undoDissolveVertex)}collapse(){const e=this.snapshotSelected(Qo.prototype.dissolveSelectedVertex);return ei(e),e}undoCollapse(e){ri().resetSelection(),Qr(),this.doAll(e,Qo.prototype.undoDissolveVertex)}flatten(e){return this.snapshotSelected(Qo.prototype.flattenVertex,e)}setVertexColor(e){return this.snapshotSelected(Qo.prototype.setVertexColor,e)}dragSelect(e,t,o,n){null!==t.vertex&&e.dragSelectVertex(t.vertex,n)&&o.push(t.vertex)}selectStart(e,t){if(null!==t.vertex){var o=e.selectVertex(t.vertex);return new co(this,e,t.vertex,o)}return null}_tweakMode(e,t,o){return new uo(e,t,o)}isVertexSelectable(){return!0}_resetSelection(e){return e._resetSelectVertex()}_restoreSelection(e,t){e.restoreVertexSelection(t)}toggleFunc(e){var t,o;return e instanceof yo?(t=ei,o=this.snapshotSelected(Qo.prototype.changeFromVertexToFaceSelect)):e instanceof po?(t=ti,o=this.snapshotSelected(Qo.prototype.changeFromVertexToEdgeSelect)):e instanceof _o?(t=oi,o=this.snapshotSelected(Qo.prototype.changeFromVertexToBodySelect)):(t=ni,o=this.snapshotSelected(Qo.prototype.changeFromVertexToMultiSelect)),new Yt(t,Qr,o)}restoreMode(e,t){e instanceof yo?this.doAll(t,Qo.prototype.restoreFromVertexToFaceSelect):e instanceof po?this.doAll(t,Qo.prototype.restoreFromVertexToEdgeSelect):e instanceof _o?this.doAll(t,Qo.prototype.restoreFromVertexToBodySelect):this.doAll(t,Qo.prototype.restoreFromVertexToMultiSelect)}vertexShader(e){return e.useShader(Ge),!0}}class co extends Xt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new ho(this.select)}}class uo extends qt{constructor(e,t,o){let n=e.tweakVertex(t.vertex);super(e),n&&(this.vertex=n)}finish(){return this.vertex&&this.model.selectVertex(this.vertex),this.moveHandler.commit(),this.moveHandler}finishAsSelect(e){this.vertex||this.model.selectVertex(e.vertex);const t=new Map;return t.set(this.model,[e.vertex]),new ho(t)}}class ho extends Pe{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)for(var o=0;o<t.length;++o)e.selectVertex(t[o])}undo(){this.doIt()}}class fo extends Ie{constructor(e,t){super(!0,!1,!1),this.madsor=e,this.preview=t}hilite(e,t){return!(t!==this.preview||!e.vertex)&&!1!==this.preview.weldableVertex(e.vertex)}select(e){const t=e.vertex;return!(!t||(this.collapseHEdge=this.preview.weldableVertex(t),0==this.collapseHEdge))&&this.doIt()}doIt(){return this.restore=this.preview.weldVertex(this.collapseHEdge),!0}undo(){this.preview.undoWeldVertex(this.restore)}}class po extends Ht{constructor(){super("Edge");const e=this;for(let t of[Q.cutLine2,Q.cutLine3,Q.cutLine4,Q.cutLine5,Q.cutLine10]){const o=t.name,n=o.substring("cutLine".length);ne(o,(function(t){const o=new so(e,e.cut,[n],e.undoCut,[e.snapshotSelection()]);o.doIt()&&yi(o)}))}ne(Q.cutAsk.name,(function(t){de("#cutLineDialog",t,(function(t){const o=t.querySelector('input[name="Segments"');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new so(e,e.cut,[t],e.undoCut,[e.snapshotSelection()]);o.doIt()&&yi(o)}}}))})),ne(Q.cutAndConnect.name,e=>{const t=new so(this,this.cut,[2],this.undoCut,[this.snapshotSelection()]);t.doIt();ri().andConnectVertex(t)}),re(Q.edgeDissolve.name,e=>{const t=new so(this,this.dissolve,null,this.reinsertDissolve,null);t.doIt()&&yi(t)},this,"Backspace"),ne(Q.edgeCollapse.name,e=>{const t=new so(this,this.collapse,null,this.undoCollapse,null);t.doIt()&&yi(t)}),ne(Q.edgeCrease.name,e=>{this.doMoveAlongNormal(!1,so(this,this.crease,null,this.undoExtrude,null))});for(let[e,t]of[[Q.edgeLoop1,"l"],[Q.edgeLoop2,void 0],[Q.edgeLoop3,void 0]]){const o=e.name,n=o.substring("edgeLoop".length);ne(o,e=>{const t=new so(this,this.edgeLoop,[n],this.undoLoopOrRing,null);t.doIt()&&yi(t)},t)}ne(Q.edgeLoopN.name,(function(t){de("#cutLineDialog",t,(function(t){const o=t.querySelector('input[name="Segments"]');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new so(e,e.edgeLoop,[t],e.undoLoopOrRing,null);o.doIt()&&yi(o)}}}))}));for(let[e,t]of[[Q.edgeRing1,"g"],[Q.edgeRing2,void 0],[Q.edgeRing3,void 0]]){const o=e.name,n=o.substring("edgeRing".length);ne(o,e=>{const t=new so(this,this.edgeRing,[n],this.undoLoopOrRing,null);t.doIt()&&yi(t)},t)}ne(Q.edgeRingN.name,(function(t){de("#cutLineDialog",t,(function(t){const o=t.querySelector('input[name="Segments"]');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new so(e,e.edgeRing,[t],e.undoLoopOrRing,null);o.doIt()&&yi(o)}}}))})),ne(Q.edgeLoopCut.name,e=>{const t=new so(this,this.loopCut,null,this.undoLoopCut,null);t.doIt()&&yi(t)}),ne(Q.edgeCorner.name,e=>{this.doMoveAlongNormal(!1,new so(this,this.corner,null,this.undoCorner,null))}),ne(Q.edgeSlide.name,e=>{this.doMoveBidirection(new so(this,this.slide))});for(let[e,t]of[[Q.edgeSoft,0],[Q.edgeHard,1],[Q.edgeInvert,2]])ne(e.name,e=>{const o=new so(this,this.hardness,[t],this.undoHardness);o.doIt()&&yi(o)});ne(Q.edgeBoundary.name,e=>{const t=Zr(),o=new so(this,this.edgeBoundary,null,this.undoDoSelection);o.doIt()?yi(t?new Re([t,o]):o):t&&yi(t)}),ne(Q.closeCrack.name,e=>{const t=new so(this,this.closeCrack,null,this.undoCloseCrack);t.doIt()&&yi(t)})}snapshotPosition(){return this.snapshotSelected(Qo.prototype.snapshotEdgePosition)}snapshotPositionAndNormal(){return this.snapshotSelected(Qo.prototype.snapshotEdgePositionAndNormal)}snapshotTransformGroup(){return this.snapshotSelected(Qo.prototype.snapshotTransformEdgeGroup)}loopCut(){const e=this.snapshotSelected(Qo.prototype.loopCut);if(e.length>0){oi();for(let t of e)for(let e of t.snapshot.separateCages)di(e),e.selectBody()}return e}undoLoopCut(e){for(let t of e)for(let e of t.snapshot.separateCages)e.selectBody(),ui(e);ti(),this.doAll(e,Qo.prototype.undoLoopCut)}bevel(){const e=this.snapshotSelected(Qo.prototype.bevelEdge);return ei(e),e}undoBevel(e,t){this.collapseEdge(e),ti(t)}crease(){return this.snapshotSelected(Qo.prototype.creaseEdge)}extrude(){return this.snapshotSelected(Qo.prototype.extrudeEdge)}undoExtrude(e){this.doAll(e,Qo.prototype.undoExtrudeEdge)}cut(e){const t=this.snapshotSelected(Qo.prototype.cutEdge,e);return Qr(t),t}undoCut(e,t){this.collapseEdge(e),ti(t)}closeCrack(){return this.snapshotSelected(Qo.prototype.closeCrack)}undoCloseCrack(e){this.doAll(e,Qo.prototype.undoCloseCrack)}edgeBoundary(){return this.snapshotSelectable(Qo.prototype.selectBoundaryEdge)}edgeLoop(e){return this.snapshotSelected(Qo.prototype.edgeLoop,e)}edgeRing(e){return this.snapshotSelected(Qo.prototype.edgeRing,e)}undoLoopOrRing(e){this.doAll(e,Qo.prototype.undoLoopOrRing)}collapseEdge(e){this.doAll(e,Qo.prototype.collapseSplitOrBevelEdge)}dissolve(){return this.snapshotSelected(Qo.prototype.dissolveSelectedEdge)}reinsertDissolve(e){this.doAll(e,Qo.prototype.reinsertDissolveEdge)}collapse(){const e=this.snapshotSelected(Qo.prototype.collapseSelectedEdge);return e.length>0&&Qr(e),e}undoCollapse(e){ri().resetSelection(),ti(),this.doAll(e,Qo.prototype.restoreCollapseEdge)}corner(){return this.snapshotSelected(Qo.prototype.cornerEdge)}undoCorner(e){this.doAll(e,Qo.prototype.undoCornerEdge)}hardness(e){return this.snapshotSelected(Qo.prototype.hardnessEdge,e)}undoHardness(e,t){this.doAll(e,Qo.prototype.undoHardness,t)}slide(){return this.snapshotSelected(Qo.prototype.slideEdge)}flatten(e){return this.snapshotSelected(Qo.prototype.flattenEdge,e)}dragSelect(e,t,o,n){null!==t.edge&&e.dragSelectEdge(t.edge,n)&&o.push(t.edge)}selectStart(e,t){if(null!==t.edge){var o=e.selectEdge(t.edge);return new go(this,e,t.edge,o)}return null}_tweakMode(e,t,o){return new mo(e,t,o)}isEdgeSelectable(){return!0}_resetSelection(e){return e._resetSelectEdge()}_restoreSelection(e,t){e.restoreEdgeSelection(t)}toggleFunc(e){var t,o;return e instanceof yo?(t=ei,o=this.snapshotSelected(Qo.prototype.changeFromEdgeToFaceSelect)):e instanceof lo?(t=Qr,o=this.snapshotSelected(Qo.prototype.changeFromEdgeToVertexSelect)):e instanceof _o?(t=oi,o=this.snapshotSelected(Qo.prototype.changeFromEdgeToBodySelect)):(t=ni,o=this.snapshotSelected(Qo.prototype.changeFromEdgeToMultiSelect)),new Yt(t,ti,o)}restoreMode(e,t){e instanceof yo?this.doAll(t,Qo.prototype.restoreFromEdgeToFaceSelect):e instanceof lo?this.doAll(t,Qo.prototype.restoreFromEdgeToVertexSelect):e instanceof _o?this.doAll(t,Qo.prototype.restoreFromEdgeToBodySelect):this.doAll(t,Qo.prototype.restoreFromEdgeToMultiSelect)}edgeShader(e){e.useShader(qe)}}class go extends Xt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new vo(this.select)}}class mo extends qt{constructor(e,t,o){let n=e.tweakEdge(t.edge);super(e),n&&(this.edge=n)}finish(){return this.edge&&this.model.selectEdge(this.edge),this.moveHandler.commit(),this.moveHandler}finishAsSelect(e){this.edge||this.model.selectEdge(e.edge);const t=new Map;return t.set(this.model,[e.edge]),new vo(t)}}class vo extends Pe{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)for(var o=0;o<t.length;++o)e.selectEdge(t[o])}undo(){this.doIt()}}const{vec3:xo}=glMatrix;class yo extends Ht{constructor(){super("Face");re(Q.faceDissolve.name,e=>{const t=new so(this,this.dissolve,null,this.undoDissolve,null);t.doIt()?yi(t):geometryStatus("Selected Face not dissolveable")},this,"Backspace"),ne(Q.faceCollapse.name,e=>{const t=new so(this,this.collapse,null,this.undoCollapse,null);t.doIt(),yi(t)}),ne(Q.faceBridge.name,e=>{let t=this.getBridgeFaces();if(2===t.length){const e=t[0],o=t[1];if(e.face.numberOfVertex==o.face.numberOfVertex){let t,n;e.preview!==o.preview?(t=new Co(e,o),t.doIt(),n=new Eo(t.getCombine(),e.face,o.face)):n=new Eo(e.preview,e.face,o.face),n.doIt(),t?xi([t,n]):yi(n)}}}),ne(Q.faceInset.name,e=>{this.hasSelection()?this.doMoveLimit(new so(this,this.inset,[],this.collapseEdgeNew,[])):geometryStatus("No selected face")}),ne(Q.faceBump.name,e=>{this.doMoveAlongNormal(!1,new so(this,this.bump,null,this.undoBump,null))}),ne(Q.faceIntrude.name,e=>{this.doMoveAlongNormal(!0,so(this,this.intrude,null,this.undoIntrude,null))}),ne(Q.faceLift.name,e=>{const t=this.snapshotSelected(Qo.prototype.snapshotTransformFaceGroup);if(1===t.length){const e=t[0];Li(new Ao(this,e.preview))}}),ne(Q.facePutOn.name,e=>{let t=[];for(let e of this.selectedCage())1==e.selectionSize()&&t.push(e);if(1==t.length){Li(new Fo(this,t[0]))}else geometryStatus("You can only PutOn one face")}),ne(Q.faceMirror.name,e=>{const t=new so(this,this.mirror,null,this.undoMirror,null);t.doIt(),yi(t)}),ne(Q.faceFlattenNormal.name,e=>{const t=new so(this,this.flatten);t.doIt()&&yi(t)}),ne(Q.faceExtractNormal.name,e=>{this.doMoveAlongNormal(!1,new so(this,this.extract,null,this.undoExtract,[this.snapshotSelection()]))}),ne(Q.faceExtractFree.name,e=>{this.doMoveFree(new so(this,this.extract,null,this.undoExtract,[this.snapshotSelection()]))});const e=["X","Y","Z"];for(let t=0;t<3;++t)ne("faceExtract"+e[t],e=>{this.doMoveAlongAxis(t,new so(this,this.extract,null,this.undoExtract,[this.snapshotSelection()]))})}snapshotPosition(){return this.snapshotSelected(Qo.prototype.snapshotFacePosition)}snapshotPositionAndNormal(){return this.snapshotSelected(Qo.prototype.snapshotFacePositionAndNormal)}snapshotTransformGroup(){return this.snapshotSelected(Qo.prototype.snapshotTransformFaceGroup)}extract(){const e=[];for(let t of this.selectedCage()){const o=t.extractFace();e.push(o)}for(let t of e)di(t.preview);return e}undoExtract(e,t){for(let t of e)ui(t.preview),t.preview.freeBuffer();this.restoreSelection(t)}bevel(){return this.snapshotSelected(Qo.prototype.bevelFace)}undoBevel(e,t){this.doAll(e,Qo.prototype.collapseSplitOrBevelEdge)}bump(){return this.snapshotSelected(Qo.prototype.bumpFace)}undoBump(e){this.doAll(e,Qo.prototype.undoExtrudeEdge)}extrude(){return this.snapshotSelected(Qo.prototype.extrudeFace)}undoExtrude(e){this.doAll(e,Qo.prototype.collapseExtrudeEdge)}collapseEdgeNew(e){this.doAll(e,Qo.prototype.collapseExtrudeEdge)}dissolve(){return this.snapshotSelected(Qo.prototype.dissolveSelectedFace)}undoDissolve(e){this.doAll(e,Qo.prototype.undoDissolveFace)}collapse(){const e=this.snapshotSelected(Qo.prototype.collapseSelectedFace);return e.length>0&&Qr(e),e}undoCollapse(e){ri().resetSelection(),this.doAll(e,Qo.prototype.undoCollapseFace),ei(e)}intrude(){return this.snapshotSelected(Qo.prototype.intrudeFace)}undoIntrude(e){return this.doAll(e,Qo.prototype.undoIntrudeFace)}getBridgeFaces(){const e=[];for(let t of this.selectedCage()){const o=t.snapshotSelection();for(let n of o)e.push({preview:t,face:n})}return e}inset(){return this.snapshotSelected(Qo.prototype.insetFace)}mirror(){return this.snapshotSelected(Qo.prototype.mirrorFace)}undoMirror(e){return this.doAll(e,Qo.prototype.undoMirrorFace)}flatten(e){return this.snapshotSelected(Qo.prototype.flattenFace,e)}planeCuttable(e){return this.resultAll(Qo.prototype.planeCuttableFace,e)}planeCut(e){return this.snapshotSelected(Qo.prototype.planeCutFace,e)}undoPlaneCut(e){this.doAll(e,Qo.prototype.collapseSplitOrBevelEdge),ei(e)}assignMaterial(e){return this.snapshotSelected(Qo.prototype.assignFaceMaterial,e)}undoAssignMaterial(e){return this.doAll(e,Qo.prototype.undoAssignFaceMaterial)}setVertexColor(e){return this.snapshotSelected(Qo.prototype.setFaceColor,e)}dragSelect(e,t,o,n){null!==t.face&&e.dragSelectFace(t.face,n)&&o.push(t.face)}selectStart(e,t){if(null!==t.face){var o=e.selectFace(t.face);return new bo(this,e,t.face,o)}}_tweakMode(e,t,o){return new So(e,t,o)}isFaceSelectable(){return!0}_resetSelection(e){return e._resetSelectFace()}_restoreSelection(e,t){e.restoreFaceSelection(t)}toggleFunc(e){var t,o;return e instanceof po?(t=ti,o=this.snapshotSelected(Qo.prototype.changeFromFaceToEdgeSelect)):e instanceof lo?(t=Qr,o=this.snapshotSelected(Qo.prototype.changeFromFaceToVertexSelect)):e instanceof _o?(t=oi,o=this.snapshotSelected(Qo.prototype.changeFromFaceToBodySelect)):(t=ni,o=this.snapshotSelected(Qo.prototype.changeFromFaceToMultiSelect)),new Yt(t,ei,o)}restoreMode(e,t){e instanceof po?this.doAll(t,Qo.prototype.restoreFromFaceToEdgeSelect):e instanceof lo?this.doAll(t,Qo.prototype.restoreFromFaceToVertexSelect):e instanceof _o?this.doAll(t,Qo.prototype.restoreFromFaceToBodySelect):this.doAll(t,Qo.prototype.restoreFromFaceToMultiSelect)}}class bo extends Xt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new wo(this.select)}}class So extends qt{constructor(e,t,o){let n=e.tweakFace(t.face);super(e),n&&(this.face=n)}finish(){return this.face&&this.model.selectFace(this.face),this.moveHandler.commit(),this.moveHandler}finishAsSelect(e){this.face||this.model.selectFace(e.face);const t=new Map;return t.set(this.model,[e.face]),new wo(t)}}class wo extends Pe{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)for(var o=0;o<t.length;++o)e.selectFace(t[o])}undo(){this.doIt()}}class Eo extends Pe{constructor(e,t,o){super(),this.cage=e,this.target=t,this.source=o}doIt(){this.bridge=this.cage.bridge(this.target,this.source)}undo(){this.cage.undoBridge(this.bridge),this.cage.restoreFaceSelection(this.bridge)}}class Co extends Pe{constructor(e,t){super(),this.target=e,this.source=t}getCombine(){return this.combine}doIt(){return this.target.preview.selectFace(this.target.face),this.source.preview.selectFace(this.source.face),this.combine?(this.combine.revive(),di(this.combine)):(this.combine=pi([this.target.preview,this.source.preview]),this.combine.name=this.target.preview.name),this.combine.selectFace(this.target.face),this.combine.selectFace(this.source.face),!0}undo(){this.combine.selectFace(this.target.face),this.combine.selectFace(this.source.face),ui(this.combine),this.combine.extinquish(),this.target.preview.revive(),di(this.target.preview),this.target.preview.selectFace(this.target.face),this.source.preview.revive(),di(this.source.preview),this.source.preview.selectFace(this.source.face)}}class Ao extends Ie{constructor(e,t){super(!1,!0,!1),this.madsor=e,this.preview=t,this.contours=this.preview.getSelectedFaceContours()}hilite(e,t){return!(t!==this.preview||!e.edge)&&this.contours.edges.has(e.edge.wingedEdge)}select(e){return!(!e.edge||!this.contours.edges.has(e.edge.wingedEdge))&&(this.axis=xo.create(),xo.sub(this.axis,e.edge.destination(),e.edge.origin),this.hiliteEdge=e.edge,this.lift=this.preview.liftFace(this.contours,e.edge),this.moveHandler=new oo(this.madsor,this.axis,e.edge.origin),!0)}doIt(){return this.lift=this.preview.liftFace(this.contours,this.hiliteEdge),super.doIt(),!0}undo(){super.undo(),this.preview.collapseExtrudeEdge(this.lift)}}class Fo extends Ie{constructor(e,t){super(!0,!0,!0),this.madsor=e,this.preview=t,this.snapshot=t.snapshotPositionAll()}hilite(e,t){return t!==this.preview}select(e,t){return e.vertex?(this.vertex=e.vertex,this.doIt(),!0):e.edge?(this.edge=e.edge,this.doIt(),!0):!!e.face&&(this.face=e.face,this.doIt(),!0)}doIt(){if(this.vertex)this.preview.putOnVertex(this.vertex);else if(this.edge)this.preview.putOnEdge(this.edge);else{if(!this.face)return!1;this.preview.putOnFace(this.face)}return this.preview.updatePosition(this.snapshot),!0}undo(){this.preview.restoreMoveSelection(this.snapshot),this.preview.updatePosition(this.snapshot)}}const{vec3:Mo}=glMatrix;class _o extends Ht{constructor(){super("Body");const e=this;re(Q.bodyDelete.name,(function(t){const o=e.deleteCommand(e.getSelected());yi(o),o.doIt()}),this,"Backspace"),ne(Q.bodyRename.name,(function(t){de("#renameDialog",t,(function(t){const o=ce(t),n=new Io(e.getSelected(),o);yi(n),n.doIt()}),(function(t){le(t,e.getSelected())}))}));const t=[Q.bodyDuplicateMoveX,Q.bodyDuplicateMoveY,Q.bodyDuplicateMoveZ];for(let e=0;e<3;++e)ne(t[e].name,t=>{this.doMoveAlongAxis(e,this.duplicateCommand(this.getSelected()))});ne(Q.bodyDuplicateMoveFree.name,e=>{this.doMoveFree(this.duplicateCommand(this.getSelected()))}),ne(Q.bodyInvert.name,e=>{const t=new Vo(this,this.invert,null,this.invert,null);t.doIt(),yi(t)}),ne(Q.bodyCombine.name,e=>{const t=new Vo(this,this.combine,null,this.undoCombine,null);t.doIt()?yi(t):geometryStatus("No Combine")}),ne(Q.bodySeparate.name,e=>{const t=new Vo(this,this.separate,null,this.undoSeparate,null);t.doIt()?yi(t):geometryStatus("No separation")});const o=[Q.bodyFlipX,Q.bodyFlipY,Q.bodyFlipZ];for(let e=0;e<3;++e)ne(o[e].name,t=>{const o=new Bo(this,e);o.doIt(),yi(o)});const n=[[1,0,0],[0,1,0],[0,0,1]],r=[Q.bodySliceX,Q.bodySliceY,Q.bodySliceZ];for(let e=0;e<3;++e)ne(r[e].name,t=>{de("#sliceBodyDialog",t,t=>{const o=t.querySelector('input[name="amountRange"');if(o){const t=parseInt(o.value,10);if(NaN!=t&&t>0&&t<100){const o=new GenericEditCommand(this,this.slice,[n[e],t],this.undoPlaneCut);if(o.doIt()){ri().andConnectVertex(o)}}}})});ne(Q.bodyWeld.name,e=>{const t=new GenericEditCommand(this,this.weld,void 0,this.undoWeld);t.doIt()&&yi(t)})}getSelected(){const e=[];for(let t of this.selectedCage())e.push(t);return e}snapshotPosition(){return this.snapshotSelected(Qo.prototype.snapshotBodyPosition)}snapshotTransformGroup(){return this.snapshotSelected(Qo.prototype.snapshotTransformBodyGroup)}deleteCommand(e){return new Vo(this,this.delete,[e],this.undoDelete,null)}delete(e){const t=[];for(let o of e)t.push([o,o.parent]),ui(o);return t}undoDelete(e){for(let[t,o]of e)di(t,o)}duplicateCommand(e){return new Vo(this,this.duplicate,[e],this.undoDuplicate,[e])}duplicate(e){const t=[];for(let o of e){let e=Qo.duplicate(o);di(e),e.selectBody(),t.push(e),o.selectBody()}return t}undoDuplicate(e,t){for(let t of e)t.selectBody(),ui(t);for(let e of t)e.selectBody()}combine(e){if(void 0===e){e=[];for(let t of this.selectedCage())e.push(t)}if(e.length>=2){const t=pi(e);return t.name=e[0].name,t.selectBody(),{combine:t,oldSelection:e}}return null}undoCombine(e){if(e){ui(e.combine),e.combine.extinquish();for(let t of e.oldSelection)t.revive(),di(t)}}separate(){const e=[];for(let t of this.selectedCage()){let o=t.separate();o.length>0&&e.push({preview:t,snapshot:o})}for(let t of e){ui(t.preview);for(let e of t.snapshot)di(e)}return e.length>0?e:null}undoSeparate(e){for(let t of e){for(let e of t.snapshot)ui(e),e.extinquish();t.preview.revive(),di(t.preview)}}invert(){for(let e of this.selectedCage())e.invertBody();return fi(),this.hiliteView=null,!0}flipAxis(e,t){return this.doAll(e,Qo.prototype.flipBodyAxis,t),fi(),!0}planeCuttable(e){return this.resultAll(Qo.prototype.planeCuttableFace,e)}planeCut(e){return this.snapshotSelected(Qo.prototype.planeCutBody,e)}undoPlaneCut(e){this.doAll(e,Qo.prototype.collapseSplitOrBevelEdge),oi(e)}slice(e,t){const o=this.snapshotSelected(Qo.prototype.sliceBody,e,t);return Qr(o),o}weld(e=.001){const t={min:Mo.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),max:Mo.fromValues(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE)},o=[];for(let e of this.selectedCage())e.getBodySelection(o,t);let n=function(e){let t,o,n,r=Je.create();return Je.sub(r,e.max,e.min),r[0]>r[1]?r[0]>r[2]&&(t=0,r[1]>r[2]?(o=1,n=2):(o=2,n=1)):(r[1],r[2]),[t,o,n]}(t);o.sort((e,t)=>{for(let o=0;o<3;++o){let r=e.center[n[o]]-t.center[n[o]];if(0!==r)return r}return e.polygon.index-t.polygon.index});const r=Qo.findOverlapFace(n,o,e),i=Qo.findWeldContours(r);if(!1!==i){const e=Qo.weldHole(r),t=[],o=new Map;for(let e of i.combineCages){const n=this.combine(e);o.set(e,n),t.push(n)}const n=Qo.weldBody(o,i);return Qr(t),[{holes:e,weldContours:n,combinedCages:t}]}return[]}undoWeld(e){const t=e[0];oi(),Qo.undoWeldBody(t.weldContours);for(let e of t.combinedCages)this.undoCombine(e);Qo.undoWeldHole(t.holes)}setVertexColor(e){return this.snapshotSelected(Qo.prototype.setBodyColor,e)}centroid(){return this.snapshotSelected(Qo.prototype.bodyCentroid)}dragSelect(e,t,o,n){t.edge}selectStart(e,t){if(null!==t.cage){var o=e.selectBody();return new To(this,e,t.edge,o)}}_tweakMode(e,t,o){return new Po(e,t,o)}selectBody(e){for(let t of e)t.selectBody()}similarSelection(){const e=new Set;for(let t of this.selectedCage()){const o=t._getGeometryMetric();e.add(o)}const t=[];for(let o of this.notSelectedCage()){const n=o._getGeometryMetric();e.has(n)&&(o.selectBody(),t.push(o))}return t.length>0&&{undo:this.selectBody,snapshots:t}}adjacentSelection(){return!1}moreSelection(){return!1}_resetSelection(e){return e._resetSelectBody()}_restoreSelection(e,t){e.restoreBodySelection(t)}toggleFunc(e){var t,o;return e instanceof yo?(t=ei,o=this.snapshotSelected(Qo.prototype.changeFromBodyToFaceSelect)):e instanceof lo?(t=Qr,o=this.snapshotSelected(Qo.prototype.changeFromBodyToVertexSelect)):e instanceof po?(t=ti,o=this.snapshotSelected(Qo.prototype.changeFromBodyToEdgeSelect)):(t=ni,o=this.snapshotSelected(Qo.prototype.changeFromBodyToMultiSelect)),new Yt(t,oi,o)}restoreMode(e,t){e instanceof yo?this.doAll(t,Qo.prototype.restoreFromBodyToFaceSelect):e instanceof lo?this.doAll(t,Qo.prototype.restoreFromBodyToVertexSelect):e instanceof po?this.doAll(t,Qo.prototype.restoreFromBodyToEdgeSelect):this.doAll(t,Qo.prototype.restoreFromBodyToMultiSelect)}}class To extends Xt{constructor(e,t,o,n){super(e,t,o,n)}finish(){return new Lo(this.select)}}class Po extends qt{constructor(e,t,o){let n=e.tweakBody(t.body);super(e),n&&(this.body=n)}finish(){return this.body&&this.model.selectBody(),this.moveHandler.commit(),this.moveHandler}finishAsSelect(e){this.body||this.model.selectBody();const t=new Map;return t.set(this.model,[this.model]),new Lo(t)}}class Lo extends Pe{constructor(e){super(),this.select=e}doIt(){for(var[e,t]of this.select)t.length>0&&e.selectBody()}undo(){this.doIt()}}class Vo extends Pe{constructor(e,t,o,n,r){super(),this.madsor=e,this.doCmd=t,this.doParams=o,this.undoCmd=n,this.undoParams=r}doIt(e){return this.snapshots=this.doCmd.call(this.madsor,...this.doParams?this.doParams:[]),!!this.snapshots}undo(e){this.undoCmd&&this.undoCmd.call(this.madsor,this.snapshots,...this.undoParams?this.undoParams:[])}}class Io extends Pe{constructor(e,t){super(),this.previewCages=e,this.newName=t,this.oldName=new Map}doIt(){for(let e of this.previewCages)this.newName.hasOwnProperty(e.uuid)&&(this.oldName.has(e)||this.oldName.set(e,e.name),e.name=this.newName[e.uuid],geometryStatus("Object new name is "+e.name))}undo(){for(let[e,t]of this.oldName)e.name=t,geometryStatus("Object restore name to "+e.name)}}class Bo extends Pe{constructor(e,t){super(),this.madsor=e,this.axis=t,this.pivot=e.centroid()}doIt(){return this.madsor.flipAxis(this.pivot,this.axis),!0}undo(){this.madsor.flipAxis(this.pivot,this.axis)}}let Ro,Oo,No="US",Do="en";function ko(e,t=""){let o=Oo.msgstr.get(e+t);return!o&&Ro?Ro.msgstr.get(e+t):o}function zo(e,t){let o=ko(t,"-help");if(o){let n=ko(t,"-helpM"),r=ko(t,"-helpR"),i="";n||r?(i+="LMB: "+o,n&&(i+="\nMMB: "+n),r&&(i+="\nRMB: "+r)):i=o,e.setAttribute("title",i)}else e.setAttribute("title","")}function*Uo(e){for(let t in e)yield[t,e[t]]}function jo(e,t,o){ee(`./resources/${e}.json?v=${t}`).then(e=>{!function(e){Oo={msgstr:new Map};for(let[t,o]of Uo(e))Oo[t]=new Map(Uo(o));Ro||(Ro=Oo),qo(document)}(e),o&&o()}).catch(e=>{console.log("Fetch Error :-S",e)})}function Ho(e,t,o,n){No=o||"unknown",Do=e||"unknown",jo(Do,t,n)}function Xo(e,t){let o=ko(e);return o?t?function(e,t){return new Function(`return \`${e}\`;`).call(t)}(o,t):o:`Error: ${e} don't exist`}function qo(e){let t=e.querySelectorAll("[data-i18n]");for(let e of t){let t=!0,o=e.getAttribute("data-i18n"),n=ko(o);n&&(e.textContent=n,t=!1),t&&console.log(`Warning: ${o} has no translation`)}t=e.querySelectorAll("[data-menuid]");for(let e of t){let t=e.getAttribute("data-menuid");zo(e,t)}t=e.querySelectorAll("[data-tooltip]");for(let e of t){let t=e.getAttribute("data-tooltip");zo(e,t)}}function Go(e){let t=e.querySelectorAll("[data-i18n]");for(let e of t){let t=e.getAttribute("data-i18n");t||(t=e.textContent.replace(/ /g,""),t&&(t=t.replace(/^.{1}/g,t[0].toLowerCase()),e.setAttribute("data-i18n",t))),e.hasAttribute("data-tooltip")&&e.setAttribute("data-tooltip",t)}t=e.querySelectorAll('[data-tooltip=""]');for(let e of t){let t=e.getAttribute("data-tooltip");t||(t=e.textContent.replace(/ /g,""),t&&(t=t.replace(/^.{1}/g,t[0].toLowerCase()),e.setAttribute("data-tooltip",t)))}return e}O(()=>{Go(document);let e=document.querySelector("#selectLanguage");if(e){const t=JSON.parse(e.value);Ho(t.lang,t.ver),e.addEventListener("change",(function(t){const o=JSON.parse(e.value);Ho(o.lang,o.ver)}))}else Ho("en");document.body.addEventListener("pointerover",(function(e){const t=e.target.getAttribute("title");if(null!==t){const e=t.replace("\n","    ");help(e)}}))});const{vec3:Yo,quat:$o,mat4:Wo}=glMatrix,Zo=function(){this.group=[],this.parent=null,this.uuid=nt(),this.guiStatus={},this.status={locked:!1,visible:!0,wireMode:!1},this._name=""};function Ko(e,t){return e+t.numberOfCage()}Zo.nameSetters=[],Zo.prototype.checkIntegrity=function(){for(let e of this.group)e.checkIntegrity()},Object.defineProperty(Zo.prototype,"name",{get:function(){return this._name},set:function(e){if(""!==e){this._name=e;for(let t of Zo.nameSetters)t.call(this,e)}}}),Zo.prototype.empty=function(){const e=[];for(const t of this.group)e.push({child:t,restore:t.empty()}),this.remove(t);return e},Zo.prototype.emptyUndo=function(e){for(const{child:t,restore:o}of e)t.emptyUndo(o),this.insert(t)},Zo.prototype.insert=function(e){e.parent&&e.parent.remove(e),this.group.push(e),e.parent=this},Zo.prototype.remove=function(e){if(e.parent===this){const t=this.group.indexOf(e);if(t>=0)return this.group.splice(t,1),e.parent=null,e}throw new Error("remove() integrity error")},Zo.prototype.numberOfCage=function(){return this.group.reduce(Ko,0)},Zo.prototype.getCage=function*(){for(let e of this.group)for(let t of e.getCage())yield t},Zo.prototype.removeFromParent=function(){return this.parent?this.parent.remove(this):null};class Jo{constructor(e){this.preview=e}allocVertex(...e){return this.preview.bench.allocVertex(...e)}allocEdge(...e){return this.preview.bench.allocEdge(...e)}allocPolygon(...e){const t=this.preview.bench.allocPolygon(...e);return this.preview.insertFace(t),t}freeAll(e,t,o){this.preview.bench.freeAll(e,t,o)}freeVertex(e){this.preview.bench.freeVertex(e)}freeHEdge(e){return this.preview.bench.freeHEdge(e)}freePolygon(e){this.preview.removeFace(e),this.preview.bench.freePolygon(e)}getVertices(e){return this.preview.bench.getVertices(e)}updateAffected(){this.preview.bench.updateAffected()}updateAffectedIncipient(){this.preview.bench.updateAffectedIncipient()}addAffectedFace(e){this.preview.bench.addAffectedFace(e)}addAffectedVertex(e){this.preview.bench.addAffectedVertex(e)}addAffectedVertexFace(e){this.preview.bench.addAffectedVertexFace(e)}}const Qo=function(e,t){this.parent=null,this.uuid=nt(),t||(t=new Dt(new Jo(this))),this.geometry=t,this.bench=e,this.guiStatus={},this.status={locked:!1,visible:!0,wireMode:!1},this.selectedSet=new Set,this._name="",this.bvh={root:null,queue:new Set}};Qo.nameSetters=[],Qo.prototype.checkIntegrity=function(){this.geometry.checkIntegrity()},Object.defineProperty(Qo.prototype,"name",{get:function(){return this._name},set:function(e){this._name=e;for(let t of Qo.nameSetters)t.call(this,e)}}),Qo.prototype.empty=function(){return this.geometry.empty()},Qo.prototype.emptyUndo=function(e){this.geometry.emptyUndo(e),this.geometry.updateAffected()},Qo.prototype.numberOfCage=function(){return 1},Qo.prototype.getCage=function*(){yield this},Qo.prototype.removeFromParent=function(){return!!this.parent&&this.parent.remove(this)},Qo.prototype.display=function(e){e?this.isVisible()&&this.geometry.show():this.geometry.hide()},Qo.prototype.freeBuffer=function(){this.bvh.root&&(this.bvh.root.free(),this.bvh.root=null),this.geometry.free()},Qo.prototype.initBVH=function(){const e=this.geometry.faces;let t=[0,0,0],o=[0,0,0];const n=Yo.create(),r=[];for(let i of e)if(r.push(i),Yo.add(n,n,i.center),t)for(let e=0;e<3;++e)t[e]<i.center[e]+i.radius?t[e]=i.center[e]+i.radius:o[e]>i.center[e]-i.radius&&(o[e]=i.center[e]-i.radius);else t=Yo.fromValues(i.center[0]+i.radius,i.center[1]+i.radius,i.center[2]+i.radius),o=Yo.fromValues(i.center[0]-i.radius,i.center[1]-i.radius,i.center[2]-i.radius);Yo.scale(n,n,1/r.length);const i={center:n,halfSize:Yo.fromValues(Math.max(t[0]-n[0],n[0]-o[0]),Math.max(t[1]-n[1],n[1]-o[1]),Math.max(t[2]-n[2],n[2]-o[2]))};this.bvh.root&&this.bvh.root.free(),this.bvh.queue.clear(),this.bvh.root=new Et(this,i,0);for(let e of r)this.bvh.root.getBound(i),this.bvh.root.insert(e,i)},Qo.prototype.insertFace=function(e){e.octree?console.log("octree insert duplicated"):this.bvh.queue.add(e)},Qo.prototype.moveSphere=function(e){this.bvh.queue.add(e)},Qo.prototype.removeFace=function(e){e.octree?e.octree._remove(e):this.bvh.queue.delete(e)},Qo.prototype.updateBVH=function(){for(let e of this.bvh.queue)if(!this.bvh.root.isInside(e))return this.bvh.queue.clear(),void this.initBVH();const e={center:Yo.create(),halfSize:Yo.create()};for(let t of this.bvh.queue)this.bvh.root.getBound(e),this.bvh.root.insert(t,e);this.bvh.root.check(new Set),this.bvh.queue.clear()},Qo.prototype.rayPick=function(e){null===this.bvh.root?this.initBVH():this.updateBVH();var t,o=null,n=Number.POSITIVE_INFINITY;for(let r of this.bvh.root.intersectExtent(e))r.eachEdge((function(i){var s=ct(e,[r.center,i.origin,i.destination()]);0!=s&&s<n&&(n=s,o=i,t=r.center)}));return o?{t:n,model:this,center:t,edge:o}:null},Qo.prototype.getSelectedSorted=function(){let e=Array.from(this.selectedSet);return e.sort((e,t)=>e.index-t.index),e},Qo.prototype.getNotSelected=function(e){const t=this.selectedSet;return{*[Symbol.iterator](){for(let o of e)t.has(o)||(yield o)}}},Qo.duplicate=function(e){const t=new Map,o=new Qo(e.bench),n=o.geometry;for(let o of e.geometry.vertices){const e=n.addVertex(o);t.set(o.index,e.index)}for(let o of e.geometry.faces){let e=[];for(let n of o.eachVertex())e.push(t.get(n.index));n.addPolygon(e,o.material)}return o.updateAffected(),o.name=e.name+"_copy1",o},Qo.prototype.merge=function(e){this.geometry.merge(this,(function*(){yield*e}))},Qo.prototype.extinquish=function(){for(let e of this.geometry.faces)this.removeFace(e)},Qo.prototype.revive=function(){this.geometry.revive(this)},Qo.prototype.separate=function(){const e=[],t=this.geometry.separateOut(this);if(t){let o=0;for(let n of t){const t=new Qo(this.bench,n);t.name=o>0?this.name+"_sep"+o.toString():this.name,o++,e.push(t)}}return e},Qo.prototype.detachFace=function(e,t){const o=this.geometry.detachFace(this,e),n=new Qo(this.bench);return n.geometry._merge(n,e,o.edges,o.vertices),n.name=this.name+"_cut"+t.toString(),n},Qo.prototype.setVisible=function(e){if(e){if(!this.status.visible)return this.status.visible=!0,this.geometry.show(),!e}else if(this.status.visible)return this.status.visible=!1,this.geometry.hide(),!e;return null},Qo.prototype.toggleLock=function(e){if(e){if(!this.status.locked)return this.status.locked=!0,!e}else if(this.status.locked)return this.status.locked=!1,!e;return null},Qo.prototype.toggleWireMode=function(e){if(e){if(!this.status.wireMode)return this.status.wireMode=!0,this.geometry.setTransparency(!0),!e}else if(this.status.wireMode)return this.status.wireMode=!1,this.geometry.setTransparency(!1),!e;return null},Qo.prototype.isLock=function(){return this.status.locked},Qo.prototype.isVisible=function(){return this.status.visible},Qo.prototype.isWireMode=function(){return this.status.wireMode},Qo.prototype.hardnessEdge=function(e){let t={operand:e,selection:[]};for(let o of this.selectedSet)o.setHardness(e)&&t.selection.push(o);return t.selection.length>0?t:null},Qo.prototype.undoHardnessEdge=function(e){let t=e.operand;0===t?t=1:1===t&&(t=0);for(let o of e.selection)o.setHardness(t)},Qo.prototype.assignFaceMaterial=function(e){const t=new Map;for(let o of this.selectedSet)if(e!==o.material){let n=t.get(o.material);n?n.push(o):t.set(o.material,[o]),o.assignMaterial(e)}return t.size>0?t:void 0},Qo.prototype.undoAssignFaceMaterial=function(e){for(const[t,o]of e.entries())for(const e of o)e.assignMaterial(t)},Qo.prototype.selectFaceMaterial=function(e){const t=this._resetSelectFace();for(let t of this.geometry.faces)t.material===e&&this.selectFace(t);return t},Qo.prototype.selectEdgeMaterial=function(e){const t=this._resetSelectEdge();for(let t of this.geometry.edges)for(let o of t)if(o.face&&o.face.material===e){this.selectEdge(o);break}return t},Qo.prototype.selectVertexMaterial=function(e){const t=this._resetSelectVertex();for(let t of this.geometry.vertices)for(let o of t.edgeRing())if(o.face&&o.face.material===e){this.selectVertex(t);break}return t},Qo.prototype.selectBodyMaterial=function(e){const t=this._resetSelectBody();for(let t of this.geometry.faces)if(t.material===e){this.selectBody();break}return t},Qo.prototype.setVertexColor=function(e){const t={hEdges:[],hEdgeColors:[],oldColors:[]},o=new Set;for(let n of this.selectedSet)for(let r of n.edgeRing()){t.hEdges.push(r);let n=r.setVertexColor(e);n.value&&t.oldColors.push(n),t.hEdgeColors.push(n.index),o.add(r.face)}return t},Qo.prototype.undoVertexColor=function(e){const t=new Set;for(let t of e.oldColors)Bt.color.reserve(t.index),Bt.color.setValue(t.index,t.value);let o=e.hEdgeColors.values();for(let n of e.hEdges)n.setVertexColor(o.next().value),t.add(n.face)},Qo.prototype.setFaceColor=function(e){const t={hEdges:[],hEdgeColors:[],oldColors:[]};for(let o of this.selectedSet)for(let n of o.hEdges()){t.hEdges.push(n);let o=n.setVertexColor(e);o.color&&t.oldColors.push(o),t.hEdgeColors.push(o.index)}return t},Qo.prototype.setBodyColor=function(e){const t={hEdges:[],hEdgeColors:[],oldColors:[]};for(let o of this.geometry.faces)if(o.isLive())for(let n of o.hEdges()){t.hEdges.push(n);let o=n.setVertexColor(e);o.color&&t.oldColors.push(o),t.hEdgeColors.push(o.index)}return t},Qo.prototype._getGeometryMetric=function(){return this.geometry.faces.size+2*this.geometry.edges.size+3*this.geometry.vertices.size},Qo.prototype.updateAffected=function(){this.bench.updateAffected()},Qo.prototype.updateAffectedIncipient=function(){this.bench.updateAffectedIncipient()},Qo.prototype._updatePosition=function(e){for(let t of e)t.updatePosition()},Qo.prototype.changeFromBodyToFaceSelect=function(){const e=this.snapshotSelectionBody();if(this.hasSelection()){this._resetSelectBody();for(let e of this.geometry.faces)this._setFaceSelectionOn(e)}return e},Qo.prototype.changeFromBodyToEdgeSelect=function(){const e=this.snapshotSelectionBody();if(this.hasSelection()){this._resetSelectBody();for(let e of this.geometry.edges)this.selectedSet.add(e),e.selectEdge(!0)}return e},Qo.prototype.changeFromBodyToVertexSelect=function(){const e=this.snapshotSelectionBody();if(this.hasSelection()){this._resetSelectBody();for(let e of this.geometry.vertices)this.selectedSet.add(e),e.setSelect(!0)}return e},Qo.prototype.changeFromBodyToMultiSelect=function(){const e=this.snapshotSelectionBody();return this.hasSelection()&&this._resetSelectBody(),e},Qo.prototype.restoreSelection=function(e,t){t._restoreSelection(this,e)},Qo.prototype.restoreFaceSelection=function(e){for(let t of e.selectedFaces)this.selectFace(t)},Qo.prototype.restoreEdgeSelection=function(e){for(let t of e.wingedEdges)this.selectEdge(t.left)},Qo.prototype.restoreVertexSelection=function(e){for(let t of e.vertices)this.selectVertex(t)},Qo.prototype.restoreBodySelection=function(e){e.body.size>0&&this.selectBody()},Qo.prototype.restoreFromBodyToFaceSelect=function(e){e?(this._resetSelectBody(),this.restoreFaceSelection(e)):this.changeFromBodyToFaceSelect()},Qo.prototype.restoreFromBodyToEdgeSelect=function(e){e?(this._resetSelectBody(),this.restoreEdgeSelection(e)):this.changeFromBodyToEdgeSelect()},Qo.prototype.restoreFromBodyToVertexSelect=function(e){e?(this._resetSelectBody(),this.restoreVertexSelection(e)):this.changeFromBodyToVertexSelect()},Qo.prototype.restoreFromBodyToMultiSelect=function(e){this.changeFromBodyToMutliSelect()},Qo.prototype._resetSelectBody=function(){const e=this.snapshotSelectionBody();return this.selectedSet.delete(this.geometry),this.geometry.setSelect(!1),e},Qo.prototype._selectBodyFrustum=function(e,t){if(this.hasSelection()===t){const t=this.snapshotSelectionBody();for(const o of this.geometry.faces){let n=e.overlapSphere(o);if(n>0)return this.selectBody(),t;if(0===n&&e.overlapPolygon(o))return this.selectBody(),t}}return null},Qo.prototype._selectBodyFrustumWhole=function(e,t){if(this.hasSelection()===t){const t=this.snapshotSelectionBody();for(const t of this.geometry.vertices)if(!e.containPoint(t))return null;return this.selectBody(),t}return null},Qo.prototype._selectBodyLess=function(){const e=this.snapshotSelectionBody();return this.hasSelection()&&this.selectBody(),e},Qo.prototype._selectBodyAll=function(){const e=this.snapshotSelectionBody();return this.hasSelection()||this.selectBody(),e},Qo.prototype._selectBodyInverse=function(){const e=this.snapshotSelectionBody();return this.selectBody(),e},Qo.prototype.tweakBody=function(){return this.hasSelection()?null:(this.selectBody(),this)},Qo.prototype.selectBody=function(){return this.hasSelection()?(this.geometry.setSelect(!1),this.selectedSet.delete(this.geometry)):(this.selectedSet.add(this.geometry),this.geometry.setSelect(!0),geometryStatus(Xo("objectInfo",{name:this.name,polygonSize:this.geometry.faces.size,edgeSize:this.geometry.edges.size,vertexSize:this.geometry.vertices.size}))),this.hasSelection()},Qo.prototype.hiliteBody=function(e){this.geometry.setHilite(e)},Qo.prototype.hasSelection=function(){return this.selectedSet.size>0},Qo.prototype.selectionSize=function(){return this.selectedSet.size},Qo.prototype.snapshotSelection=function(){return new Set(this.selectedSet)},Qo.prototype.snapshotSelectionFace=function(){return{selectedFaces:new Set(this.selectedSet)}},Qo.prototype.snapshotSelectionEdge=function(){return{wingedEdges:new Set(this.selectedSet)}},Qo.prototype.snapshotSelectionVertex=function(){return{vertices:new Set(this.selectedSet)}},Qo.prototype.snapshotSelectionBody=function(){return{body:new Set(this.selectedSet)}},Qo.prototype.tweakVertex=function(e){return this.selectedSet.has(e)?null:(this.selectVertex(e),e)},Qo.prototype.dragSelectVertex=function(e,t){if(this.selectedSet.has(e)){if(!1===t)return this.selectedSet.delete(e),e.setSelect(!1),!0}else if(!0===t)return this.selectedSet.add(e),e.setSelect(!0),geometryStatus("select vertex: "+e.index),!0;return!1},Qo.prototype.selectVertex=function(e){var t;return this.selectedSet.has(e)?(this.selectedSet.delete(e),t=!1):(this.selectedSet.add(e),t=!0,geometryStatus("select vertex: "+e.index)),e.setSelect(t),t},Qo.prototype._resetSelectVertex=function(){var e=this.snapshotSelectionVertex();for(let e of this.selectedSet)e.resetState();return this.selectedSet=new Set,e},Qo.prototype._selectVertexFrustum=function(e,t){const o=this.selectedSet.size,n=this.snapshotSelectionVertex();let r=this.selectedSet;t||(r=this.getNotSelected(this.geometry.vertices));for(const t of r)e.containPoint(t)&&this.selectVertex(t);return o!==this.selectedSet.size?n:null},Qo.prototype._selectVertexFrustumWhole=function(e,t){return this._selectVertexFrustum(e,t)},Qo.prototype._selectVertexMore=function(){const e=this.snapshotSelectionVertex();for(let t of e.vertices)for(let e of t.eachInEdge())this.selectedSet.has(e.origin)||this.selectVertex(e.origin);return e},Qo.prototype._selectVertexLess=function(){const e=this.snapshotSelectionVertex();for(let t of e.vertices)for(let o of t.oneRing())if(!e.vertices.has(o)){this.selectVertex(t);break}return e},Qo.prototype._selectVertexAll=function(){const e=this.snapshotSelectionVertex();for(let t of this.geometry.vertices)t.isLive()&&!e.vertices.has(t)&&this.selectVertex(t);return e},Qo.prototype._selectVertexInverse=function(){const e=this.snapshotSelectionVertex();for(let e of this.geometry.vertices)e.isLive()&&this.selectVertex(e);return e},Qo.prototype._selectVertexAdjacent=function(){return this._selectVertexMore()},Qo.prototype._selectVertexSimilar=function(){const e=this.snapshotSelectionVertex(),t=new SimilarVertex(e.vertices);for(let o of this.geometry.vertices)o.isLive()&&!e.vertices.has(o)&&t.find(o)&&this.selectVertex(o);return e},Qo.prototype.changeFromVertexToFaceSelect=function(){const e=this.snapshotSelectionVertex();var t=this._resetSelectVertex();for(let e of t.vertices)for(let t of e.eachOutEdge())t.face&&!this.selectedSet.has(t.face)&&this.selectFace(t.face);return e},Qo.prototype.changeFromVertexToEdgeSelect=function(){const e=this.snapshotSelectionVertex();var t=this._resetSelectVertex();for(let e of t.vertices)for(let t of e.eachOutEdge())this.selectedSet.has(t.wingedEdge)||this.selectEdge(t);return e},Qo.prototype.changeFromVertexToBodySelect=function(){const e=this.snapshotSelectionVertex();return this.hasSelection()&&(this._resetSelectVertex(),this.selectBody()),e},Qo.prototype.changeFromVertexToMultiSelect=function(){const e=this.snapshotSelectionVertex();return this._resetSelectVertex(),e},Qo.prototype.restoreFromVertexToFaceSelect=function(e){e?(this._resetSelectVertex(),this.restoreFaceSelection(e)):this.changeFromVertexToFaceSelect()},Qo.prototype.restoreFromVertexToEdgeSelect=function(e){e?(this._resetSelectVertex(),this.restoreEdgeSelection(e)):this.changeFromVertexToEdgeSelect()},Qo.prototype.restoreFromVertexToBodySelect=function(e){e?(this._resetSelectVertex(),this.restoreBodySelection(e)):this.changeFromVertexToBodySelect()},Qo.prototype.restoreFromVertexToMultiSelect=function(e){this.changeFromVertexToMultiSelect()},Qo.prototype.changeFromMultiToEdgeSelect=function(){return{}},Qo.prototype.changeFromMultiToFaceSelect=function(){return{}},Qo.prototype.changeFromMultiToVertexSelect=function(){return{}},Qo.prototype.changeFromMultiToBodySelect=function(){return{}},Qo.prototype.restoreFromMultiToEdgeSelect=function(e){e&&this.restoreEdgeSelection(e)},Qo.prototype.restoreFromMultiToFaceSelect=function(e){e&&this.restoreFaceSelection(e)},Qo.prototype.restoreFromMultiToVertexSelect=function(e){e&&this.restoreVertexSelection(e)},Qo.prototype.restoreFromMultiToBodySelect=function(e){e&&this.restoreBodySelection(e)},Qo.prototype.tweakEdge=function(e){return this.selectedSet.has(e.wingedEdge)?null:(this.selectEdge(e),e)},Qo.prototype.dragSelectEdge=function(e,t){var o=e.wingedEdge;if(this.selectedSet.has(o)){if(!1===t)return this.selectedSet.delete(o),o.selectEdge(!1),!0}else if(!0===t)return this.selectedSet.add(o),o.selectEdge(!0),!0;return!1},Qo.prototype.selectEdge=function(e){var t,o=e.wingedEdge;return this.selectedSet.has(o)?(this.selectedSet.delete(o),t=!1):(this.selectedSet.add(o),t=!0,geometryStatus("select edge: "+o.index)),o.selectEdge(t),t},Qo.prototype.selectBoundaryEdge=function(){const e=this._resetSelectEdge();for(let e of this.geometry.edges)for(let t of e)if(t.isBoundary()){this.selectEdge(t);break}return e},Qo.prototype._resetSelectEdge=function(){const e=this.snapshotSelectionEdge();for(let e of this.selectedSet)e.selectEdge(!1);return this.selectedSet=new Set,e},Qo.prototype._selectEdgeFrustum=function(e,t){const o=this.selectedSet.size,n=this.snapshotSelectionEdge();let r=this.selectedSet;t||(r=this.getNotSelected(this.geometry.edges));for(const t of r)e.overlapHEdge(t.left)&&this.selectEdge(t.left);return o!==this.selectedSet.size?n:null},Qo.prototype._selectEdgeFrustumWhole=function(e,t){const o=this.selectedSet.size,n=this.snapshotSelectionEdge(),r=new Set;for(const t of this.geometry.vertices)e.containPoint(t)&&r.add(t);let i=this.selectedSet;t||(i=this.getNotSelected(this.geometry.edges));for(const e of i)r.has(e.left.origin)&&r.has(e.right.origin)&&this.selectEdge(e.left);return o!==this.selectedSet.size?n:null},Qo.prototype._selectEdgeMore=function(){const e=this.snapshotSelectionEdge();for(let t of e.wingedEdges)for(let e of t)for(let t of e.eachEdge())this.selectedSet.has(t.wingedEdge)||this.selectEdge(t);return e},Qo.prototype._selectEdgeLess=function(){const e=this.snapshotSelectionEdge();for(let t of e.wingedEdges)for(let o of t.oneRing())if(!e.wingedEdges.has(o)){this.selectEdge(t.left);break}return e},Qo.prototype._selectEdgeAll=function(){const e=this.snapshotSelectionEdge();for(let t of this.geometry.edges)t.isLive()&&!e.wingedEdges.has(t)&&this.selectEdge(t.left);return e},Qo.prototype._selectEdgeInverse=function(){const e=this.snapshotSelectionEdge();for(let e of this.geometry.edges)e.isLive()&&this.selectEdge(e.left);return e},Qo.prototype._selectEdgeAdjacent=function(){const e=this.snapshotSelectionEdge();for(let t of e.wingedEdges)for(let e of t.adjacent())this.selectedSet.has(e)||this.selectEdge(e.left);return e},Qo.prototype._selectEdgeSimilar=function(){const e=this.snapshotSelectionEdge(),t=new SimilarWingedEdge(e.wingedEdges);for(let o of this.geometry.edges)o.isLive&&!e.wingedEdges.has(o)&&t.find(o)&&this.selectEdge(o.left);return e},Qo.prototype.changeFromEdgeToFaceSelect=function(){const e=this.snapshotSelectionEdge(),t=this._resetSelectEdge();for(let e of t.wingedEdges)for(let t of e)t.face&&!this.selectedSet.has(t.face)&&this.selectFace(t.face);return e},Qo.prototype.changeFromEdgeToVertexSelect=function(){const e=this.snapshotSelectionEdge(),t=this._resetSelectEdge();for(let e of t.wingedEdges)for(let t of e)this.selectedSet.has(t.origin)||this.selectVertex(t.origin);return e},Qo.prototype.changeFromEdgeToBodySelect=function(){const e=this.snapshotSelectionEdge();return this.hasSelection()&&(this._resetSelectEdge(),this.selectBody()),e},Qo.prototype.changeFromEdgeToMultiSelect=function(){const e=this.snapshotSelectionEdge();return this.hasSelection()&&this._resetSelectEdge(),e},Qo.prototype.restoreFromEdgeToFaceSelect=function(e){e?(this._resetSelectEdge(),this.restoreFaceSelection(e)):this.changeFromEdgeToFaceSelect()},Qo.prototype.restoreFromEdgeToVertexSelect=function(e){e?(this._resetSelectEdge(),this.restoreVertexSelection(e)):this.changeFromEdgeToVertexSelect()},Qo.prototype.restoreFromEdgeToBodySelect=function(e){e?(this._resetSelectEdge(),this.restoreBodySelection(e)):this.changeFromEdgeToBodySelect()},Qo.prototype.restoreFromEdgeToMultiSelect=function(e){this.changeFromEdgeToMultiSelect()},Qo.prototype._setFaceSelectionOff=function(e){e.setSelect(!1),this.selectedSet.delete(e)},Qo.prototype._setFaceSelectionOn=function(e){e.setSelect(!0),this.selectedSet.add(e)},Qo.prototype.tweakFace=function(e){return this.selectedSet.has(e)?null:(this.selectFace(e),e)},Qo.prototype.dragSelectFace=function(e,t){if(this.selectedSet.has(e)){if(!1===t)return this._setFaceSelectionOff(e),!0}else if(!0===t)return this._setFaceSelectionOn(e),!0;return geometryStatus("polygon face # "+e.index),!1},Qo.prototype.selectFace=function(e){var t;return this.selectedSet.has(e)?(this._setFaceSelectionOff(e),z("faceSelectOff",e.index),t=!1):(this._setFaceSelectionOn(e),z("faceSelectOn",e.index),t=!0),geometryStatus("polygon face # "+e.index),t},Qo.prototype._resetSelectFace=function(){const e=this.snapshotSelectionFace();this.selectedSet=new Set;for(let t of e.selectedFaces)t.setSelect(!1);return e},Qo.prototype._selectFaceFrustum=function(e,t){const o=this.selectedSet.size,n=this.snapshotSelectionFace();let r=this.selectedSet;t||(r=this.getNotSelected(this.geometry.faces));for(const t of r){let o=e.overlapSphere(t);(o>0||0===o&&e.overlapPolygon(t))&&this.selectFace(t)}return o!==this.selectedSet.size?n:null},Qo.prototype._selectFaceFrustumWhole=function(e,t){const o=this.selectedSet.size,n=this.snapshotSelectionFace(),r=new Set;for(const t of this.geometry.vertices)e.containPoint(t)&&r.add(t);let i=this.selectedSet;t||(i=this.getNotSelected(this.geometry.faces));for(const t of i){let o=e.overlapSphere(t);if(o>0)this.selectFace(t);else if(0===o){let e=!0;for(const o of t.eachVertex())if(!r.has(o)){e=!1;break}e&&this.selectFace(t)}}return o!==this.selectedSet.size?n:null},Qo.prototype._selectFaceMore=function(){const e=this.snapshotSelectionFace();for(let t of e.selectedFaces)for(let e of t.oneRing())null===e||this.selectedSet.has(e)||this.selectFace(e);return e},Qo.prototype._selectFaceLess=function(){const e=this.snapshotSelectionFace();for(let t of e.selectedFaces)for(let o of t.adjacent())if(!e.selectedFaces.has(o)){this.selectFace(t);break}return e},Qo.prototype._selectFaceAll=function(){const e=this.snapshotSelectionFace();for(let t of this.geometry.faces)t.isLive()&&!e.selectedFaces.has(t)&&this.selectFace(t);return e},Qo.prototype._selectFaceInverse=function(){const e=this.snapshotSelectionFace();for(let e of this.geometry.faces)e.isLive()&&this.selectFace(e);return e},Qo.prototype._selectFaceAdjacent=function(){const e=this.snapshotSelectionFace();for(let t of e.selectedFaces)for(let e of t.adjacent())null===e||this.selectedSet.has(e)||this.selectFace(e);return e},Qo.prototype._selectFaceSimilar=function(){const e=this.snapshotSelectionFace(),t=new SimilarFace(e.selectedFaces);for(let o of this.geometry.faces)o.isLive()&&!e.selectedFaces.has(o)&&t.find(o)&&this.selectFace(o);return e},Qo.prototype.changeFromFaceToEdgeSelect=function(){const e=this.snapshotSelectionFace();var t=this,o=this._resetSelectFace();for(let e of o.selectedFaces)e.eachEdge((function(e){t.selectedSet.has(e.wingedEdge)||t.selectEdge(e)}));return e},Qo.prototype.changeFromFaceToVertexSelect=function(){const e=this.snapshotSelectionFace();var t=this._resetSelectFace();for(let e of t.selectedFaces)for(let t of e.eachVertex())this.selectedSet.has(t)||this.selectVertex(t);return e},Qo.prototype.changeFromFaceToBodySelect=function(){const e=this.snapshotSelectionFace();return this.hasSelection()&&(this._resetSelectFace(),this.selectBody()),e},Qo.prototype.changeFromFaceToMultiSelect=function(){const e=this.snapshotSelectionFace();return this.hasSelection()&&this._resetSelectFace(),e},Qo.prototype.restoreFromFaceToEdgeSelect=function(e){e?(this._resetSelectFace(),this.restoreEdgeSelection(e)):this.changeFromFaceToEdgeSelect()},Qo.prototype.restoreFromFaceToVertexSelect=function(e){e?(this._resetSelectFace(),this.restoreVertexSelection(e)):this.changeFromFaceToVertexSelect()},Qo.prototype.restoreFromFaceToBodySelect=function(e){e?(this._resetSelectFace(),this.restoreBodySelection(e)):this.changeFromFaceToBodySelect()},Qo.prototype.restoreFromFaceToMultiSelect=function(e){this.changeFromFaceToMultiSelect()},Qo.prototype.edgeLoop=function(e){let t=0;const o=new Set(this.selectedSet),n=[];for(let r of o)for(let o of r){for(;(o=o.next.pair.next)&&!this.selectedSet.has(o.wingedEdge)&&4===o.destination().numberOfEdge();)++t,t%e==0&&(this.selectEdge(o),n.push(o))}return n},Qo.prototype.edgeRing=function(e){let t=0;const o=new Set(this.selectedSet),n=[];for(let r of o)for(let o of r){for(;(o=o.pair.next.next)&&!this.selectedSet.has(o.wingedEdge)&&o.next.next.next.next===o;)++t,t%e==0&&(this.selectEdge(o),n.push(o))}return n},Qo.prototype.undoLoopOrRing=function(e){for(let t of e)this.selectEdge(t)},Qo.prototype.restoreMoveSelection=function(e){let t=new rt(e.position);for(let o of e.vertices)Yo.copy(o,t),t.inc()},Qo.prototype.moveSelection=function(e,t){if(e.direction){let o=new rt(e.direction);for(let n of e.vertices)Yo.scaleAndAdd(n,n,o,t),o.inc()}else for(let o of e.vertices)Yo.add(o,o,t)},Qo.prototype.rotateSelection=function(e,t,o){const n=[0,0,0],r=[1,1,1];this.transformSelection(e,(e,i)=>{Wo.fromRotationTranslationScaleOrigin(e,t,n,r,o||i)})},Qo.prototype.scaleAxisSelection=function(e,t,o){const n=[t,1,1];Yo.normalize(o,o);const r=[1,0,0];let i=Math.acos(Yo.dot(o,r));Yo.cross(r,o,r),Yo.normalize(r,r),i>Math.PI/2&&(Yo.scale(r,r,-1),i=Math.PI-i),this.transformSelection(e,(e,t)=>{let o=Wo.create();Wo.fromScaling(o,n);let s=Wo.create();Wo.fromRotation(s,i,r);let a=Wo.create();Wo.transpose(a,s),Wo.translate(e,e,t),Wo.mul(e,e,a),Wo.mul(e,e,o),Wo.mul(e,e,s),Wo.translate(e,e,[-t[0],-t[1],-t[2]])})},Qo.prototype.scaleSelection=function(e,t,o){const n=$o.create(),r=[0,0,0],i=[o[0]?t*o[0]:1,o[1]?t*o[1]:1,o[2]?t*o[2]:1];this.transformSelection(e,(e,t)=>{Wo.fromRotationTranslationScaleOrigin(e,n,r,i,t)})},Qo.prototype.transformSelection=function(e,t){const o=Wo.create(),n=new rt(e.position),r=e.vertices[Symbol.iterator]();for(let i of e.matrixGroup){t(o,i.center);for(let e=0;e<i.count;e++){const e=r.next().value;Yo.transformMat4(e,n,o),n.inc()}}},Qo.prototype.snapshotPositionAll=function(){return this.snapshotPosition(this.geometry.vertices)},Qo.prototype.snapshotPosition=function(e,t){var o={faces:new Set,vertices:null,wingedEdges:new Set,position:null,direction:t};o.vertices=e;const n=e.length?e.length:e.size;o.position=new Float32Array(3*n);let r=0;for(let e of o.vertices){for(let t of e.eachOutEdge())t.isNotBoundary()&&!o.faces.has(t.face)&&o.faces.add(t.face),o.wingedEdges.has(t.wingedEdge)||o.wingedEdges.add(t.wingedEdge);o.position.set(e,r),r+=3}return o},Qo.prototype.snapshotEdgePosition=function(){var e=new Set;for(let o of this.selectedSet)for(let n of o){var t=n.origin;e.has(t)||e.add(t)}return this.snapshotPosition(e)},Qo.prototype.snapshotFacePosition=function(){var e=new Set;for(let t of this.selectedSet)for(let o of t.eachVertex())e.has(o)||e.add(o);return this.snapshotPosition(e)},Qo.prototype.snapshotVertexPosition=function(){const e=new Set(this.selectedSet);return this.snapshotPosition(e)},Qo.prototype.snapshotBodyPosition=function(){let e=new Set;return this.hasSelection()&&(e=new Set(this.geometry.vertices)),this.snapshotPosition(e)},Qo.prototype.snapshotFacePositionAndNormal=function(){const e=new Set;let t=new Map;const o=[0,0,0];for(let n of this.selectedSet)for(let r of n.eachVertex())if(e.has(r)){const e=t.get(r);n.getNormal(o),Yo.dot(e,o)<.999&&Yo.add(e,e,o)}else{e.add(r);const o=[0,0,0];n.getNormal(o),t.set(r,o)}const n=new Float32Array(3*e.size);let r=0;for(let[e,o]of t)n[r++]=o[0],n[r++]=o[1],n[r++]=o[2];return this.snapshotPosition(e,n)},Qo.prototype.snapshotVertexPositionAndNormal=function(){const e=new Set(this.selectedSet),t=new Float32Array(3*e.size),o=new rt(t);for(let t of e){for(let e of t.eachOutEdge())e.isNotBoundary()&&Yo.add(o,o,e.face.normal);Yo.normalize(o,o),o.inc()}return this.snapshotPosition(e,t)},Qo.prototype.snapshotEdgePositionAndNormal=function(){const e=new Set,t=new Map;for(let o of this.selectedSet){const n=o.left.face,r=o.right.face;for(let i of o){let o,s=i.origin;e.has(s)?o=t.get(s):(e.add(s),o=new Set,t.set(s,o)),null!==n&&o.add(n),null!==r&&o.add(r)}}const o=new Float32Array(3*e.size),n=new rt(o);for(let[e,o]of t){for(let e of o)Yo.add(n,n,e.normal);Yo.normalize(n,n),n.inc()}return this.snapshotPosition(e,o)},Qo.prototype.snapshotTransformEdgeGroup=function(){const e=new Set,t=[];let o=this.geometry.findEdgeGroup(this.selectedSet);for(let n of o){let o=0;const r=Yo.create();for(let t of n)for(let n of t.eachVertex())e.has(n)||(e.add(n),o++,Yo.add(r,r,n));Yo.scale(r,r,1/o),t.push({center:r,count:o})}const n=this.snapshotPosition(e);return n.matrixGroup=t,n},Qo.prototype.snapshotTransformFaceGroup=function(){const e=new Set,t=[];let o=Dt.findFaceGroup(this.getSelectedSorted());const n=Yo.create();for(let r of o){let o=0;Yo.set(n,0,0,0);for(let t of r)for(let r of t.eachVertex())e.has(r)||(e.add(r),o++,Yo.add(n,n,r));Yo.scale(n,n,1/o),t.push({center:n,count:o})}const r=this.snapshotPosition(e);return r.matrixGroup=t,r},Qo.prototype.snapshotTransformBodyGroup=function(e=!1){let t=new Set;const o=Yo.create();if(this.hasSelection()||e){for(let e of this.geometry.vertices)e.isLive()&&(t.add(e),Yo.add(o,o,e));Yo.scale(o,o,1/t.size)}const n=this.snapshotPosition(t);return n.matrixGroup=[{center:o,count:t.size}],n},Qo.prototype.snapshotTransformVertexGroup=function(){let e=new Set;const t=Yo.create();if(this.hasSelection()){for(let o of this.selectedSet)e.add(o),Yo.add(t,t,o);Yo.scale(t,t,1/e.size)}const o=this.snapshotPosition(e);return o.matrixGroup=[{center:t,count:e.size}],o},Qo.prototype.updatePosition=function(e){for(let t of e.faces)t.updatePosition()},Qo.prototype._putOn=function(e){let t=this.selectedSet.values().next().value;const o=t.center,n=Yo.create();Yo.copy(n,t.normal),Yo.negate(n,n);const r=Wo.create();!function(e,t,o){let n=st.dot(t,o);if(Math.abs(n)>.999999){const n=st.fromValues(Math.abs(t[0]),Math.abs(t[1]),Math.abs(t[2]));n[0]<n[1]?n[0]<n[2]?(n[0]=1,n[1]=n[2]=0):(n[2]=1,n[0]=n[1]=0):n[1]<n[2]?(n[1]=1,n[0]=n[2]=0):(n[2]=1,n[0]=n[1]=0);let r=st.fromValues(n[0]-t[0],n[1]-t[1],n[2]-t[2]),i=st.fromValues(n[0]-o[0],n[1]-o[1],n[2]-o[2]),s=2/st.dot(r,r),a=2/st.dot(i,i),l=s*a*st.dot(r,i);for(let t=0;t<3;t++){let o=4*t;for(let n=0;n<3;n++)e[o+n]=-s*r[t]*r[n]-a*i[t]*i[n]+l*i[t]*r[n];e[o+t]+=1}}else{let r=st.create();st.cross(r,t,o);let i=(1-n)/st.dot(r,r),s=i*r[0],a=i*r[2],l=s*r[1],c=s*r[2],d=a*r[1];e[0]=n+s*r[0],e[1]=l+r[2],e[2]=c-r[1],e[4]=l-r[2],e[5]=n+i*r[1]*r[1],e[6]=d+r[0],e[8]=c+r[1],e[9]=d-r[0],e[10]=n+a*r[2]}}(r,n,e.normal);const i=Wo.create();Wo.fromTranslation(i,e.center),Wo.mul(i,i,r),Yo.negate(o,o);const s=Wo.create();Wo.fromTranslation(s,o),Wo.mul(i,i,s);for(let e of this.geometry.vertices)Yo.transformMat4(e,e,i);this._updatePosition(this.geometry.faces)},Qo.prototype.putOnVertex=function(e){const t=Yo.create();e.getNormal(t),this._putOn({normal:t,center:e})},Qo.prototype.putOnEdge=function(e){const t=Yo.create();e.wingedEdge.getNormal(t);const o=Yo.create();Yo.add(o,e.origin,e.destination()),Yo.scale(o,o,.5),this._putOn({normal:t,center:o})},Qo.prototype.putOnFace=function(e){this._putOn({normal:e.normal,center:e.center})},Qo.prototype.flattenEdge=function(e){const t=this.snapshotEdgePosition(),o=Yo.create(),n=new Set,r=this.geometry.findEdgeGroup(this.getSelectedSorted());for(let t of r){n.clear(),Yo.set(o,0,0,0);for(let e of t)for(let t of e)n.has(t.origin)||(Yo.add(o,o,t.origin),n.add(t.origin));Yo.scale(o,o,1/n.size),pt(n,e,o)}return this._updatePosition(t.faces),t},Qo.prototype.flattenFace=function(e){const t=this.snapshotFacePosition(),o=Dt.findFaceGroup(this.getSelectedSorted()),n=Yo.create(),r=new Set;let i=e;e||(i=Yo.create());for(let t of o){r.clear(),Yo.set(n,0,0,0);for(let o of t){for(let e of o.hEdges())r.has(e.origin)||(r.add(e.origin),Yo.add(n,n,e.origin));e||Yo.add(i,i,o.normal)}Yo.scale(n,n,1/r.size),e||Yo.normalize(i,i),pt(r,i,n)}return this._updatePosition(t.faces),t},Qo.prototype.flattenVertex=function(e){if(this.selectedSet.size>1){const t=this.getSelectedSorted(),o=this.snapshotVertexPosition(),n=Yo.create();for(let e of t)Yo.add(n,n,e);return Yo.scale(n,n,1/t.length),pt(t,e,n),this._updatePosition(o.faces),o}return null},Qo.prototype.extractFace=function(){const e=new Qo(this.bench),t=new Map;for(let o of this.selectedSet){let n=[];for(let r of o.eachVertex()){let o=t.get(r);if(void 0===o){o=e.geometry.addVertex(r).index,t.set(r,o)}n.push(o)}e.geometry.addPolygon(n,o.material)}this._resetSelectFace();for(let t of e.geometry.faces)e.selectFace(t);e.name=this.name+"_extract";const o=Dt.findContours(e.geometry.faces);for(let t of o){const o=t[0].outer.pair,n=[];let r=o;do{n.push(r.origin.index),r=r.next}while(r!==o);e.geometry.addPolygon(n,Tt.default)}return{preview:e,snapshot:e.snapshotFacePosition()}},Qo.prototype.creaseEdge=function(){return this.extrudeEdge(!0)},Qo.prototype.extrudeEdge=function(e=!1){let t=new Set,o=[];function n(e){for(let o of e.extrude)t.add(o.wingedEdge);for(let t of e.lift)o.push(t)}const r=[0,0,0];let i=new Set,s=new Set,a=[],l=[],c=[],d=new Set;for(let e of this.selectedSet)for(let t of e){if(d.has(t))continue;let e=t.next;for(;e!==t;){if(!this.selectedSet.has(e.wingedEdge)){for(;!this.selectedSet.has(e.next.wingedEdge);)e=e.next;break}e=e.next}if(e===t){for(let e of t.face.hEdges())d.add(e);let r=this.geometry.liftCornerEdge(e);o.push(r.pair),n(this.geometry.extrudeEdge(r.pair,r))}else{t=e;do{let n=e;for(e=e.next;this.selectedSet.has(e.wingedEdge);)d.add(e),e=e.next;let u=!1,h=!1,f=e;if(s.has(e.pair)?s.delete(e.pair):f===f.pair.next.pair.next?u=!0:(Yo.lerp(r,e.origin,e.destination(),.2),e=this.geometry.splitEdge(e,r),f=e,i.add(e),o.push(e.pair)),i.has(n.pair))i.delete(n.pair);else if(n===n.next.pair.next.pair)h=!0;else{Yo.lerp(r,n.origin,n.destination(),.8);let e=this.geometry.splitEdge(n.pair,r).pair;s.add(e),o.push(e),n===t&&(t=e),n=e}let p={start:n,end:f};for(a.push(p),u&&l.push(p),h&&c.push(p);!this.selectedSet.has(e.next.wingedEdge);)e=e.next}while(e!==t)}}for(let e of l){let t=e.end;t.face.getCentroid(r),Yo.lerp(r,t.origin,r,.2);const n=this.geometry.addVertex(r);t=this.geometry._liftDanglingEdge(t.prev(),n),o.push(t.pair),e.end=t}for(let e of c){let t=e.start;t.face.getCentroid(r),Yo.lerp(r,t.destination(),r,.2);const n=this.geometry.addVertex(r);t=this.geometry._liftDanglingEdge(t,n),o.push(t.pair),e.start=t.pair}for(let e of a){n(this.geometry.extrudeEdge(e.start,e.end))}for(let n of i){let a=n.pair;if(e){let e=a.next;const n=e.pair.next.pair;if(s.has(n)&&e.face.numberOfVertex>3&&e.pair.face.numberOfVertex>3){if(s.has(e.next.pair)&&i.has(e.pair.prev().pair)){Yo.lerp(r,e.origin,e.destination(),.5);let t=this.geometry.splitEdge(e,r);o.push(t.pair),e=t}let n=this.geometry.insertEdge(e,a);t.add(n.wingedEdge),this.geometry.slideToNext(e.pair);continue}}for(;;){if(a=a.next.pair,s.has(a)){let e=this.geometry.insertEdge(a.pair,n.pair);t.add(e.wingedEdge);break}{Yo.lerp(r,a.destination(),a.origin,.2);let e=this.geometry.splitEdge(a.pair,r);a=e.pair,o.push(a);let i=this.geometry.insertEdge(e,n.pair);t.add(i.wingedEdge)}n=a.pair}}return this.updateAffected(),{collapsibleWings:t,liftEdges:o}},Qo.prototype.undoExtrudeEdge=function(e){if(e.dissolveEdges)for(let t of e.dissolveEdges)t.wingedEdge.isLive()&&this.geometry.dissolveEdge(t,e.collapsibleWings);for(let t of e.liftEdges)this.geometry.collapseEdge(t,e.collapsibleWings);this.updateAffected()},Qo.prototype.extrudeVertex=function(){const e=[],t=[],o=[0,0,0];for(let n of this.selectedSet){let r,i=null,s=n.outEdge;do{Yo.lerp(o,s.origin,s.destination(),.25);let n=this.geometry.splitEdge(s,o);if(e.push(n),s=n.pair.next,i){let e=this.geometry.insertEdge(n,i);t.push(e),i=n.pair}else r=n,i=n.pair}while(s!==r);let a=this.geometry.insertEdge(r,i);t.push(a)}return this.updateAffected(),{insertEdges:t,splitEdges:e}},Qo.prototype.undoExtrudeVertex=function(e){for(let t of e.insertEdges)this.geometry.removeEdge(t);for(let t of e.splitEdges)this.geometry.collapseEdge(t.pair);this.updateAffected()},Qo.prototype.extrudeFace=function(e){e||((e={}).edgeLoops=Dt.findContours(this.selectedSet)),e.extrudeEdges=this.geometry.liftAndExtrudeContours(e.edgeLoops),this.updateAffected();const t=this._resetSelectFace();for(let e of t.selectedFaces)this.selectFace(e);return e},Qo.prototype.collapseExtrudeEdge=function(e){const t=e.extrudeEdges;for(let e of t)this.geometry.collapseEdge(e);this.updateAffected();const o=this._resetSelectFace();for(let e of o.selectedFaces)this.selectFace(e)},Qo.prototype.findExtFaceContours=function(){const e=new Set,t=new Set,o=[];for(let n of this.selectedSet)for(let r of n.hEdges()){let n=r.pair;if(!e.has(n)&&!this.selectedSet.has(n.face)){const r=[];let i=n;do{r.push(i),e.add(i);let o=!0;for(;!this.selectedSet.has(i.next.pair.face);)i=i.next.pair,o=!1;o&&t.add(i.face),i=i.next}while(i!==n);o.push(r)}}return{contourLoops:o,cornerFaces:t}},Qo.prototype.bumpFace=function(){const e=this.findExtFaceContours().contourLoops,t=Yo.create(),o=new Map;let n=new Set,r=new Set,i=new Set,s=this;function a(e,t){let o=s.geometry.insertEdge(e,t);n.add(o.wingedEdge),r.add(o)}for(let r of e){let e=null,s=null,l=r[r.length-1];for(let c of r){let r=l.next;if(r!==c)do{let l=r;if(n.has(r.next.wingedEdge)||i.has(r.next))if(s)r.next.next!==s&&a(l,s);else if(null===e)e=r;else{o.get(r.face).add(r)}else if(Yo.lerp(t,r.origin,r.destination(),.5),l=this.geometry.splitEdge(r,t),i.add(l.pair),s)a(l,s);else if(null===e)e=l;else{o.get(l.face).add(l)}s=l.pair,r=l.pair.next}while(r!==c);else{o.has(r.face)||o.set(r.face,new Set);const t=o.get(r.face);s&&(t.add(s.prev()),s=null),t.add(l),null===e&&(e=void 0)}l=c}if(s){if(o.has(s.face)){o.get(s.face).add(s.prev())}e&&e.next.next!==s&&a(e,s)}}for(let[e,t]of o){const o=this.geometry.insertFan(e,t);for(let e of o)n.add(e.wingedEdge),r.add(e)}return this.updateAffected(),{liftEdges:i,collapsibleWings:n,dissolveEdges:r}},Qo.prototype.cutEdge=function(e){const t=this.selectedSet,o=[],n=[];let r=Yo.create(),i=Yo.create();for(let s of t){let t=s.left;Yo.sub(r,t.origin,t.destination());for(let s=1;s<e;++s){const a=(e-s)/e;Yo.scale(i,r,a),Yo.add(i,t.destination(),i);const l=this.geometry.splitEdge(t,i);o.push(t.origin),n.push(l.pair)}}return this.updateAffected(),{vertices:o,halfEdges:n}},Qo.prototype.collapseSplitOrBevelEdge=function(e){for(let t of e.halfEdges)t.wingedEdge.isLive()&&this.geometry.collapseEdge(t,e.collapsibleWings);this.updateAffected()},Qo.prototype.connectVertex=function(){const e=this.geometry.connectVertex(this.selectedSet),t=[];for(let o of e)t.push(o.wingedEdge);return this.updateAffected(),{halfEdges:e,wingedEdges:t}},Qo.prototype.dissolveConnect=function(e){const t=e.halfEdges;for(let e=t.length-1;e>=0;--e){const o=t[e];this.geometry.removeEdge(o)}this.updateAffected()},Qo.prototype.dissolveSelectedEdge=function(){const e=[];for(let t of this.selectedSet){let o=this.geometry.dissolveEdge(t.left),n={halfEdge:t.left,undo:o};e.push(n)}return this.selectedSet.clear(),this.updateAffected(),e},Qo.prototype.reinsertDissolveEdge=function(e){for(let t=e.length-1;t>=0;--t){let o=e[t];this.geometry.restoreDissolveEdge(o.undo),this.selectEdge(o.halfEdge)}this.updateAffected()},Qo.prototype.collapseSelectedEdge=function(){const e=[],t=[],o=new Map;for(let e of this.selectedSet){let n=null;if(e.isLive()){let t,r=e.left.origin;o.has(r)?(t=o.get(r),o.delete(r),Yo.add(t.pt,t.pt,r),t.count++):(t={pt:new Float32Array(3),count:1},Yo.copy(t.pt,r));let i=e.right.origin;if(o.has(i)){const e=o.get(i);Yo.add(e.pt,t.pt,e.pt),e.count+=t.count}else o.set(i,t);n=this.geometry.collapseEdge(e.left)}let r={halfEdge:e.left,undo:n};t.push(r)}this.selectedSet.clear();const n=[];for(let[t,r]of o){n.push(t);const o=[0,0,0];Yo.copy(o,t),e.push({vertex:t,savePt:o}),Yo.add(r.pt,r.pt,o),Yo.scale(r.pt,r.pt,1/(r.count+1)),t.set(r.pt),this.geometry.addAffectedVertexFace(t)}return this.updateAffected(),{collapse:{edges:t,vertices:e},vertices:n}},Qo.prototype.restoreCollapseEdge=function(e){const t=e.collapse;this.selectedSet.clear();const o=t.edges;for(let e=o.length-1;e>=0;--e){let t=o[e];t.undo&&this.geometry.restoreCollapseEdge(t.undo)}for(let e of o)this.selectEdge(e.halfEdge);const n=t.vertices;for(let e of n)e.vertex.set(e.savePt),this.geometry.addAffectedVertexFace(e.vertex);this.updateAffected()},Qo.prototype.dissolveSelectedFace=function(){const e=new Set;for(let t of this.selectedSet)for(let o of t.hEdges())e.add(o.wingedEdge);const t=Dt.findContours(this.selectedSet);for(let o of t)for(let t of o){let o=t.outer;e.has(o.wingedEdge)&&e.delete(o.wingedEdge)}const o=[];for(let t of e)t.isLive()&&o.unshift(this.geometry.dissolveEdge(t.left));const n=this.selectedSet,r=new Set;for(let e of this.selectedSet)e.isLive()?r.add(e):e.setSelect(!1);return this.selectedSet=r,this.updateAffected(),o.length?{edges:o,selection:n}:null},Qo.prototype.undoDissolveFace=function(e){for(let t of e.edges)this.geometry.restoreDissolveEdge(t);this.selectedSet.clear();for(let t of e.selection)this.selectFace(t);this.updateAffected()},Qo.prototype.collapseSelectedFace=function(){const e=this.selectedSet;this.changeFromFaceToEdgeSelect();const t=this.collapseSelectedEdge();return t.selectedFaces=e,t},Qo.prototype.undoCollapseFace=function(e){this.restoreCollapseEdge(e),this._resetSelectEdge()},Qo.prototype.dissolveSelectedVertex=function(){const e={array:[],selectedFaces:[]};for(let t of this.selectedSet){let o=this.geometry.dissolveVertex(t);e.array.unshift(o),e.selectedFaces.push(o.polygon)}return this._resetSelectVertex(),this.updateAffected(),e},Qo.prototype.undoDissolveVertex=function(e){for(let t of e.array)this.geometry.restoreDissolveVertex(t),this.selectVertex(t.vertex);this.updateAffected()},Qo.prototype.bevelEdge=function(){const e=this.selectedSet,t=this.geometry.bevelEdge(e);this.updateAffected(),t.wingedEdges=new Set,t.faces=new Set;for(let e of t.vertices)for(let o of e.edgeRing())t.wingedEdges.add(o.wingedEdge),t.faces.add(o.face);return t},Qo.prototype.bevelFace=function(){const e=this.selectedSet;let t=new Set;for(let o of e)for(let e of o.hEdges())t.add(e.wingedEdge);const o=this.geometry.bevelEdge(t);this.updateAffected(),o.wingedEdges=new Set,o.faces=new Set;for(let e of o.vertices)for(let t of e.edgeRing())o.wingedEdges.add(t.wingedEdge),o.faces.add(t.face);const n=this._resetSelectFace();for(let e of n.selectedFaces)this.selectFace(e);return o},Qo.prototype.bevelVertex=function(){const e=this.selectedSet,t=this.geometry.bevelVertex(e);this.updateAffected(),t.wingedEdges=new Set,t.faces=new Set;for(let e of t.vertices)for(let o of e.edgeRing())t.wingedEdges.add(o.wingedEdge),t.faces.add(o.face);return t},Qo.prototype.bridge=function(e,t){if(2===this.selectedSet.size){for(let o of e.oneRing())if(o===t)return null;const o=this._resetSelectFace(),n=this.geometry.bridgeFace(e,t);return Object.assign(n,o),this.updateAffected(),n}return null},Qo.prototype.undoBridge=function(e){e&&(this.geometry.undoBridgeFace(e),this.updateAffected())},Qo.prototype.insetFace=function(){const e={};e.edgeLoops=Dt.findInsetContours(this.selectedSet),e.extrudeEdges=this.geometry.liftAndExtrudeContours(e.edgeLoops);let t=0;for(let e of this.selectedSet)t+=e.numberOfVertex;e.vertices=[],e.faces=new Set,e.wingedEdges=new Set,e.position=new Float32Array(3*t);const o=new rt(e.position);e.direction=new Float32Array(3*t);const n=new rt(e.direction);e.vertexLimit=Number.MAX_SAFE_INTEGER;const r=Yo.create();for(let t of this.selectedSet){t.getCentroid(r),e.faces.add(t);for(let i of t.hEdges()){e.vertices.push(i.origin),e.faces.add(i.pair.face),e.wingedEdges.add(i.wingedEdge),e.wingedEdges.add(i.pair.next.wingedEdge),Yo.copy(o,i.origin),o.inc(),Yo.sub(n,r,i.origin);const t=Yo.length(n);t<e.vertexLimit&&(e.vertexLimit=t),Yo.normalize(n,n),n.inc()}}this.updateAffected();const i=this._resetSelectFace();for(let e of i.selectedFaces)this.selectFace(e);return e},Qo.prototype.invertBody=function(){this.geometry.invert(),this.updateAffected()},Qo.prototype.flipBodyAxis=function(e,t){this.geometry.flip(e,t),this.geometry.invert()},Qo.prototype.bodyCentroid=function(){const e=Yo.create();let t=0;for(let o of this.geometry.vertices)Yo.add(e,e,o),++t;return t>0&&Yo.scale(e,e,1/t),e},Qo.prototype.weldableVertex=function(e){if(1==this.selectedSet.size){const t=this.selectedSet.values().next().value.outEdge;let o=t;do{if(o.destination()===e)return o;o=o.pair.next}while(o!==t)}return!1},Qo.prototype.weldVertex=function(e){this.selectVertex(e.origin),this.selectVertex(e.destination());let t=this.geometry.collapseEdge(e);return this.updateAffected(),t},Qo.prototype.undoWeldVertex=function(e){this.geometry.restoreCollapseEdge(e),this.selectVertex(e.hEdge.destination()),this.selectVertex(e.hEdge.origin),this.updateAffected()},Qo.prototype.intrudeFace=function(){const e={};if(0==this.selectedSet.size)return e;e.dissolve=this.dissolveSelectedFace();const t=new Map,o=e=>{let o=t.get(e);return o||(o=this.geometry.addVertex(e),t.set(e,o)),o.index},n=[],r=[],i=Array.from(this.geometry.faces);for(let e of i){const t=[];for(let n of e.hEdges())t.push(o(n.origin));if(this.selectedSet.has(e)){let o,n,i=0;for(let s of e.hEdges()){const e=s.origin.index,a=t[i];i>0&&r.push([o,e,a,n]),++i,o=e,n=a}r.push([o,e.halfEdge.origin.index,t[0],n])}else t.reverse(),n.push(this.geometry.addPolygon(t,Tt.default))}this.updateAffected(),e.holed=this.holeSelectedFace();for(let e of n)this.selectFace(e);e.invert=n,e.connect=[];for(let t of r)e.connect.push(this.geometry.addPolygon(t,Tt.default));return this.updateAffected(),e},Qo.prototype.undoIntrudeFace=function(e){for(let t of e.connect)this.geometry.makeHole(t);for(let t of e.invert)this.selectFace(t);const t=new Set;for(let o of e.invert){for(let e of o.hEdges())this.geometry._freeVertex(e.origin),t.add(e.wingedEdge);this.geometry._freePolygon(o)}for(let e of t)this.geometry._freeEdge(e.left);this.undoHoleSelectedFace(e.holed),this.undoDissolveFace(e.dissolve)},Qo.prototype.holeSelectedFace=function(){const e=new Set(this.selectedSet),t=[];for(let o of e)this.selectFace(o),t.push(this.geometry.makeHole(o));return t},Qo.prototype.undoHoleSelectedFace=function(e){for(let t of e){const e=this.geometry.undoHole(t);this.selectFace(e)}},Qo.prototype.loopCut=function(){const e=new Set(this.geometry.faces);let t;const o=n=>{t.add(n),e.delete(n);for(let t of n.hEdges())!this.selectedSet.has(t.wingedEdge)&&e.has(t.pair.face)&&o(t.pair.face)};let n=[];for(let r of this.selectedSet)for(let i of r)e.has(i.face)&&(t=new Set,o(i.face),n.push(t));if(n.length<2)return geometryStatus("less than 2 partitions"),null;n=n.sort((e,t)=>e.size-t.size);const r=new Set(this.selectedSet);for(let e of r)this.selectEdge(e.left);const i={separateCages:[],fillFaces:[],contourLoops:[],selectedSet:r},s=new Set;for(let e=0;e<n.length;++e){const t=n[e];let o=[],r=this;if(e!==n.length-1){let n=Dt.findContours(t);for(let a of n)if(a.length>0&&!s.has(a[0].outer.face)){this.geometry.liftContour(a);let n=this.geometry._createPolygon(a[0].outer,a.size);n._assignFace(),o.push(n),r=this.detachFace(t,e),n=r.geometry._createPolygon(a[0].inner.pair,a.size),n._assignFace(),r.selectedSet.add(n),i.contourLoops.push(a)}}for(let e of s)r.geometry.faces.has(e)&&(r.selectedSet.add(e),s.delete(e));r.dissolveSelectedFace(),i.fillFaces=i.fillFaces.concat(Array.from(r.selectedSet)),r.selectedSet=new Set;for(let e of o)s.add(e);r!==this&&i.separateCages.push(r)}return this.updateAffected(),i},Qo.prototype.undoLoopCut=function(e){this.merge(e.separateCages);for(let t of e.fillFaces)this.geometry.removePolygon(t);for(let t of e.contourLoops)this.geometry.weldContour(t);for(let t of e.selectedSet)this.selectEdge(t.left);this.updateAffected()},Qo.prototype.getSelectedFaceContours=function(){let e={};e.edgeLoops=Dt.findContours(this.selectedSet),e.edges=new Set;for(let t of e.edgeLoops)for(let o of t)e.edges.add(o.outer.wingedEdge);return e},Qo.prototype.liftFace=function(e,t){e.extrudeEdges=this.geometry.liftAndExtrudeContours(e.edgeLoops),this.updateAffected();const o=e.extrudeEdges.length;for(let n=0;n<o;++n){const r=e.extrudeEdges[n];if(r.next.wingedEdge===t.wingedEdge){this.geometry.collapseEdge(r),n===o-1?(this.geometry.collapseEdge(e.extrudeEdges[0]),e.extrudeEdges=e.extrudeEdges.slice(1,o-1)):(this.geometry.collapseEdge(e.extrudeEdges[n+1]),e.extrudeEdges.splice(n,2));break}}this.updateAffected();const n=this._resetSelectFace();for(let e of n.selectedFaces)this.selectFace(e);return e},Qo.prototype.mirrorFace=function(){const e=this.getSelectedSorted(),t=Wo.create(),o=new Set,n=new Set,r=new Map;function i(e){r.clear();for(let t of e.hEdges())r.set(t.origin,t.origin),o.add(t.origin),n.add(t.wingedEdge);!function(e,t,o){const n=-st.dot(t,o);e[0]=-2*t[0]*t[0]+1,e[1]=-2*t[1]*t[0],e[2]=-2*t[2]*t[0],e[3]=0,e[4]=-2*t[0]*t[1],e[5]=-2*t[1]*t[1]+1,e[6]=-2*t[2]*t[1],e[7]=0,e[8]=-2*t[0]*t[2],e[9]=-2*t[1]*t[2],e[10]=-2*t[2]*t[2]+1,e[11]=0,e[12]=-2*t[0]*n,e[13]=-2*t[1]*n,e[14]=-2*t[2]*n,e[15]=1}(t,e.normal,e.halfEdge.origin)}const s=e=>{let o=r.get(e);return o||(o=this.geometry.addVertex(e),Yo.transformMat4(o,o,t),r.set(e,o)),o.index},a=Array.from(this.geometry.faces),l=[];for(let t of e){i(t);const e=[];for(let o of a)if(o!==t){const t=[];for(let e of o.hEdges())t.push(s(e.origin));t.reverse(),e.push(t)}l.push(e)}const c=[];for(let t=0;t<e.length;++t){const o=e[t];this.selectFace(o);const n=this.geometry.makeHole(o),r=l[t],i=[];for(let e of r)i.push(this.geometry.addPolygon(e,Tt.default));c.push({holed:n,newMirrors:i})}return this.updateAffected(),{mirrorGroups:c,protectVertex:o,protectWEdge:n}},Qo.prototype.undoMirrorFace=function(e){const t=new Set,o=[];for(let n of e.mirrorGroups){for(let o of n.newMirrors){for(let n of o.hEdges())e.protectVertex.has(n.origin)||this.geometry._freeVertex(n.origin),e.protectWEdge.has(n.wingedEdge)||t.add(n.wingedEdge);this.geometry._freePolygon(o)}o.push(n.holed)}for(let o of e.protectVertex)o.restructure(t);for(let e of t)this.geometry._freeEdge(e.left);this.undoHoleSelectedFace(o),this.updateAffected()},Qo.prototype.cornerEdge=function(){const e=this.getSelectedSorted(),t=[],o=[],n=[],r=[],i=Yo.create();for(let s of e){let e,a=s.left;if(a.face&&(5==a.face.numberOfVertex?(e=s.right,e.face&&3!==e.face.numberOfVertex&&(e=null)):3===a.face.numberOfVertex&&(e=a,a=s.right,a.face&&5!==a.face.numberOfVertex&&(a=null))),e&&a){t.push(e.face),t.push(a.face),Yo.add(i,e.origin,a.origin),Yo.scale(i,i,.5);let s=this.geometry.splitEdge(a,i);o.push(a.origin),n.push(s.pair);let l=this.geometry.insertEdge(s,a.next.next.next);r.push(l.pair),t.push(l.face)}}let s=new Float32Array(3*r.length);const a=new rt(s);for(let e of r)Yo.sub(a,e.origin,e.destination()),Yo.normalize(a,a),a.inc();const l=this.snapshotPosition(o,s);this.updateAffected();for(let e of n)this.selectEdge(e);return l.splitEdges=n,l.dissolveEdges=r,l},Qo.prototype.undoCornerEdge=function(e){for(let t of e.dissolveEdges)this.geometry.removeEdge(t);for(let t of e.splitEdges)this.selectEdge(t),this.geometry.collapseEdge(t);this.updateAffected()},Qo.prototype.slideEdge=function(){const e=this.snapshotSelectionEdge(),t=[[0,0,-1],[0,1,0],[1,0,0],[0,0,1],[0,-1,0],[-1,0,0]],o=new Map,n=Yo.create(),r=Yo.create(),i=Yo.create(),s=Yo.create(),a=Yo.create();for(let l of e.wingedEdges){l.getNormal(i),Yo.sub(s,l.left.origin,l.right.origin),Yo.normalize(s,s),Yo.cross(a,s,i),Yo.normalize(a,a);let e=0,c=-1;for(let o=0;o<6;++o){let n=Yo.dot(t[o],a);n>c&&(c=n,e=o)}e>2&&Yo.negate(s,s);for(let e of l){let t=o.get(e.origin);t||(t={positive:Yo.create(),negative:Yo.create()},o.set(e.origin,t));const a=e.prev(),l=e.pair.next;Yo.sub(n,a.origin,e.origin);let c=ft(s,i,n);Yo.sub(r,l.destination(),e.origin),c>ft(s,i,r)?(Yo.negate(r,r),Yo.add(t.positive,t.positive,n),Yo.add(t.negative,t.negative,r)):(Yo.negate(n,n),Yo.add(t.positive,t.positive,r),Yo.add(t.negative,t.negative,n))}}const l=[],c=new Float32Array(3*o.size),d=new rt(c),u=new Float32Array(3*o.size),h=new rt(u);for(const[e,t]of o)l.push(e),Yo.copy(d,t.positive),Yo.normalize(d,d),d.inc(),Yo.copy(h,t.negative),Yo.normalize(h,h),h.inc();const f=this.snapshotPosition(l,c);return f.directionPositive=c,f.directionNegative=u,f},Qo.prototype.positiveDirection=function(e){e.direction=e.directionPositive},Qo.prototype.negativeDirection=function(e){e.direction=e.directionNegative},Qo.prototype.planeCuttableFace=function(e){for(let t of this.bvh.root.intersectBound(e))if(this.selectedSet.has(t))for(let o of t.hEdges()){const t=ht(null,e,o);if(t>0&&t<1)return!0}return!1},Qo.prototype._planeCutFace=function(e){const t=new Set,o=[],n=Yo.create();for(let r of e){const e=[];for(let t of this.bvh.root.intersectBound(r))this.selectedSet.has(t)&&e.push(t);e.sort((e,t)=>e.index-t.index);const i=[],s=new Set;for(let t of e)for(let e of t.hEdges())s.has(e.wingedEdge)||(i.push(e),s.add(e.wingedEdge));for(let e of i){const i=ht(n,r,e);if(0==i)t.add(e.origin);else if(i>0&&i<1){let r=this.geometry.splitEdge(e,n);o.push(r.pair),t.add(e.origin)}}}return this.updateAffected(),{selectedFaces:this.selectedSet,vertices:t,halfEdges:o}},Qo.prototype.planeCutFace=function(e){return this._planeCutFace([e])},Qo.prototype.planeCutBody=function(e){const t=this._planeCutFace([e]);return{body:t.selectedFaces,vertices:t.vertices,halfEdges:t.halfEdges}},Qo.prototype.sliceBody=function(e,t){const o=Yo.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=Yo.fromValues(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);this.geometry.getExtent(o,n);const r=Yo.create();Yo.sub(r,n,o);const i=[],s=Yo.create(),a=t-1;for(let t=1;t<=a;++t)Yo.lerp(s,o,n,t/(a+1)),i.push(xt.fromNormalPoint(e,s));const l=this._planeCutFace(i);return{body:l.selectedFaces,vertices:l.vertices,halfEdges:l.halfEdges}},Qo.prototype.getBodySelection=function(e,t){this.geometry.getExtent(t.min,t.max);for(let t of this.selectedSet)e.push(t)},Qo.prototype.makeHolesFromBB=function(e){const t=[];for(let o of e)this.selectedSet.delete(o),o.isLive()&&t.push(this.geometry.makeHole(o));return this.updateAffected(),t},Qo.findWeldContours=function(e){const t=new Map,o=[];function n(e,n){let r;return e.cage===n.cage?t.has(e.cage)?r=t.get(e.cage):(r=[],o.push(r),r.push(e.cage),o.set(e.cage,r),o.set(n.cage,r)):t.has(e.cage)?(r=t.get(e.cage),t.has(n.cage)||(t.set(n.cage,r),r.push(n.cage))):t.has(n.cage)?(r=t.get(n.cage),t.set(e.cage,r),r.push(e.cages),loopUse.push()):(r=[],o.push(r),r.push(e.cage,n.cage),t.set(e.cage,r),t.set(n.cage,r)),r}const r=[],i=new Map,s=Dt.findContours(e.selection);for(let t of s){const o=e.pair.get(t[0].outer),s=e.pair.get(o.hEdge);if(i.has(o.hEdge)){if(i.get(o.hEdge).length!==t.length)return!1;for(let o=0;o<t.length;++o){let n=e.pair.get(t[o].outer);if(!e.pair.has(n.hEdge))return!1;t[o].inner=n.hEdge.pair}r.push({combine:n(o,s),edgeLoop:t})}else for(let e=0;e<t.length;++e){const o=t[e].outer;i.set(o,t)}}return{combineCages:o,edgeLoops:r}},Qo.weldableFace=function(e,t,o){if(e.polygon.numberOfVertex!==t.polygon.numberOfVertex)return!1;if(Yo.dot(e.polygon.normal,t.polygon.normal)>0)return!1;const n=o*o;if(Yo.sqrDist(e.center,t.center)>n)return!1;if(Math.abs(e.radius-t.radius)>o)return!1;const r=[];for(let e of t.polygon.hEdges())r.unshift(e);for(let t of e.polygon.hEdges())for(let e=0;e<r.length;++e){let o=t,i=r[e],s=[],a=e;do{if(Yo.sqrDist(o.origin,i.destination())>n){s=void 0;break}s.push({target:o,source:i}),o=o.next,a=++a%r.length,i=r[a]}while(o!==t);if(s)return s}return!1},Qo.findOverlapFace=function(e,t,o){const n=new Set,r=new Set,i=new Map;for(let s=0;s<t.length;++s){const a=t[s];if(!n.has(a))for(let l=s+1;l<t.length;l++){const s=t[l];if(s.isLive()&&!n.has(s)){if(Math.abs(a.center[e[0]]-s.center[e[0]])>o)break;const t=Qo.weldableFace(a,s,o);if(t){n.add(s),n.add(a),r.add(s.polygon),r.add(a.polygon);for(let e of t)i.set(e.target,{hEdge:e.source,cage:s.octree.bvh}),i.set(e.source,{hEdge:e.target,cage:a.octree.bvh})}}}}return{pair:i,merged:n,selection:r}},Qo.weldHole=function(e){const t=new Map;for(let o of e.merged){let e=t.get(o.octree.bvh);void 0===e&&(e=[],t.set(o.octree.bvh,e)),e.push(o)}const o=[];for(let[e,n]of t)o.push([e,e.makeHolesFromBB(n)]),e.updateAffected();return o},Qo.undoWeldHole=function(e){for(let[t,o]of e){for(let e of o)t.geometry.undoHole(e);t.updateAffected()}},Qo.weldBody=function(e,t){const o=[];for(let{combine:n,edgeLoop:r}of t.edgeLoops){const t=e.get(n);t.combine.geometry.weldContour(r),t.combine.updateAffected(),t.preview=t.combine,t.snapshot||(t.snapshot={vertices:new Set});for(let e of r)t.snapshot.vertices.add(e.outer.origin);o.push([t.preview,r])}return o},Qo.undoWeldBody=function(e){for(let[t,o]of e)t.geometry.restoreContour(o),t.updateAffected()},Qo.prototype.undoCloseCrack=function(e){this.makeHolesFromBB(e.mesh);for(let t of e.borderPolygon)this.geometry.undoHole(t);this.updateAffected()},Qo.prototype.closeCrack=function(){const e=this._resetSelectEdge();let t=new Set;for(let o of e.wingedEdges)t.add(o.left.origin),t.add(o.right.origin);t=Array.from(t).sort((function(e,t){for(let o=0;o<3;++o){if(e[o]<t[o])return-1;if(e[o]>t[o])return 1}return 0}));const o=new Map,n=[];let r;for(;r=t.pop();){const e={pt:[r[0],r[1],r[2]],count:1,vert:r};n.push(e),o.set(r,e);for(let n=t.length-1;n>=0;--n){const i=t[n],s=Rt.isOverlap(i,r);if(s>0)o.set(i,e),Yo.add(e.pt,e.pt,i),e.count++,t.splice(n,1);else if(s<0)break}}let i=new Set;for(let[e,t]of o)if(t.count>1)for(let t of e.edgeRing())t.face&&i.add(t.face);const s=[];for(let e of i){let t=[];for(let n of e.hEdges()){let e=o.get(n.origin);e?t.push(e.vert.index):t.push(n.origin.index)}s.push(t)}const a={mesh:[]};a.borderPolygon=this.makeHolesFromBB(i).reverse();for(let e=0;e<n.length;++e){const t=n[e];Yo.scale(t.pt,t.pt,1/t.count),t.vert.isLive()||this.geometry.addVertex(t.pt,t.vert)}for(let e of s){let t=this.geometry.addPolygon(e);t&&a.mesh.push(t)}return this.updateAffected(),a};class en extends Pe{constructor(e){super(),this.previewCage=e}free(){ui(this.previewCage),this.previewCage.freeBuffer()}doIt(){this.undoEmpty&&(this.previewCage.emptyUndo(this.undoEmpty),this.undoEmpty=null),di(this.previewCage)}undo(){ui(this.previewCage),this.undoEmpty=this.previewCage.empty()}}class tn{constructor(e,t){e&&(this.importMenuText={name:e[0],ext:e[1]}),t&&(this.exportMenuText={name:t[0],ext:t[1]})}createCage(e=""){return function(e){const t=new Qo(ii.draftBench);return t.name=e,t}(e)}createGroup(e=""){return function(e){const t=new Zo;return t.name=e,t}(e)}createMaterial(e){return Tt.create(e)}createTexture(e,t){return ai(e,t)}async export(e,t,o){return this.saveAsync=o,this._reset(),this.workingFiles.selected=t,this._export(e,t.root).then(([e,n])=>(t.uploadBlob(e),n&&o(t.root+"."+n.ext).then(e=>{e.uploadBlob(n.blob)}),this.workingFiles))}async import(e,t){return this.loadAsync=t,this._reset(),this.files=e,this.workingFiles.selected=e[0],this._import(e[0]).then(e=>{if(e){let t=[];for(let o of e.world){let e=new en(o);t.push(e),e.doIt()}t.length>1?xi(t):t.length>0&&yi(t[0]);for(let t of e.materialCatalog)si(t);fi();let o={vertices:0,edges:0,faces:0,boundary:0};for(let t of e.world)for(let e of t.getCage())e.geometry.getStat(o);geometryStatus(`${o.vertices} vertices, ${o.edges} edges, ${o.faces} faces, ${o.boundary} boundary, ${this.non_manifold.length} non-manifold`)}const t=this.workingFiles;return this._reset(),Promise.resolve(t)})}_readAuxFiles(){}_reset(){this.objs=[],this.obj=null,this.objView=null,this.materialCatalog=new Map,this.currentMaterial=Tt.default,this.realVertices=[],this.texCoords=[],this.polygonCount=0,this.vertexCount=0,this.non_manifold=[],this.files=[],this.workingFiles={selected:null,linked:new Map}}static decodeText(e){return new TextDecoder("utf-8").decode(e)}static addLoadStore(e){(e.importMenuText||e.exportMenuText)&&tn.LOADSTORE.add(e)}static setDefault(e){tn.DEFAULT&&tn.LOADSTORE.add(tn.DEFAULT),tn.DEFAULT=e,tn.LOADSTORE.delete(e)}}tn.LOADSTORE=new Set,tn.DEFAULT=null;const on={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},nn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};class rn extends tn{constructor(){super(["GLTF","gltf, glb"]),this.cache={}}extension(){return"gltf"}fileTypes(){return["gltf","glb"]}_reset(){super._reset(),this.def=new Map,this.count={appearance:0,cage:0}}async _import(e){const t=await e.arrayBuffer();if("glTF"===tn.decodeText(new Uint8Array(t,0,4))?this.parseGLB(t):this.json=JSON.parse(tn.decodeText(t)),this.vertex=new Map,this.uv=new Map,void 0===this.json.asset||this.json.asset.version[0]<2)throw new Error("GLTF: Unsupported asset. Version < 2.0.");if(void 0===this.json.scene)throw new Error("No Scene");this.loadBuffers(),this.loadImages();return{world:await this._parse("scenes",this.json.scene),materialCatalog:Array.from(this.cache.materials.values())}}_parse(e,t){if("function"==typeof this[e]){if("undefined"!==t){let o;if(void 0===this.cache[e]?this.cache[e]=new Map:o=this.cache[e].get(t),void 0===o){const n=this.json[e]||[];n.length>t&&(o=this[e](n[t]),this.cache[e].set(t,o))}return o}console.log("no index")}}parseGLB(e){const t=new DataView(e,0);if(t.getUint32(4,!0)<2)throw new Error("GLTF: Don't support 1.0 file.");let o=12;for(;o<t.byteLength;){let n=t.getUint32(o,!0);o+=4;let r=t.getUint32(o,!0);if(o+=4,1313821514===r){const t=new Uint8Array(e,o,n);this.json=JSON.parse(tn.decodeText(t))}else 5130562===r&&(this._bin=e.slice(o,o+n));o+=n}if(!this.json)throw new Error("GLTF: Invalid file, no JSON Chunk")}loadBuffers(){const e=this.json.buffers||[];this.cache.buffers=new Map;let t=0;for(let o of e)this.cache.buffers.set(t++,this.buffers(o))}loadImages(){const e=this.json.images||[];this.cache.images=new Map;let t=0;for(let o of e)this.cache.images.set(t++,this.images(o))}async getBuffer(e){if(e<0||e>=this.cache.buffers.length)throw new Error("out of range buffer index");let t=this.cache.buffers.get(e);return t instanceof ArrayBuffer||(t=await t,this.cache.buffers.set(e,t)),t}buffers(e){return e.uri?this.loadAsync(e.uri).then(e=>e[0].arrayBuffer()):Promise.resolve(this._bin)}images(e){return e.uri?{loading:this.loadAsync(e.uri).then(e=>e[0].image()),uri:e.uri}:{loading:this._parse("bufferViews",e.bufferView).then(t=>{const o=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),n=new Blob([o],{type:e.mimeType}),r=document.createElement("img");return r.src=URL.createObjectURL(n),r.onload=function(){URL.revokeObjectURL(this.src)},r}),uri:"Internal"}}samplers(e){return e}textures(e){let t=this._parse("samplers",e.sampler),o=this.cache.images.get(e.source),n=this.createTexture(o.uri,t);return o.loading.then(e=>(e.onload=()=>{n.setImage(e)},e)),n}materials(e){const t=this.createMaterial(e.name||"NoName"),o=e.pbrMetallicRoughness,n={baseColor:[1,1,1],opacity:1};return o&&(Array.isArray(o.baseColorFactor)&&(n.baseColor=[o.baseColorFactor[0],o.baseColorFactor[1],o.baseColorFactor[2]],n.opacity=o.baseColorFactor[3]),o.baseColorTexture&&(t.baseColorTexture=this._parse("textures",o.baseColorTexture.index)),o.metallicRoughnessTexture&&(t.roughnessTexture=this._parse("textures",o.metallicRoughnessTexture.index)),o.metallicFactor&&(n.metallic=o.metallicFactor),o.roughness&&(n.roughness=o.roughnessFactor)),e.normalTexture&&(t.normalTexture=this._parse("textures",e.normalTexture.index)),e.occlusionTexture&&(t.occlusionTexture=this._parse("textures",e.occlusionTexture.index)),e.emissiveTexture&&(t.emissionTexture=this._parse("textures",e.emissiveTexture.index)),e.emissiveFactor&&(n.emission=e.emissiveFactor),t.setValues(n),t}async accessors(e){const t=nn[e.type],o=on[e.componentType],n=await this._parse("bufferViews",e.bufferView),r=o.BYTES_PER_ELEMENT*t,i=(e.byteOffset||0)+n.byteOffset,s=n.byteStride||r,a=e.count*t;if(s!==r)throw new UserException("No interleaved array support");return new o(n.buffer,i,a)}async bufferViews(e){return e.byteOffset=e.byteOffset||0,e.buffer=await this.getBuffer(e.buffer),e}addTriangles(e,t,o,n){if(e)for(let r=0;r<e.length;r+=3){let i=this.geometry.addPolygon([t[e[r]],t[e[r+1]],t[e[r+2]]],n).halfEdge;o&&(i.setUV(o[e[r]]),i=i.next,i.setUV(o[e[r+1]]),i=i.next,i.setUV(o[e[r+2]]))}}async meshes(e){const t=this.createCage(e.name);this.geometry=t.geometry;for(let t of e.primitives){const e=t.attributes||{};let o,n=await this._parse("accessors",t.indices),r=await this._parse("materials",t.material),i=await this._parse("accessors",e.POSITION),s=this.vertex.get(i);if(void 0===s){s=[];for(let e=0;e<i.length;e+=3)s.push(this.geometry.addVertex([i[e],i[e+1],i[e+2]]).index);this.vertex.set(i,s)}if(e.TEXCOORD_0){let t,n=await this._parse("accessors",e.TEXCOORD_0);if(e.TEXCOORD_1&&(t=await this._parse("accessors",e.TEXCOORD_1)),o=this.uv.get(n),void 0===o){o=[];for(let e=0;e<n.length;e+=2){let r=It.uv.reserve();o.push(r),It.uv.setChannel(r,0,[n[e],n[e+1]]),t&&It.uv.setChannel(r,1,[t[e],t[e+1]])}this.uv.set(n,o)}}void 0!==t.mode&&4!==t.mode||this.addTriangles(n,s,o,r)}return t}async nodes(e){if(void 0!==e.children){let t=this.createGroup(e.name);for(let o of e.children){let e=await this._parse("nodes",o);t.insert(e)}return t}if(void 0!==e.mesh)return await this._parse("meshes",e.mesh);throw new Error("unable to handle nodes")}async scenes(e){let t=[];for(let o of e.nodes)t.push(await this._parse("nodes",o));return t}}const{vec3:sn,vec4:an,mat4:ln}=glMatrix;let cn,dn,un,hn,fn=!0;function pn(){fn=!0}class gn{constructor(e,t,o,n){this.lineEnd={x:null,y:null,z:null};for(let e of Object.keys(this.lineEnd))this.lineEnd[e]=document.createElementNS("http://www.w3.org/2000/svg","text"),this.lineEnd[e].style.fontSize="18px",this.lineEnd[e].style.fontFamily="Arial",this.lineEnd[e].textContent=e,hn.appendChild(this.lineEnd[e]);this.camera=new Ue,this.viewport=e,this.canvasHeight=e[3],this._computeAxes(),this.isOrtho=t,this.axesShow=o,this.groundplaneShow=n}setViewport(e,t,o,n,r){this.viewport=[e,t,o,n],this.canvasHeight=r,this.isRedraw=!0}loadMatrices(e,t){return this.projection(e.projection,ln.create()),e.useSceneLights=this.modelView(e.modelView,t),e}projection(e,t){const o=this.viewport,n=o[2]/o[3],r=this.isOrtho;!r&&this.camera.alongAxis&&(r=Dr.force_ortho_along_axis);const i=ln.create();if(r){const e=this.camera.distance*Math.tan(this.camera.fov*Math.PI/180/2);ln.ortho(i,-e*n,e*n,-e,e,this.camera.zNear,this.camera.zFar)}else ln.perspective(i,this.camera.fov,n,this.camera.zNear,this.camera.zFar);ln.mul(e,t,i)}modelView(e,t=!1){let o=!1;return t&&(o=Dr.useSceneLights),ln.fromTranslation(e,sn.fromValues(this.camera.panX,this.camera.panY,-this.camera.distance)),ln.rotateX(e,e,this.camera.elevation*Math.PI/180),ln.rotateY(e,e,this.camera.azimuth*Math.PI/180),ln.translate(e,e,this.camera.origin),o}screenPointToWorld(e){const t=this.viewport,o=t[0],n=t[1],r=o+t[2],i=n+t[3];let s=e.x,a=this.canvasHeight-e.y;s<o&&(s=o),s>r&&(s=r),a<n&&(a=n),a>i&&(a=i);const l={modelView:ln.create(),projection:ln.create()};return this.loadMatrices(l,!1),[mt(s,a,0,l.modelView,l.projection,t),mt(s,a,1,l.modelView,l.projection,t)]}worldToScreenPoint(e){const t={modelView:ln.create(),projection:ln.create()};this.loadMatrices(t,!1);const o=[e[0],e[1],e[2],1];return Vec4.transformMat4(o,o,t.modelView),Vec4.transformMat4(o,o,t.projection),o[0]/=o[3],o[1]/=o[3],[(.5*o[0]+.5)*this.viewport[2]+this.viewport[0],(-.5*o[1]+.5)*this.viewport[3]+this.viewport[1]]}isInside(e){const t=this.viewport,o=t[0],n=t[1],r=o+t[2],i=n+t[3],s=e.x,a=this.canvasHeight-e.y;return s>=o&&s<=r&&a>=n&&a<=i}makeCurrent(e){if(e){let e=document.querySelector('input[id="toggleGroundFor"]');e&&(e.checked=this.groundplaneShow),e=document.querySelector('input[id="toggleAxesFor"]'),e&&(e.checked=this.axesShow),e=document.querySelector('input[id="toggleOrthoFor"]'),e&&(e.checked=this.isOrtho)}}orthogonalView(e){this.isOrtho=e,this.isRedraw=!0}showAxes(e){this.axesShow=e,this.isRedraw=!0,e||this._hideText()}showGroundplane(e){this.groundplaneShow=e,this.isRedraw=!0}selectionBox(e,t){let o=e.x,n=t.x;e.x>t.x&&(o=t.x,n=e.x);let r=e.y,i=t.y;e.y>t.y&&(r=t.y,i=e.y);const[s,a]=this.screenPointToWorld({x:o,y:i}),[l,c]=this.screenPointToWorld({x:o,y:r}),[d,u]=this.screenPointToWorld({x:n,y:r}),[h,f]=this.screenPointToWorld({x:n,y:i});return new yt(xt.fromPoints(l,s,a),xt.fromPoints(h,d,u),xt.fromPoints(d,l,c),xt.fromPoints(s,h,f),xt.fromPoints(h,s,l),xt.fromPoints(f,u,c))}render(e,t){const o=e.getViewport();if(this.isRedraw||this.camera.isModified||fn){e.viewport(...this.viewport),e.scissor(...this.viewport);const o=et(kr.geometryBackground);e.clearColor(o[0],o[1],o[2],o[3]),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.polygonOffset(0,0),e.enable(e.POLYGON_OFFSET_FILL);const n=this.loadMatrices(e,!0);(this.camera.isModified||this.isRedraw)&&(this.camera.isModified=!1,this.isRedraw=!1,this._computeGround(n.projection,n.modelView));const r=this._renderGround(e,n.projection,n.modelView);this._renderAxes(e,n.projection,n.modelView),this._renderMiniAxes(e,n.modelView),t(e),this._renderAxisLetter(e,r)}e.viewport(...o)}hide(){this._hideText()}_hideText(){for(let e of Object.keys(this.lineEnd))"none"!==this.lineEnd[e].style.display&&(this.lineEnd[e].style.display="none")}_renderASCII(e,t,o,n){if(function(e,t){for(var o,n=0,r=1,i=[e[3]+e[0],e[3]-e[0],e[3]+e[1],e[3]-e[1],e[3]+e[2],e[3]-e[2]],s=[t[3]+t[0],t[3]-t[0],t[3]+t[1],t[3]-t[1],t[3]+t[2],t[3]-t[2]],a={pt0:0,pt1:0},l=0;l<6;++l){var c=(i[l]<0)<<l;a.pt0|=c,a.pt1|=(s[l]<0)<<l}if(0!=(a.pt0&a.pt1))return!1;if(0==(a.pt0|a.pt1))return!0;for(l=0;l<6;l++)if(s[l]<0?(o=i[l]/(i[l]-s[l]),r=Math.min(r,o)):i[l]<0&&(o=i[l]/(i[l]-s[l]),n=Math.max(n,o)),n>r)return!1;if(c=at.create(),0!=a.pt0)for(l=0;l<4;++l)c[l]=e[l]+n*(t[l]-e[l]);if(0!=a.pt1)for(l=0;l<4;++l)t[l]=e[l]+r*(t[l]-e[l]);return e=c,!0}(o,n)){const o=this.viewport,r=Math.trunc((.5*n[0]/n[3]+.5)*(o[2]-20)+10),i=Math.trunc((.5*n[1]/n[3]+.5)*(o[3]-16)+7);this.lineEnd[e].setAttributeNS(null,"x",r+o[0]),this.lineEnd[e].setAttributeNS(null,"y",this.canvasHeight-(i+o[1])),this.lineEnd[e].setAttributeNS(null,"fill",t)}}_renderAxisLetter(e,t){if(this.axesShow){for(let e of Object.keys(this.lineEnd))"none"===this.lineEnd[e].style.display&&(this.lineEnd[e].style.display="block");var o=vt(an.fromValues(0,0,0,1),e.modelView,e.projection);t+=1;let n=vt(an.fromValues(t,0,0,1),e.modelView,e.projection),r=vt(an.fromValues(0,t,0,1),e.modelView,e.projection),i=vt(an.fromValues(0,0,t,1),e.modelView,e.projection);this._renderASCII("x",kr.colorX,o,n),this._renderASCII("y",kr.colorY,o,r),this._renderASCII("z",kr.colorZ,o,i)}}_renderAxes(e,t,o){this.axesShow&&(e.useProgram(dn.handle),e.uniformMatrix4fv(dn.uPMatrix,!1,t),e.uniformMatrix4fv(dn.uMVMatrix,!1,o),e.setBufferAndAttrib(this.axesVBO.position,dn.vertexPosition),e.setBufferAndAttrib(this.axesVBO.color,dn.vertexColor),e.drawArrays(e.LINES,0,this.axesVBO.length))}_renderMiniAxes(e,t){if(Dr.showMiniAxis){let o=this.viewport[2]/this.viewport[3];const n=ln.create();ln.copy(n,t),n[12]=.11-o,n[13]=-.89,n[14]=0;const r=ln.create();ln.ortho(r,-o,o,-1,1,1e-5,1e7);const i=un.length;e.useProgram(dn.handle),e.uniformMatrix4fv(dn.uPMatrix,!1,r),e.uniformMatrix4fv(dn.uMVMatrix,!1,n),e.setBufferAndAttrib(un.position,dn.vertexPosition),e.setBufferAndAttrib(un.color,dn.vertexColor),e.drawArrays(e.LINES,0,i)}}_renderGround(e,t,o){if(this.groundplaneShow){const r=et(kr.gridColor);var n=this.groundGridVBO.length;this.axesShow&&(n-=4),e.useProgram(cn.progHandle),e.setBufferAndAttrib(this.groundGridVBO.position,cn.attribute.position.loc),e.uniform4fv(cn.uniform.uColor.loc,r),e.uniformMatrix4fv(cn.transform.projection,!1,t),e.uniformMatrix4fv(cn.transform.worldView,!1,o),e.drawArrays(e.LINES,0,n)}return this.camera.zFar}_computeAxes(){var e,t;this.axesVBO={position:x.createBufferHandle((e=this.camera.zFar,t=[[e,0,0],[0,0,0],[0,0,0],[-e,0,0],[0,e,0],[0,0,0],[0,0,0],[0,-e,0],[0,0,e],[0,0,0],[0,0,0],[0,0,-e]],new Float32Array([].concat.apply([],t)))),color:x.createBufferHandle(function(){const e=[Qe(kr.colorX),Qe(kr.colorY),Qe(kr.colorZ)],t=[Qe(kr.negColorX),Qe(kr.negColorY),Qe(kr.negColorZ)];let o=[];for(let n=0;n<3;n++)o=o.concat(e[n],e[n],t[n],t[n]);return new Float32Array(o)}()),length:12}}_computeGround(e,t){const o=this.viewport[2],n=this.viewport[3],r=function(e,t,o,n){var r=mt(Math.max(e,t),0,0,n,o,[0,0,e,t]),i=1*Math.max(Math.round(Math.max(Math.max(Math.abs(r[0]),Math.abs(r[1])),Math.abs(r[2]))),10);return i*=e/t*.7,Math.round(i)}(o,n,e,t),i=function(e,t,o,n){let r=Math.min(e,t);16*o>r&&(n*=16*o/r);for(var i=[],s=o;s>0;s-=n)i=i.concat([s,0,o],[s,0,-o],[-s,0,o],[-s,0,-o],[o,0,s],[-o,0,s],[o,0,-s],[-o,0,-s]);return i.concat([0,0,o],[0,0,-o],[o,0,0],[-o,0,0])}(o,n,r,1);return this.groundGridVBO={position:x.createBufferHandle(new Float32Array(i)),length:i.length/3},r}}O((function(){x.enable(x.DEPTH_TEST),x.enable(x.CULL_FACE),x.enable(x.SCISSOR_TEST),cn=x.createShaderProgram(je.vertexShader,je.fragShader),dn={handle:x.compileGLSL(He.vertexShader,He.fragShader)},dn.vertexPosition=x.getAttribLocation(dn.handle,"aVertexPosition"),dn.vertexColor=x.getAttribLocation(dn.handle,"aVertexColor"),dn.uPMatrix=x.getUniformLocation(dn.handle,"uPMatrix"),dn.uMVMatrix=x.getUniformLocation(dn.handle,"uMVMatrix"),un=function(e){for(var t=.08,o=.01,n=[].concat([0,0,0],[.1,0,0],[0,0,0],[0,.1,0],[0,0,0],[0,0,.1],[t,0,-o],[.1,0,0],[t,0,o],[.1,0,0],[-o,t,0],[0,.1,0],[o,t,0],[0,.1,0],[-o,0,t],[0,0,.1],[o,0,t],[0,0,.1]),r=[Qe(kr.colorX),Qe(kr.colorY),Qe(kr.colorZ)],i=[],s=[],a=0;a<3;++a)i=i.concat(r[a],r[a]),s=s.concat(r[a],r[a],r[a],r[a]);return i=i.concat(s),{position:new Float32Array(n),color:new Float32Array(i),length:18}}(),un.position=x.createBufferHandle(un.position),un.color=x.createBufferHandle(un.color),hn=document.getElementById("svgUI")}));class mn extends tn{constructor(){super(["Wavefront","obj"],["Wavefront","obj"])}extension(){return"obj"}fileTypes(){return["obj"]}_reset(){super._reset(),this.mtl=new Map}async _export(e,t){let o=1;const n=new Map;let r="#wings3d.net wavefront export\n";r+=`mtllib ${t}.mtl\n`;let i=new Set;for(const t of e){const e=t.geometry;r+="o "+t.name+"\n",r+="\n#vertex total "+e.vertices.size+"\n";for(let t of e.vertices)r+="v "+t[0]+" "+t[1]+" "+t[2]+"\n",n.has(t.index)||n.set(t.index,o++);const s=new Map;for(let t of e.faces){i.add(t.material);let e=s.get(t.material);e||(e=[],s.set(t.material,e)),e.push(t)}for(let[e,t]of s){r+=`\nusemtl ${e.name}\n`,r+="#face list total "+t.length+"\n";for(let e of t){r+="f";for(let t of e.hEdges())r+=" "+n.get(t.origin.index);r+="\n"}}}return[new Blob([r],{type:"text/plain;charset=utf-8"}),{ext:"mtl",blob:vn.exportBlob(i)}]}async _import(e){const t=(await e.text()).match(/^([vfogs]|vt|usemtl|mtllib)(?:\s+(.+))$/gm);if(t){for(let e of t){let t=e.match(/\S+/g),o=t.shift();"function"==typeof this[o]?this[o](t):console.log("unexpected tag: "+o)}return this._readAuxFiles(),{world:this.objs,materialCatalog:Array.from(this.materialCatalog.values())}}return null}_readAuxFiles(){const e=this.workingFiles.linked,t=this.materialCatalog;for(let o of this.mtl)this.loadAsync(o[0]).then(n=>{const r=new vn;r.setMaterialCatalog(t),r.import(n,this.loadAsync),e.set(o[0],n[0])});super._readAuxFiles()}o(e){this.objView=li(),this.obj=this.objView.geometry,this.objs.push(this.objView),this.objView.name=e}g(e){this.objView||(this.objView=li(),this.obj=this.objView.geometry,this.objs.push(this.objView))}s(e){}v(e){const t=this.obj.addVertex(e.slice(0,3));this.realVertices.push(t.index),this.vertexCount++}vt(e){const t=It.uv.reserve();this.texCoords.push(t),It.uv.setChannel(t,0,e.slice(0,2))}f(e){const t=[],o=[];for(let n of e){let e=n.split("/"),r=e[0]-1;if(e.length>1){let t=e[1]-1;o.push(this.texCoords[t])}r>=0&&r<this.realVertices.length?t.push(this.realVertices[r]):console.log("face index out of bound: "+r)}let n=this.obj.addPolygon(t,this.currentMaterial);if(null===n)this.non_manifold.push(this.polygonCount);else{let e=n.halfEdge;if(o.length>0&&o.length===t.length)for(let t=0;t<o.length;++t)e.setUV(o[t]),e=e.next}this.polygonCount++}usemtl(e){const t=e[0];let o=this.materialCatalog.get(t);o||(o=this.createMaterial(t),this.materialCatalog.set(t,o)),this.currentMaterial=o}mtllib(e){let t="";for(let o of e)"\\"===o[o.length-1]?t+=o.replace(/.$/," "):t&&(o=t+o,t=""),t||this.mtl.set(o,null)}}class vn extends tn{constructor(){super(null,null),this.library=new Map,this.textureLibrary=new Map}extension(){return"mtl"}fileTypes(){return["mtl"]}setMaterialCatalog(e){this.catalog=e}static exportBlob(e){let t="#wings3d.net wavefront export\n";for(let o of e){t+=`newmtl ${o.name}\n`,t+=`Kd ${o.pbr.baseColor[0]} ${o.pbr.baseColor[1]} ${o.pbr.baseColor[2]}\n`,t+=`Pr ${o.pbr.roughness}\n`,t+=`Pm ${o.pbr.metallic}\n`,t+=`Ke ${o.pbr.emission[0]} ${o.pbr.emission[1]} ${o.pbr.emission[2]}\n`,t+=`Tf ${1-o.pbr.opacity}\n`}return new Blob([t],{type:"text/plain;charset=utf-8"})}async _import(e){this._reset();const t=(await e.text()).match(/^(newmtl|Ka|Kd|Pr|Pm|ke|Ks|Ns|Tr|d|illum|map_Kd)(?:\s+(.+))$/gm);if(t){for(let e of t){e=e.match(/\S+/g),this[e[0]](e)}for(let[e,t]of this.library){const o=this.catalog.get(e);o&&(o.setValues(Tt.convertTraditionalToMetallicRoughness(t.material)),t.texture.baseColorTexture&&(o.baseColorTexture=t.texture.baseColorTexture))}return{world:[],materialCatalog:[]}}}newmtl(e){const t=e[1];this.current={material:{diffuseMaterial:[.78,.81,.69],ambientMaterial:[.78,.81,.69],specularMaterial:[0,0,0],emissionMaterial:[0,0,0]},texture:{}},this.library.set(t,this.current)}_parseRGB(e){return[parseFloat(e[1])||0,parseFloat(e[2])||0,parseFloat(e[3])||0]}Ka(e){this.current.material.ambientMaterial=this._parseRGB(e)}Kd(e){this.current.material.diffuseMaterial=this._parseRGB(e)}Ke(e){this.current.material.emissionMaterial=this._parseRGB(e)}Ks(e){this.current.material.specularMaterial=this._parseRGB(e)}Ns(e){let t=(parseFloat(e[1])||0)/1e3;this.current.material.shininessMaterial=Math.min(1,Math.max(0,t))}Pr(e){this.current.material.roughnessMaterial=this._parseRGB(e)}Pm(e){this.current.material.metallicMaterial=parseFloat(e)||.1}d(e){this.current.material.opacityMaterial=parseFloat(e[1])||1}Tr(e){this.current.material.opacityMaterial=1-(parseFloat(e[1])||0)}illum(e){}map_Kd(e){function t(e,t){let o=t[e+1],n=t[e+2],r=t[e+3],i=4;return isNaN(n)?(i=2,n=0):isNaN(r)&&(i=3),t.splice(e,i),[o,n]}e.shift();const o={};let n=e.indexOf("-s");n>=0&&(o.scale=t(n,e)),n=e.indexOf("-o"),n>=0&&(o.offset=t(n,e)),n=e.indexOf("-bm"),n>=0&&(o.bumpScale=parseFloat(e[n+1]),e.splice(n,2)),n=e.indexOf("-clamp"),n>=0&&(0===e[n+1].localeCompare("on")&&(o.wrapS=gl.CLAMP_TO_EDGE,o.wrapT=gl.CLAMP_TO_EDGE),e.splice(n,2)),n=e.indexOf("-t"),n>=0&&t(n,e);for(const t of["-cc","-mm","imfchan","texres","blendu","blendv","-boost"])n=e.indexOf(t),n>=0&&e.splice(n,2);const i=e.join("").trim(),s=r(i).join(".");let a=this.textureLibrary.get(s);a||(a=this.createTexture(s,{flipY:!0}),this.loadAsync(i).then(e=>e[0].image()).then(e=>(e.onload=()=>{a.setImage(e)},e)),this.textureLibrary.set(s,a)),this.current.texture.baseColorTexture=a}}function xn(e,t){return e?e.trim().split(/[,\s]+/).map(Number):t}function yn(e,t=0){return e?parseFloat(e):t}function bn(e,t){var o="",n="";return t=t||"\t",e.split(/>\s*</).forEach((function(e){e.match(/^\/\w/)&&(n=n.substring(t.length)),o+=n+"<"+e+">\r\n",e.match(/^<?\w[^>]*[^\/]$/)&&(n+=t)})),o.substring(1,o.length-3)}class Sn extends tn{constructor(){super(["Web3D","x3d"],["Web3D","x3d"])}extension(){return"x3d"}fileTypes(){return["x3d"]}_reset(){super._reset(),this.def=new Map,this.count={appearance:0,cage:0},this.material=[],this.textures=new Map}async _export(e){const t=(new DOMParser).parseFromString("<?xml version=\"1.0\" encoding=\"utf-8\"?>\n         <!DOCTYPE X3D PUBLIC \"ISO//Web3D//DTD X3D 3.3//EN\" \"http://www.web3d.org/specifications/x3d-3.3.dtd\">\n         <X3D profile='Interchange' version='3.3'  xmlns:xsd='http://www.w3.org/2001/XMLSchema-instance' xsd:noNamespaceSchemaLocation =' http://www.web3d.org/specifications/x3d-3.3.xsd '>\n         <head>\n            <meta name='title' content=''/>\n            <meta name='creator' content=''/>\n            <meta name='created' content=''/>\n            <meta name='modified' content=''/>\n            <meta name='description' content=''/>\n            <meta name='generator' content='Wings3D.net, https://www.wings3d.net'/>\n            <meta name='license' content=''/>\n         </head> \n         <Scene></Scene>\n         </X3D>","application/xml"),o=t.querySelector("Scene"),n=new Map;for(let r of e){const e=r.geometry,i=new Map;let s="",a=0;for(let t of e.vertices)i.set(t.index,a++),s=`${s} ${t[0]} ${t[1]} ${t[2]}`;let l=t.createElement("Coordinate");const c=r.name+"Coord";l.setAttribute("DEF",c),l.setAttribute("point",s.trim()),n.set(c,l);let d="",u=0;const h=new Map,f=new Map;for(let t of e.faces){let e=f.get(t.material);e||(e={faces:[],coordIndex:"",uvIndex:""},f.set(t.material,e)),e.faces.push(t);const o=[0,0];for(let n of t.hEdges()){e.coordIndex=`${e.coordIndex} ${i.get(n.origin.index)}`;const t=n.getUV();if(t>0){let r=h.get(t);r||(r=u++,h.set(r),n.getUVCoord(0,o),d+=` ${o[0]} ${o[1]}`),e.uvIndex+=" "+r}}e.coordIndex+=" -1",e.uvIndex&&(e.uvIndex+=" -1")}let p;const g=r.name+"TextureCoord";d&&(p=t.createElement("TextureCoordinate"),p.setAttribute("DEF",g),p.setAttribute("point",d.trim()),n.set(g,p));const m=t.createElement("Group");m.setAttribute("DEF",r.name),o.appendChild(m),n.set(r.name,m);for(const[e,o]of f){const r=t.createElement("Shape");m.appendChild(r);const i=e.name,s=t.createElement("Appearance");r.appendChild(s);const a=t.createElement("PhysicalMaterial");if(s.appendChild(a),n.has(i))s.setAttribute("USE",i);else{n.set(i,s),s.setAttribute("DEF",i);const o=e.pbr;if(a.setAttribute("baseColor",`${o.baseColor[0]} ${o.baseColor[1]} ${o.baseColor[2]}`),a.setAttribute("roughnessFactor",""+o.roughness),a.setAttribute("metallicFactor",""+o.metallic),a.setAttribute("transparency",""+(1-o.opacity)),e.hasBaseColorTexture()){const o=t.createElement("ImageTexture");o.setAttribute("containerField","baseTexture"),o.setAttribute("url",`"${e.baseColorTexture.name}"`);e.baseColorTexture.sampler.flipY||o.setAttribute("flipVertically","true"),a.appendChild(o)}}const d=t.createElement("IndexedFaceSet");r.appendChild(d),d.setAttribute("coordIndex",o.coordIndex.trim()),l||(l=t.createElement("Coordinate"),l.setAttribute("USE",c)),d.appendChild(l),l=null,o.uvIndex&&(d.setAttribute("texCoordIndex",o.uvIndex.trim()),p||(p=t.createElement("TextureCoordinate"),p.setAttribute("DEF",g)),d.appendChild(p),p=null)}}const r=new XMLSerializer;return[new Blob([bn(r.serializeToString(t))],{type:"text/plain;charset=utf-8"}),null]}async _import(e){const t=await e.text(),o=(new DOMParser).parseFromString(t,"application/xml").querySelector("Scene");if(o){let e={group:new wn,coords:new Map};for(let t of o.children)this._parseNode(t,e);return{world:e.group.children,materialCatalog:this.material}}}_parseNode(e,t){"function"==typeof this[e.tagName]&&this[e.tagName](e,t)}_getUse(e){let t=e.getAttribute("USE");return t&&this.def.has(t)?this.def.get(t):null}_getUrl(e){return e.getAttribute("url").match(/"[^"]+"/g)[0].slice(1,-1)}Group(e,t){this.Transform(e,t)}Transform(e,t){const o=new wn;let n=t.group,r=t.cage,i=t.coords,s=t.uv;t.group=o,t.coords=new Map,t.uv=null,t.cage=null;for(const o of e.children)this._parseNode(o,t);if(o.children.length>1){let t=this.createGroup(e.getAttribute("DEF"));for(let e of o.children)t.insert(e);n.insert(t)}else if(t.cage){let o=e.getAttribute("DEF");o&&(t.cage.name=o),n.insert(t.cage)}t.group=n,t.cage=r,t.coords=i,t.uv=s}Shape(e,t){for(const o of e.children)this._parseNode(o,t)}Appearance(e,t){let o=this._getUse(e);if(!o){let t=e.getAttribute("DEF");const n=t;t||(t="Material."+this.count.appearance++),o=this.createMaterial(t),this.material.push(o),n&&this.def.set(t,o)}t.appearance=o;for(const o of e.children)this._parseNode(o,t)}PhysicalMaterial(e,t){let o=this._getUse(e);if(!o){e.getAttribute("DEF");o=e}const n={};let r;(r=e.getAttribute("baseColor"))&&(n.baseColor=xn(r)),(r=e.getAttribute("roughnessFactor"))&&(n.roughness=yn(r)),(r=e.getAttribute("metallicFactor"))&&(n.metallic=yn(r)),(r=e.getAttribute("transparency"))&&(n.opacity=1-r),t.appearance.setValues(n);for(const o of e.children)this._parseNode(o,t)}Material(e,t){let o=this._getUse(e);if(!o){let t=e.getAttribute("DEF");t&&this.def.set(t,e),o=e}const n={};n.diffuseMaterial=xn(e.getAttribute("diffuseColor"),[1,1,1]),n.specularMaterial=xn(e.getAttribute("specularColor"),[0,0,0]),n.shininessMaterial=yn(e.getAttribute("shininess"),0),n.emissionMaterial=xn(e.getAttribute("emissiveColor"),[0,0,0]),n.opacityMaterial=1-yn(e.getAttribute("transparency"),0);const r=Tt.convertTraditionalToMetallicRoughness(n);t.appearance.setValues(r)}ImageTexture(e,t){let o=this._getUse(e);if(!o){const t=this._getUrl(e);if(o=this.textures.get(t),!o){let n=!0;"true"==e.getAttribute("flipVertically")&&(n=!1),o=this.createTexture(t,{flipY:n}),this.loadAsync(t).then(e=>e[0].image()).then(e=>(e.onload=()=>{o.setImage(e)},e)),this.textures.set(t,o)}}let n=e.getAttribute("containerField");n&&(n="baseTexture"==n?"baseColorTexture":null),n&&(t.appearance[n]=o)}IndexedFaceSet(e,t){let o=this._getUse(e);if(o)e=o;else{let t=e.getAttribute("DEF");t&&this.def.set(t,e)}for(const o of e.children)this._parseNode(o,t);const n=t.appearance||Tt.default;let r=0,i=e.getAttribute("coordIndex");i=i.trim().split(/[,\s]+/);let s=e.getAttribute("texCoordIndex");s=s?s.trim().split(/[,\s]+/):Array.from(i);for(let e=0;e<i.length;++e){const o=parseInt(i[e],10);if(-1===o){let o=t.cage.geometry._addPolygon(r,e,i,n).halfEdge;if(t.uv)for(let n=r;n<e;++n)o.setUV(t.uv[s[n]]),o=o.next;r=e+1}else i[e]=t.remapIndex[o]}}Color(e){}ColorRGBA(e){}Coordinate(e,t){let o=e.getAttribute("USE");if(o){if(!t.coords.has(o))throw new Error("TODO: support coordinate instancing.");{let e=t.coords.get(o).cage;t.cage=e.cage,t.remapIndex=e.remapIndex}}else{t.cage=this.createCage(),t.group.insert(t.cage);let o=[];t.remapIndex=o;let n=e,r=n.getAttribute("DEF");r&&(this.def.set(r,n),t.coords.set(r,{cage:t.cage,remapIndex:o}));let i=n.getAttribute("point");i=i.trim().split(/[,\s]+/);const s=[0,0,0];for(let e=0;e<i.length;e+=3)s[0]=parseFloat(i[e])||0,s[1]=parseFloat(i[e+1])||0,s[2]=parseFloat(i[e+2])||0,o.push(t.cage.geometry.addVertex(s).index)}}TextureCoordinate(e,t){let o=this._getUse(e);if(!o){o=[];let t=e.getAttribute("DEF");t&&this.def.set(t,o);let n=e.getAttribute("point");n=n.trim().split(/[,\s]+/);for(let e=0;e<n.length;e+=2){let t=It.uv.reserve();o.push(t),It.uv.setChannel(t,0,[parseFloat(n[e]),parseFloat(n[e+1])])}}t.uv=o}MultiTextureCoordinate(){}}class wn{constructor(){this.children=[]}insert(e){this.children.push(e)}}class En extends Ht{constructor(){super("Multi")}selectMaterialCmd(e){return $r(),ri().selectMaterialCmd(e)}isFaceSelectable(){return!0}isEdgeSelectable(){return!0}isVertexSelectable(){return!0}toggleMulti(e){e.face?$r():e.vertex?Yr():Wr()}_doSelection(){return!1}toggleFunc(e){let t,o;return e instanceof yo?(t=ei,o=this.snapshotSelected(Qo.prototype.changeFromMultiToFaceSelect)):e instanceof lo?(t=Qr,o=this.snapshotSelected(Qo.prototype.changeFromMultiToVertexSelect)):e instanceof po?(t=ti,o=this.snapshotSelected(Qo.prototype.changeFromMultiToEdgeSelect)):(t=ti,o=this.snapshotSelected(Qo.prototype.changeFromMultiToBodySelect)),new Yt(t,ni,o)}restoreMode(e,t){e instanceof yo?this.doAll(t,Qo.prototype.restoreFromMultiToFaceSelect):e instanceof lo?this.doAll(t,Qo.prototype.restoreFromMultiToVertexSelect):e instanceof po?this.doAll(t,Qo.prototype.restoreFromMultiToEdgeSelect):this.doAll(t,Qo.prototype.restoreFromMultiToBodySelect)}polygonShader(e,t){e.useShader(Xe)}edgeShader(e,t){t?e.useShader(qe):e.useShader(Ze)}vertexShader(e,t){return!!t&&(e.useShader(Ge),!0)}}const{vec3:Cn,quat:An,mat4:Fn}=glMatrix,Mn=function(e,t,o,n=2048){Nt.call(this,n),this.materialList=o,this.preview={centroid:{},indexLength:0,visibleLength:0,isAltered:!1},this.preview.shaderData=x.createShaderData();var r=S.attribLayout(3),i=S.attribLayout(4);this.preview.shaderData.createAttribute("polygonIndex",i,x.STATIC_DRAW),this.preview.shaderData.createAttribute("a_AttributeIndex",r,x.STATIC_DRAW),this.preview.shaderData.createSampler("faceState",2,3,x.UNSIGNED_BYTE),this.preview.shaderData.createSampler("groupState",3,1,x.UNSIGNED_BYTE),this.preview.shaderData.createSampler("positionBuffer",0,3,x.FLOAT),this.preview.shaderData.createIndex("triangleList"),this.setTheme(e,t),this.preview.shaderData.createSampler("materialColor",4,3,x.FLOAT),this.preview.shaderData.createAttribute("indexBuffer",i,x.STATIC_DRAW),this.preview.shaderData.createSampler("edgeState",1,1,x.UNSIGNED_BYTE),this.preview.shaderData.createSampler("attributeColor",5,3,x.UNSIGNED_BYTE),this.preview.shaderData.createSampler("attributeTexCoord",6,2,x.HALF_FLOAT),this.preview.shaderData.createAttribute("vertexIndex",r,x.DYNAMIC_DRAW),this.previewBody={hilite:!1},this.previewPlane={},this.previewPlane.shaderData=x.createShaderData(),this.previewPlane.shaderData.setUniform4fv("faceColor",[1,0,0,1]),this.previewPlane.shaderData.createAttribute("position",r,x.STATIC_DRAW),this.previewPlane.rectangle=new Float32Array(12),this.previewPlane.shaderData.resizeAttribute("position",3*Float32Array.BYTES_PER_ELEMENT*4),this.previewPlane.pts=[];for(let e=0;e<4;++e)this.previewPlane.pts[e]=this.previewPlane.rectangle.subarray(3*e,3*(e+1))};Mn.prototype=Object.create(Nt.prototype),Object.defineProperty(Mn.prototype,"constructor",{value:Mn,enumerable:!1,writable:!0}),Mn.theme={unselectedEdgeColor:[0,0,0,1],hardEdgeColor:[1,.5,0,1],selectedColor:[.65,0,0,1],selectedHilite:[.7,.7,0,1],unselectedHilite:[0,.65,0,1],unselectedVertexColor:[0,0,0,1],maskedVertexColor:[.5,1,0,.8],faceColor:[.7898538076923077,.8133333333333334,.6940444444444445,1],sculptMagnetColor:[0,0,1,.1],tweakMagnetColor:[0,0,1,.06],tweakVectorColor:[1,.5,0]},Mn.pref={unselectedVertexSize:4,selectedVertexSize:5,maskedVertexSize:8,unselectedEdgeWidth:2,selectedEdgeWidth:2,hardEdgeWidth:2},Mn.CONST=function(){const e={EDGEWIDTH:1.1};return e}(),Mn.prototype.setTheme=function(e,t){Object.entries(e).forEach(([e,t])=>{this.preview.shaderData.setUniform4fv(e,et(t)),Mn.theme[e]=et(t)}),Object.entries(t).forEach(([e,t])=>{Mn.pref[e]=t,this.preview.shaderData.setUniform1f(e,t)}),this.preview.shaderData.setUniform4fv("edgeColor",function(e){const t=new Float32Array(32),o=new it(t);return o.set(e.unselectedEdgeColor).inc(),o.set(e.hardEdgeColor).inc(),o.set(e.selectedColor).inc(),o.set(e.selectedColor).inc(),o.set(e.unselectedHilite).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite).inc(),o.set(e.selectedHilite),t}(Mn.theme)),this.preview.shaderData.setUniform1fv("edgeWidth",function(e){const t=new Float32Array(8);return t[0]=e.unselectedEdgeWidth,t[1]=e.unselectedEdgeWidth,t[2]=e.selectedEdgeWidth,t[3]=e.selectedEdgeWidth,t[4]=e.unselectedEdgeWidth,t[5]=e.unselectedEdgeWidth,t[6]=e.selectedEdgeWidth,t[7]=e.selectedEdgeWidth,t}(Mn.pref)),this.preview.shaderData.setUniform4fv("vertexColor",function(e){const t=new Float32Array(32),o=new it(t);return o.set(e.unselectedVertexColor).inc(),o.set(e.selectedColor).inc(),o.set(e.maskedVertexColor).inc(),o.set(e.maskedVertexColor).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite),t}(Mn.theme)),this.preview.shaderData.setUniform1fv("sizeOfVertex",function(e){const t=new Float32Array(8);return t[0]=e.unselectedVertexSize,t[1]=1.5*e.selectedVertexSize,t[2]=1.5*e.maskedVertexSize,t[3]=1.5*e.maskedVertexSize,t[4]=1.5*e.selectedVertexSize,t[5]=1.5*e.selectedVertexSize,t[6]=1.5*e.maskedVertexSize,t[7]=1.5*e.maskedVertexSize,t}(Mn.pref)),this.preview.shaderData.setUniform4fv("faceColor",function(e){const t=new Float32Array(16),o=new it(t);return o.set(e.faceColor).inc(),o.set(e.selectedColor).inc(),o.set(e.unselectedHilite).inc(),o.set(e.selectedHilite),t}(Mn.theme))},Mn.prototype.freeBuffer=function(){this.preview.shaderData.freeAllAttributes(),this.preview.shaderData=null,this.previewEdge.shaderData.freeAllAttributes(),this.previewEdge.shaderData=null},Mn.prototype.isModified=function(){return Rt.index.isAltered()||Bt.index.isAltered()||Bt.indexAttribute.isAltered()||Vt.index.isAltered()||Rt.position.isAltered()||Ot.state.isAltered()||Vt.state.isAltered()||Dt.state.isAltered()||Tt.color.isAltered()||Bt.triangleList.isAltered()||Bt.color.isAltered()},Mn.prototype.draw=function(e,t){try{this.preview.shaderData.updateAttribute("polygonIndex",Bt.index),this.preview.shaderData.updateAttribute("a_AttributeIndex",Bt.indexAttribute),this.preview.shaderData.updateSampler("positionBuffer",Rt.position),this.preview.shaderData.updateSampler("attributeColor",Bt.color),this.preview.shaderData.updateSampler("attributeTexCoord",It.uv),this.preview.shaderData.updateSampler("faceState",Ot.state),this.preview.shaderData.updateSampler("groupState",Dt.state),this.preview.shaderData.updateSampler("materialColor",Tt.color),this.preview.shaderData.updateIndex("triangleList",Bt.triangleList,Bt.index.usedSize/4-1,e.STATIC_DRAW),e.bindAttribute(this.preview.shaderData,["polygonIndex"]),e.bindAttribute(this.preview.shaderData,["a_AttributeIndex"]),e.bindUniform(this.preview.shaderData,["faceColor","faceState","faceStateHeight","groupState","groupStateHeight","materialColor","materialColorHeight","attributeColor","attributeColorHeight","attributeTexCoord","attributeTexCoordHeight","positionBuffer","positionBufferHeight"]),e.bindIndex(this.preview.shaderData,"triangleList");const t=new Set;for(const o of Tt.getInUse()){const n=o.textureHash();t.has(n)||(t.add(n),this.preview.shaderData.setUniform1f("currentBaseColorTexture",o.pbr.baseColorTexture),this.preview.shaderData.setUniformTexture("baseColorTexture",o.baseColorTexture.id,7),e.bindUniform(this.preview.shaderData,["currentBaseColorTexture","baseColorTexture"]),e.drawElements(e.TRIANGLES,Bt.triangleList.usedSize,e.UNSIGNED_INT,0))}}catch(e){console.log(e)}},Mn.prototype.drawVertex=function(e,t){try{this.preview.shaderData.updateAttribute("vertexIndex",Rt.index),e.bindAttribute(this.preview.shaderData,["vertexIndex"]),this.preview.shaderData.updateSampler("groupState",Dt.state),this.preview.shaderData.updateSampler("positionBuffer",Rt.position),e.bindUniform(this.preview.shaderData,["vertexColor","sizeOfVertex","groupState","groupStateHeight","positionBuffer","positionBufferHeight"]),e.drawArrays(e.POINTS,0,Rt.index.usedSize/3)}catch(e){console.log(e)}},Mn.prototype.drawEdge=function(e,t){try{this.preview.shaderData.updateAttribute("indexBuffer",Vt.index),e.bindAttribute(this.preview.shaderData,["indexBuffer"]),this.preview.shaderData.updateSampler("positionBuffer",Rt.position),this.preview.shaderData.updateSampler("edgeState",Vt.state),this.preview.shaderData.updateSampler("groupState",Dt.state),e.bindUniform(this.preview.shaderData,["edgeColor","edgeWidth","groupState","groupStateHeight","positionBuffer","positionBufferHeight","edgeState","edgeStateHeight"]),e.drawArrays(e.TRIANGLES,0,Vt.index.usedSize/4)}catch(e){console.log(e)}},Mn.prototype.drawPlane=function(){const e=Cn.create(),t=Cn.fromValues(0,1,0),o=An.create(),n=Fn.create(),r=Cn.create();return function(i,s){Cn.copy(r,s.halfSize),Cn.normalize(r,r),Cn.cross(e,r,t),Cn.normalize(e,e),An.rotationTo(o,e,s.normal),Fn.fromQuat(n,o),Cn.copy(r,s.halfSize),Cn.negate(this.previewPlane.pts[0],r);let a=this.previewPlane.pts[1];a[0]=r[0],a[1]=-r[1],a[2]=r[2],Cn.copy(this.previewPlane.pts[2],r),Cn.negate(this.previewPlane.pts[3],a);for(let e=0;e<4;++e){const t=this.previewPlane.pts[e];Cn.transformMat4(t,t,n),Cn.add(t,s.center,t)}this.previewPlane.shaderData.uploadAttribute("position",0,this.previewPlane.rectangle),s.hilite?this.previewPlane.shaderData.setUniform4fv("faceColor",[0,1,0,1]):this.previewPlane.shaderData.setUniform4fv("faceColor",[.1,.1,.1,1]),i.disable(i.CULL_FACE),i.useShader($e),i.bindTransform(),i.bindAttribute(this.previewPlane.shaderData,["position"]),i.bindUniform(this.previewPlane.shaderData,["faceColor"]),i.drawArrays(i.TRIANGLE_FAN,0,4),i.disableShader(),i.enable(i.CULL_FACE)}}(),Mn.prototype.checkPoint=function(){const e=[];for(let t of this.vertices)t.isLive()?e.push(t.outEdge.index):e.push(-1);const t=[];for(let e of this.edges)e.isLive()?t.push(e.left.next.index,e.right.next.index,e.left.origin.index,e.right.origin.index):t.push(-1,-1,-1,-1);const o=[];for(let e of this.faces)e.isLive()?o.push(e.halfEdge.index):o.push(-1);return{faces:o,edges:t,vertices:e}},Mn.prototype.checkup=function(e){for(let t=0;t<e.faces.length;++t){const o=this.faces[t];if(o.isLive()){if(o.halfEdge.index!=e.faces[t])throw"CheckPoint failed: non matching polygon halfEdge"}else if(-1!==e.faces[t])throw"CheckPoint failed: unexpected face"}for(let t=0;t<e.vertices.length;++t){const o=this.vertices[t];if(o.isLive()){if(o.outEdge.index!=e.vertices[t])throw"CheckPoint failed: non-matching vertex outEdge"}else if(-1!==e.vertices[t])throw"CheckPoint failed: unexpected vertex"}for(let t=0,o=0;t<e.edges.length;t+=4,o++){const n=this.edges[o];if(n.isLive()){if(n.left.next.index!=e.edges[t]||n.right.next.index!=e.edges[t+1]||n.left.origin.index!=e.edges[t+2]||n.right.origin.index!=e.edges[t+3])throw"CheckPoint failed: non matching wEdge"}else if(-1!==e.edges[t])throw"CheckPoint failed: unexpected wEdge"}};const{vec3:_n}=glMatrix;function*Tn(e,t,o){yield*Pn(e,t,o,o)}function*Pn(e,t,o,n){const r=2*Math.PI/e;for(let i=0;i<e;++i){const e=i*r;yield[o*Math.cos(e),t,n*Math.sin(e)]}}function*Ln(e,t,o,n,r){const i=2*Math.PI/e;for(let s=0;s<r*e;++s)yield[(o+s*n)*Math.cos(s*i),t,(o+s*n)*Math.sin(s*i)]}function*Vn(e,t,o,n,r){const i=2*Math.PI/e;for(let s=0;s<r*e;++s)yield[o*Math.cos(s*i),t+s*n,o*Math.sin(s*i)]}function In(e,t,o,n,r,i){let s,a=e.addVertex([0,-r,0]).index,l=Math.PI/n;for(let c=1;c<n;c++){let n=-Math.cos(c*l),d=Math.sin(c*l),u=[];for(let t of Tn(o,n*r,d*i))u.push(e.addVertex(t).index);if(s){const o=[s[s.length-1],u[u.length-1],-1,-1];for(let n=0;n<u.length;++n)o[2]=u[n],o[3]=s[n],e.addPolygon(o,t),o[0]=o[3],o[1]=o[2]}else{const o=[a,u[u.length-1],-1];for(let n of u)o[2]=n,e.addPolygon(o,t),o[1]=n}s=u}let c=e.addVertex([0,r,0]).index;const d=[s[s.length-1],c,-1];for(let o of s)d[2]=o,e.addPolygon(d,t),d[0]=o;return!0}function Bn(e,t,o,n,r,i){const s=2*Math.PI/n;let a=[];for(let t=0;t<n;++t){let n=[],l=.25*Math.sin(t*s),c=.75+.25*Math.cos(t*s);for(let t of i(o,l,c,.05,r))n.push(e.addVertex(t).index);a.push(n)}const l=[],c=[];let d=a[a.length-1];for(let o of a){const n=[d[0],o[0],-1,-1];for(let r=1;r<o.length;++r)n[2]=o[r],n[3]=d[r],e.addPolygon(n,t),n[0]=n[3],n[1]=n[2];d=o,l.push(o[0]),c.push(o[o.length-1])}return e.addPolygon(l.reverse(),t),e.addPolygon(c,t),!0}const{vec3:Rn,vec4:On,mat4:Nn}=glMatrix;class Dn{constructor(e){this._index=e}get index(){return this._index}}class kn{constructor(){this.vertex=[],this.uv=[],this.normal=[],this.index=[],this.buffer={}}addVertex(e){this.vertex.push(e),this.normal.push([0,0,0]);const t=[0,0,0];Rn.normalize(t,e);const o=.5+Math.atan2(t[2],t[0])/(2*Math.PI),n=.5-Math.asin(t[1])/Math.PI;return this.uv.push([o,n]),new Dn(this.vertex.length-1)}addPolygon(e,t){const o=(e,t,o)=>{this.index.push(e,t,o);const n=this.vertex[e],r=this.vertex[t],i=this.vertex[o],s=[i[0]-n[0],i[1]-n[1],i[2]-n[2]],a=[r[0]-n[0],r[1]-n[1],r[2]-n[2]];Rn.cross(a,a,s),Rn.normalize(a,a),Rn.add(this.normal[e],this.normal[e],a),Rn.add(this.normal[t],this.normal[t],a),Rn.add(this.normal[o],this.normal[o],a)};if(!(e.length<5))throw"unable to handle general polygon";return o(e[0],e[1],e[2]),4===e.length&&o(e[0],e[2],e[3]),null}finalized(){for(let e of this.normal)Rn.normalize(e,e);this.buffer.normal=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.buffer.normal);let e=Float32Array.from(this.normal.flat());x.bufferData(x.ARRAY_BUFFER,e,x.STATIC_DRAW),this.buffer.position=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.buffer.position),e=Float32Array.from(this.vertex.flat()),x.bufferData(x.ARRAY_BUFFER,e,x.STATIC_DRAW),this.buffer.uv=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.buffer.uv),e=Float32Array.from(this.uv.flat()),x.bufferData(x.ARRAY_BUFFER,e,x.STATIC_DRAW),this.buffer.index=x.createBuffer(),x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,this.buffer.index),x.bufferData(x.ELEMENT_ARRAY_BUFFER,Uint16Array.from(this.index),x.STATIC_DRAW)}}class zn{constructor(){this.target={width:128,height:128,handle:x.createTexture()},x.bindTexture(x.TEXTURE_2D,this.target.handle),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,this.target.width,this.target.height,0,x.RGBA,x.UNSIGNED_BYTE,null),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),this.fb=x.createFramebuffer(),x.bindFramebuffer(x.FRAMEBUFFER,this.fb),x.framebufferTexture2D(x.FRAMEBUFFER,x.COLOR_ATTACHMENT0,x.TEXTURE_2D,this.target.handle,0),x.bindFramebuffer(x.FRAMEBUFFER,null),x.bindTexture(x.TEXTURE_2D,null),this.mesh=new kn,In(this.mesh,null,16,16,1,1),this.mesh.finalized()}_drawSphere(e){x.useProgram(Ke.progHandle),x.uniform3fv(Ke.uniform.baseColor.loc,e.baseColor),x.uniform3fv(Ke.uniform.emission.loc,e.emission),x.uniform1f(Ke.uniform.metallic.loc,e.metallic),x.uniform1f(Ke.uniform.roughness.loc,e.roughness),x.uniform1i(Ke.uniform.useDiffuseMap.loc,0),x.uniform1i(Ke.uniform.usePBRMap.loc,0),x.uniform1i(Ke.uniform.useEmissionMap.loc,0),x.setBufferAndAttrib(this.mesh.buffer.position,Ke.attribute.position.loc),x.setBufferAndAttrib(this.mesh.buffer.normal,Ke.attribute.normal.loc),x.setBufferAndAttrib(this.mesh.buffer.uv,Ke.attribute.uv.loc,2),x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,this.mesh.buffer.index);const t=Nn.create();Nn.perspective(t,60*Math.PI/180,this.target.width/this.target.height,.5,100);const o=[0,0,2],n=Nn.create();Nn.lookAt(n,o,[0,0,0],[0,1,0]),Nn.multiply(t,t,n),Nn.identity(n);const r=[1,-1,1];Rn.normalize(r,r),x.uniformMatrix4fv(Ke.transform.worldViewProjection,!1,t),x.uniformMatrix4fv(Ke.transform.world,!1,n),x.uniform3fv(Ke.uniform.wsEyepoint.loc,o),x.uniform3fv(Ke.uniform.lightDir.loc,r),x.uniform3fv(Ke.uniform.lightDiffuse.loc,[1,1,1]),x.uniform3fv(Ke.uniform.lightSpecular.loc,[1,1,1]),x.drawElements(x.TRIANGLES,this.mesh.index.length,x.UNSIGNED_SHORT,0)}preview(e){x.bindFramebuffer(x.FRAMEBUFFER,this.fb),x.viewport(0,0,this.target.width,this.target.height),x.clearColor(.2,.2,.2,1),x.clear(x.COLOR_BUFFER_BIT),this._drawSphere(e);const t=new Uint8ClampedArray(this.target.width*this.target.height*4);return x.readPixels(0,0,this.target.width,this.target.height,x.RGBA,x.UNSIGNED_BYTE,t),x.bindFramebuffer(x.FRAMEBUFFER,null),new ImageData(t,this.target.width,this.target.height)}}let Un,jn=null;function Hn(e){return jn||(jn=new zn),jn.preview(e)}function Xn(e){e.preventDefault()}function qn(e){e.preventDefault(),e.stopPropagation(),e.target===this&&this.classList.remove("dropZone")}function Gn(e){e.preventDefault(),e.stopPropagation(),this.classList.add("dropZone")}Zo.nameSetters.push((function(e){this.guiStatus&&this.guiStatus.textNode&&(this.guiStatus.textNode.textContent=e)})),Zo.prototype.addGuiStatus=function(e,t){e.addGroup(t,this);for(let t of this.group)t.addGuiStatus(e,this.guiStatus.ul)},Zo.prototype.removeGuiStatus=function(e){e.removeObject(this)},Zo.prototype.updateCount=function(){let e=0;for(let t of this.group)e+=t.updateCount();return this.guiStatus&&this.guiStatus.count&&(this.guiStatus.count.textContent=e),e},Qo.nameSetters.push((function(e){this.guiStatus&&this.guiStatus.textNode&&(this.guiStatus.textNode.textContent=e)})),Qo.prototype.addGuiStatus=function(e,t){e.addObject(this,t)},Qo.prototype.removeGuiStatus=function(e){e.removeObject(this)},Qo.prototype.updateCount=function(){return 1};class Yn{constructor(e,t,o){this.label=e,this.treeView=t,this.world=o,this.drag={cage:null,li:null};const n=this;o&&(o.guiStatus.count=e.querySelector(".resultCount")),o.guiStatus.ul=t,e.addEventListener("drop",(function(e){qn.call(this,e),n.treeView.id===e.dataTransfer.getData("text")&&(n.treeView.insertBefore(n.drag.li,n.treeView.firstChild),ci(o,n.drag.cage),n.drag.li=n.drag.cage=null)})),e.addEventListener("dragover",Xn),e.addEventListener("dragenter",Gn),e.addEventListener("dragleave",qn),e.addEventListener("contextmenu",(function(e){e.preventDefault();let t=document.querySelector("#geometryGraphWorld");t&&(ae(t,se(e)),Fe(t),gi(o,[o]))}),!1)}updateStatus(e){let t=0;for(let o of e.getCage())o.isVisible()&&o.hasSelection()?o.guiStatus.select&&!o.guiStatus.select.checked&&(o.guiStatus.select.checked=!0):o.guiStatus.select&&o.guiStatus.select.checked&&(o.guiStatus.select.checked=!1),++t;return t}updateCount(e){return e.updateCount()}static addRenameListener(e,t){e.textContent=t.name,t.guiStatus.textNode=e;const o=function(e){if("Enter"==e.key){if(this.textContent!==t.name){const e={};e[t.uuid]=this.textContent;const o=new Io([t],e);yi(o),o.doIt()}this.contentEditable=!1,this.removeEventListener("keydown",o)}};return e.addEventListener("dblclick",(function(e){this.contentEditable=!0,this.focus(),this.addEventListener("keydown",o)})),e.addEventListener("blur",(function(e){this.textContent=t.name,this.contentEditable=!1,this.removeEventListener("keydown",o)})),e}addNode(e,t){e.addGuiStatus(this,t.guiStatus.ul)}addGroup(e,t){const o=this;let n=t.guiStatus.li;if(!n){n=document.createElement("li"),t.guiStatus.li=n;const e=t.uuid,r=document.createRange().createContextualFragment(`<input type="checkbox" id="${e}"><label for="${e}" class="folder"></label><p><span></span><span class="resultCount">0</span></p><ul></ul>`);Yn.addRenameListener(r.querySelector("span"),t);const i=r.querySelector("ul");t.guiStatus.ul=i;const s=r.querySelector("p");t.guiStatus.count=r.querySelector(".resultCount"),n.appendChild(r),s.addEventListener("drop",(function(e){qn.call(this,e),o.treeView.id===e.dataTransfer.getData("text")&&(i.insertBefore(o.drag.li,i.firstChild),ci(t,o.drag.cage),o.drag.li=o.drag.cage=null)})),s.addEventListener("dragover",Xn),s.addEventListener("dragenter",Gn),s.addEventListener("dragleave",qn)}e.appendChild(n)}addObject(e,t=this.treeView){const o=this;let n=e.guiStatus.li;if(!n){const t=document.createRange();n=document.createElement("li"),e.guiStatus.li=n,n.classList.add("objectName"),n.draggable=!0,n.addEventListener("dragstart",(function(t){t.stopPropagation(),t.dataTransfer.setData("text",o.treeView.id),o.drag.li=this,o.drag.cage=e}));const r=t.createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallWhole"></span></label>');let i=r.querySelector("input");i.addEventListener("change",t=>{!e.isLock()&&e.isVisible()?(gi(e.parent,[e]),K(0,"toggleObjectSelect",t)):t.target.checked=!t.target.checked}),e.guiStatus.select=i,n.appendChild(r);const s=Yn.addRenameListener(document.createElement("span"),e);s.addEventListener("contextmenu",(function(t){t.preventDefault();let o=document.querySelector("#geometryGraphText");o&&(ae(o,se(t)),Fe(o),gi(e.parent,[e]))}),!1),n.appendChild(s);const a=t.createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallShow"></span></label>');i=a.querySelector("input"),i.addEventListener("change",t=>{e.isLock()?t.target.checked=!t.target.checked:(gi(e.parent,[e]),K(0,"toggleObjectVisibility",t))}),e.guiStatus.visibility=i,n.appendChild(a);const l=t.createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallUnlock"></span></label>');i=l.querySelector("input"),i.addEventListener("change",t=>{gi(e.parent,[e]),K(0,"toggleObjectLock",t)}),n.appendChild(l),e.guiStatus.locked=i;const c=t.createContextualFragment('<label><input type="checkbox"><span class="smallIcon smallWire"></span></label>');i=c.querySelector("input"),i.addEventListener("change",t=>{gi(e.parent,[e]),K(0,"toggleWireMode",t)}),n.appendChild(c)}t.appendChild(n)}removeObject(e){const t=e.guiStatus.li;t.parentNode.removeChild(t)}removeNode(e){e.removeGuiStatus(this)}}class $n{constructor(e){this.view=e,this.list=[]}static addRenameListener(e,t){const o=function(e){"Enter"==e.key&&(""!=this.textContent?t.name=this.textContent:this.textContent=t.name,this.contentEditable=!1,this.removeEventListener("keydown",o))};return e.addEventListener("dblclick",(function(e){this.contentEditable=!0,this.focus(),this.addEventListener("keydown",o)})),e.addEventListener("blur",(function(e){this.textContent=t.name,this.contentEditable=!1,this.removeEventListener("keydown",o)})),e}[Symbol.iterator](){return this.list[Symbol.iterator]()}}class Wn extends $n{constructor(e,t){super(t);let o=document.querySelector("#importImageMenu");o&&e.addEventListener("contextmenu",(function(e){e.preventDefault(),ae(o,se(e)),Fe(o)}),!1),this.popup=Te()}buildImageItem(e){const t=document.createElement("wings3d-image");return t.texture=e,this.view.appendChild(t),t}loadTexture(e){this.buildImageItem(e)}showImage(e){const t=e[0],o=this.popup.querySelector(".wrap");for(;o.firstChild;)o.removeChild(o.lastChild);o.appendChild(t.texture.image);this.popup.querySelector("h3").textContent=t.texture.name,document.body.appendChild(this.popup)}deleteImage(e){const t=e[0];Pt.release(t.texture)?t.ui&&this.view.removeChild(t.ui):alert("Texture is still in use")}}class Zn extends $n{constructor(e,t){super(t);let o=document.querySelector("#createMaterialMenu");o&&e.addEventListener("contextmenu",(function(e){e.preventDefault(),ae(o,se(e)),Fe(o)}),!1)}addMaterial(e){const t=e,o=document.createElement("wings3d-material");if(this.submenu||(this.submenu=document.querySelector('[data-menuid="faceMaterialMenu"]'),this.submenu&&(this.submenu=this.submenu.nextElementSibling)),this.submenu){o.menu={};let e=o.menu.li=document.createElement("li"),n=document.createRange().createContextualFragment("<a></a>");o.menu.a=n.firstElementChild,e.appendChild(n);let r=document.createRange().createContextualFragment(`<span>${t.name}</span>`);o.menu.text=r.firstElementChild,o.menu.a.appendChild(r);let i=document.createRange().createContextualFragment('<span style="width: 1rem;"></span>');o.menu.color=i.firstElementChild,o.menu.a.appendChild(i),o.menu.color.style.backgroundColor=ot(...t.pbr.baseColor),o.menu.a.addEventListener("click",(function(e){gi(null,[o]),K(e.button,"assignMaterial",e)})),this.submenu.prepend(e)}return o.material=e,e===Tt.default&&(o.default=!0),this.view.appendChild(o),this.list.push(t),o}createMaterial(e){const t=this.newName();this.addMaterial(Tt.create(t)).editMaterial(e)}duplicateMaterial(e){const t=e[0].material;let o=t.name.split(/\d+$/);o=o.length>1?o[0]+(parseInt(t.name.match(/\d+$/),10)+1):t.name+"2",this.addMaterial(Tt.create(o,t.pbr))}deleteMaterial(e){const t=e[0];t.default||(this.view.removeChild(t),this.list.splice(this.list.indexOf(t._mat),1),this.submenu.removeChild(t.menu.li),Tt.release(t._mat),t.material=null)}newName(){return"New Material "+this.list.length}renameMaterial(e,t){const o=t[0];o.default||de("#renameDialog",e,(function(e){const t=ce(e);o.rename(t[o.material.uuid])}),(function(e){le(e,[o.material])}))}static resetCSS(){const e=document.documentElement.style;e.setProperty("--baseColorMax","#FFFFFF"),e.setProperty("--emissionMax","#FFFFFF")}}class Kn extends m{constructor(e){super(e)}async download(e="arraybuffer"){return er().then(t=>u({method:"POST",responseType:e},"https://content.dropboxapi.com/2/files/download",{Authorization:"Bearer "+t.access_token,"Dropbox-API-Arg":JSON.stringify({path:this.file.path_display})}).then(e=>(this.file=JSON.parse(e.xhr.getResponseHeader("Dropbox-API-Result")),e)))}async upload(e,t){return er().then(t=>u({method:"POST"},"https://content.dropboxapi.com/2/files/upload",{Authorization:"Bearer "+t.access_token,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:this.file.path_display,mode:"overwrite",autorename:!1,mute:!1})},e).then(e=>{let t=JSON.parse(e.xhr.response);return this.file=t,t.name}))}get isFile(){return!("folder"===this.file[".tag"])}get modified(){return new Date(this.file.client_modified)}get size(){return this.file.size}get directory(){return this.file.path_display.substring(0,this.file.path_display.lastIndexOf("/"))}get path(){return this.file.path_display}get name(){return this.file.name}}function Jn(){if(!Un)throw new Error("A client id is required. You can set the client id using .setClientId().");const e=window.location.protocol+"//"+window.location.host+"/oauth-redirect.html";return`https://www.dropbox.com/oauth2/authorize?response_type=token&client_id=${Un}&redirect_uri=${e}`}function Qn(){const e=window.top.outerHeight/2+window.top.screenY-390,t=window.top.outerWidth/2+window.top.screenX-290;return window.open("","_blank",`alwaysRaised=1, toolbar=0, menubar=0, status=0, height=780, width=580, top=${e}, left=${t}`)}async function er(){let e;return(e=window.localStorage.getItem("dropboxAccessToken"))?(e=JSON.parse(e),e):l(Qn,Jn).then(e=>(window.localStorage.setItem("dropboxAccessToken",JSON.stringify(e)),e))}async function tr(e,t){return er().then(o=>{const n={Authorization:"Bearer "+o.access_token,"Content-Type":"application/json"},r=JSON.stringify({path:e,recursive:!1,include_deleted:!1,include_has_explicit_shared_members:!1,include_mounted_folders:!0,include_non_downloadable_files:!0}),i=s(t);return u({method:"POST",responseType:"json"},"https://api.dropboxapi.com/2/files/list_folder",n,r).then(e=>h(e)).then(([e,t])=>or(t,i))})}function or(e,t){const o=[],n=[];for(let r of e.entries)"folder"===r[".tag"]?o.push(new Kn(r)):r.name.match(t)&&n.push(new Kn(r));let r;return e.has_more&&(r=()=>function(e,t){return er().then(o=>u({method:"POST",responseType:"json"},"https://api.dropboxapi.com/2/files/list_folder/continue",{Authorization:"Bearer "+o.access_token,"Content-Type":"application/json"},JSON.stringify({cursor:e})).then(e=>h(e)).then(([e,o])=>or(o,t)))}(e.cursor,t)),{folders:o,files:n,cursor:r}}async function nr(e){return e=a(e),new Kn({path_display:e})}async function rr(e){return er().then(t=>d(ir,tr,e).then(e=>e instanceof Kn?e:(e.path_display=e.directory+"/"+e.name,new Kn(e))))}let ir="#";async function sr(e){return er().then(t=>{e=a(e);return u({method:"POST",responseType:"json"},"https://api.dropboxapi.com/2/files/get_metadata",{Authorization:"Bearer "+t.access_token,"Content-Type":"application/json"},JSON.stringify({path:e,include_media_info:!1,include_deleted:!1,include_has_explicit_shared_members:!1})).then(e=>[new Kn(e.data)])})}async function ar(e){return er().then(t=>d(ir,tr,{path:"",ext:e}).then(e=>[e]))}class lr extends m{constructor(e){super(e)}download(e="arraybuffer"){return u({responseType:e},this.file["@microsoft.graph.downloadUrl"])}async upload(e,t){return e.size<4194304?this._upload(e,t):this._uploadSession(e,t)}async _upload(e,t){return hr().then(t=>{let o;o=this.file.parentReference?`${cr.graphApiRoot}me/drive/items/${this.file.id}/content`:`${cr.graphApiRoot}me/drive/root:${this.file.directory}/${this.file.name}:/content`;return u({method:"PUT",responseType:"json"},o,{Authorization:"Bearer "+t.access_token,"Content-Type":"application/octet-stream"},e).then(e=>(this.file=e.data,this.file.name))})}async _uploadSession(e,t){return hr().then(e=>{let t;t=this.file.parentReference?`${cr.graphApiRoot}me/drive/items/${this.file.id}/createUploadSession`:`${cr.graphApiRoot}me/drive/root:${this.file.directory}/${this.file.name}:/createUploadSession`;return u({method:"POST",responseType:"json"},t,{Authorization:"Bearer "+e.access_token,"Content-Type":"application/json"},{item:{"@microsoft.graph.conflictBehavior":"replace"}})}).then(async t=>{const o={method:"PUT",responseType:"json"},n={"Content-Type":"application/octet-stream","Content-Length":i},r=t.data.uploadUrl,i=6553.6;let s=Math.floor(e.size/i);for(let t=0;t<s;++t){let s=t*i,a=(t+1)*i-1;n["Content-Range"]=`byte ${s}-${a}/${e.size}`;await u(o,r,n,e.slice(s,a+1))}let a=s*i,l=e.size-1;return n["Content-Length"]=e.size-a,n["Content-Range"]=`byte ${a}-${l}/${e.size}`,u(o,r,n,e.slice(a,e.size)).then(e=>(this.file=e.data,this))})}get isFile(){return void 0===this.file.folder}get modified(){return new Date(this.file.lastModifiedDateTime)}get name(){return this.file.name}static rootPath(e){return`${e.parentReference.path}/${e.name}`.split(":").pop()}get directory(){return this.file.parentReference.path.split(":").pop()}get size(){return this.file.size}}const cr={clientId:"",redirectUri:window.location.protocol+"//"+window.location.host+"/oauth-redirect.html",scopes:"user.read files.readWrite files.readWrite.all",authServiceUri:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",graphApiRoot:"https://graph.microsoft.com/v1.0/"};function dr(){let e=cr.authServiceUri+"?client_id="+cr.clientId+"&response_type=token&redirect_uri="+encodeURIComponent(cr.redirectUri);return cr.scopes&&(e=e+"&scope="+encodeURIComponent(cr.scopes)),cr.resourceUri&&(e=e+"&resource="+encodeURIComponent(cr.resourceUri)),e}function ur(){let e=window.screenX,t=window.screenY,o=window.outerWidth,n=window.outerHeight,r=e+Math.max(o-525,0)/2,i=["width=525","height=525","top="+(t+Math.max(n-525,0)/2),"left="+r,"alwaysRaised=1","status=no","resizable=yes","toolbar=no","menubar=no","scrollbars=yes"];return window.open("","_blank",i.join(","))}async function hr(){let e;return!(e=window.localStorage.getItem(mr))||(e=JSON.parse(e),t=e.expires_in,new Date(t)<new Date)?l(ur,dr).then(e=>(e.expires_in=function(e){const t=new Date;return t.setTime(t.getTime()+1e3*e),t}(e.expires_in),window.localStorage.setItem(mr,JSON.stringify(e)),Promise.resolve(e))):e;var t}async function fr(e,t){return hr().then(o=>{const n={Authorization:"Bearer "+o.access_token,"Content-Type":"application/json;odata.metadata=none"};let r=cr.graphApiRoot+"me/drive/root/children";e&&(r=cr.graphApiRoot+"me/drive/root:"+e+":/children");const i=s(t);return u({method:"GET",responseType:"json"},r,n).then(e=>h(e)).then(([e,t])=>pr(t,i))})}function pr(e,t){const o=[],n=[];for(let r of e.value)r.folder?o.push(new lr(r)):r.name.match(t)&&n.push(new lr(r));let r;const i=e["@odata.nextLink"];return i&&(r=()=>function(e,t){return hr().then(o=>{const n={Authorization:"Bearer "+o.access_token,"Content-Type":"application/json;odata.metadata=none"};return u({method:"GET",responseType:"json"},e,n).then(e=>h(e)).then(([e,o])=>pr(o,t))})}(i,t)),{folders:o,files:n,cursor:r}}let gr="#";const mr="onedriveAccessToken";async function vr(e){return new lr({name:e,directory:g().currentDirectory})}async function xr(e){return hr().then(t=>d(gr,fr,e).then(e=>e instanceof lr?e:new lr(e)))}function yr(e){return hr().then(t=>{e=a(e);return u({method:"GET",responseType:"json"},`${cr.graphApiRoot}/me/drive/root:${e}`,{Authorization:"Bearer "+t.access_token}).then(e=>[new lr(e.data)])})}async function br(e){return hr().then(t=>d(gr,fr,{path:"",ext:e}).then(e=>[e]))}class Sr extends m{constructor(e){super(e)}async image(){return m._createImage(this.file)}async arrayBuffer(){return this.file.arrayBuffer()}async text(){return this.file.text()}async upload(e,t){window.saveAs(e,this.file.name)}get directory(){return""}get name(){return this.file.name}get root(){return this.file.root}}async function wr(e){return new Sr({path:"",name:e})}function Er(){p({success:function(e){},progress:function(e){},cancel:function(){},error:function(e){},folderSVG:"./img/clouddisk.svg#folder"})}let Cr,Ar,Fr=new Map,Mr={},_r={};function Tr(e){Mr=Object.assign(_r,e),_r={}}async function Pr(e){if(!Cr){if(Cr=document.getElementById("cloudSaveDialog"),!Cr)throw new Error("No Save Dialog");Er();let e=document.getElementById("dropboxSave");e&&Fr.set(e.id,function(e){return e?(Un=e.getAttribute("data-app-key"),ir=e.querySelector(".home"),[rr,nr]):null}(e)),e=document.getElementById("onedriveSave"),e&&Fr.set(e.id,function(e){return e?(cr.clientId=e.getAttribute("data-app-key"),gr=e.querySelector(".home").src,[xr,vr]):null}(e)),e=document.getElementById("localSave"),e&&Fr.set(e.id,[async function(e){return new Sr(e)},wr])}let t="untitled";if(Mr.selected){let[e,o]=r(Mr.selected.name);t=e}const[o,n]=await pe("#cloudSaveDialog",(function(o){let n=o.querySelector('input[name="selected"');n&&(n.value=t);let r=o.querySelector("span.fileExt");r&&(r.textContent=e)}));if("cancel"===n.value)throw new Error("No storage selected");let i=o.querySelector('input[name="selected"');if(i&&i.value){let[e,o]=r(i.value);t=e}let[s,a]=Fr.get(n.id);_r.saveFn=a;return s({path:"",name:t+"."+e,ext:[e],root:t}).then(e=>[e,a])}async function Lr(e){return Mr.selected?[Mr.selected,Mr.saveFn]:Pr(e)}let Vr=new Map;async function Ir(e){if(!Ar){if(Ar=document.getElementById("cloudOpenDialog"),!Ar)throw new Error("No OpenDialog");Er();let e=document.getElementById("dropboxOpen");e&&Vr.set(e.id,function(e){return e?(Un=e.getAttribute("data-app-key"),ir=e.querySelector(".home").src,[ar,sr,nr]):null}(e)),e=document.getElementById("onedriveOpen"),e&&Vr.set(e.id,function(e){return e?(cr.clientId=e.getAttribute("data-app-key"),gr=e.querySelector(".home").src,[br,yr,vr]):null}(e)),e=document.getElementById("yandexDiskOpen"),e&&Vr.set(e.id,YandexDisk.setupOpenButton(e)),e=document.getElementById("localOpen"),e&&Vr.set(e.id,[async e=>ge(i(e)).then(e=>e.map(e=>new Sr(e))),async e=>me(e).then(e=>e.map(e=>new Sr(e))),wr])}const[t,o]=await pe("#cloudOpenDialog",null);if("cancel"===o.value)throw new Error("No storage selected");const[n,r,s]=Vr.get(o.id);return _r.saveFn=s,n(e).then(e=>[e,r])}function Br(e,t){if(t){const t=new Map;return o=>{let n=o.join(),r=t.get(n);return void 0===r&&(r=e.addVertex(o).index,t.set(n,r)),r}}return t=>e.addVertex(t).index}class Rr extends tn{constructor(){super(["STereoLithography","stl"])}extension(){return"stl"}fileTypes(){return["stl"]}async _import(e){const t=e.arrayBuffer(),[o,n]=await pe("#askStlDialog",e=>{for(let[t,o]of Object.entries(Rr.options)){let n=e[t];n&&(n.checked=o)}});if("ok"===n.value)for(let[e,t]of Object.entries(Rr.options)){let t=o[e];t&&(Rr.options[e]=t.checked)}this.objs=[];const r=new DataView(await t);if(this._isBinary(r)){const e=this._parseBinary(r);e&&(e.name="stlmesh",this.objs.push(e))}else{let e=(new TextDecoder).decode(r);const t=/solid (\S*)([\S\s]*)endsolid[ ]*(\S*)/g;let o;for(;o=t.exec(e);){let e=o[1];const t=o[3];e!=t&&console.log(`Error in STL, solid ${e} != endsolid ${t}`);const n=this._parseASCII(o[2]);n&&(n.name=e||"stlmesh",this.objs.push(n))}}return{world:this.objs,materialCatalog:[]}}_isBinary(e){return 84+50*e.getUint32(80,!0)===e.byteLength}_addVertex(e){if(!Rr.options.unify)return this.obj.addVertex(e).index}_parseASCII(e){this.objView=li(),this.obj=this.objView.geometry;const t=Br(this.obj,Rr.options.unify),o=[0,1,2];let n,r=0,i=/vertex(?:\s+(.+))$/gm;for(;n=i.exec(e);){let e=n[1].match(/\S+/g).map(Number);if(Rr.options.zup){let t=e[1];e[1]=e[2],e[2]=-t}o[r++]=t(e),r>=3&&(r=0,this.obj.addPolygon(o)||([o[0],o[2]]=[o[2],o[0]],this.obj.addPolygon(o)||this.non_manifold.push(o.slice())))}return this.obj.updateAffected(),this.objView}_parseBinary(e){this.objView=li(),this.obj=this.objView.geometry;const t=Br(this.obj,Rr.options.unify),o=e.getUint32(80,!0);let n=[0,0,0];const r=[0,0,0];for(let i=0;i<o;i++){let o=84+50*i+12;for(let i=0;i<3;i++,o+=12)r[0]=e.getFloat32(o,!0),Rr.options.zup?(r[1]=e.getFloat32(o+8,!0),r[2]=-e.getFloat32(o+4,!0)):(r[1]=e.getFloat32(o+4,!0),r[2]=e.getFloat32(o+8,!0)),n[i]=t(r);this.obj.addPolygon(n)||this.non_manifold.push(n.slice())}return this.obj.updateAffected(),this.objView}}Rr.options={unify:!0,zup:!0};const{vec2:Or,vec3:Nr}=glMatrix,Dr={showEdges:!0,showBackfaces:!0,showNormals:!1,showBB:!0,showBBCenter:!0,showColors:!0,showMaterials:!0,showTextures:!0,showNormalMaps:!0,showWireBackfaces:!1,showGroundplane:!0,showCamImagePlane:!1,showAxes:!0,infoVerbose:!1,constrainAxes:!0,clipPlane:!1,orthogonalView:!1,filterTexture:!0,frameDisregardsMirror:!1,useSceneLights:!1,forceOrthoAlongAxis:!1,workmode:!0,allowRotation:!0,allowInfoText:!0,showMiniAxis:!0},kr={activeVectorColor:[0,1,0],clipPlaneColor:[.8,.3,0],defaultAxis:[[0,0,0],[1,0,0]],gridColor:"#4D4D4D",draftBench:{unselectedEdgeColor:"#000000",hardEdgeColor:"#FF8000",selectedColor:"#A60000",selectedHilite:"#B3B300",unselectedHilite:"#00A600",unselectedVertexColor:"#000000",faceColor:"#C9CFB1",sculptMagnetColor:"#0000FF",tweakMagnetColor:"#0000FF",tweakVectorColor:"#FF8000"},draftBenchPref:{unselectedVertexSize:4,selectedVertexSize:5,maskedVertexSize:8,unselectedEdgeWidth:2,selectedEdgeWidth:2,hardEdgeWidth:2},normalVectorColor:[0,1,0],colorX:"#B3001A",colorY:"#5FD100",colorZ:"#004DCC",negColorX:"#CCCCCC",negColorY:"#CCCCCC",negColorZ:"#CCCCCC",geometryBackground:"#CCCCCC",css:{menubarBackground:"#3C3B37",menubarText:"#FFFFFF",menuBackground:"#3C3B37",menuText:"#FFFFFF",menuHighlight:"#F07746",menuHighlightText:"#FFFFFF",infoLineBackground:"#F2F1F0",infoLineText:"#4C4C4C",infoBackground:"#6161617F",infoText:"#FFFFFF"}},zr={geometryBackground:"FF",infoBackground:"7F"};function Ur(e,t){Object.entries(e).forEach(([o,n])=>{"object"!=typeof n||Array.isArray(n)?t(e,o,n):Ur(n,t)})}function jr(e){Ur(kr,(t,o,n)=>{let r=e.querySelector(`input[type=color][name=${o}]`);r&&(9===n.length?r.value=n.slice(0,7):r.value=n),r=e.querySelector(`input[type=number][name=${o}]`),r&&(r.value=n)}),Ur(Dr,(t,o,n)=>{const r=e.querySelector(`input[type=checkbox][name=${o}]`);r&&(r.checked=n)}),Ur(Dr,(e,t,o)=>{}),Ur(De,(t,o,n)=>{const r=e.querySelectorAll(`input[name=${o}]`);for(let e of r)e.value=n})}function Hr(e){Ur(kr,(t,o,n)=>{let r=e.querySelector(`input[type=color][name=${o}]`);r&&(t[o]=zr[o]?r.value+zr[o]:r.value),r=e.querySelector(`input[type=number][name=${o}]`),r&&(t[o]=r.value)});const t=document.documentElement;Object.entries(kr.css).forEach(([e,o])=>{var n;7===o.length?t.style.setProperty("--"+e,o):9===o.length&&t.style.setProperty("--"+e,(n=o,`rgba(${parseInt(n.slice(1,3),16)}, ${parseInt(n.slice(3,5),16)}, ${parseInt(n.slice(5,7),16)}, ${parseInt(n.slice(7,9),16)/255})`))}),ii.draftBench.setTheme(kr.draftBench,kr.draftBenchPref),Ur(Dr,(t,o,n)=>{const r=e.querySelector(`input[type=checkbox][name=${o}]`);r&&(t[o]=r.checked)}),Ur(De,(t,o,n)=>{const r=e.querySelector(`input[type=number][name=${o}]`);r&&(t[o]=r.value)}),pn()}const Xr={face:null,edge:null,vertex:null,body:null,multi:null,current:null};function qr(e){let t=document.getElementById("toggle"+e+"ModeFor");t&&!t.checked&&t.click()}function Gr(){return Xr.current===Xr.multi}function Yr(){const e=function(){let e=null;Xr.current!==Xr.vertex&&(e=Xr.current.toggleFunc(Xr.vertex),Xr.current=Xr.vertex,qr("Vertex"),pn());return e}();e&&yi(e)}function $r(){const e=function(){let e=null;Xr.current!==Xr.face&&(e=Xr.current.toggleFunc(Xr.face),Xr.current=Xr.face,qr("Face"),pn());return e}();e&&yi(e)}function Wr(){const e=Zr();e&&yi(e)}function Zr(){let e=null;return Xr.current!==Xr.edge&&(e=Xr.current.toggleFunc(Xr.edge),Xr.current=Xr.edge,qr("Edge"),pn()),e}function Kr(){const e=function(){let e=null;Xr.current!==Xr.body&&(e=Xr.current.toggleFunc(Xr.body),Xr.current=Xr.body,qr("Body"),pn());return e}();e&&yi(e)}function Jr(){const e=function(){let e=null;Xr.current!==Xr.multi&&(e=Xr.current.toggleFunc(Xr.multi),Xr.current=Xr.multi,qr("Multi"),pn());return e}();e&&yi(e)}function Qr(e){Xr.current!==Xr.vertex&&(Xr.current.restoreMode(Xr.vertex,e),Xr.current=Xr.vertex,qr("Vertex"),pn())}function ei(e){Xr.current!==Xr.face&&(Xr.current.restoreMode(Xr.face,e),Xr.current=Xr.face,qr("Face"),pn())}function ti(e){Xr.current!==Xr.edge&&(Xr.current.restoreMode(Xr.edge,e),Xr.current=Xr.edge,qr("Edge"),pn())}function oi(e){Xr.current!==Xr.body&&(Xr.current.restoreMode(Xr.body,e),Xr.current=Xr.body,qr("Body"),pn())}function ni(e){Xr.current!==Xr.multi&&(Xr.current.restoreMode(Xr.multi,e),Xr.current=Xr.multi,qr("Multi"),pn())}const ri=()=>Xr.current,ii={world:new Zo,draftBench:void 0,geometryGraph:void 0,imageList:void 0,materialList:void 0,lightList:void 0,currentObjects:void 0,currentParent:void 0,fileName:"",debug:{toggleOn:!1,queue:[]}};function si(e){ii.materialList.addMaterial(e)}function ai(e,t){const o=Pt.create(e,t);return ii.imageList.loadTexture(o),o}function li(){return di(new Qo(ii.draftBench))}function ci(e,t){t.removeFromParent(),e.insert(t),ii.geometryGraph.updateCount(ii.world)}function di(e,t=ii.world){t.insert(e),ii.geometryGraph.addNode(e,t);for(let t of e.getCage())t.display(!0);return pn(),ii.geometryGraph.updateCount(ii.world),ii.draftBench.updateAffected(),e}function ui(e){const t=e.removeFromParent();if(t){for(let t of e.getCage())t.display(!1);pn(),ii.geometryGraph.removeNode(e),ii.geometryGraph.updateCount(ii.world)}return t}function hi(){return ii.world.getCage()}function fi(){for(let e of ii.world.getCage())e.updateAffected();pn()}function pi(e){let t=new Qo(ii.draftBench);for(let t of e)ui(t);return t.merge(e),di(t),t}function gi(e,t){ii.currentObjects=t,ii.currentParent=e}function mi(){ii.debug.toggleOn&&(ii.world.checkIntegrity(),ii.debug.queue.push(ii.draftBench.checkPoint()))}const vi={queue:[],current:-1,isModified:!1};function xi(e){yi(new Re(e))}function yi(e){for(;vi.queue.length-1>vi.current;){vi.queue.pop().free()}vi.queue.push(e),vi.current++,pn(),vi.isModified=!0,mi()}function bi(){vi.queue.length-1>vi.current&&(vi.queue[++vi.current].doIt(Xr.current),pn(),vi.isModified=!0,mi())}function Si(){if(vi.current>=0){vi.queue[vi.current--].undo(Xr.current),pn(),vi.isModified=!0,function(){if(ii.debug.toggleOn&&(ii.world.checkIntegrity(),ii.debug.queue.pop(),ii.debug.queue.length)){const e=ii.debug.queue[ii.debug.queue.length-1];ii.draftBench.checkup(e)}}()}}const wi={cage:null,edge:null,vertex:null,face:null,plane:null};let Ei;const Ci={camera:null,mousemove:null,mouseSelect:null},Ai={center:Nr.create(),halfSize:Nr.create(),normal:Nr.create(),hilite:!1},Fi=()=>Ci.mouseSelect?Ci.mouseSelect.isVertexSelectable():!Xr.current||Xr.current.isVertexSelectable(),Mi=()=>Ci.mouseSelect?Ci.mouseSelect.isEdgeSelectable():!Xr.current||Xr.current.isEdgeSelectable();function _i(e,t,o){let n=null,r=null,i=null,s=null;if(wi.plane=null,null!==e){const o=Nr.create(),a=Nr.create(),l=Nr.create(),c=e.destination(),d=e.origin;Nr.sub(o,t,d),Nr.sub(a,t,c),Nr.sub(l,c,d);const u=Nr.length(o),h=Nr.length(a),f=Nr.length(l),p=f/4,g=Fi(),m=Mi(),v=Ci.mouseSelect?Ci.mouseSelect.isFaceSelectable():!Xr.current||Xr.current.isFaceSelectable(),x=!!Ci.mouseSelect&&Ci.mouseSelect.getPlaneNormal(),y=e.face;if(x&&(Nr.copy(Ai.halfSize,y.getBVHRoot().getHalfSize()),Nr.copy(Ai.normal,Ci.mouseSelect.getPlaneNormal())),g&&(u<h?(!m&&!v||u<p)&&(n=e.origin):(!m&&!v||h<p)&&(n=e.destination()),n&&x&&(Nr.copy(Ai.center,n),wi.plane=Ai)),m&&null===n){Nr.cross(o,o,a),Nr.sub(a,c,d);const t=Nr.length(o)/f;(!g&&!v||t<p)&&(r=e,x&&(Nr.add(Ai.center,r.origin,r.destination()),Nr.scale(Ai.center,Ai.center,.5),wi.plane=Ai))}v&&null===n&&null===r&&(i=e.face,x&&(Nr.copy(Ai.center,y.center),wi.plane=Ai)),g||m||v||(s=Ei)}n!==wi.vertex&&(null!==wi.vertex&&wi.vertex.setHilite(!1),null!==n&&(Ci.mouseSelect&&!Ci.mouseSelect.hilite({vertex:n,plane:wi.plane},Ei)?n=null:n.setHilite(!0)),wi.vertex=n),r!==wi.edge&&(null!==wi.edge&&wi.edge.setHilite(!1),null!==r&&(Ci.mouseSelect&&!Ci.mouseSelect.hilite({edge:r,plane:wi.plane},Ei)?r=null:r.setHilite(!0)),wi.edge=r),i!==wi.face&&(null!==wi.face&&wi.face.setHilite(!1),null!==i&&(Ci.mouseSelect&&!Ci.mouseSelect.hilite({face:i,plane:wi.plane},Ei)?i=null:i.setHilite(!0)),wi.face=i),s!==wi.cage&&(null!==wi.cage&&wi.cage.hiliteBody(!1),s&&s.hiliteBody(!0),wi.cage=s),wi.vertex||wi.edge||wi.face||(wi.plane=null)}const Ti=function(){let e=0;return{hide:()=>{0===e&&x.canvas.requestPointerLock(),++e},show:()=>{--e,0===e&&setTimeout(()=>{document.exitPointerLock()},1)}}}();function Pi(e){function t(o){"Tab"==o.key&&(o.preventDefault(),document.removeEventListener("keyup",t),Ti.show(),pe("#numericInput",(function(t){const o=t.querySelectorAll("label"),n=e.getInputSetting();for(let e=0;e<n.length;++e){o[e].classList.remove("hide");const t=o[e].querySelector("input");t.value=n[e].value,t.addEventListener("change",(function(t){Ci.mousemove.onInput(t,e)}));o[e].querySelector("span").textContent=n[e].name}})).then(([e,t])=>{"ok"==t.value?Ci.mousemove.commit():Ci.mousemove.rescind()}))}function o(){document.removeEventListener("keyup",t),Ti.show(),Ci.mousemove=null,pn()}Ti.hide(),document.addEventListener("keyup",t),Ci.mousemove={commit:()=>{e.commit(),yi(e),o()},rescind:()=>{e.undo(),o()},onMove:t=>{e.handleMouseMove(t,os.current.camera),pn()},onInput:(t,o)=>{e.handleInput(t,os.current.camera,o),pn()}}}function Li(e){Ci.mouseSelect=e}function Vi(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}let Ii=!0;function Bi(){Ii?help(`${Xo("clickSelect")}   ${Xo("paintSelect")}  M:${Xo("startCamera")}   R:${Xo("showMenu")}   [Alt]+R:${Xo("tweakMenu")}`):help(`L:${Xo("select")}   M:${Xo("startCamera")}  R:${Xo("showMenu")}   [Alt]+R:${Xo("tweakMenu")}`)}let Ri=(()=>{let e,t;function o(e){return{pos:[e.clientX,e.clientY],velocity:[0,0],time:Date.now()}}const n={is2Fingers:()=>!1,onDown:i=>2===i.touches.length?(e=[o(i.touches[0]),o(i.touches[1])],t=e,r):n,onUp:i=>2===i.touches.length?(e=[o(i.touches[0]),o(i.touches[1])],t=e,r):n,onCancel:e=>n,onMove:e=>n};const r={is2Fingers:()=>!0,onGesture:(o,n,r)=>{!function(o,n,r){let i=e[0].pos,s=t[0].pos,a=e[1].pos,l=t[1].pos;const c=[0,0],d=[0,0];Or.sub(c,s,i),Or.sub(d,l,a);let u=Or.len(c),h=Or.len(d);if(u>9||h>9){const f=[0,0],p=[0,0];Or.sub(f,l,s),Or.sub(p,a,i);let g=Math.atan2(f[1],f[0])-Math.atan2(p[1],p[0]);const m=Math.PI/25;if(g>m||g<-m)i[0]>a[0]&&([u,h]=[h,u]),g>0?o(-u,-h):o(u,h),e=t;else{let o=Math.sqrt(Or.sqrLen(f)/Or.sqrLen(p));if(Or.dot(c,d)<=0)(o>1.04||o<.96)&&(n(o),e=t);else{let o=u/h;o<1.22&&o>.8&&(Or.lerp(c,c,d,.5),r(c),e=t)}}}}(o,n,r)},onDown:o=>2!==o.touches.length?(e=t=null,n):r,onUp:o=>2!==o.touches.length?(e=t=null,n):r,onCancel:e=>{},onMove:e=>(2===e.touches.length&&(t=[o(e.touches[0]),o(e.touches[1])]),r)};return n})();function Oi(e){Ri=Ri.onDown(e)}function Ni(e){Ri=Ri.onUp(e)}function Di(e){Ri=Ri.onMove(e),2===e.touches.length&&Ri.onGesture((e,t)=>{os.current.camera.rotate(e,t)},e=>{e>=1?os.current.camera.zoomStep(-50*e):os.current.camera.zoomStep(1/e*50)},e=>{os.current.camera.pan(e[0],-e[1])})}let ki=null,zi=function(){let e={detail:0,lastDown:{time:0,pos:[0,0]}},t=new Map;return{downUpdate:t=>{if(t.isPrimary){const o=Date.now(),n=[t.clientX,t.clientY];o-e.lastDown.time<300&&Or.distance(n,e.lastDown.pos)<10?e.detail+=1:e.detail=1,e.lastDown.time=o,e.lastDown.pos=n}},upUpdate:e=>{e.isPrimary},moveUpdate:e=>{const o=[e.clientX,e.clientY];if(t.has(e.pointerId)){const n=t.get(e.pointerId);n.last=n.current,n.current=o}else t.set(e.pointerId,{last:o,current:o})},isDoubleDown:()=>2===e.detail,getMovement:(e,o)=>{const n=t.get(e);n&&(o.movementX=n.current[0]-n.last[0],o.movementY=n.current[1]-n.last[1])}}}();function Ui(e){const t=e.target.getBoundingClientRect();return{x:e.clientX-t.left,y:e.clientY-t.top}}function ji(e){const[t,o]=os.current.screenPointToWorld(e);Nr.sub(o,o,t),Nr.normalize(o,o);const n=new bt(t,o);let r=null;for(let e of ii.world.getCage())if(!e.isLock()&&e.isVisible()){const t=e.rayPick(n);null!==t&&(null===r||r.t>t.t)&&(r=t)}if(null!==r){Ei=r.model,ki=r;let e=Nr.create();Nr.scaleAndAdd(e,n.origin,n.direction,r.t),_i(r.edge,e,r.center),pn()}else null!==ki&&(_i(null),pn());ki=r}const Hi={start:function(){},move:function(e){if(!os.current.isInside(e.mousePos))for(let t=0;t<os.length;++t)if(os.viewports[t].isInside(e.mousePos)){rs(os.viewports[t]);break}ji(e.mousePos)},finish:function(e){}},Xi=function(){let e=null;return{start:function(t){Xr.current.toggleMulti(wi),e=Xr.current.selectStart(ki.model,wi),pn()},move:function(t){ji(t.mousePos),null!==ki&&(e.dragSelect(ki.model,wi),pn())},finish:function(t){yi(e.finish()),e=null}}}(),qi=function(){let e={rect:null,start:[0,0],end:[0,0]};return{start:function(t){e.start=e.end=t},move:function(t){Gr()&&Xr.current.toggleMulti({face:!0});let o=e.start.x;e.end=t.mousePos;let n=t.mousePos.x-o;n<0&&(n=-n,o=t.mousePos.x);let r=e.start.y,i=t.mousePos.y-r;var s;i<0&&(i=-i,r=t.mousePos.y),e.rect||(s=e.start,e.rect=Vi("rect"),e.rect.setAttributeNS(null,"x",s.x),e.rect.setAttributeNS(null,"y",s.y),e.rect.setAttributeNS(null,"fill","blue"),e.rect.setAttributeNS(null,"fill-opacity",.5),hn.appendChild(e.rect)),e.rect.setAttributeNS(null,"x",o),e.rect.setAttributeNS(null,"y",r),e.rect.setAttributeNS(null,"width",n),e.rect.setAttributeNS(null,"height",i),help(`[Ctrl] ${Xo("deselectMarquee")}    [Shift] ${Xo("whollyInsideMarquee")}`)},finish:function(t){if(e.rect){let o="frustumSelection";t.shiftKey&&(o="frustumSelectionWhole");const n=t.ctrlKey;if(e.start.x!==e.end.x&&e.start.y!==e.end.y){const t=new Be(o,os.current.selectionBox(e.start,e.end),n);t.doIt(Xr.current)&&yi(t)}hn.removeChild(e.rect),e.rect=null,Bi()}}}}(),Gi=function(){let e,t,o="tweakMove";return{start:function(n){if(Ti.hide(),t=!1,Gr()){for(let t of["vertex","edge","face","body"])if(wi[t]){e=Xr[t];break}}else e=Xr.current;e=e[o](ki.model,wi),pn()},finish:function(o){t?(yi(e.finish()),t=!1):(Gr()&&Xr.current.toggleMulti(wi),yi(e.finishAsSelect(wi))),e=null,Ti.show()},move:function(o){t=!0,e.handleMove(o,os.current.camera),pn()},setMode(e){o=e}}}();let Yi=Hi;function $i(e){Yi.finish(e),Yi=Hi}function Wi(e){Bi()}function Zi(e){$i(e)}function Ki(e){var t,o;e.preventDefault(),zi.downUpdate(e),0===e.button&&(null!==Ci.camera?Ci.camera.commit():null!==Ci.mousemove?Ci.mousemove.commit():null!==Ci.mouseSelect?Ci.mouseSelect.select(wi)&&(Ci.mouseSelect.isMoveable()?Pi(Ci.mouseSelect):yi(Ci.mouseSelect),Ci.mouseSelect=null):(t=zi.isDoubleDown(e.pointerId),o=Ui(e),null!==ki?Ii?t?(Si(),Yi=Xi):Yi=Gi:Yi=Xi:Yi=qi,Yi.start(o)))}function Ji(e){zi.upUpdate(e),0==e.button?$i(e):1==e.button?null===Ci.camera&&(e.stopImmediatePropagation(),function(e){function t(e){z(Q.cameraModeExit,os.current.camera),Bi(),Ci.camera=null,Ti.show()}Ti.hide(),z(Q.cameraModeEnter,os.current.camera),help(`L:${Xo("accept")}   M:${Xo("dragPan")}  R:${Xo("cancelRestoreView")}   ${Xo("moveMouseTumble")}`),Ci.camera={commit:()=>{e.commit(),t()},rescind:()=>{e.rescind(),t()},onMove:t=>{e.handleMouseMove(t)}}}(os.current.camera.getMouseMoveHandler())):2===e.button&&(Ci.camera?Ci.camera.rescind():Ci.mousemove?Ci.mousemove.rescind():(Ci.mouseSelect=null,pn()))}function Qi(e){zi.moveUpdate(e);const t=Object.assign({},e);t.mousePos=Ui(e),t.movementX=e.movementX,t.movementY=e.movementY,"mouse"!==e.pointerType&&zi.getMovement(e.pointerId,t),Ri.is2Fingers()||0===t.movementX&&0===t.movementY||(null!==Ci.camera?Ci.camera.onMove(t):null!==Ci.mousemove?Ci.mousemove.onMove(t):Yi.move(t))}function es(e){var t=e.deltaX,o=e.deltaY,n=e.deltaZ;if((t||o||n)&&e.deltaMode){var r=360;1==e.deltaMode&&(r=18),t*=r,o*=r,n*=r}os.current.camera.zoomStep(o)}function ts(e){if(e.defaultPrevented)return;const t=os.current.camera;switch(e.key){case"Down":case"ArrowDown":t.keyPanDownArrow();break;case"Up":case"ArrowUp":t.keyPanUpArrow();break;case"Left":case"ArrowLeft":t.keyPanLeftArrow();break;case"Right":case"ArrowRight":t.keyPanRightArrow();break;default:return}e.preventDefault()}const os={current:null,viewports:[],mode:0,length:1,hilite:null};function ns(){let e=os.current.viewport[0],t=os.current.viewport[1],o=os.current.viewport[2],n=os.current.viewport[3];t=x.canvas.height-n-t,os.hilite.setAttributeNS(null,"x",e),os.hilite.setAttributeNS(null,"y",t),os.hilite.setAttributeNS(null,"width",o),os.hilite.setAttributeNS(null,"height",n)}function rs(e){os.current!==e&&(os.current.makeCurrent(!1),os.current=e,e.makeCurrent(!0),ns())}function is(e,t){if(e!==os.mode){for(let e=t;e<os.length;++e)os.viewports[e].hide();os.mode=e,os.length=t,rs(os.viewports[0]),ss()}}function ss(){const e=x.getViewport();if(0===os.mode)os.viewports[0].setViewport(...e,e[3]);else{const t=Math.round(e[2]/2),o=e[2]-t,n=Math.round(e[3]/2),r=e[3]-n;1===os.mode?(os.viewports[0].setViewport(0,0,t,e[3],e[3]),os.viewports[1].setViewport(t,0,o,e[3],e[3])):2===os.mode?(os.viewports[0].setViewport(0,0,e[2],n,e[3]),os.viewports[1].setViewport(0,n,e[2],r,e[3])):(os.viewports[0].setViewport(0,0,t,n,e[3]),os.viewports[1].setViewport(t,0,o,n,e[3]),os.viewports[2].setViewport(0,n,t,r,e[3]),os.viewports[3].setViewport(t,n,o,r,e[3]))}ns()}function as(e){0!==ii.geometryGraph.updateStatus(ii.world)&&(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(1,1),Xr.face.polygonShader(e,wi.face||wi.cage),e.bindTransform(),ii.draftBench.draw(e,Xr.current),e.disable(e.POLYGON_OFFSET_FILL),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),Xr.current.edgeShader(e,Mi()),e.bindTransform(),ii.draftBench.drawEdge(e,Xr.current),Xr.current.vertexShader(e,Fi())&&(e.bindTransform(),ii.draftBench.drawVertex(e,Xr.current)),e.disable(e.BLEND),wi.plane&&ii.draftBench.drawPlane(e,wi.plane))}function ls(e){ii.world.numberOfCage()>0&&ii.draftBench.isModified()&&pn(),e.resizeToDisplaySize()&&ss();for(let t=0;t<os.length;++t)os.viewports[t].render(e,as);fn=!1}O((function(){Xr.face=new yo,Xr.edge=new po,Xr.vertex=new lo,Xr.body=new _o,Xr.multi=new En,Xr.current=Xr.multi,ii.draftBench=new Mn(kr.draftBench,kr.draftBenchPref,ii.materialList);for(let e=0;e<4;++e)os.viewports.push(new gn([0,0,x.canvas.width,x.canvas.height],Dr.orthogonalView,Dr.showAxes,Dr.showGroundplane));os.current=os.viewports[0],os.hilite=Vi("rect"),os.hilite.setAttributeNS(null,"x",0),os.hilite.setAttributeNS(null,"y",0),os.hilite.setAttributeNS(null,"stroke","black"),os.hilite.setAttributeNS(null,"fill","none"),hn.appendChild(os.hilite),ne(Q.singlePane.name,e=>{const t=document.querySelector('input[data-menuid="singlePane"');t!==e.target&&(t.checked=!0),is(0,1)}),ne(Q.horizontalPane.name,e=>{const t=document.querySelector('input[data-menuid="horizontalPane"');t!==e.target&&(t.checked=!0),is(1,2)}),ne(Q.verticalPane.name,e=>{const t=document.querySelector('input[data-menuid="verticalPane"');t!==e.target&&(t.checked=!0),is(2,2)}),ne(Q.quadPane.name,e=>{const t=document.querySelector('input[data-menuid="quadPane"');t!==e.target&&(t.checked=!0),is(3,4)});const e=[{id:Q.deselect,fn:"resetSelection",hotKey:" "},{id:Q.more,fn:"moreSelection",hotKey:"+"},{id:Q.less,fn:"lessSelection",hotKey:"-"},{id:Q.similar,fn:"similarSelection",hotkey:"i"},{id:Q.all,fn:"allSelection",hotKey:"a",meta:"ctrl"},{id:Q.inverse,fn:"inverseSelection",hotKey:"i",meta:"ctrl+shift"},{id:Q.adjacent,fn:"adjacentSelection"}];for(let t of e)ne(t.id.name,(function(e){const o=new Be(t.fn);o.doIt(Xr.current)&&yi(o)}),t.hotKey,t.meta);ne(Q.openSidebar.name,e=>{const t=document.querySelector("#sidebar"),o=document.querySelector("#openSidebarFor");t&&o&&(o.checked?t.style.display="none":t.style.display="flex")});const t=[{id:Q.undoEdit,fn:Si,hotKey:" "},{id:Q.redoEdit,fn:bi,hotKey:" "},{id:Q.toggleVertexMode,fn:Yr,hotKey:" "},{id:Q.toggleEdgeMode,fn:Wr,hotKey:" "},{id:Q.toggleFaceMode,fn:$r,hotKey:" "},{id:Q.toggleBodyMode,fn:Kr,hotKey:" "},{id:Q.toggleMultiMode,fn:Jr,hotkey:" "}];for(let e of t)ne(e.id.name,(function(t){help("wings3d - "+t.currentTarget.id),e.fn()}));const o=[{id:Q.toggleGround,propName:"showGroundplane",selector:"#toggleGroundFor"},{id:Q.toggleAxes,propName:"showAxes",selector:"#toggleAxesFor"},{id:Q.toggleOrtho,propName:"orthogonalView",selector:"#toggleOrthoFor"}];for(let e of o)ne(e.id.name,t=>{const o=document.querySelector(e.selector);o&&(Dr[e.propName]=!o.checked,os.current[e.propName](!o.checked))});ne(Q.preferenceButton.name,e=>{fe("#preferenceForm",Hr,jr)}),ii.geometryGraph=function(e,t,o){const n=document.querySelector(e),r=document.querySelector(t);return n&&r?new Yn(n,r,o):null}("#objectListLabel","#objectList",ii.world),Z([],0,Q.toggleObjectSelect.name,e=>{Gr()&&$r();const t=new Gt(e.target),o=new so(ri(),ri().selectObject,[ii.currentObjects,e.target],ri().undoSelectObject,[e.target]);o.doIt(),xi([t,o])}),Z([],0,Q.toggleObjectVisibility.name,e=>{const t=new Gt(e.target),o=new so(ri(),ri().toggleObjectVisibility,[ii.currentObjects,e.target],ri().undoObjectVisibility);o.doIt(),xi([t,o])}),Z([],0,Q.toggleObjectLock.name,e=>{const t=new Gt(e.target),o=new so(ri(),ri().toggleObjectLock,[ii.currentObjects,e.target],ri().undoToggleObjectLock);o.doIt(),xi([t,o])}),Z([],0,Q.toggleWireMode.name,e=>{const t=new Gt(e.target),o=new so(ri(),ri().toggleObjectWireMode,[ii.currentObjects,e.target.checked],ri().undoToggleObjectWireMode);o.doIt(),xi([t,o])}),ne(Q.objectDelete.name,e=>{const t=Xr.body.deleteCommand(ii.currentObjects);yi(t),t.doIt()}),ne(Q.objectDuplicate.name,e=>{const t=Xr.body.duplicateCommand(ii.currentObjects);yi(t),t.doIt()}),ne(Q.createGroup.name,e=>{const t=new Zo;t.name="new_folder";let o=ii.currentParent;o||(o=ii.world),o.insert(t),ii.geometryGraph.addGroup(o.guiStatus.ul,t)}),ne(Q.createGroupWorld.name,e=>{const t=new Zo;t.name="new_folder";let o=ii.world;o.insert(t),ii.geometryGraph.addGroup(o.guiStatus.ul,t)}),ne(Q.openTweak.name,e=>{const t=document.querySelector("#tweak-context-menu"),o=e.target.getBoundingClientRect(),n=e.clientX,r=e.clientY+(o.bottom-o.top);t.style.left=n+"px",t.style.top=r+"px",Me(t)}),ne(Q.toggleTweak.name,(function(e){const t=(Ii=!Ii,Ii),o=document.querySelectorAll('input[data-menuid="toggleTweak"]');for(let n of o)n!==e.target&&(n.checked=t)})),ne(Q.tweakMoveFree.name,(function(e){Gi.setMode("tweakMove");document.querySelector('input[data-menuid="tweakMoveFree"').checked=!0})),ne(Q.tweakMoveNormal.name,(function(e){Gi.setMode("tweakMoveNormal");document.querySelector('input[data-menuid="tweakMoveNormal"').checked=!0})),ne(Q.tweakScaleFree.name,(function(e){Gi.setMode("tweakScale");document.querySelector('input[data-menuid="tweakScaleFree"').checked=!0})),ne(Q.tweakScaleUniform.name,(function(e){Gi.setMode("tweakScaleUniform");document.querySelector('input[data-menuid="tweakScaleUniform"').checked=!0})),ii.imageList=function(e,t){const o=document.querySelector(t),n=document.querySelector(e);return n&&o?new Wn(n,o):null}("#imageListLabel","#imageList"),ne(Q.importImageFileGUI.name,(function(e){Ir(["bmp","jpg","jpeg","jfif","pjpeg","pjp","png","webp"]).then(([e,t])=>{for(let t of e){const e=ai(t.name);t.image().then(t=>(e.setImage(t),t))}}).catch(e=>{alert(e)})})),ne(Q.showImage.name,(function(e){ii.imageList.showImage(ii.currentObjects)})),ne(Q.deleteImage.name,(function(e){ii.imageList.deleteImage(ii.currentObjects)})),ii.materialList=function(e,t){const o=document.querySelector(t),n=document.querySelector(e);if(n&&o){const e=new Zn(n,o);e.addMaterial(Tt.default);return e}return null}("#materialListLabel","#materialList"),ne(Q.createMaterial.name,(function(e){ii.materialList.createMaterial(e)})),ne(Q.editMaterial.name,(function(e){ii.currentObjects[0].editMaterial(e)})),ne(Q.deleteMaterial.name,(function(e){ii.currentObjects[0].isInUse()?alert("Materials is in use"):ii.materialList.deleteMaterial(ii.currentObjects)})),ne(Q.renameMaterial.name,(function(e){ii.materialList.renameMaterial(e,ii.currentObjects)})),ne(Q.duplicateMaterial.name,(function(e){ii.materialList.duplicateMaterial(ii.currentObjects)})),ne(Q.assignMaterial.name,(function(e){if(Xr.current===Xr.face){const e=new so(ri(),ri().assignMaterial,[ii.currentObjects[0].material],ri().undoAssignMaterial);yi(e),e.doIt()}else help("Cannot Assign Material without selecting Face")})),ne(Q.selectMaterial.name,(function(e){const t=ri().selectMaterialCmd([ii.currentObjects[0]]);t.doIt(),yi(t)})),ne(Q.deleteTexture.name,(function(e){const t=ii.currentObjects[0];t.ui.removeTexture(t.textureType)}));let n=document.querySelectorAll("li.dropdown > a");for(let e of n){const t=e.getAttribute("data-menuid");if(t){let o=e.nextElementSibling;o&&o.classList.contains("popup")&&o.classList.contains("menu")&&ne(t,(function(e){Me(o)}))}}n=document.querySelectorAll("li.dropside > a");for(let e of n){const t=e.getAttribute("data-menuid");if(t){let o=e.nextElementSibling;o&&o.classList.contains("popup")&&o.classList.contains("menu")&&ne(t,(function(e){be(o),e.stopPropagation()}))}}document.addEventListener("keydown",(function(e){!function(e,t){const o=j(t.altKey,t.ctrlKey,t.shiftKey),n=t.key.toLowerCase();let r=te.get(n);if(r){for(let n of r)if(o===n.meta&&n.mode===e)return void K(0,n.id,t);for(let e of r)if(o===e.meta&&null===e.mode)return void K(0,e.id,t)}}(ri(),e)})),x.canvas.addEventListener("pointerenter",Wi,!1),x.canvas.addEventListener("pointerdown",Ki,!1),x.canvas.addEventListener("pointerup",Ji,!1),x.canvas.addEventListener("pointerleave",Zi,!1),x.canvas.addEventListener("pointermove",Qi,!1),x.canvas.addEventListener("touchstart",Oi),x.canvas.addEventListener("touchend",Ni),x.canvas.addEventListener("touchmove",Di),x.canvas.addEventListener("wheel",es,!1),x.canvas.addEventListener("pointerover",(function(e){x.canvas.focus()})),x.canvas.addEventListener("pointerout",(function(e){x.canvas.blur()})),x.canvas.addEventListener("keydown",ts,!1);const r={menu:document.querySelector("#create-context-menu")},i={menu:document.querySelector("#tweak-context-menu")};x.canvas.addEventListener("contextmenu",(function(e){if(t=e,!Ri.is2Fingers()&&!Ci.mouseSelect||(t.preventDefault(),t.stopImmediatePropagation(),0)){let t;e.preventDefault(),e.altKey?t=i:(t=ri().getContextMenu(),t&&t.menu||(t=r)),Fe(t.menu),ae(t.menu,se(e))}var t}),!1),tn.addLoadStore(new mn),tn.addLoadStore(new Rr),tn.addLoadStore(new rn);let s=new Sn;async function a(e){if(vi.isModified&&ii.world.numberOfCage()>0){const[e,t]=await pe("#askSaveDialog",null);let o="cancel"===t.value;if("ok"===t.value&&await Lr(s.extension()).then((e,t)=>s.export(e,t,hi())).catch(e=>{o=!0,alert(e)}),o)return!1}return Mr={},_r={},function(){for(;vi.queue.length;){vi.queue.pop().free()}vi.isModified=!1,vi.current=-1}(),Xr.current.resetSelection(),ii.world.empty(),pn(),!0}async function l(e,t){Ir(t.fileTypes()).then(([e,o])=>t.import(e,o)).catch(e=>{alert(e)})}async function c(e,t){ii.world.numberOfCage()>0&&Lr(t.extension()).then(([e,o])=>t.export(hi(),e,o)).catch(e=>{alert(e)})}tn.setDefault(s);for(let e of tn.LOADSTORE){if(e.importMenuText){const t=e.importMenuText;ie("fileImport","import"+t.name,`${t.name} (.${t.ext})...`,(function(t){l(0,e)}))}if(e.exportMenuText){const t=e.exportMenuText;ie("fileExport","export"+t.name,`${t.name} (.${t.ext})...`,(function(t){c(0,e)}))}}ne(Q.save.name,(function(e){c(0,s)})),ne(Q.saveAs.name,(function(e){!async function(e,t,o=!1){ii.world.numberOfCage()>0&&Pr(t.extension()).then(([e,o])=>t.export(hi(),e,o)).then(e=>{o||Tr(e)}).catch(e=>{alert(e)})}(0,s)})),ne(Q.open.name,(function(e){!async function(e,t){await a()&&Ir(t.fileTypes()).then(([e,o])=>t.import(e,o)).then(e=>{Tr(e)}).catch(e=>{alert(e)})}(0,s)})),ne(Q.clearNew.name,(function(e){a()})),window.addEventListener("keyup",(function(e){e.altKey&&e.ctrlKey&&"j"===e.key&&(ii.debug.toggleOn=!ii.debug.toggleOn,ii.debug.toggleOn?alert("In Debug Mode"):ii.debug.queue=[])})),requestAnimationFrame((function e(t){ls(x),requestAnimationFrame(e)})),de("#start-help","center")}));let cs=null;const ds={stops:new Map,routes:[],currentStation:-1};let us=null,hs={};function fs(e){hs.next&&(hs.next.style.display=e?"inline-block":"none")}function ps(){return us||ds.routes[ds.currentStation]}function gs(e){const t=hs.bubble.getElementsByClassName(e);if(t.length>0)return t[0]}let ms=function(e){if(e<0||e>=ds.routes.length)console.log("bad step number in tutor guide");else{if(e===ds.routes.length-1&&(hs.next.textContent="Done"),ds.currentStation>=0&&ds.currentStation<ds.routes.length){ps().done()}ds.currentStation=e;const t=ps();fs(t.option("showNext")),t.show()}};function vs(){ds.currentStation>-1&&ds.routes[ds.currentStation].done(),hs.bubble.classList.add("hide"),hs.next.textContent="Next",ds.stops.clear(),ds.routes.length=0,ds.currentStation=-1,U(ys,!1)}function xs(){ms(ds.currentStation+1)}function ys(e,t){if(ds.currentStation>=0){ps().expect(e,t),"createCube"===e&&(cs=value)}}O((function(e){hs.bubble=document.getElementById("tutorGuide"),hs.bubble&&(hs.close=gs("close"),hs.close&&hs.close.addEventListener("click",(function(e){vs()})),hs.next=gs("next"),hs.next&&hs.next.addEventListener("click",(function(e){"Done"===hs.next.textContent?vs():xs()})),hs.title=gs("tutor-title"),hs.content=gs("tutor-content"),hs.select=gs("tutor-selection"),hs.progressBar=gs("tutor-progress"),hs.progressDone=gs("tutor-progress-done"),hs.progressIndicator=gs("tutor-progress-indicator"))}));const{quat:bs,mat4:Ss}=glMatrix,ws=function(){const e=document.createElement("template");return function(t,...o){e.innerHTML=t;const n=e.content.firstChild;return o&&o.map((function(e){n.addEventListener(e[0],e[1])})),n}}();function Es(e,...t){const o=ws(e);return t.map(e=>{o.appendChild(e)}),o}function Cs(e,t,o){let n="";for(let[e,o]of Object.entries(t))n+=` ${e}='${o}'`;return Es("<fieldset>",ws("<legend data-i18n>Number of Cuts</legend>"),ws(`<input type='range' name=${e}${n} onchange="this.nextElementSibling.value=this.value">`,["change",o]),ws(`<input type='number' name=${e}${n} onchange="this.previousElementSibling.value=this.value">`,["change",o]))}function As(e,t,o,n=!0){const r=ws(`<label><span ${n?"data-i18n":""}>${e}</span></label>`);let i="";for(let[e,o]of Object.entries(t))i+=` ${e}='${o}'`;const s=ws(`<input type='number'${i}>`,["change",o]);return r.appendChild(s),r}function Fs(e,t,o,...n){const r=ws('<form class="dialog small"></form>',["reset",function(e){o.reset()}],["submit",function(e){e.preventDefault(),o.confirm(),document.body.removeChild(r)}]);let i,s;if(r.appendChild(i=Es(`<h3 class="primitiveHeader"><span data-i18n>${t}</span></h3>`,ws('<span class="close">&times;</span>',["click",function(e){o.cancel(),document.body.removeChild(r)}]))),n)for(let e of n)r.appendChild(e);r.appendChild(Es('<fieldset">',Es('<div class="horizontalPref alignCenter">',ws("<label data-i18n>Rotate</label>"),Es('<span class="verticalPref">',As("X",{value:0,step:1,name:"rotate_x"},(function(e){o.rotate(0,e.target.value)}),!1),As("Y",{value:0,step:1,name:"rotate_y"},(function(e){o.rotate(1,e.target.value)}),!1),As("Z",{value:0,step:1,name:"rotate_z"},(function(e){o.rotate(2,e.target.value)}),!1)),ws("<label data-i18n>Move</label>"),Es('<span class="verticalPref">',As("X",{value:0,step:1,name:"translate_x"},(function(e){o.translate(0,e.target.value)}),!1),s=As("Y",{value:0,step:1,name:"translate_y"},(function(e){o.translate(1,e.target.value)}),!1),As("Z",{value:0,step:1,name:"translate_z"},(function(e){o.translate(2,e.target.value)}),!1))),function(e,t,o){const n=document.createElement("label");let r="";for(let[e,o]of Object.entries(t))r+=` ${e}='${o}'`;const i=ws(`<input type='checkbox'${r}>`,["change",o]);return n.appendChild(i),n.appendChild(ws(`<span data-i18n>${e}</span>`)),n}("Put on Ground",{name:"ground"},(function(e){const t=e.target.checked;s.disabled=t,o.putOnGround(t)})))),r.appendChild(Es("<div>",ws('<button type="reset" value="Reset">Reset</button>'),ws('<button type="submit" value="Ok">Ok</button>'))),function(e,t){let o,n;function r(t){t.preventDefault(),e.style.top=e.offsetTop+t.clientY-n+"px",e.style.left=e.offsetLeft+t.clientX-o+"px",o=t.clientX,n=t.clientY}t.addEventListener("pointerdown",(function(e){o=e.clientX,n=e.clientY,document.body.addEventListener("pointermove",r,!1),t.classList.add("dragging")}),!1),t.addEventListener("pointerup",(function(e){t.classList.remove("dragging"),document.body.removeEventListener("pointermove",r)}),!1),t.classList.add("draggable")}(r,i),qo(Go(r)),r.style.display="flex",ae(r,se(e)),document.body.appendChild(r)}class Ms{constructor(e,t,o){this.name=e,this.cage=null,this.makeShape=t,this.options=Object.assign({},o),this.rotation=[0,0,0],this.translation=[0,0,0],this.ground=!1,this.default={},Object.assign(this.default,o)}cancel(){this.cage&&(ui(this.cage),this.cage.freeBuffer(),this.cage=null)}confirm(){yi(new en(this.cage)),Ms.reationCount++,this.cage.name=this.name+Ms.creationCount,this.cage=null}make(){this.cancel(),function(e){const t=new Qo(ii.draftBench);e(t),di(t),fi()}(e=>{this.cage=e,this.originY=this.makeShape(e.geometry,Tt.defaultMaterial,this.options),this.snapshot=e.snapshotTransformBodyGroup(!0),this.transform()})}transform(e){let t=!1;e&&(this.cage.restoreMoveSelection(e),t=!0);let o=bs.create();bs.fromEuler(o,this.rotation[0],this.rotation[1],this.rotation[2]);const n=Ss.create();Ss.fromRotationTranslation(n,o,this.translation),this.ground&&(n[13]=-this.originY);const r=Ss.create();Ss.identity(r),Ss.exactEquals(r,n)||(this.cage.transformSelection(this.snapshot,(e,t)=>{Ss.copy(e,n)}),t=!0),t&&this.cage.updatePosition(this.snapshot)}putOnGround(e){this.ground=e,this.transform(this.snapshot)}reset(){Object.assign(this.options,this.default),this.ground=!1,this.rotation=[0,0,0],this.translation=[0,0,0],this.make()}rotate(e,t){this.rotation[e]=t,this.transform(this.snapshot)}translate(e,t){this.translation[e]=t,this.transform(this.snapshot)}update(e,t){this.options[e]=t,this.make()}}function _s(e,t,o,n){let r=Q["create"+e].name;ne(r,(function(n){const r=new Ms(e,t,o);r.make(),r.confirm()}));const i=function(r){const i=new Ms(e,t,o);i.make(),Fs(r,e+" Options",i,...n(i))};!function(e,t){const o=document.querySelectorAll(`[data-menuId="${e}"]`);o?oe(null,o,2,e,t):console.log("ContextClick: could not find menuItem "+e)}(r,i),ne(Q["create"+e+"Pref"].name,i)}function Ts(e,t,o){let n=-o.height/2;return function(e,t,o,n,r,i,s){if(o<3||n<0||i<0||s<0)return!1;const a=[];for(let t of Pn(o,r,i,s))a.push(e.addVertex(t).index);e.addPolygon(a,t);let l=[0,r+n,0];const c=[e.addVertex(l).index,0,a[a.length-1]];for(let o=0;o<a.length;++o)c[1]=a[o],e.addPolygon(c,t),c[2]=c[1]}(e,t,o.sections,o.height,n,o.r1,o.r2),n}function Ps(e,t,o){let n=-o.sizeX/2,r=-o.sizeY/2;return function(e,t,o,n,r,i,s,a,l){const c={};function d(t){var o=t[0],n=t[1],r=t[2],i=o.toFixed(6)+","+n.toFixed(6)+","+r.toFixed(6);return c.hasOwnProperty(i)||(c[i]=e.addVertex(t)),c[i].index}function u(o){var n=0,r=[],i=[];for(let s=0;s<=l;++s){for(let e=0;e<=l;++e)r.push(d(o(s,e)));if(s>0){for(let o=0;o<l;++o)i.push(r[n+o]),i.push(r[n+o+1]),i.push(r[n+o+1+l+1]),i.push(r[n+o+l+1]),e.addPolygon(i,t),i.length=0;n+=l+1}}}const h=_n.fromValues(o,n,r),f=_n.fromValues(i,0,0),p=_n.fromValues(0,s,0),g=_n.fromValues(0,0,a),m=_n.create(),v=[],x=[],y=[];for(let e=0;e<=l;++e){const t=e/l,o=_n.create();_n.scale(o,f,t),v.push(o);const n=_n.create();_n.scale(n,p,t),x.push(n);const r=_n.create();_n.scale(r,g,t),y.push(r)}_n.add(m,h,f),u((function(e,t){return _n.fromValues(m[0]-v[t][0]+x[e][0],m[1]-v[t][1]+x[e][1],m[2]-v[t][2]+x[e][2])})),u((function(e,t){return[m[0]-v[e][0]+y[t][0],m[1]-v[e][1]+y[t][1],m[2]-v[e][2]+y[t][2]]})),_n.add(m,m,g),u((function(e,t){return[m[0]+x[e][0]-y[t][0],m[1]+x[e][1]-y[t][1],m[2]+x[e][2]-y[t][2]]})),_n.add(m,h,g),u((function(e,t){return[m[0]+v[t][0]+x[e][0],m[1]+v[t][1]+x[e][1],m[2]+v[t][2]+x[e][2]]})),u((function(e,t){return[h[0]+x[e][0]+y[t][0],h[1]+x[e][1]+y[t][1],h[2]+x[e][2]+y[t][2]]})),_n.add(m,h,f),_n.add(m,m,p),_n.add(m,m,g),u((function(e,t){return[m[0]-v[e][0]-y[t][0],m[1]-v[e][1]-y[t][1],m[2]-v[e][2]-y[t][2]]}))}(e,t,n,r,-o.sizeZ/2,o.sizeX,o.sizeY,o.sizeZ,o.cut),r}function Ls(e,t,o){let n=-o.height/2;return function(e,t,o,n,r,i,s,a,l){const c=[];for(let t of Pn(o,r,i,s))c.push(e.addVertex(t).index);e.addPolygon(c,t);const d=[];for(let t of Pn(o,r+n,a,l))d.push(e.addVertex(t).index);const u=[c[o-1],d[o-1],0,0];for(let n=0;n<o;++n)u[2]=d[n],u[3]=c[n],e.addPolygon(u,t),u[0]=u[3],u[1]=u[2];e.addPolygon(d.reverse(),t)}(e,t,o.sections,o.height,n,o.bottomR1,o.bottomR2,o.topR1,o.topR2),n}function Vs(e,t,o){return In(e,t,o.sections,o.slices,o.radialX,o.radialY),-o.radialX}function Is(e,t,o){return function(e,t,o,n,r,i,s){function a(o,n){const r=[o[o.length-1],n[n.length-1],-1,-1];for(let i=0;i<n.length;++i)r[2]=n[i],r[3]=o[i],e.addPolygon(r,t),r[0]=r[3],r[1]=r[2]}let l,c,d=2*Math.PI/n;for(let t=0;t<n;++t){let n=-Math.cos(t*d)*s,u=Math.sin(t*d)*s,h=[];for(let t of Pn(o,n,r+u,i+u))h.push(e.addVertex(t).index);l?a(l,h):c=h,l=h}a(l,c)}(e,t,o.sections,o.slices,o.r1,o.r2,o.rMinor),-o.rMinor}function Bs(e,t,o){return function(e,t,o,n,r){let i=2*n,s=-n,a=-r,l=-n;function c(){let t=[];for(let n=0;n<o;n++){let r=n/(o-1)*i;r+=s;let c=[];for(let t=0;t<o;t++){let n=t/(o-1)*i;n+=l,c.push(e.addVertex([r,a,n]).index)}t.push(c)}return t}let d=c();for(let n=1;n<o;++n)for(let r=1;r<o;++r){const o=[d[n-1][r-1],d[n][r-1],d[n][r],d[n-1][r]];e.addPolygon(o,t)}a=r;let u=c();for(let n=1;n<o;++n)for(let r=1;r<o;++r){const o=[u[n-1][r-1],u[n-1][r],u[n][r],u[n][r-1]];e.addPolygon(o,t)}let h=o-1;for(let n=1;n<o;++n){let o=[d[n-1][0],u[n-1][0],u[n][0],d[n][0]];e.addPolygon(o,t)}for(let n=1;n<o;++n){let o=[d[n][h],u[n][h],u[n-1][h],d[n-1][h]];e.addPolygon(o,t)}for(let n=1;n<o;++n){let o=[d[0][n],u[0][n],u[0][n-1],d[0][n-1]];e.addPolygon(o,t)}for(let n=1;n<o;++n){let o=[d[h][n-1],u[h][n-1],u[h][n],d[h][n]];e.addPolygon(o,t)}}(e,t,o.resolution,o.size,o.thickness),-o.thickness}function Rs(e,t,o){return function(e,t,o,n,r){Bn(e,t,o,n,r,Ln)}(e,t,o.segments,2*o.sections,o.loops),-1}function Os(e,t,o){return function(e,t,o,n,r){Bn(e,t,o,n,r,Vn)}(e,t,o.segments,2*o.sections,o.loops),-1}function Ns(e,t,o){return function(e,t,o){const n=o/2,r=Math.sqrt(3),i=n*r,s=n/r,a=o*Math.sqrt(2/3),l=a/3,c=[[0,a-l,0],[0,-l,i-s],[-n,-l,-s],[n,-l,-s]],d=[];for(let t of c)d.push(e.addVertex(t).index);return e.addPolygon([d[2],d[1],d[0]],t),e.addPolygon([d[1],d[2],d[3]],t),e.addPolygon([d[1],d[3],d[0]],t),e.addPolygon([d[3],d[2],d[0]],t),-l}(e,t,o.length)}function Ds(e,t,o){return function(e,t,o){const n=[];for(let t of[[o,0,0],[-o,0,0],[0,o,0],[0,-o,0],[0,0,o],[0,0,-o]])n.push(e.addVertex(t).index);for(let o of[[2,4,0],[4,2,1],[4,3,0],[3,4,1],[5,2,0],[2,5,1],[3,5,0],[5,3,1]])e.addPolygon([n[o[0]],n[o[1]],n[o[2]]],t);return-o}(e,t,o.height)}function ks(e,t,o){return function(e,t,o){const n=o/2,r=[[1,1/3,1/3],[1,1/3,-1/3],[1,-1/3,1/3],[1,-1/3,-1/3],[-1,1/3,1/3],[-1,1/3,-1/3],[-1,-1/3,1/3],[-1,-1/3,-1/3],[1/3,1,1/3],[1/3,1,-1/3],[1/3,-1,1/3],[1/3,-1,-1/3],[1/3,1/3,1],[1/3,1/3,-1],[1/3,-1/3,1],[1/3,-1/3,-1],[-1/3,1,1/3],[-1/3,1,-1/3],[-1/3,-1,1/3],[-1/3,-1,-1/3],[-1/3,1/3,1],[-1/3,1/3,-1],[-1/3,-1/3,1],[-1/3,-1/3,-1]],i=[];for(let t of r)i.push(e.addVertex([t[0]*n,t[1]*n,t[2]*n]).index);const s=[[2,3,1,0],[7,6,4,5],[9,8,0,1],[10,11,3,2],[12,0,8],[12,14,2,0],[13,9,1],[14,10,2],[15,3,11],[15,13,1,3],[16,17,5,4],[16,20,12,8],[17,16,8,9],[18,19,11,10],[19,18,6,7],[19,23,15,11],[20,16,4],[20,22,14,12],[21,5,17],[21,17,9,13],[21,23,7,5],[22,6,18],[22,18,10,14],[22,20,4,6],[23,19,7],[23,21,13,15]];for(let o of s)e.addPolygon(o.map(e=>i[e]),t);return-1*n}(e,t,o.height)}function zs(e,t,o){return function(e,t,o){const n=Math.sqrt(5),r=o/2*((1+n)/2),i=Math.sqrt(2/(3+n)),s=r*i,a=r*(1+Math.sqrt(6/(3+n)-2+2*i)),l=[[-s,0,a],[s,0,a],[-r,-r,-r],[-r,-r,r],[-r,r,-r],[-r,r,r],[r,-r,-r],[r,-r,r],[r,r,-r],[r,r,r],[a,s,0],[a,-s,0],[-a,s,0],[-a,-s,0],[-s,0,-a],[s,0,-a],[0,a,s],[0,a,-s],[0,-a,s],[0,-a,-s]],c=[];for(let t of l)c.push(e.addVertex(t).index);const d=[[0,1,9,16,5],[1,0,3,18,7],[1,7,11,10,9],[11,7,18,19,6],[8,17,16,9,10],[2,14,15,6,19],[2,13,12,4,14],[2,19,18,3,13],[3,0,5,12,13],[6,15,8,10,11],[4,17,8,15,14],[4,12,5,16,17]];for(let o of d)e.addPolygon(o.map(e=>c[e]),t);return-a}(e,t,o.length)}function Us(e,t,o){return function(e,t,o){const n=Math.PI/10,r=2*n,i=Math.cos(r),s=o/2/Math.sin(r),a=i*s,l=s*Math.cos(n),c=s*Math.sin(n),d=Math.sqrt(o*o-s*s),u=(Math.abs(s)*Math.sqrt(1+2*i)-d)/2,h=u+d,f=[[0,h,0],[s,u,0],[c,u,l],[-a,u,o/2],[-a,u,-o/2],[c,u,-l],[-s,-u,0],[-c,-u,-l],[a,-u,-o/2],[a,-u,o/2],[-c,-u,l],[0,-h,0]],p=[];for(let t of f)p.push(e.addVertex(t).index);const g=[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[4,7,6],[2,9,1],[5,8,7],[3,10,2],[9,8,1],[4,6,3],[10,9,2],[7,4,5],[6,10,3],[1,8,5],[11,10,6],[11,6,7],[11,7,8],[11,8,9],[11,9,10]];for(let o of g)e.addPolygon([p[o[0]],p[o[1]],p[o[2]]],t);return-h}(e,t,o.length)}let js;function Hs(e,t,o){e.preventDefault(),e.stopPropagation();let n=document.querySelector(t);n&&(Fe(n),ae(n,se(e)),gi(null,[o]))}Ms.creationCount=0,O((function(){_s("Cone",Ts,{sections:16,height:2,r1:1,r2:1},e=>[Es('<div class="primitiveOptions"></div>',As("Sections",{min:3,value:16,step:1},(function(t){e.update("sections",Number(t.target.value))})),As("Height",{min:0,value:2},(function(t){e.update("height",Number(t.target.value))})),As("X Diameter",{min:0,value:2},(function(t){e.update("r1",Number(t.target.value)/2)})),As("Z Diameter",{min:0,value:2},(function(t){e.update("r2",Number(t.target.value)/2)})))]),_s("Cube",Ps,{sizeX:2,sizeY:2,sizeZ:2,cut:1},e=>[Cs("numberOfCuts",{min:1,max:20,value:1,step:1},(function(t){e.update("cut",Number(t.target.value))})),Es('<div class="primitiveOptions"></div>',As("X",{min:0,step:"any",value:2},(function(t){e.update("sizeX",Number(t.target.value))}),!1),As("Y",{min:0,step:"any",value:2},(function(t){e.update("sizeY",Number(t.target.value))}),!1),As("Z",{min:0,step:"any",value:2},(function(t){e.update("sizeZ",Number(t.target.value))}),!1)),Es("<fieldset>\n               <legend data-i18n>Spherize</legend>\n               <label><input type='radio' name='sphere' value='true' disabled><span data-i18n>Yes</span></label>\n               <label><input type='radio' name='sphere' value='false' checked disabled><span data-i18n>No</span></label>\n             </fieldset>")]),_s("Cylinder",Ls,{sections:16,height:2,bottomR1:1,bottomR2:1,topR1:1,topR2:1},e=>[Es('<div class="primitiveOptions cylinder"></div>',As("Sections",{min:3,value:16,step:1},(function(t){e.update("sections",Number(t.target.value))})),As("Height",{min:0,value:2},(function(t){e.update("height",Number(t.target.value))})),As("Top X Radius",{min:0,value:1},(function(t){e.update("topR1",Number(t.target.value))})),As("Top Z Radius",{min:0,value:1},(function(t){e.update("topR2",Number(t.target.value))})),As("Bottom X Radius",{min:0,value:1},(function(t){e.update("bottomR1",Number(t.target.value))})),As("Bottom Z Radius",{min:0,value:1},(function(t){e.update("bottomR2",Number(t.target.value))})))]),_s("Sphere",Vs,{sections:16,slices:8,radialX:1,radialY:1},e=>[Es('<div class="primitiveOptions"></div>',As("Sections",{min:3,value:16,step:1},(function(t){e.update("sections",Number(t.target.value))})),As("Slices",{min:3,value:8},(function(t){e.update("slices",Number(t.target.value))})),As("X Radial",{min:0,value:2},(function(t){e.update("radialX",Number(t.target.value)/2)})),As("Y Radial",{min:0,value:2},(function(t){e.update("radialY",Number(t.target.value)/2)})))]),_s("Torus",Is,{sections:16,slices:8,r1:1,r2:1,rMinor:.25},e=>[Es('<div class="primitiveOptions"></div>',As("Sections",{min:3,value:16,step:1},(function(t){e.update("sections",Number(t.target.value))})),As("Slices",{min:3,value:8},(function(t){e.update("slices",Number(t.target.value))})),As("Major X Radius",{min:0,value:2},(function(t){e.update("r1",Number(t.target.value))})),As("Major Z Radius",{min:0,value:2},(function(t){e.update("r2",Number(t.target.value))})),As("Minor Radius",{min:0,value:.25,step:.25},(function(t){e.update("rMinor",Number(t.target.value))})))]),_s("Plane",Bs,{resolution:40,size:2,thickness:.2},e=>[Es('<div class="primitiveOptions"></div>',As("Resolution",{min:3,value:40,step:1},(function(t){e.update("resolution",Number(t.target.value))})),As("Size",{min:0,value:2},(function(t){e.update("size",Number(t.target.value))})),As("Thickness",{min:0,value:.2,step:.2},(function(t){e.update("thickness",Number(t.target.value))})))]),_s("Spiral",Rs,{loops:2,segments:16,sections:8},e=>[Es('<div class="primitiveOptions"></div>',As("Loops",{min:1,max:32,value:2},(function(t){e.update("loops",Number(t.target.value))})),As("Segments",{min:3,max:128,value:16},(function(t){e.update("segments",Number(t.target.value))})),As("Sections",{min:2,max:64,value:8},(function(t){e.update("sections",Number(t.target.value))})))]),_s("Spring",Os,{loops:2,segments:16,sections:8},e=>[Es('<div class="primitiveOptions"></div>',As("Loops",{min:1,max:32,value:2,step:1},(function(t){e.update("loops",Number(t.target.value))})),As("Segments",{min:3,max:128,value:16,step:1},(function(t){e.update("segments",Number(t.target.value))})),As("Sections",{min:2,max:64,value:8,step:1},(function(t){e.update("sections",Number(t.target.value))})))]),_s("Tetrahedron",Ns,{length:2},e=>[Es('<div class="primitiveOptions"></div>',As("Length",{min:0,value:2,step:"any"},(function(t){e.update("length",Number(t.target.value))})))]),_s("Octahedron",Ds,{height:2},e=>[Es('<div class="primitiveOptions"></div>',As("Height",{min:0,value:2,step:"any"},(function(t){e.update("height",Number(t.target.value))})))]),_s("Octotoad",ks,{height:2},e=>[Es('<div class="primitiveOptions"></div>',As("Height",{min:0,value:2,step:"any"},(function(t){e.update("height",Number(t.target.value))})))]),_s("Dodecahedron",zs,{length:1},e=>[Es('<div class="primitiveOptions"></div>',As("Edge Length",{min:0,value:1,step:"any"},(function(t){e.update("length",Number(t.target.value))})))]),_s("Icosahedron",Us,{length:1},e=>[Es('<div class="primitiveOptions"></div>',As("Edge Length",{min:0,value:1,step:"any"},(function(t){e.update("length",Number(t.target.value))})))])}));const Xs=document.createElement("template");Xs.innerHTML='\n  <style>\n   :host {\n     display: block;\n   }\n   img { \n     object-fit: cover;\n     height: 16px;\n     width: 16px;\n     object-position: 0px 0px;\n   }\n  </style>\n  <img src="../img/bluecube/small_texture.png"><span></span>\n';class qs extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(Xs.content.cloneNode(!0)),this.listener={},this.listener.contextMenu=e=>{Hs(e,"#importImageTextMenu",{textureTypes:"image",texture:this._texture,ui:this})},this.listener.showImage=e=>{gi(null,[{textureTypes:"image",texture:this._texture,ui:this}]),K(0,"showImage",e)},this.listener.dragStart=e=>{e.stopPropagation(),e.dataTransfer.setData("text/plain","ImageUI"),js=this}}connectedCallback(){this.setAttribute("draggable",!0),this.addEventListener("dragstart",this.listener.dragStart),this.addEventListener("contextmenu",this.listener.contextMenu,!1);this.shadowRoot.querySelector("img").addEventListener("click",this.listener.showImage)}disconnectedCallback(){this.shadowRoot.querySelector("img").removeEventListener("click",this.listener.showImage),this.removeEventListener("contextmenu",this.listener.contextMenu),this.removeEventListener("dragstart",this.listener.dragStart)}get texture(){return this._texture}set texture(e){if(e){this._texture=e;this.shadowRoot.querySelector("span").textContent=e.name}}}customElements.define("wings3d-image",qs);const Gs=document.createElement("template");Gs.innerHTML='\n   <style>\n   :host {\n      display: block;\n    }\n   :host.dropZone {\n      border-style: dashed;\n      border-color: #333;\n      background: #ccc;\n    }\n   :host.dropZone * { /* avoid dragleave event when .dropZone have children */\n      pointer-events: none;\n    }\n\n   ul {\n      display: none;\n      list-style: none; /* Remove list bullets */\n      padding: 0;\n      margin: 0;\n   }\n   li {\n      display: none;\n      padding-left: 1rem;\n   }\n   li.shown {\n      display: block;\n   }\n   .materialIcon { /* https://stackoverflow.com/questions/50646577/how-to-ignore-transparent-pixels-with-background-blend-mode */\n      display: inline-block;\n      background-image: url("../img/bluecube/material.png");\n      width: 16px;\n      height: 16px;\n      -webkit-mask-image: url("../img/bluecube/material.png");\n      -webkit-mask-mode: alpha;\n      mask-image: url("../img/bluecube/material.png");\n      mask-mode: alpha;\n      background-blend-mode: multiply;\n      background-color: white;\n   }\n   .resultCount::before {\n      content: " (";\n   }\n   .resultCount::after {\n      content: ")";\n   }\n   li > img {\n      object-fit: cover;\n      height: 16px;\n      width: 16px;\n   }\n   li.baseColorTexture > img {\n      object-position: -32px 0px;\n   }\n   li.normalTexture > img {\n      object-position: -48px 0px;\n   }\n   li.occlusionTexture > img {\n      object-position: -64px 0px;\n   }\n   li.emissionTexture > img {\n      object-position: -80px 0px;\n   }\n   li.roughnessTexture > img {\n      object-position: -96px 0px;\n   }\n   \n    input {\n      display: none;\n    }\n    input:checked ~ ul {\n      display: block;\n    }\n    label {\n      cursor: pointer;\n      font-weight: bold;\n    }\n    input:not([disabled]) ~ label:before {\n      content: \'\';\n      width: 0;\n      height: 0;\n      position: absolute;\n      border-style: solid;\n      margin-top: 0.2em;\n      margin-left: -0.6em;\n      border-width: 6px;\n      border-top-color: transparent;\n      border-right-color: transparent;\n      border-bottom-color: transparent;\n      border-left-color: red;\n    }\n    input:checked:not([disabled])~ label:before {\n      content: \'\';\n      margin-top: 0.4em;\n      margin-left: -0.8em;\n      border-width: 7px 5px 0;\n      border-top-color: red;\n      border-right-color: transparent;\n      border-bottom-color: transparent;\n      border-left-color: transparent;\n    }\n   </style>\n   <input type="checkbox" id="materialCheck" disabled />\n   <label for="materialCheck"><span class="materialIcon"></span><span></span><span class="resultCount"></span></label>\n   <ul class="texture">\n     <li class="baseColorTexture"><img src="../img/bluecube/small_texture.png"><span></span></li>\n     <li class="roughnessTexture"><img src="../img/bluecube/small_texture.png"><span></span></li>\n     <li class="normalTexture"><img src="../img/bluecube/small_texture.png"><span></span></li>\n     <li class="occlusionTexture"><img src="../img/bluecube/small_texture.png"><span></span></li>\n     <li class="emissionTexture"><img src="../img/bluecube/small_texture.png"><span></span></li>\n   </ul>\n';class Ys extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(Gs.content.cloneNode(!0)),this.listener={},this.listener.dragEnter=e=>{js&&js instanceof qs&&(e.preventDefault(),e.stopPropagation(),this.classList.add("dropZone"))},this.listener.dragOver=e=>{e.preventDefault()},this.listener.dragLeave=e=>{e.preventDefault(),e.stopPropagation(),e.target===this&&js&&js instanceof qs&&this.classList.remove("dropZone")},this.listener.drop=e=>{"ImageUI"===e.dataTransfer.getData("text/plain")&&(this.listener.dragLeave(e),this.addTexture(e,js))},this.listener.editMaterial=e=>{this.editMaterial(e)},this.listener.contextMaterial=e=>{Hs(e,"#materialMenu",this)};for(let e of Ys.textureTypes())this.listener[e]=t=>{Hs(t,"#importTextureMenu",{textureType:e,texture:this._mat[e],ui:this})};this.listener.editDef=this.editDef()}getMain(){const e={};return[e.pict,e.def,e.count]=this.shadowRoot.querySelectorAll("span"),e}static get observedAttributes(){return["def"]}static textureTypes(){return["baseColorTexture","roughnessTexture","normalTexture","occlusionTexture","emissionTexture"]}attributeChangedCallback(e,t,o){switch(e){case"def":this.getMain().def.textContent=o}}connectedCallback(){this._upgradeProps(["def"]),this.addEventListener("drop",this.listener.drop),this.addEventListener("dragenter",this.listener.dragEnter),this.addEventListener("dragover",this.listener.dragOver),this.addEventListener("dragleave",this.listener.dragLeave);const e=this.getMain();e.pict.addEventListener("click",this.listener.editMaterial),this.addEventListener("contextmenu",this.listener.contextMaterial,!1),this.default||(e.def.addEventListener("dbclick",this.listener.editDef.dbclick),e.def.addEventListener("blur",this.listener.editDef.blur));for(let e of Ys.textureTypes()){this.shadowRoot.querySelector("."+e).addEventListener("contextmenu",this.listener[e])}}disconnectedCallback(){for(let e of Ys.textureTypes()){this.shadowRoot.querySelector("."+e).removeEventListener("contextmenu",this.listener[e])}const e=this.getMain();e.pict.removeEventListener("click",this.listener.editMaterial),this.removeEventListener("contextmenu",this.listener.menuMaterial),e.def.removeEventListener("dblclick",this.listener.editDef.dbclick),e.def.removeEventListener("blur",this.listener.editDef.blur)}_upgradeProps(e){for(let t of e)if(this.hasOwnProperty(t)){const e=this[t];delete this[t],this[t]=e}}addTexture(e,t){de("#textureTypePicker",e,e=>{const o=e.querySelector("input:checked").value;o in this._mat&&(this._mat[o]=t.texture)},e=>{e.reset()})}editMaterial(e){function t(e){const t=ce(e);for(let[e,o]of Object.entries(t))isNaN(o)?t[e]=Qe(o):t[e]=parseFloat(o);return t}const o=this._mat;de("#materialSetting",e,e=>{const n=t(e);o.setValues(n)},e=>{e.reset();{const e=document.documentElement.style;e.setProperty("--baseColorMax","#FFFFFF"),e.setProperty("--emissionMax","#FFFFFF")}const n=e.querySelector("h3 > span:nth-child(2)");n&&(n.textContent=o.name);const r=e.querySelector("canvas");if(r){r.getContext("2d").putImageData(Hn(o.pbr),0,0)}for(let[t,n]of Object.entries(o.pbr)){const o=e.querySelector(`div > [name=${t}]`);o&&(isNaN(n)?o.value=ot(n[0],n[1],n[2]):o.value=n,o.onchange&&o.onchange())}e.onchange||(e.onchange=function(o){if(r){const o=t(e);r.getContext("2d").putImageData(Hn(o),0,0)}})})}editDef(){const e=this,t=function(o){"Enter"==o.key&&(""!=this.textContent?e._mat.name=this.textContent:this.textContent=e.name,this.contentEditable=!1,this.removeEventListener("keydown",t))},o={dbclick:function(e){this.contentEditable=!0,this.focus(),this.addEventListener("keydown",t)},blur:function(o){this.textContent=e._mat.name,this.contentEditable=!1,this.removeEventListener("keydown",t)}};return o}get def(){return this.getAttribute("def")}set def(e){this.setAttribute("def",e)}get default(){return null!==this.getAttribute("default")}set default(e){e?this.setAttribute("default",""):this.removeAttribute("default")}rename(e){this._mat.name=e}removeTexture(e){this.shadowRoot.querySelector("."+e)&&this._mat.removeTexture(e)}_setName(e){this.def=e,this.menu.text.textContent=e}_setBaseColor(e){this.getMain().pict.style.backgroundColor=e,this.menu.color.style.backgroundColor=e}_setTexture(e,t){const o=this.shadowRoot.querySelector("."+e);if(o){if(t.isExist())return o.classList.add("shown"),o.querySelector("span").textContent=t.name,!0;o.classList.remove("shown")}return!1}_setUsageCount(e){this.getMain().count.textContent=e}isInUse(){return this.material.isInUse()}get material(){return this._mat}set material(e){if(this._mat&&(this._mat.pbr=this._oldPbr,this._oldPbr=null),this._mat=e,e){this.def=e.pbr.name,this._oldPbr=e.pbr;const t=new Map;t.set("name",e=>{this._setName(e)}),t.set("usageCount",e=>{this._setUsageCount(e)}),t.set("baseColor",e=>{this._setBaseColor(ot(...e))});for(let e of Ys.textureTypes())t.set(e,t=>{this._setTexture(e,t)});e.pbr=new Proxy(e.pbr,{set(e,o,n){e[o]=n;const r=t.get(o);return r&&r(n),!0}}),this._setBaseColor(e.getBaseColorInHex()),this._setUsageCount(e.pbr.usageCount);let o=!1;for(let t of Ys.textureTypes())o|=this._setTexture(t,e[t]);this.shadowRoot.querySelector("input").disabled=!o}}}var $s;customElements.define("wings3d-material",Ys),$s="glcanvas","loading"!=document.readyState?H($s):(N=$s,document.addEventListener("DOMContentLoaded",D))},function(e,t){}]);